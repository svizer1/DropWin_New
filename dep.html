<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ | DropWin</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .method-card {
      background: rgba(30,27,71,0.75);
      border-radius: 16px;
      padding: 18px;
      margin: 16px 0;
      border: 2px solid #6b7280;
      cursor: pointer;
      transition: all 0.25s;
    }
    .method-card.active {
      border-color: #34d399;
      background: rgba(16,185,129,0.15);
      box-shadow: 0 0 20px rgba(52,211,153,0.4);
    }
    .bonus-notice {
      background: linear-gradient(135deg, #1e40af, #1e3a8a);
      padding: 16px;
      border-radius: 16px;
      margin: 20px 0;
      text-align: center;
    }

    /* –û–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è */
    #confirmModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    #confirmModal.show {
      display: flex;
    }
    .confirm-box {
      background: linear-gradient(145deg, #1e1b4b, #312e81);
      border-radius: 24px;
      padding: 32px;
      max-width: 400px;
      width: 100%;
      text-align: center;
      border: 2px solid #4f46e5;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
    }
    .confirm-title {
      font-size: 1.5rem;
      font-weight: bold;
      color: #fff;
      margin-bottom: 20px;
    }
    .confirm-amount {
      font-size: 2.5rem;
      font-weight: bold;
      color: #34d399;
      margin: 20px 0;
    }
    .confirm-details {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 16px;
      margin: 20px 0;
      text-align: left;
      color: #d1d5db;
      font-size: 0.95rem;
    }
    .confirm-details div {
      margin: 8px 0;
      display: flex;
      justify-content: space-between;
    }
    .confirm-details span:last-child {
      color: #fff;
      font-weight: 600;
    }
    .confirm-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    .confirm-btn {
      flex: 1;
      padding: 16px;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
    }
    .confirm-btn.cancel {
      background: rgba(239, 68, 68, 0.2);
      color: #f87171;
      border: 2px solid #ef4444;
    }
    .confirm-btn.cancel:hover {
      background: rgba(239, 68, 68, 0.4);
    }
    .confirm-btn.confirm {
      background: linear-gradient(135deg, #34d399, #10b981);
      color: #fff;
      box-shadow: 0 4px 15px rgba(52, 211, 153, 0.4);
    }
    .confirm-btn.confirm:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(52, 211, 153, 0.5);
    }

    /* –û–∫–Ω–æ –æ–ø–ª–∞—Ç—ã */
    #paymentModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    #paymentModal.show {
      display: flex;
    }
    .payment-box {
      background: linear-gradient(145deg, #1e1b4b, #312e81);
      border-radius: 24px;
      padding: 32px;
      max-width: 420px;
      width: 100%;
      text-align: center;
      border: 2px solid #4f46e5;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
    }
    .payment-title {
      font-size: 1.3rem;
      font-weight: bold;
      color: #fff;
      margin-bottom: 16px;
    }
    .payment-amount {
      font-size: 2rem;
      font-weight: bold;
      color: #fbbf24;
      margin: 16px 0;
    }
    .payment-id {
      background: rgba(0, 0, 0, 0.4);
      padding: 12px;
      border-radius: 10px;
      font-family: monospace;
      font-size: 0.9rem;
      color: #a78bfa;
      margin: 16px 0;
    }
    .payment-link {
      display: block;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: #fff;
      padding: 16px;
      border-radius: 12px;
      text-decoration: none;
      font-weight: bold;
      font-size: 1.1rem;
      margin: 20px 0;
      transition: all 0.3s;
    }
    .payment-link:hover {
      transform: scale(1.02);
      box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
    }
    .payment-timer {
      color: #9ca3af;
      font-size: 0.9rem;
      margin-top: 12px;
    }
    .payment-close {
      background: transparent;
      border: 2px solid #6b7280;
      color: #9ca3af;
      padding: 12px 24px;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 16px;
      transition: all 0.3s;
    }
    .payment-close:hover {
      border-color: #fff;
      color: #fff;
    }
    .payment-status {
      margin-top: 16px;
      padding: 12px;
      border-radius: 10px;
      font-size: 0.95rem;
    }
    .payment-status.pending {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
    }
    .payment-status.processing {
      background: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
    }

    #promoFloat {
      position: fixed;
      top: 80px;
      right: 16px;
      background: linear-gradient(135deg, #34d399, #10b981);
      color: white;
      padding: 14px 18px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      max-width: 320px;
      z-index: 9999;
      font-size: 0.95rem;
      display: none;
      opacity: 1;
      transition: opacity 1s ease-out;
    }
    #promoFloat.fade-out { opacity: 0; }

    #promoFloat button {
      margin-top: 10px;
      background: white;
      color: #10b981;
      border: none;
      padding: 8px 16px;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
    }

    #promoBonusPreview {
      margin: 12px 0;
      color: #34d399;
      font-weight: bold;
      font-size: 1.1rem;
      text-align: center;
      min-height: 30px;
    }

    #loadingLine {
      height: 4px;
      background: linear-gradient(to right, #fbbf24, #34d399);
      width: 0%;
      transition: width 1.8s ease-in-out;
      position: absolute;
      bottom: 0;
      left: 0;
      border-radius: 2px;
    }

    #depStatus.success {
      color: #34d399;
      font-weight: bold;
      font-size: 1.3rem;
      opacity: 1;
      transition: opacity 1.2s ease-out;
    }
    #depStatus.success.fade-out {
      opacity: 0;
    }
  </style>
</head>
<body>
<div class="particles" id="particles"></div>

<!-- –û–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
<div id="confirmModal">
  <div class="confirm-box">
    <div class="confirm-title">üìã –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã</div>
    <div class="confirm-amount" id="confirmAmount">0 ‚ÇΩ</div>
    <div class="confirm-details">
      <div><span>–°—É–º–º–∞:</span><span id="detailAmount">0 ‚ÇΩ</span></div>
      <div><span>–ë–æ–Ω—É—Å:</span><span id="detailBonus">+0 ‚ÇΩ</span></div>
      <div><span>–ò—Ç–æ–≥–æ:</span><span id="detailTotal" style="color:#34d399;">0 ‚ÇΩ</span></div>
      <div><span>–ú–µ—Ç–æ–¥:</span><span>Telegram –ë–æ—Ç</span></div>
    </div>
    <div class="confirm-buttons">
      <button class="confirm-btn cancel" onclick="closeConfirmModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="confirm-btn confirm" onclick="submitPayment()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å ‚Üí</button>
    </div>
  </div>
</div>

<!-- –û–∫–Ω–æ –æ–ø–ª–∞—Ç—ã -->
<div id="paymentModal">
  <div class="payment-box">
    <div class="payment-title">üí≥ –û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ Telegram</div>
    <div class="payment-amount" id="paymentAmount">0 ‚ÇΩ</div>
    <div class="payment-id">ID: <span id="paymentId">---</span></div>
    <div class="payment-status pending" id="paymentStatus">
      ‚è≥ –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã... –ë–æ—Ç —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ Telegram
    </div>
    <a href="#" class="payment-link" id="paymentLink" target="_blank">
      üì± –û—Ç–∫—Ä—ã—Ç—å Telegram –ë–æ—Ç
    </a>
    <div class="payment-timer">–°–æ–∑–¥–∞–Ω–æ: <span id="paymentTime">--:--</span></div>
    <button class="payment-close" onclick="closePaymentModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<div id="promoFloat">
  <strong>–°–µ–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ +20%!</strong><br>
  –°–µ–π—á–∞—Å —á–∞—Å—Ç–æ –≤—ã–ø–∞–¥–∞–µ—Ç <b id="randomPromoCode">DEP-X7K9P2</b><br>
  –í–≤–µ–¥–∏ –µ–≥–æ –Ω–∏–∂–µ –∏ –ø–æ–ª—É—á–∏ +20% –∫ –¥–µ–ø–æ–∑–∏—Ç—É!
  <button onclick="copyPromoCode()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
</div>

<div class="header">
  <div class="logo" onclick="location.href='index.html'" style="cursor: pointer;">üíé DROPWIN</div>
  <div class="balance-container">
    <div class="balance">üí∞ <span id="balance">0</span>‚ÇΩ</div>
  </div>
</div>

<div class="content">
  <button class="back-btn" onclick="location.href='index.html'">‚Üê –ù–∞–∑–∞–¥</button>

  <div class="game-card">
    <div class="game-title">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</div>

    <div class="bonus-notice">
      <strong>üéÅ –ë–æ–Ω—É—Å –æ—Ç 100‚ÇΩ</strong><br>
      –ß–µ–º –±–æ–ª—å—à–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ ‚Äî —Ç–µ–º –±–æ–ª—å—à–µ –±–æ–Ω—É—Å!
    </div>

    <div id="method-tg" class="method-card active">
      <h3>üì± Telegram –ë–æ—Ç</h3>
      <p>–ö–∞—Ä—Ç–∞ ‚Ä¢ –°–ë–ü ‚Ä¢ –ÆMoney ‚Ä¢ –ö—Ä–∏–ø—Ç–∞</p>
    </div>

    <div style="margin: 24px 0; position: relative;">
      <label class="input-label">–°—É–º–º–∞ (‚ÇΩ)</label>
      <div style="display: flex; align-items: center; gap: 12px;">
        <input type="number" id="depAmount" placeholder="100" min="50" value="500" style="font-size:1.4rem; padding:16px; flex: 1;">
        <div id="totalWithBonus" style="color:#34d399; font-weight:700; font-size:1.5rem; min-width: 120px; text-align: right;"></div>
      </div>
      <div id="loadingLine"></div>
    </div>

    <div style="margin: 16px 0;">
      <label class="input-label">–ü—Ä–æ–º–æ–∫–æ–¥ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
      <input type="text" id="depPromoCode" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: DROPWIN-ABC123" style="font-size:1.2rem; padding:12px;">
    </div>

    <button class="btn" onclick="activatePromoOnDep()" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</button>

    <button class="btn" onclick="showConfirmModal()" style="margin-top: 16px; background: linear-gradient(135deg, #34d399, #10b981);">üí≥ –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ</button>

    <div id="depStatus"></div>
  </div>
</div>

<div class="nav">
  <button class="nav-btn" onclick="location.href='index.html'"><span>üè†</span>–ì–ª–∞–≤–Ω–∞—è</button>
  <button class="nav-btn" onclick="location.href='profile.html'"><span>üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</button>
  <button class="nav-btn active"><span>üí∏</span>–î–µ–ø–æ–∑–∏—Ç</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBVra2JN-C7-1b_Qa4cU8--XvJ83lymiM8",
    authDomain: "dropwin-8d94b.firebaseapp.com",
    projectId: "dropwin-8d94b",
    storageBucket: "dropwin-8d94b.firebasestorage.app",
    messagingSenderId: "988974289403",
    appId: "1:988974289403:web:886d34e6f65920a105fb5e",
    measurementId: "G-BK010MHN8N"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let userId = null;
  let activePromoCode = null;
  let pendingPayment = null;

  function createParticles() {
    const container = document.getElementById('particles');
    for (let i = 0; i < 40; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      p.style.width = p.style.height = Math.random() * 3 + 1 + 'px';
      p.style.left = Math.random() * 100 + '%';
      p.style.animationDuration = Math.random() * 15 + 10 + 's';
      p.style.animationDelay = Math.random() * 5 + 's';
      container.appendChild(p);
    }
  }

  function showRandomPromo() {
    const float = document.getElementById('promoFloat');
    if (float) float.style.display = 'none';
  }

  function getTodayStr() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}${m}${day}`;
  }

  function generateDailyCode() {
    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let part = '';
    for (let i = 0; i < 6; i++) {
      part += alphabet[Math.floor(Math.random() * alphabet.length)];
    }
    return `DROPWIN-${part}`;
  }

  window.copyPromoCode = function() {
    const el = document.getElementById('randomPromoCode');
    if (!el) return;
    const code = el.textContent;
    navigator.clipboard.writeText(code).then(() => {
      alert('–ü—Ä–æ–º–æ–∫–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
    });
  };

  window.ensureDailyPromo = async function() {
    if (!currentUser || !userId) return;
    try {
      const today = getTodayStr();
      const needNew = !currentUser.dailyPromoDate || currentUser.dailyPromoDate !== today;
      if (needNew) {
        const newCode = generateDailyCode();
        await updateDoc(doc(db, 'users', userId), {
          dailyPromoDate: today,
          dailyPromoCode: newCode,
          dailyPromoUsed: false,
          dailyPromoExpiresAt: Date.now() + 20 * 60 * 1000
        });
        currentUser.dailyPromoDate = today;
        currentUser.dailyPromoCode = newCode;
        currentUser.dailyPromoUsed = false;
        currentUser.dailyPromoExpiresAt = Date.now() + 20 * 60 * 1000;
      }
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞:', e);
    }
  };

  window.checkAndShowDailyPromo = function() {
    try {
      const float = document.getElementById('promoFloat');
      const codeEl = document.getElementById('randomPromoCode');
      if (!float || !codeEl) return;
      const today = getTodayStr();
      const code = currentUser?.dailyPromoCode;
      const date = currentUser?.dailyPromoDate;
      const used = !!currentUser?.dailyPromoUsed;
      const expiresAt = currentUser?.dailyPromoExpiresAt || 0;
      const now = Date.now();
      if (code && date === today && !used && expiresAt > now) {
        codeEl.textContent = code;
        float.style.display = 'block';
        float.classList.remove('fade-out');
        const remain = Math.max(0, expiresAt - now);
        setTimeout(() => {
          float.classList.add('fade-out');
          setTimeout(() => float.style.display = 'none', 1000);
        }, remain);
      } else {
        float.style.display = 'none';
      }
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –ø—Ä–æ–º–æ:', e);
    }
  };

  window.activatePromoOnDep = async function() {
    const code = document.getElementById('depPromoCode').value.trim().toUpperCase();
    if (!code) return alert('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥');

    const amount = Number(document.getElementById('depAmount').value) || 0;
    if (amount < 50) return alert('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–µ–ø–æ–∑–∏—Ç–∞ ‚Äî 50‚ÇΩ');

    let calculatedBonus = 0;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ–¥–∏–Ω–æ—Ä–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if (currentUser?.activePromoCode === code && !currentUser?.activePromoUsed) {
      const promoType = currentUser.activePromoType;
      const promoValue = currentUser.activePromoValue;

      if (promoType === 'dep20') {
        calculatedBonus = Math.round(amount * 0.20);
      } else if (promoType === 'dep25') {
        calculatedBonus = Math.round(amount * 0.25);
      } else if (promoType === 'dep30') {
        calculatedBonus = Math.round(amount * 0.30);
      } else if (promoType && promoType.startsWith('bonus')) {
        calculatedBonus = promoValue;
      } else {
        return alert('–≠—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –¥–µ–ø–æ–∑–∏—Ç–∞');
      }

      activePromoCode = {
        code: code,
        type: promoType,
        value: promoValue
      };

      document.getElementById('totalWithBonus').textContent = `= ${amount + calculatedBonus}‚ÇΩ`;

      try {
        await updateDoc(doc(db, 'users', userId), { activePromoUsed: true });
        currentUser.activePromoUsed = true;
        const float = document.getElementById('promoFloat');
        if (float) float.style.display = 'none';
      } catch (e) {
        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–º:', e);
      }
    }
    // –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ DROPWIN-XXXXXX, –µ–¥–∏–Ω–æ—Ä–∞–∑–æ–≤–æ –≤ –¥–µ–Ω—å
    else if (currentUser?.dailyPromoCode && code === currentUser.dailyPromoCode) {
      const today = getTodayStr();
      if (currentUser.dailyPromoDate !== today) {
        return alert('–≠—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω —Å–µ–≥–æ–¥–Ω—è');
      }
      if (currentUser.dailyPromoUsed) {
        return alert('–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω');
      }
      calculatedBonus = Math.round(amount * 0.20);
      activePromoCode = {
        code: code,
        type: 'dep20',
        value: 20
      };
      document.getElementById('totalWithBonus').textContent = `= ${amount + calculatedBonus}‚ÇΩ`;
      try {
        await updateDoc(doc(db, 'users', userId), { dailyPromoUsed: true });
        currentUser.dailyPromoUsed = true;
        const float = document.getElementById('promoFloat');
        if (float) float.style.display = 'none';
      } catch (e) {
        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ—Ç–∏—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–º:', e);
      }
    }
    else {
      document.getElementById('totalWithBonus').textContent = '';
      alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥');
    }
  };

  // –ü–æ–∫–∞–∑–∞—Ç—å –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
  window.showConfirmModal = function() {
    const amount = Number(document.getElementById('depAmount').value);
    if (!amount || amount < 50) return alert('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ ‚Äî 50 ‚ÇΩ');

    let bonus = calculateBonus(amount);
    let total = amount + bonus;

    document.getElementById('confirmAmount').textContent = `${total} ‚ÇΩ`;
    document.getElementById('detailAmount').textContent = `${amount} ‚ÇΩ`;
    document.getElementById('detailBonus').textContent = bonus > 0 ? `+${bonus} ‚ÇΩ` : '0 ‚ÇΩ';
    document.getElementById('detailTotal').textContent = `${total} ‚ÇΩ`;

    document.getElementById('confirmModal').classList.add('show');
  };

  // –ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
  window.closeConfirmModal = function() {
    document.getElementById('confirmModal').classList.remove('show');
  };

  // –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –±–æ–Ω—É—Å
  function calculateBonus(amount) {
    if (activePromoCode) {
      const promoType = activePromoCode.type;
      const promoValue = activePromoCode.value;

      if (promoType === 'dep20') return Math.round(amount * 0.20);
      if (promoType === 'dep25') return Math.round(amount * 0.25);
      if (promoType === 'dep30') return Math.round(amount * 0.30);
      if (promoType && promoType.startsWith('bonus')) return promoValue;
    }
    return 0;
  }

  // –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É
  window.submitPayment = async function() {
    const amount = Number(document.getElementById('depAmount').value);
    const bonus = calculateBonus(amount);
    const total = amount + bonus;

    closeConfirmModal();

    const status = document.getElementById('depStatus');
    status.innerHTML = '<div style="color:#fbbf24;">–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏...</div>';

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –∑–∞—è–≤–∫–∏
    const paymentId = 'PAY' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substring(2, 6).toUpperCase();

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞—è–≤–∫—É –≤ Firestore
    const paymentData = {
      paymentId: paymentId,
      userId: userId,
      username: currentUser?.username || currentUser?.email || 'Unknown',
      amount: amount,
      bonus: bonus,
      total: total,
      status: 'pending', // pending, processing, completed, cancelled
      method: 'telegram_bot',
      promoCode: activePromoCode?.code || null,
      promoType: activePromoCode?.type || null,
      promoValue: activePromoCode?.value || null,
      createdAt: Date.now(),
      updatedAt: Date.now()
    };

    try {
      await setDoc(doc(db, 'payments', paymentId), paymentData);

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ –æ–ø–ª–∞—Ç—ã
      document.getElementById('paymentAmount').textContent = `${total} ‚ÇΩ`;
      document.getElementById('paymentId').textContent = paymentId;
      document.getElementById('paymentTime').textContent = new Date().toLocaleTimeString('ru-RU');

      // –°—Å—ã–ª–∫–∞ –Ω–∞ –±–æ—Ç–∞
      const tgLink = `https://t.me/DropWins_Bot?start=${paymentId}`;
      document.getElementById('paymentLink').href = tgLink;

      document.getElementById('paymentModal').classList.add('show');

      status.innerHTML = '';

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º pending payment –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
      pendingPayment = {
        paymentId: paymentId,
        amount: total,
        bonus: bonus
      };

      // –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞
      checkPaymentStatus(paymentId);

    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏:', error);
      status.innerHTML = '<div style="color:#ef4444;">–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.</div>';
    }
  };

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã
  async function checkPaymentStatus(paymentId) {
    const checkInterval = setInterval(async () => {
      if (!pendingPayment || pendingPayment.paymentId !== paymentId) {
        clearInterval(checkInterval);
        return;
      }

      try {
        const docSnap = await getDoc(doc(db, 'payments', paymentId));
        if (docSnap.exists()) {
          const payment = docSnap.data();

          if (payment.status === 'completed') {
            clearInterval(checkInterval);
            await processCompletedPayment(payment);
          } else if (payment.status === 'cancelled') {
            clearInterval(checkInterval);
            closePaymentModal();
            alert('–ó–∞—è–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞');
            pendingPayment = null;
          }
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
      }
    }, 3000); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã

    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç
    setTimeout(() => {
      clearInterval(checkInterval);
    }, 30 * 60 * 1000);
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
  async function processCompletedPayment(payment) {
    closePaymentModal();

    const amount = payment.amount;
    const bonus = payment.bonus;
    const total = payment.total;

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥
    let newPromoCode = null;
    let newPromoBonus = 0;

    if (amount >= 1000) newPromoBonus = Math.floor(Math.random() * 100) + 1;
    else if (amount >= 500) newPromoBonus = Math.floor(Math.random() * 50) + 1;
    else if (amount >= 250) newPromoBonus = Math.floor(Math.random() * 30) + 1;
    else if (amount >= 100) newPromoBonus = Math.floor(Math.random() * 15) + 1;

    if (newPromoBonus > 0) {
      const randomPart = Math.random().toString(36).substring(2, 9).toUpperCase();
      newPromoCode = `BONUS-${randomPart}`;
    }

    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
    if (!currentUser.cryptoTransactions) currentUser.cryptoTransactions = [];
    const txEntry = {
      type: 'deposit',
      amount: total,
      originalAmount: amount,
      method: 'Telegram Bot',
      paymentId: payment.paymentId,
      timestamp: Date.now()
    };
    if (bonus && bonus > 0) {
      txEntry.bonus = bonus;
    }
    if (payment.promoCode) {
      txEntry.promoCode = payment.promoCode;
    }
    currentUser.cryptoTransactions.push(txEntry);

    // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
    currentUser.balance = (currentUser.balance || 0) + total;

    const updateData = {
      balance: currentUser.balance,
      cryptoTransactions: currentUser.cryptoTransactions,
      lastDepositAt: Date.now(),
      lastDepositAmount: amount,
      gamesPlayedAtLastDeposit: currentUser.gamesPlayed || 0,
      totalBetAtLastDeposit: currentUser.totalBet || 0
    };

    if (newPromoCode) {
      updateData.activePromoCode = newPromoCode;
      updateData.activePromoType = `bonus${newPromoBonus}`;
      updateData.activePromoValue = newPromoBonus;
    }

    await updateDoc(doc(db, 'users', userId), updateData);
    document.getElementById('balance').textContent = currentUser.balance;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    const status = document.getElementById('depStatus');
    let promoMessage = '';
    if (newPromoCode) {
      promoMessage = `
        <div style="background: rgba(52,211,153,0.1); padding: 12px; border-radius: 10px; margin-top: 12px; border: 2px solid #34d399;">
          <div style="color:#34d399; font-weight:700;">üéÅ –í—ã –ø–æ–ª—É—á–∏–ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥!</div>
          <div style="font-family: monospace; font-size: 1.3rem; letter-spacing: 2px; margin: 8px 0; cursor: pointer; background: #111827; padding: 10px; border-radius: 8px;"
               onclick="navigator.clipboard.writeText('${newPromoCode}').then(() => alert('–ü—Ä–æ–º–æ–∫–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!'))"
               title="–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">
            ${newPromoCode}
          </div>
          <div style="color:#fbbf24; font-size: 0.95rem;">–ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –≤ –ø—Ä–æ—Ñ–∏–ª–µ: +${newPromoBonus}‚ÇΩ</div>
        </div>
      `;
    }

    status.innerHTML = `
      <div style="color:#34d399; font-weight:700; font-size:1.4rem;">
        ‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞—á–∏—Å–ª–µ–Ω–æ +${total} ‚ÇΩ
      </div>
      ${bonus ? `<div style="color:#fbbf24; margin-top:8px;">–ë–æ–Ω—É—Å: +${bonus}‚ÇΩ</div>` : ''}
      ${promoMessage}
    `;
    status.classList.add('success');

    setTimeout(() => {
      status.classList.add('fade-out');
      setTimeout(() => {
        status.innerHTML = '';
        status.classList.remove('success', 'fade-out');
      }, 1200);
    }, 6000);

    pendingPayment = null;
  }

  // –ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –æ–ø–ª–∞—Ç—ã
  window.closePaymentModal = function() {
    document.getElementById('paymentModal').classList.remove('show');
    pendingPayment = null;
  };

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      userId = user.uid;
      try {
        const snap = await getDoc(doc(db, 'users', user.uid));
        if (snap.exists()) {
          currentUser = snap.data();
          document.getElementById('balance').textContent = currentUser.balance || 0;
          await ensureDailyPromo();
          checkAndShowDailyPromo();
        }
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:", e);
      }
    } else {
      location.href = 'register.html';
    }
  });

  document.addEventListener('DOMContentLoaded', () => {
    createParticles();
    setTimeout(() => { checkAndShowDailyPromo(); }, 500);
  });
</script>
</body>
</html>

