<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>ĞšĞ¾ÑÑ‚Ğ¸ | DropWin</title>
  <link rel="stylesheet" href="../style.css">
  <style>
    /* Ñ‚Ğ²Ğ¾Ğ¹ ÑÑ‚Ğ¸Ğ»ÑŒ Ğ´Ğ»Ñ ĞºÑƒĞ±Ğ¸ĞºĞ¾Ğ² Ğ¾ÑÑ‚Ğ°Ñ‘Ñ‚ÑÑ Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ */
    .dice-container {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin: 40px 0;
      perspective: 800px;
    }
    .dice {
      width: 110px;
      height: 110px;
      background: linear-gradient(145deg, #f1f5f9, #e2e8f0);
      border-radius: 20px;
      border: 5px solid #1e293b;
      box-shadow: 0 10px 30px rgba(0,0,0,0.7), inset 0 4px 10px rgba(255,255,255,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4.2rem;
      font-weight: bold;
      color: #111;
      transform-style: preserve-3d;
      transition: transform 0.4s;
    }
    .dice.rolling {
      animation: rollDice3D 1.4s cubic-bezier(0.68, -0.55, 0.265, 1.55) 3;
    }
    @keyframes rollDice3D {
      0%   { transform: rotateX(0deg) rotateY(0deg) scale(1); }
      25%  { transform: rotateX(180deg) rotateY(180deg) scale(1.12); }
      50%  { transform: rotateX(360deg) rotateY(360deg) scale(0.92); }
      75%  { transform: rotateX(540deg) rotateY(540deg) scale(1.08); }
      100% { transform: rotateX(720deg) rotateY(720deg) scale(1); }
    }
    .dice-face-1 { color: #ef4444; }
    .dice-face-2, .dice-face-3 { color: #10b981; }
    .dice-face-4, .dice-face-5, .dice-face-6 { color: #6366f1; }

    .result {
      font-size: 1.5rem;
      font-weight: 600;
      min-height: 80px;
      text-align: center;
      margin-top: 30px;
    }

    .bot-dice-container {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin: 20px 0;
      perspective: 800px;
    }
    .bot-label {
      text-align: center;
      font-size: 1.2rem;
      color: #fbbf24;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

<div class="particles" id="particles"></div>

<div class="header">
  <div class="logo">ğŸ’ DROPWIN</div>
  <div class="balance-container">
    <div class="balance">ğŸ’° <span id="balance">0</span>â‚½</div>
    <button class="auth-btn" id="authBtn">ĞĞºĞºĞ°ÑƒĞ½Ñ‚</button>
  </div>
</div>

<div class="content">
  <button class="back-btn" onclick="location.href='../index.html'">â† ĞĞ°Ğ·Ğ°Ğ´</button>

  <div class="game-card">
    <div class="game-title">ğŸ² ĞšĞ¾ÑÑ‚Ğ¸</div>

    <div class="dice-container" id="diceContainer">
      <div class="dice" id="dice1">?</div>
      <div class="dice" id="dice2">?</div>
    </div>

    <div class="bot-label">ĞšĞ¾ÑÑ‚Ğ¸ Ğ±Ğ¾Ñ‚Ğ°:</div>
    <div class="bot-dice-container" id="botDiceContainer">
      <div class="dice" id="botDice1">?</div>
      <div class="dice" id="botDice2">?</div>
    </div>

    <div class="input-group" style="max-width:300px; margin:30px auto;">
      <label class="input-label">Ğ¡Ñ‚Ğ°Ğ²ĞºĞ°</label>
      <input type="number" id="betDice" value="100" min="10" step="10">
    </div>

    <button class="btn" id="rollBtn">Ğ‘Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ ĞºĞ¾ÑÑ‚Ğ¸</button>

    <div class="result" id="diceResult">Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ñ‹ Ğº Ğ±Ñ€Ğ¾ÑĞºÑƒ? Ğ‘Ğ¾Ñ‚ Ñ‚Ğ¾Ğ¶Ğµ Ğ³Ğ¾Ñ‚Ğ¾Ğ²!</div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBVra2JN-C7-1b_Qa4cU8--XvJ83lymiM8",
    authDomain: "dropwin-8d94b.firebaseapp.com",
    projectId: "dropwin-8d94b",
    storageBucket: "dropwin-8d94b.firebasestorage.app",
    messagingSenderId: "988974289403",
    appId: "1:988974289403:web:886d34e6f65920a105fb5e",
    measurementId: "G-BK010MHN8N"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let isGuest = false;
  let userId = null;

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Firebase Ğ¸Ğ»Ğ¸ Ğ“Ğ¾ÑÑ‚ÑŒ)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function loadCurrentUser() {
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // Firebase-ÑĞ·ĞµÑ€
        userId = user.uid;
        isGuest = false;
        getDoc(doc(db, 'users', user.uid)).then(docSnap => {
          if (docSnap.exists()) {
            currentUser = docSnap.data();
            renderUser();
          } else {
            goToLogin();
          }
        });
      } else {
        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ³Ğ¾ÑÑ‚Ñ
        const username = localStorage.getItem('dropwin_current_username');
        if (username === 'Ğ“Ğ¾ÑÑ‚ÑŒ') {
          isGuest = true;
          const users = JSON.parse(localStorage.getItem('dropwin_users') || '[]');
          currentUser = users.find(u => u.username === 'Ğ“Ğ¾ÑÑ‚ÑŒ');
          if (currentUser) {
            renderUser();
          } else {
            goToLogin();
          }
        } else {
          goToLogin();
        }
      }
    });
  }

  function renderUser() {
    document.getElementById('balance').textContent = currentUser.balance || 0;
    const btn = document.getElementById('authBtn');
    btn.textContent = isGuest ? 'Ğ“Ğ¾ÑÑ‚ÑŒ' : (currentUser.username || 'Ğ˜Ğ³Ñ€Ğ¾Ğº');
    btn.onclick = () => location.href = '../profile.html';
  }

  function goToLogin() {
    alert('ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ğ² Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚');
    location.href = '../register.html';
  }

  function saveUser() {
    if (!currentUser) return;

    if (isGuest) {
      let users = JSON.parse(localStorage.getItem('dropwin_users') || '[]');
      const idx = users.findIndex(u => u.username === 'Ğ“Ğ¾ÑÑ‚ÑŒ');
      if (idx !== -1) {
        users[idx] = { ...currentUser };
      }
      localStorage.setItem('dropwin_users', JSON.stringify(users));
    } else if (userId) {
      updateDoc(doc(db, 'users', userId), currentUser)
        .catch(err => console.error("ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ² Firestore:", err));
    }
  }

  function addToHistory(game, change) {
    const entry = {
      game,
      time: new Date().toLocaleString('ru-RU'),
      win: change,
      result: change > 0 ? 'win' : (change < 0 ? 'loss' : 'draw')
    };
    currentUser.history = currentUser.history || [];
    currentUser.history.unshift(entry);
    if (currentUser.history.length > 30) currentUser.history = currentUser.history.slice(0, 30);
    saveUser();
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¸Ğ³Ñ€Ñ‹
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function createParticles() {
    const container = document.getElementById('particles');
    for (let i = 0; i < 40; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      p.style.width = p.style.height = Math.random() * 3 + 1 + 'px';
      p.style.left = Math.random() * 100 + '%';
      p.style.animationDuration = Math.random() * 15 + 10 + 's';
      p.style.animationDelay = Math.random() * 5 + 's';
      container.appendChild(p);
    }
  }

  async function rollDice() {
    if (!currentUser) return alert('Ğ’Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ğ² Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚');

    const btn = document.getElementById('rollBtn');
    if (btn.disabled) return;

    const betInput = document.getElementById('betDice');
    const bet = Number(betInput.value);
    if (isNaN(bet) || bet < 10 || bet > currentUser.balance) {
      return alert('ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ°Ñ ÑÑ‚Ğ°Ğ²ĞºĞ° (Ğ¼Ğ¸Ğ½ 10 â‚½, Ğ½Ğµ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°)');
    }

    btn.disabled = true;
    currentUser.balance -= bet;
    document.getElementById('balance').textContent = currentUser.balance;
    saveUser();

    document.getElementById('diceResult').innerHTML = 'Ğ‘Ñ€Ğ¾ÑĞ°ĞµĞ¼ ĞºĞ¾ÑÑ‚Ğ¸...';

    // ĞĞ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ñ
    document.getElementById('dice1').classList.add('rolling');
    document.getElementById('dice2').classList.add('rolling');
    document.getElementById('botDice1').classList.add('rolling');
    document.getElementById('botDice2').classList.add('rolling');

    await new Promise(r => setTimeout(r, 4200));

    // Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹
    const p1 = Math.floor(Math.random() * 6) + 1;
    const p2 = Math.floor(Math.random() * 6) + 1;
    const playerSum = p1 + p2;

    const b1 = Math.floor(Math.random() * 6) + 1;
    const b2 = Math.floor(Math.random() * 6) + 1;
    const botSum = b1 + b2;

    document.getElementById('dice1').textContent = p1;
    document.getElementById('dice2').textContent = p2;
    document.getElementById('botDice1').textContent = b1;
    document.getElementById('botDice2').textContent = b2;

    document.querySelectorAll('.dice').forEach(d => d.classList.remove('rolling'));

    let resultText = `Ğ’Ğ°ÑˆĞ° ÑÑƒĞ¼Ğ¼Ğ°: <b>${playerSum}</b> | Ğ‘Ğ¾Ñ‚: <b>${botSum}</b><br>`;
    let profit = 0;

    currentUser.gamesPlayed = (currentUser.gamesPlayed || 0) + 1;
    currentUser.totalBet = (currentUser.totalBet || 0) + bet;

    if (playerSum > botSum) {
      profit = bet * 2;
      currentUser.balance += profit;
      currentUser.totalWin = (currentUser.totalWin || 0) + profit;
      currentUser.wins = (currentUser.wins || 0) + 1;
      resultText += `<span style="color:#22c55e;font-weight:bold">Ğ’Ñ‹Ğ¸Ğ³Ñ€Ğ°Ğ½Ğ¾ +${profit}â‚½!</span>`;
      addToHistory('ĞšĞ¾ÑÑ‚Ğ¸', profit - bet);
    } else if (playerSum < botSum) {
      currentUser.losses = (currentUser.losses || 0) + 1;
      resultText += `<span style="color:#ef4444;font-weight:bold">ĞŸÑ€Ğ¾Ğ¸Ğ³Ñ€Ñ‹Ñˆ âˆ’${bet}â‚½</span>`;
      addToHistory('ĞšĞ¾ÑÑ‚Ğ¸', -bet);
    } else {
      currentUser.balance += bet; // Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚
      resultText += `<span style="color:#fbbf24;font-weight:bold">ĞĞ¸Ñ‡ÑŒÑ â€” ÑÑ‚Ğ°Ğ²ĞºĞ° Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ°</span>`;
      addToHistory('ĞšĞ¾ÑÑ‚Ğ¸', 0);
    }

    document.getElementById('diceResult').innerHTML = resultText;
    document.getElementById('balance').textContent = currentUser.balance;
    saveUser();

    setTimeout(() => { btn.disabled = false; }, 800);
  }

  // Ğ—Ğ°Ğ¿ÑƒÑĞº
  document.addEventListener('DOMContentLoaded', () => {
    createParticles();
    loadCurrentUser();
    document.getElementById('rollBtn').addEventListener('click', rollDice);
  });
</script>
</body>
</html>