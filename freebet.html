<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>FreeBet –ë–æ–Ω—É—Å—ã | DropWin</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .case-big {
      font-size: 9rem;
      text-align: center;
      margin: 30px 0;
      cursor: pointer;
      transition: transform 0.4s;
      filter: drop-shadow(0 0 20px rgba(251, 191, 36, 0.2));
    }
    .case-big:hover { transform: scale(1.12); filter: drop-shadow(0 0 30px rgba(251, 191, 36, 0.5)); }
    .case-big.spin { animation: spin 2.2s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
    @keyframes spin {
      0%   { transform: rotate(0deg) scale(1); }
      50%  { transform: rotate(360deg) scale(1.15); }
      100% { transform: rotate(720deg) scale(1); }
    }
    .daily-info {
      background: linear-gradient(145deg, rgba(30,41,59,0.9), rgba(15, 23, 42, 0.9));
      padding: 30px;
      border-radius: 24px;
      margin: 24px 0;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.05);
      box-shadow: 0 10px 40px rgba(0,0,0,0.3), inset 0 0 0 1px rgba(255,255,255,0.05);
      position: relative;
      overflow: hidden;
    }
    .daily-info::before {
        content: '';
        position: absolute;
        top: -50%; left: -50%;
        width: 200%; height: 200%;
        background: radial-gradient(circle, rgba(124, 58, 237, 0.15) 0%, transparent 60%);
        pointer-events: none;
        z-index: 0;
    }
    .daily-info > * { position: relative; z-index: 1; }
    
    .promo-code {
      background: rgba(17, 24, 39, 0.8);
      padding: 16px;
      border-radius: 12px;
      font-family: 'Courier New', monospace;
      font-size: 1.6rem;
      font-weight: bold;
      letter-spacing: 4px;
      margin: 16px 0;
      border: 1px solid var(--primary);
      color: var(--primary);
      box-shadow: 0 0 15px rgba(124, 58, 237, 0.2);
    }
    
    .rewards-list {
        margin-top: 30px; 
        padding: 20px; 
        background: rgba(30,27,71,0.4); 
        border-radius: 16px; 
        border: 1px solid var(--border);
    }
    .rewards-list h4 { margin-bottom: 12px; color: var(--text-sec); }
    .rewards-list ul { text-align: left; display: inline-block; }
    .rewards-list li { margin-bottom: 6px; color: var(--text-main); }
    .rewards-list li span { color: var(--accent); font-weight: bold; }
  </style>
</head>
<body>
<div class="particles" id="particles"></div>

<div class="header">
  <div class="logo" onclick="location.href='index.html'" style="cursor: pointer;">üíé DROP<span>WIN</span></div>
  <div class="balance-container">
    <div class="balance">üí∞ <span id="balance">0</span>‚ÇΩ</div>
  </div>
</div>

<div class="content">
  <button class="back-btn" onclick="location.href='index.html'">‚Üê –ù–∞–∑–∞–¥</button>

  <div class="game-card" style="border: none; background: transparent; box-shadow: none; padding: 0;">
    <div class="game-title" style="font-size: 2rem; margin-bottom: 10px;">üéÅ FreeBet & –ë–æ–Ω—É—Å—ã</div>
    <div style="text-align: center; color: var(--text-sec); margin-bottom: 20px;">–û—Ç–∫—Ä—ã–≤–∞–π –∫–µ–π—Å –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ!</div>

    <div class="daily-info">
      <h3 style="font-size: 1.5rem; margin-bottom: 10px;">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –∫–µ–π—Å</h3>
      <div class="case-big" id="dailyCaseEmoji">üì¶</div>
      <button class="btn" id="openDailyBtn" style="margin:16px auto; max-width:320px; font-size: 1.1rem; padding: 16px 32px;">–û—Ç–∫—Ä—ã—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ</button>
      <div id="dailyResult" style="margin-top:20px; font-size:1.3rem; min-height:70px;"></div>
    </div>

    <div class="rewards-list">
      <h4>–í–æ–∑–º–æ–∂–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã:</h4>
      <ul>
        <li><span>+20% - 30%</span> –Ω–∞ –¥–µ–ø–æ–∑–∏—Ç (–ü–æ–≤—ã—à–µ–Ω–Ω—ã–π —à–∞–Ω—Å!)</li>
        <li><span>+1‚ÇΩ - +15‚ÇΩ</span> –Ω–∞ –±–∞–ª–∞–Ω—Å</li>
        <li>–°–µ–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã</li>
      </ul>
    </div>
  </div>
</div>

<div class="nav">
  <button class="nav-btn" onclick="location.href='index.html'"><span>üè†</span><span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span></button>
  <button class="nav-btn" onclick="location.href='profile.html'"><span>üë§</span><span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span></button>
  <button class="nav-btn active"><span>üéÅ</span><span class="nav-label">–ë–æ–Ω—É—Å—ã</span></button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBVra2JN-C7-1b_Qa4cU8--XvJ83lymiM8",
    authDomain: "dropwin-8d94b.firebaseapp.com",
    projectId: "dropwin-8d94b",
    storageBucket: "dropwin-8d94b.firebasestorage.app",
    messagingSenderId: "988974289403",
    appId: "1:988974289403:web:886d34e6f65920a105fb5e"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let userId = null;

  function createParticles() {
    const container = document.getElementById('particles');
    for (let i = 0; i < 40; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      p.style.width = p.style.height = Math.random() * 3 + 1 + 'px';
      p.style.left = Math.random() * 100 + '%';
      p.style.animationDuration = Math.random() * 15 + 10 + 's';
      p.style.animationDelay = Math.random() * 5 + 's';
      container.appendChild(p);
    }
  }

  function loadUser() {
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        userId = user.uid;
        const snap = await getDoc(doc(db, 'users', user.uid));
        if (snap.exists()) {
          currentUser = snap.data();
          document.getElementById('balance').textContent = currentUser.balance || 0;

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—É–ª–¥–∞—É–Ω
          const now = Date.now();
          const lastOpen = currentUser.lastDailyCaseTime || 0;
          const cooldown = 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞

          if (now - lastOpen < cooldown) {
            const remaining = Math.ceil((cooldown - (now - lastOpen)) / 1000);
            document.getElementById('dailyResult').innerHTML = `<div style="color:#ef4444;">‚è±Ô∏è –ü–æ–¥–æ–∂–¥–∏—Ç–µ –µ—â–µ ${remaining} —Å–µ–∫—É–Ω–¥</div>`;
            document.getElementById('openDailyBtn').disabled = true;
            document.getElementById('openDailyBtn').style.opacity = '0.5';

            setTimeout(() => {
              document.getElementById('openDailyBtn').disabled = false;
              document.getElementById('openDailyBtn').style.opacity = '1';
              document.getElementById('dailyResult').innerHTML = '';
            }, remaining * 1000);
          }
        }
      }
    });
  }

  window.openDailyCase = async function() {
    if (!currentUser) return alert('–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç');

    // –°–†–ê–ó–£ –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
    const btn = document.getElementById('openDailyBtn');
    btn.disabled = true;
    btn.style.opacity = '0.5';

    const now = Date.now();
    const lastOpen = currentUser.lastDailyCaseTime || 0;
    const cooldown = 10 * 1000; // 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è —Ç–µ—Å—Ç–∞ (–≤ –ø—Ä–æ–¥–µ 24—á)

    // Using 24h logic for real check, but user might want testing.
    // Keeping logic consistent with loadUser:
    const realCooldown = 24 * 60 * 60 * 1000; 
    // IF user requested "repeating infinite" was about tape, not freebet.
    // But let's stick to 24h unless user asks.
    
    if (now - lastOpen < realCooldown) {
       // Allow for dev testing if needed, but standard logic applies.
       // The previous code had 10s test cooldown inside openDailyCase but 24h in loadUser.
       // I'll make them consistent to 24h.
       const remaining = Math.ceil((realCooldown - (now - lastOpen)) / 1000);
       document.getElementById('dailyResult').innerHTML = `<div style="color:#ef4444;">‚è±Ô∏è –ü–æ–¥–æ–∂–¥–∏—Ç–µ –µ—â–µ ${remaining} —Å–µ–∫—É–Ω–¥</div>`;
       return;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –°–†–ê–ó–£
    await updateDoc(doc(db, 'users', userId), {
      lastDailyCaseTime: now
    });
    currentUser.lastDailyCaseTime = now;

    // –ê–Ω–∏–º–∞—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–µ–π—Å–∞
    const emoji = document.getElementById('dailyCaseEmoji');
    emoji.classList.add('spin');
    await new Promise(r => setTimeout(r, 2200));
    emoji.classList.remove('spin');

    const randomPart = Math.random().toString(36).substring(2, 9).toUpperCase();
    const promoCode = `DROPWIN-${randomPart}`;

    const rewards = [
      // Increased chances for promo codes as requested
      {type: 'dep30', value: 30, text: '+30% –Ω–∞ –¥–µ–ø–æ–∑–∏—Ç', weight: 5000},        
      {type: 'dep25', value: 25, text: '+25% –Ω–∞ –¥–µ–ø–æ–∑–∏—Ç', weight: 15000},        
      {type: 'dep20', value: 20, text: '+20% –Ω–∞ –¥–µ–ø–æ–∑–∏—Ç', weight: 100000},     

      // Money rewards
      {type: 'bonus15', value: 15, text: '+15‚ÇΩ', weight: 20000},
      {type: 'bonus10', value: 10, text: '+10‚ÇΩ', weight: 40000},
      {type: 'bonus7',  value:  7, text: '+7‚ÇΩ',  weight: 60000},
      {type: 'bonus5',  value:  5, text: '+5‚ÇΩ',  weight: 80000},
      {type: 'bonus3',  value:  3, text: '+3‚ÇΩ',  weight: 60000},
      {type: 'bonus1',  value:  1, text: '+1‚ÇΩ',  weight: 20000}
    ];

    let totalWeight = rewards.reduce((sum, r) => sum + r.weight, 0);
    let rand = Math.random() * totalWeight;
    let sum = 0;
    let prize;

    for (let item of rewards) {
      sum += item.weight;
      if (rand <= sum) {
        prize = item;
        break;
      }
    }
    if (!prize) prize = rewards[rewards.length-1];

    await updateDoc(doc(db, 'users', userId), {
      activePromoCode: promoCode,
      activePromoType: prize.type,
      activePromoValue: prize.value
    });

    let resultHTML = `
      <div style="color:#34d399; font-size:1.6rem; font-weight:700;">üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</div>
      –í–∞—à –ø—Ä–æ–º–æ–∫–æ–¥:<br>
      <div class="promo-code">${promoCode}</div>
      –ù–∞–≥—Ä–∞–¥–∞: <b>${prize.text}</b><br>
    `;

    if (prize.type.startsWith('dep')) {
      resultHTML += `<small style="color:#9ca3af;">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ <a href="dep.html" style="color:#34d399;">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è</a></small>`;
    } else {
      resultHTML += `<small style="color:#9ca3af;">–ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –≤ <a href="profile.html" style="color:#34d399;">–ü—Ä–æ—Ñ–∏–ª–µ</a></small>`;
    }

    document.getElementById('dailyResult').innerHTML = resultHTML;

    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥ (visual reset)
    setTimeout(() => {
      btn.disabled = false;
      btn.style.opacity = '1';
    }, 10000);
  };

  document.addEventListener('DOMContentLoaded', () => {
    createParticles();
    loadUser();
    document.getElementById('openDailyBtn').addEventListener('click', openDailyCase);
  });
</script>
</body>
</html>