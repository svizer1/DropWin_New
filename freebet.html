<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>FreeBet –ë–æ–Ω—É—Å—ã | DropWin</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .case-big {
      font-size: 9rem;
      text-align: center;
      margin: 30px 0;
      cursor: pointer;
      transition: transform 0.4s;
    }
    .case-big:hover { transform: scale(1.12); }
    .case-big.spin { animation: spin 2.2s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
    @keyframes spin {
      0%   { transform: rotate(0deg) scale(1); }
      50%  { transform: rotate(360deg) scale(1.15); }
      100% { transform: rotate(720deg) scale(1); }
    }
    .daily-info {
      background: rgba(30,41,59,0.7);
      padding: 20px;
      border-radius: 16px;
      margin: 24px 0;
      text-align: center;
    }
    .promo-code {
      background: #111827;
      padding: 12px;
      border-radius: 10px;
      font-family: monospace;
      font-size: 1.4rem;
      letter-spacing: 3px;
      margin: 12px 0;
    }
  </style>
</head>
<body>
<div class="particles" id="particles"></div>

<div class="header">
  <div class="logo">üíé DROPWIN</div>
  <div class="balance-container">
    <div class="balance">üí∞ <span id="balance">0</span>‚ÇΩ</div>
  </div>
</div>

<div class="content">
  <button class="back-btn" onclick="location.href='index.html'">‚Üê –ù–∞–∑–∞–¥</button>

  <div class="game-card">
    <div class="game-title">üéÅ FreeBet & –ë–æ–Ω—É—Å—ã</div>

    <div class="daily-info">
      <h3>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –∫–µ–π—Å</h3>
      <div class="case-big" id="dailyCaseEmoji">üì¶</div>
      <button class="btn" id="openDailyBtn" style="margin:16px auto; max-width:320px;">–û—Ç–∫—Ä—ã—Ç—å —Å–µ–≥–æ–¥–Ω—è</button>
      <div id="dailyResult" style="margin-top:20px; font-size:1.3rem; min-height:70px;"></div>
    </div>

    <div style="margin-top:30px; padding:16px; background:rgba(30,27,71,0.6); border-radius:16px;">
      <h4>–í–æ–∑–º–æ–∂–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã:</h4>
      <ul>
        <li>+1‚ÇΩ - +15‚ÇΩ (—á–∞—Å—Ç–æ)</li>
        <li>+20% –Ω–∞ –¥–µ–ø–æ–∑–∏—Ç (—á–∞—Å—Ç–æ)</li>
        <li>+25% –Ω–∞ –¥–µ–ø–æ–∑–∏—Ç (—Ä–µ–¥–∫–æ)</li>
        <li>+30% –Ω–∞ –¥–µ–ø–æ–∑–∏—Ç (–æ—á–µ–Ω—å —Ä–µ–¥–∫–æ)</li>
      </ul>
    </div>
  </div>
</div>

<div class="nav">
  <button class="nav-btn" onclick="location.href='index.html'"><span>üè†</span><span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span></button>
  <button class="nav-btn" onclick="location.href='profile.html'"><span>üë§</span><span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span></button>
  <button class="nav-btn active"><span>üéÅ</span><span class="nav-label">–ë–æ–Ω—É—Å—ã</span></button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBVra2JN-C7-1b_Qa4cU8--XvJ83lymiM8",
    authDomain: "dropwin-8d94b.firebaseapp.com",
    projectId: "dropwin-8d94b",
    storageBucket: "dropwin-8d94b.firebasestorage.app",
    messagingSenderId: "988974289403",
    appId: "1:988974289403:web:886d34e6f65920a105fb5e"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let userId = null;

  function createParticles() {
    const container = document.getElementById('particles');
    for (let i = 0; i < 40; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      p.style.width = p.style.height = Math.random() * 3 + 1 + 'px';
      p.style.left = Math.random() * 100 + '%';
      p.style.animationDuration = Math.random() * 15 + 10 + 's';
      p.style.animationDelay = Math.random() * 5 + 's';
      container.appendChild(p);
    }
  }

  function loadUser() {
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        userId = user.uid;
        const snap = await getDoc(doc(db, 'users', user.uid));
        if (snap.exists()) {
          currentUser = snap.data();
          document.getElementById('balance').textContent = currentUser.balance || 0;

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—É–ª–¥–∞—É–Ω
          const now = Date.now();
          const lastOpen = currentUser.lastDailyCaseTime || 0;
          const cooldown = 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞ (1 –¥–µ–Ω—å)

          if (now - lastOpen < cooldown) {
            const remaining = Math.ceil((cooldown - (now - lastOpen)) / 1000);
            document.getElementById('dailyResult').innerHTML = `<div style="color:#ef4444;">‚è±Ô∏è –ü–æ–¥–æ–∂–¥–∏—Ç–µ –µ—â–µ ${remaining} —Å–µ–∫—É–Ω–¥</div>`;
            document.getElementById('openDailyBtn').disabled = true;
            document.getElementById('openDailyBtn').style.opacity = '0.5';

            setTimeout(() => {
              document.getElementById('openDailyBtn').disabled = false;
              document.getElementById('openDailyBtn').style.opacity = '1';
              document.getElementById('dailyResult').innerHTML = '';
            }, remaining * 1000);
          }
        }
      }
    });
  }

  window.openDailyCase = async function() {
    if (!currentUser) return alert('–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç');

    // –°–†–ê–ó–£ –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
    const btn = document.getElementById('openDailyBtn');
    btn.disabled = true;
    btn.style.opacity = '0.5';

    const now = Date.now();
    const lastOpen = currentUser.lastDailyCaseTime || 0;
    const cooldown = 10 * 1000; // 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è —Ç–µ—Å—Ç–∞

    if (now - lastOpen < cooldown) {
      const remaining = Math.ceil((cooldown - (now - lastOpen)) / 1000);
      document.getElementById('dailyResult').innerHTML = `<div style="color:#ef4444;">‚è±Ô∏è –ü–æ–¥–æ–∂–¥–∏—Ç–µ –µ—â–µ ${remaining} —Å–µ–∫—É–Ω–¥</div>`;
      setTimeout(() => {
        btn.disabled = false;
        btn.style.opacity = '1';
      }, remaining * 1000);
      return;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –°–†–ê–ó–£
    await updateDoc(doc(db, 'users', userId), {
      lastDailyCaseTime: now
    });
    currentUser.lastDailyCaseTime = now;

    // –ê–Ω–∏–º–∞—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–µ–π—Å–∞
    const emoji = document.getElementById('dailyCaseEmoji');
    emoji.classList.add('spin');
    await new Promise(r => setTimeout(r, 2200));
    emoji.classList.remove('spin');

    const randomPart = Math.random().toString(36).substring(2, 9).toUpperCase();
    const promoCode = `DROPWIN-${randomPart}`;

    const rewards = [
      // –ü—Ä–æ–º–æ–∫–æ–¥—ã –Ω–∞ –¥–µ–ø–æ–∑–∏—Ç
      {type: 'dep30', value: 30, text: '+30% –Ω–∞ –¥–µ–ø–æ–∑–∏—Ç', weight: 100},        // –æ—á–µ–Ω—å —Ä–µ–¥–∫–æ
      {type: 'dep25', value: 25, text: '+25% –Ω–∞ –¥–µ–ø–æ–∑–∏—Ç', weight: 500},        // —Ä–µ–¥–∫–æ
      {type: 'dep20', value: 20, text: '+20% –Ω–∞ –¥–µ–ø–æ–∑–∏—Ç', weight: 300000},     // —á–∞—Å—Ç–æ

      // –ú–∞–ª–µ–Ω—å–∫–∏–µ –±–æ–Ω—É—Å—ã (–æ—Ç 1‚ÇΩ –¥–æ 15‚ÇΩ) - —á–∞—â–µ –≤—Å–µ–≥–æ
      {type: 'bonus15', value: 15, text: '+15‚ÇΩ', weight: 50000},
      {type: 'bonus10', value: 10, text: '+10‚ÇΩ', weight: 100000},
      {type: 'bonus7',  value:  7, text: '+7‚ÇΩ',  weight: 150000},
      {type: 'bonus5',  value:  5, text: '+5‚ÇΩ',  weight: 200000},
      {type: 'bonus3',  value:  3, text: '+3‚ÇΩ',  weight: 150000},
      {type: 'bonus1',  value:  1, text: '+1‚ÇΩ',  weight: 50000}
    ];

    let totalWeight = rewards.reduce((sum, r) => sum + r.weight, 0);
    let rand = Math.random() * totalWeight;
    let sum = 0;
    let prize;

    for (let item of rewards) {
      sum += item.weight;
      if (rand <= sum) {
        prize = item;
        break;
      }
    }
    if (!prize) prize = rewards[rewards.length-1];

    await updateDoc(doc(db, 'users', userId), {
      activePromoCode: promoCode,
      activePromoType: prize.type,
      activePromoValue: prize.value
    });

    let resultHTML = `
      <div style="color:#34d399; font-size:1.6rem; font-weight:700;">üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</div>
      –í–∞—à –ø—Ä–æ–º–æ–∫–æ–¥:<br>
      <div class="promo-code">${promoCode}</div>
      –ù–∞–≥—Ä–∞–¥–∞: <b>${prize.text}</b><br>
    `;

    if (prize.type.startsWith('dep')) {
      resultHTML += `<small style="color:#9ca3af;">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ <a href="dep.html" style="color:#34d399;">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è</a></small>`;
    } else {
      resultHTML += `<small style="color:#9ca3af;">–ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –≤ <a href="profile.html" style="color:#34d399;">–ü—Ä–æ—Ñ–∏–ª–µ</a></small>`;
    }

    document.getElementById('dailyResult').innerHTML = resultHTML;

    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
      btn.disabled = false;
      btn.style.opacity = '1';
    }, 10000);
  };

  document.addEventListener('DOMContentLoaded', () => {
    createParticles();
    loadUser();
    document.getElementById('openDailyBtn').addEventListener('click', openDailyCase);
  });
</script>
</body>
</html>