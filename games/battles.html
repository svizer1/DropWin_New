<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>–ë–∞—Ç—Ç–ª—ã –ö–µ–π—Å–æ–≤ | DropWin</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        .mode-select {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin: 16px 0;
        }
        .mode-btn {
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            background: linear-gradient(135deg, #6d28d9, #4c1d95);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(167, 139, 250, 0.4);
            transition: all 0.3s ease;
        }
        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(167, 139, 250, 0.6);
        }
        .mode-btn.active {
            background: linear-gradient(135deg, #a855f7, #8b5cf6);
            box-shadow: 0 6px 16px rgba(192, 132, 252, 0.6);
        }
        .battle-form {
            margin: 20px 0;
        }
        .battle-list {
            margin: 20px 0;
        }
        .battle-item {
            background: linear-gradient(135deg, rgba(59, 7, 100, 0.8), rgba(106, 27, 154, 0.8));
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(192, 132, 252, 0.3);
            transition: transform 0.2s;
        }
        .battle-item:hover {
            transform: scale(1.03);
        }
        .open-results {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
        }
        .player-opens, .opponent-opens {
            width: 48%;
            min-width: 200px;
        }
        .total-value {
            font-weight: 700;
            margin-top: 12px;
            color: #c084fc;
            text-align: center;
        }
        .case-select-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }
        .case-card {
            background: transparent;
            padding: 8px;
            border-radius: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s ease;
            box-shadow: 0 4px 18px rgba(0,0,0,0.5);
            overflow: hidden;
            aspect-ratio: 1 / 1;
            position: relative;
        }
        .case-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }
        .case-card.selected {
            border: 3px solid #d946ef;
            transform: scale(1.06);
            box-shadow: 0 0 25px #d946ef88;
        }
        .case-card .name {
            position: absolute;
            bottom: 36px;
            left: 0;
            right: 0;
            font-weight: 700;
            color: white;
            text-shadow: 0 0 6px black;
            font-size: 1.1rem;
        }
        .case-card .price {
            position: absolute;
            bottom: 8px;
            left: 0;
            right: 0;
            color: #fde047;
            text-shadow: 0 0 6px black;
            font-size: 1.05rem;
        }
        .case-box {
            width: 140px;
            height: 140px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
            cursor: pointer;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 5px 18px rgba(0,0,0,0.6);
            transition: transform 0.35s ease;
        }
        .case-box:hover {
            transform: scale(1.09);
        }
        .case-box.opening {
            animation: shakeAndOpen 3.2s ease-in-out forwards;
        }
        @keyframes shakeAndOpen {
            0% { transform: scale(1) rotate(0deg); }
            10% { transform: scale(1.05) rotate(2deg); }
            20% { transform: scale(1.05) rotate(-2deg); }
            30% { transform: scale(1.05) rotate(2deg); }
            40% { transform: scale(1.05) rotate(-2deg); }
            50% { transform: scale(1.1) rotate(0deg); opacity: 0.7; }
            70% { transform: scale(0.9) rotate(180deg); opacity: 0.4; }
            100% { transform: scale(1) rotate(360deg); opacity: 1; }
        }
        .case-box .item-reveal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            display: none;
            z-index: 2;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
        }
        .case-box.revealed .item-reveal {
            display: block;
            animation: popIn 0.8s ease-out;
        }
        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-180deg); opacity: 0; }
            60% { transform: translate(-50%, -50%) scale(1.3) rotate(20deg); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); }
        }
        .case-box .value-label {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.1rem;
            display: none;
        }
        .case-box.revealed .value-label {
            display: block;
        }
        .remove-btn {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-left: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        .remove-btn:hover {
            transform: scale(1.05);
        }
        .delete-battle-btn {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            margin-top: 8px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.4);
            transition: all 0.2s;
        }
        .delete-battle-btn:hover {
            transform: scale(1.05);
            background: #dc2626;
        }
        .claim-btn {
            background: linear-gradient(135deg, #34d399, #059669);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            margin-top: 16px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            transition: all 0.3s ease;
        }
        .claim-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.6);
        }
        .claim-btn.disabled {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            cursor: not-allowed;
            box-shadow: none;
        }
        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            background: linear-gradient(135deg, #a855f7, #7e22ce);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(167, 139, 250, 0.4);
            transition: all 0.3s ease;
            margin: 8px 0;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(167, 139, 250, 0.6);
        }
        .add-case-btn {
            display: block;
            margin: 16px auto;
        }
        .join-btn {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            box-shadow: 0 3px 6px rgba(59, 130, 246, 0.4);
            transition: all 0.2s;
        }
        .join-btn:hover {
            transform: scale(1.05);
            background: #2563eb;
        }
        .nickname {
            font-weight: bold;
            color: #a855f7;
        }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>
    <div class="header">
        <div class="logo">üíé DROPWIN</div>
        <div class="balance-container">
            <div class="balance">üí∞ <span id="balance">0</span>‚ÇΩ</div>
            <button class="auth-btn" id="authBtn">–ê–∫–∫–∞—É–Ω—Ç</button>
        </div>
    </div>
    <div class="content">
        <button class="back-btn" onclick="location.href='../index.html'">‚Üê –ù–∞–∑–∞–¥</button>
        <div class="game-card">
            <div class="game-title">‚öîÔ∏è –ë–∞—Ç—Ç–ª—ã –ö–µ–π—Å–æ–≤</div>
            <div class="mode-select">
                <button class="mode-btn active" id="vsBotBtn">Vs –ë–æ—Ç</button>
                <button class="mode-btn" id="vsPlayerBtn">Vs –ò–≥—Ä–æ–∫</button>
            </div>
            <!-- Vs Bot Section -->
            <div id="vsBotSection">
                <div class="case-select-grid" id="botCaseGrid"></div>
                <button class="btn add-case-btn" id="addBotCase">–î–æ–±–∞–≤–∏—Ç—å –∫–µ–π—Å</button>
                <div class="selected-cases" id="selectedBotCases"></div>
                <div id="botTotalCost" style="text-align:center; margin:8px 0;">–ò—Ç–æ–≥–æ: 0‚ÇΩ</div>
                <button class="btn" id="playVsBot">–ò–≥—Ä–∞—Ç—å</button>
                <button class="btn" id="quickVsBot" style="background: linear-gradient(135deg, #fbbf24, #d97706);">–ë—ã—Å—Ç—Ä–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ</button>
                <div id="botResults" style="margin-top:20px;"></div>
            </div>
            <!-- Vs Player Section -->
            <div id="vsPlayerSection" style="display:none;">
                <button class="btn" id="createBattleBtn">–°–æ–∑–¥–∞—Ç—å –±–∞—Ç—Ç–ª</button>
                <div class="battle-form" id="createForm" style="display:none;">
                    <div class="case-select-grid" id="playerCaseGrid"></div>
                    <button class="btn add-case-btn" id="addPlayerCase">–î–æ–±–∞–≤–∏—Ç—å –∫–µ–π—Å</button>
                    <div class="selected-cases" id="selectedPlayerCases"></div>
                    <div id="playerTotalCost" style="text-align:center; margin:8px 0;">–ò—Ç–æ–≥–æ: 0‚ÇΩ</div>
                    <button class="btn" id="confirmCreate">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
                <div class="battle-list" id="battleList"></div>
            </div>
            <div id="status" style="margin-top:16px; text-align:center; min-height:24px;"></div>
        </div>
    </div>
    <div class="nav">
        <button class="nav-btn" onclick="location.href='../index.html'"><span>üè†</span><span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span></button>
        <button class="nav-btn" onclick="location.href='../profile.html'"><span>üë§</span><span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span></button>
        <button class="nav-btn" onclick="location.href='../register.html'"><span>üîë</span><span class="nav-label">–í—Ö–æ–¥</span></button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, addDoc, onSnapshot, getDocs, query, where, deleteDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBVra2JN-C7-1b_Qa4cU8--XvJ83lymiM8",
            authDomain: "dropwin-8d94b.firebaseapp.com",
            projectId: "dropwin-8d94b",
            storageBucket: "dropwin-8d94b.firebasestorage.app",
            messagingSenderId: "988974289403",
            appId: "1:988974289403:web:886d34e6f65920a105fb5e",
            measurementId: "G-BK010MHN8N"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        function createParticles() {
            const container = document.getElementById('particles');
            if (!container) return;
            for (let i = 0; i < 40; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.width = p.style.height = Math.random() * 3 + 1 + 'px';
                p.style.left = Math.random() * 100 + '%';
                p.style.animationDuration = Math.random() * 15 + 10 + 's';
                p.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(p);
            }
        }

        let currentUser = null;
        let userId = null;
        let isGuest = false;

        const cases = {
            'vibe': {
                price: 50,
                items: [
                    {emoji: 'üíñ', name: '–°–µ—Ä–¥—Ü–µ', value: 15, prob: 0.65},
                    {emoji: 'üåπ', name: '–†–æ–∑–∞', value: 25, prob: 0.17},
                    {emoji: 'üöÄ', name: '–†–∞–∫–µ—Ç–∞', value: 50, prob: 0.07},
                    {emoji: 'üíê', name: '–¶–≤–µ—Ç—ã', value: 50, prob: 0.07},
                    {emoji: 'üíç', name: '–ö–æ–ª—å—Ü–æ', value: 100, prob: 0.015},
                    {emoji: 'üíé', name: '–ê–ª–º–∞–∑', value: 100, prob: 0.015},
                    {emoji: 'üç≠', name: '–õ–æ–ª-–ø–æ–ø', value: 325, prob: 0.0075},
                    {emoji: 'üê∂', name: '–°—É–ø –î–æ–≥', value: 425, prob: 0.005},
                    {emoji: 'ü§°', name: '–®–∞–ø–∫–∞ —à—É—Ç–∞', value: 500, prob: 0.0025},
                    {emoji: '‚≠ê', name: '–ó–≤–µ–∑–¥–∞', value: 200, prob: 0.0025},
                ],
                color: '#ec4899',
                icon: 'üíñ'
            },
            'schoolboy': {
                price: 350,
                items: [
                    {emoji: 'üìö', name: '–£—á–µ–±–Ω–∏–∫', value: 100, prob: 0.45},
                    {emoji: 'üéí', name: '–†—é–∫–∑–∞–∫', value: 200, prob: 0.2},
                    {emoji: 'üì±', name: '–°–º–∞—Ä—Ç—Ñ–æ–Ω', value: 500, prob: 0.15},
                    {emoji: 'üíª', name: '–ù–æ—É—Ç–±—É–∫', value: 800, prob: 0.1},
                    {emoji: 'üéÆ', name: 'PlayStation', value: 1200, prob: 0.04},
                    {emoji: 'üöó', name: '–ú–∞—à–∏–Ω–∫–∞', value: 1500, prob: 0.025},
                    {emoji: 'üè†', name: '–ö–≤–∞—Ä—Ç–∏—Ä–∞', value: 5000, prob: 0.01},
                ],
                color: '#3b82f6',
                icon: 'üìö'
            },
            'event': {
                price: 500,
                items: [
                    {emoji: 'üéâ', name: '–ö–æ–Ω—Ñ–µ—Ç—Ç–∏', value: 150, prob: 0.4},
                    {emoji: 'üéÅ', name: '–ü–æ–¥–∞—Ä–æ–∫', value: 300, prob: 0.25},
                    {emoji: 'üéà', name: '–í–æ–∑–¥—É—à–Ω—ã–π —à–∞—Ä', value: 400, prob: 0.15},
                    {emoji: 'üçæ', name: '–®–∞–º–ø–∞–Ω—Å–∫–æ–µ', value: 600, prob: 0.1},
                    {emoji: 'üé§', name: '–ú–∏–∫—Ä–æ—Ñ–æ–Ω', value: 900, prob: 0.04},
                    {emoji: 'üé¨', name: '–ö–∏–Ω–æ', value: 1500, prob: 0.025},
                    {emoji: '‚úàÔ∏è', name: '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ', value: 3000, prob: 0.01},
                ],
                color: '#ef4444',
                icon: 'üéâ'
            },
            'milioner': {
                price: 1000,
                items: [
                    {emoji: 'üíµ', name: '–î–µ–Ω—å–≥–∏', value: 500,   prob: 0.48},     // ‚Üë
                    {emoji: 'üè¶', name: '–ë–∞–Ω–∫', value: 1000,   prob: 0.24},     // ‚Üë
                    {emoji: 'üí∞', name: '–ú–µ—à–æ–∫ –¥–µ–Ω–µ–≥', value: 2000, prob: 0.18},   // ‚Üë
                    {emoji: 'üìà', name: '–ì—Ä–∞—Ñ–∏–∫ —Ä–æ—Å—Ç–∞', value: 3000, prob: 0.08},  // ‚Üì –±—ã–ª–æ 0.1
                    {emoji: 'ü§ë', name: '–ú–∏–ª–ª–∏–æ–Ω–µ—Ä', value: 5000,  prob: 0.015},  // —Å–∏–ª—å–Ω–æ ‚Üì (–±—ã–ª–æ 0.04)
                    {emoji: 'üöÄ', name: '–†–∞–∫–µ—Ç–∞', value: 10000, prob: 0.007},     // —Å–∏–ª—å–Ω–æ ‚Üì (–±—ã–ª–æ 0.025)
                    {emoji: 'üè∞', name: '–î–≤–æ—Ä–µ—Ü', value: 50000, prob: 0.003},     // —Å–∏–ª—å–Ω–æ ‚Üì (–±—ã–ª–æ 0.01)
                ],
                color: '#fbbf24',
                icon: 'üí∞'
            }
        };

        const caseBackgrounds = {
            'vibe': '/images/vibe.png',
            'schoolboy': '/images/schoolboy.png',
            'event': '/images/event.png',
            'milioner': '/images/milioner.png'
        };

        function loadCurrentUser() {
            onAuthStateChanged(auth, async (user) => {
                try {
                    if (user) {
                        userId = user.uid;
                        const snap = await getDoc(doc(db, 'users', user.uid));
                        if (snap.exists()) {
                            currentUser = snap.data();
                            isGuest = false;
                            updateBalance();
                            if (document.getElementById('vsPlayerBtn')?.classList.contains('active')) {
                                loadBattles();
                            }
                        }
                    } else {
                        const username = localStorage.getItem('dropwin_current_username');
                        if (username === '–ì–æ—Å—Ç—å') {
                            const users = JSON.parse(localStorage.getItem('dropwin_users')) || [];
                            currentUser = users.find(u => u.username === '–ì–æ—Å—Ç—å');
                            isGuest = true;
                            updateBalance();
                        } else {
                            location.href = '../register.html';
                        }
                    }
                } catch (err) {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", err);
                    document.getElementById('status').textContent = "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∞–∫–∫–∞—É–Ω—Ç—É.";
                }
            });
        }

        function updateBalance() {
            document.getElementById('balance').textContent = currentUser ? currentUser.balance || 0 : 0;
            document.getElementById('authBtn').textContent = isGuest ? '–ì–æ—Å—Ç—å' : (currentUser ? currentUser.username : '–í–æ–π—Ç–∏');
            document.getElementById('authBtn').onclick = () => location.href = '../profile.html';
        }

        async function saveUser() {
            try {
                if (isGuest) {
                    let users = JSON.parse(localStorage.getItem('dropwin_users')) || [];
                    const idx = users.findIndex(u => u.username === '–ì–æ—Å—Ç—å');
                    if (idx !== -1) users[idx] = currentUser;
                    localStorage.setItem('dropwin_users', JSON.stringify(users));
                } else if (userId) {
                    await updateDoc(doc(db, 'users', userId), { balance: currentUser.balance });
                }
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", err);
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å.");
            }
        }

        function openCase(caseType) {
            const items = cases[caseType].items;
            const rand = Math.random();
            let cumulative = 0;
            for (let item of items) {
                cumulative += item.prob;
                if (rand <= cumulative) return { ...item, caseType };
            }
            return { ...items[0], caseType };
        }

        function openCaseBot(caseType) {
            const items = cases[caseType].items.map(item => {
                // –ë–æ—Ç—É —á—É—Ç—å –±–æ–ª—å—à–µ —à–∞–Ω—Å–æ–≤ –Ω–∞ –¥–æ—Ä–æ–≥–∏–µ –≤–µ—â–∏
                const boost = item.value > cases[caseType].price * 1.8 ? 1.35 : 1.05;
                return { ...item, adjustedProb: item.prob * boost };
            });
            const totalProb = items.reduce((sum, item) => sum + item.adjustedProb, 0);
            const normalizedItems = items.map(item => ({
                ...item,
                prob: item.adjustedProb / totalProb
            }));
            const rand = Math.random();
            let cumulative = 0;
            for (let item of normalizedItems) {
                cumulative += item.prob;
                if (rand <= cumulative) return { emoji: item.emoji, name: item.name, value: item.value, caseType };
            }
            return { emoji: normalizedItems[0].emoji, name: normalizedItems[0].name, value: normalizedItems[0].value, caseType };
        }

        function renderCaseGrid(containerId, onSelect) {
            const grid = document.getElementById(containerId);
            grid.innerHTML = '';
            Object.keys(cases).forEach(key => {
                const caseData = cases[key];
                const card = document.createElement('div');
                card.className = 'case-card';
                card.innerHTML = `
                    <img src="${caseBackgrounds[key]}" alt="${key}">
                    <div class="name">${key.charAt(0).toUpperCase() + key.slice(1)}</div>
                    <div class="price">${caseData.price}‚ÇΩ</div>
                `;
                card.onclick = () => onSelect(key);
                grid.appendChild(card);
            });
        }

        let selectedBotCases = [];
        let selectedPlayerCases = [];

        function addSelectedCase(section, caseType) {
            const selected = section === 'bot' ? selectedBotCases : selectedPlayerCases;
            selected.push(caseType);
            updateSelectedCases(section);
            updateTotalCost(section);
        }

        function updateSelectedCases(section) {
            const container = document.getElementById(section === 'bot' ? 'selectedBotCases' : 'selectedPlayerCases');
            container.innerHTML = '<h4>–í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–µ–π—Å—ã:</h4>';
            const selected = section === 'bot' ? selectedBotCases : selectedPlayerCases;
            selected.forEach((type, idx) => {
                const div = document.createElement('div');
                div.textContent = `${type} (${cases[type].price}‚ÇΩ)`;
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
                removeBtn.onclick = () => {
                    selected.splice(idx, 1);
                    updateSelectedCases(section);
                    updateTotalCost(section);
                };
                div.appendChild(removeBtn);
                container.appendChild(div);
            });
        }

        function updateTotalCost(section) {
            const selected = section === 'bot' ? selectedBotCases : selectedPlayerCases;
            const total = selected.reduce((sum, type) => sum + cases[type].price, 0);
            document.getElementById(section === 'bot' ? 'botTotalCost' : 'playerTotalCost').textContent = `–ò—Ç–æ–≥–æ: ${total}‚ÇΩ`;
        }

        async function playVsBot(quick = false) {
            const totalCost = selectedBotCases.reduce((sum, type) => sum + cases[type].price, 0);
            if (currentUser.balance < totalCost) return alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞');
            if (selectedBotCases.length === 0) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–µ–π—Å—ã');

            currentUser.balance -= totalCost;
            await saveUser();
            updateBalance();

            const playerItems = selectedBotCases.map(type => openCase(type));
            const playerTotal = playerItems.reduce((sum, item) => sum + item.value, 0);
            const botItems = selectedBotCases.map(type => openCaseBot(type));
            const botTotal = botItems.reduce((sum, item) => sum + item.value, 0);

            const resultsDiv = document.getElementById('botResults');
            resultsDiv.innerHTML = `
                <div class="open-results">
                    <div class="player-opens">
                        <h4>–í–∞—à–∏ –∫–µ–π—Å—ã (<span class="nickname">${currentUser.username || '–ì–æ—Å—Ç—å'}</span>):</h4>
                        <div class="case-opening-container" id="playerCases"></div>
                        <div class="total-value" id="playerTotal">–ò—Ç–æ–≥–æ: 0‚ÇΩ</div>
                    </div>
                    <div class="opponent-opens">
                        <h4>–ë–æ—Ç –∫–µ–π—Å—ã:</h4>
                        <div class="case-opening-container" id="botCases"></div>
                        <div class="total-value" id="botTotal">–ò—Ç–æ–≥–æ: 0‚ÇΩ</div>
                    </div>
                </div>
                <div id="resultText" style="text-align:center; margin-top:20px; font-size:1.4rem;"></div>
                <button class="claim-btn disabled" id="claimBotPrize">–ó–∞–±—Ä–∞—Ç—å –ø—Ä–∏–∑</button>
            `;

            animateSimultaneousOpenings('playerCases', selectedBotCases, playerItems, playerTotal, 'player', quick);
            animateSimultaneousOpenings('botCases', selectedBotCases, botItems, botTotal, 'bot', quick);

            if (quick) {
                showBotResult(playerTotal, botTotal, totalCost);
            } else {
                setTimeout(() => {
                    showBotResult(playerTotal, botTotal, totalCost);
                }, 4200);
            }
        }

        function animateSimultaneousOpenings(containerId, caseTypes, items, total, side, quick = false) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = '';
            caseTypes.forEach((type, index) => {
                const item = items[index];
                const box = document.createElement('div');
                box.className = 'case-box';
                box.style.backgroundImage = `url('${caseBackgrounds[type]}')`;
                box.innerHTML = `
                    <div class="item-reveal">${item.emoji}</div>
                    <div class="value-label">${item.value}‚ÇΩ</div>
                `;
                container.appendChild(box);
            });

            const totalEl = document.getElementById(containerId === 'playerCases' ? 'playerTotal' : 'botTotal');

            if (quick) {
                container.querySelectorAll('.case-box').forEach(box => box.classList.add('revealed'));
                if (totalEl) totalEl.textContent = `–ò—Ç–æ–≥–æ: ${total}‚ÇΩ`;
            } else {
                setTimeout(() => {
                    container.querySelectorAll('.case-box').forEach(box => box.classList.add('opening'));
                }, 300);
                setTimeout(() => {
                    container.querySelectorAll('.case-box').forEach(box => box.classList.add('revealed'));
                    if (totalEl) totalEl.textContent = `–ò—Ç–æ–≥–æ: ${total}‚ÇΩ`;
                }, 1100);
            }
        }

        function showBotResult(playerTotal, botTotal, totalCost) {
            let resultText = '';
            let prize = 0;
            const resultsContainer = document.getElementById('botResults');
            const claimBtn = document.getElementById('claimBotPrize');

            if (playerTotal > botTotal) {
                prize = playerTotal + botTotal;
                resultText = `<span style="color:#34d399">–ü–æ–±–µ–¥–∞! +${prize}‚ÇΩ</span>`;
            } else if (playerTotal < botTotal) {
                resultText = `<span style="color:#f87171">–ü—Ä–æ–∏–≥—Ä—ã—à</span>`;
            } else {
                prize = playerTotal;
                resultText = `–ù–∏—á—å—è ‚Äî –≤–æ–∑–≤—Ä–∞—Ç ${prize}‚ÇΩ`;
            }

            document.getElementById('resultText').innerHTML = resultText;

            if (prize > 0) {
                claimBtn.textContent = `–ó–∞–±—Ä–∞—Ç—å ${prize}‚ÇΩ`;
                claimBtn.classList.remove('disabled');
                claimBtn.onclick = () => {
                    claimBtn.disabled = true;
                    claimBtn.classList.add('disabled');
                    currentUser.balance += prize;
                    saveUser();
                    updateBalance();
                    resultsContainer.innerHTML = `
                        <div style="text-align:center; padding:40px; color:#a78bfa; font-size:1.3rem;">
                            –ü—Ä–∏–∑ —É—Å–ø–µ—à–Ω–æ –∑–∞–±—Ä–∞–Ω ‚úì<br><br>
                            <button class="btn" onclick="document.getElementById('botResults').innerHTML = '';">–ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>`;
                };
            } else {
                claimBtn.remove();
                resultsContainer.innerHTML += '<div style="text-align:center; padding:20px; color:#f87171;">–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏ :(</div>';
                setTimeout(() => {
                    document.getElementById('botResults').innerHTML = '';
                }, 5000);
            }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Vs Player (–æ—Å—Ç–∞–≤–∏–ª –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Ç–æ–ª—å–∫–æ –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–±–æ—Ä–∞)
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function createBattle() {
            try {
                if (isGuest) throw new Error('–¢–æ–ª—å–∫–æ –¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö');
                if (selectedPlayerCases.length === 0) throw new Error('–í—ã–±–µ—Ä–∏—Ç–µ –∫–µ–π—Å—ã');
                const totalCost = selectedPlayerCases.reduce((sum, type) => sum + cases[type].price, 0);
                if (currentUser.balance < totalCost) throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞');

                const existingQ = query(collection(db, 'battles'), where('creator', '==', userId), where('status', '==', 'open'));
                const existingSnap = await getDocs(existingQ);
                if (!existingSnap.empty) throw new Error('–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–π –±–∞—Ç—Ç–ª. –£–¥–∞–ª–∏—Ç–µ –µ–≥–æ —Å–Ω–∞—á–∞–ª–∞.');

                currentUser.balance -= totalCost;
                await saveUser();
                updateBalance();

                const battleDoc = await addDoc(collection(db, 'battles'), {
                    creator: userId,
                    creatorName: currentUser.username,
                    caseTypes: selectedPlayerCases,
                    totalCost,
                    player1: userId,
                    player1Name: currentUser.username,
                    player2: null,
                    player2Name: null,
                    status: 'open',
                    player1Items: [],
                    player2Items: [],
                    player1Total: 0,
                    player2Total: 0,
                    player1Claimed: false,
                    player2Claimed: false,
                    createdAt: new Date()
                });

                subscribeToBattle(battleDoc.id);
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–∞—Ç—Ç–ª–∞:", err);
                alert(err.message || "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–∞—Ç—Ç–ª–∞");
            }
        }

        function subscribeToBattle(battleId) {
            onSnapshot(doc(db, 'battles', battleId), async (snap) => {
                try {
                    const data = snap.data();
                    if (!data) return;

                    const statusDiv = document.getElementById('status');
                    statusDiv.innerHTML = '';

                    if (data.status === 'open') {
                        statusDiv.innerHTML = `<div style="color:#fbbf24;">–ë–∞—Ç—Ç–ª —Å–æ–∑–¥–∞–Ω! –û–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞...</div>`;
                    } else if (data.status === 'started') {
                        statusDiv.innerHTML = `<div style="color:#34d399;">–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è! –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–µ–π—Å–æ–≤...</div>`;
                        if (data.player1Items.length === 0 && userId === data.player1) {
                            const p1Items = data.caseTypes.map(type => openCase(type));
                            const p1Total = p1Items.reduce((sum, item) => sum + item.value, 0);
                            const p2Items = data.caseTypes.map(type => openCase(type));
                            const p2Total = p2Items.reduce((sum, item) => sum + item.value, 0);

                            await updateDoc(snap.ref, {
                                player1Items: p1Items.map(item => ({emoji: item.emoji, name: item.name, value: item.value})),
                                player2Items: p2Items.map(item => ({emoji: item.emoji, name: item.name, value: item.value})),
                                player1Total: p1Total,
                                player2Total: p2Total,
                                status: 'finished'
                            });
                        }
                    } else if (data.status === 'finished') {
                        const p1Total = data.player1Total;
                        const p2Total = data.player2Total;
                        let winner = null;
                        if (p1Total > p2Total) winner = data.player1;
                        else if (p2Total > p1Total) winner = data.player2;

                        const isPlayer1 = userId === data.player1;
                        const myItems = isPlayer1 ? data.player1Items : data.player2Items;
                        const oppItems = isPlayer1 ? data.player2Items : data.player1Items;
                        const myTotal = isPlayer1 ? p1Total : p2Total;
                        const oppTotal = isPlayer1 ? p2Total : p1Total;
                        const opponentName = isPlayer1 ? data.player2Name : data.player1Name;
                        const myClaimed = isPlayer1 ? data.player1Claimed : data.player2Claimed;

                        let resultText = '';
                        let prize = 0;
                        if (winner === userId) {
                            prize = myTotal + oppTotal;
                            resultText = `<span style="color:#34d399">–ü–æ–±–µ–¥–∞! –ü—Ä–∏–∑: ${prize}‚ÇΩ</span>`;
                        } else if (winner) {
                            resultText = `<span style="color:#f87171">–ü—Ä–æ–∏–≥—Ä—ã—à</span>`;
                        } else {
                            prize = myTotal;
                            resultText = `–ù–∏—á—å—è ‚Äî –∑–∞–±–∏—Ä–∞–µ—à—å —Å–≤–æ–∏ ${prize}‚ÇΩ`;
                        }

                        statusDiv.innerHTML = `
                            <div class="open-results">
                                <div class="player-opens">
                                    <h4>–í–∞—à–∏ (<span class="nickname">${currentUser.username}</span>):</h4>
                                    <div class="case-opening-container" id="myBattleCases"></div>
                                    <div class="total-value">–ò—Ç–æ–≥–æ: ${myTotal}‚ÇΩ</div>
                                </div>
                                <div class="opponent-opens">
                                    <h4>${opponentName || '–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫'}:</h4>
                                    <div class="case-opening-container" id="oppBattleCases"></div>
                                    <div class="total-value">–ò—Ç–æ–≥–æ: ${oppTotal}‚ÇΩ</div>
                                </div>
                            </div>
                            <div id="battleResultText" style="text-align:center; margin-top:12px;">${resultText}</div>
                            <button class="claim-btn ${myClaimed ? 'disabled' : ''}" id="claimPrizeBtn">
                                ${prize > 0 ? `–ó–∞–±—Ä–∞—Ç—å ${prize}‚ÇΩ` : '–ù–µ—Ç –ø—Ä–∏–∑–∞'}
                            </button>
                        `;

                        animateSimultaneousOpenings('myBattleCases', data.caseTypes, myItems, myTotal, 'my');
                        animateSimultaneousOpenings('oppBattleCases', data.caseTypes, oppItems, oppTotal, 'opp');

                        const claimBtn = document.getElementById('claimPrizeBtn');
                        if (myClaimed || prize === 0) {
                            claimBtn.disabled = true;
                            if (prize === 0) claimBtn.remove();
                        } else {
                            claimBtn.onclick = async () => {
                                claimBtn.disabled = true;
                                claimBtn.classList.add('disabled');
                                claimBtn.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';

                                const freshSnap = await getDoc(snap.ref);
                                const freshData = freshSnap.data();
                                if (!freshData) return;

                                const alreadyClaimed = isPlayer1 ? freshData.player1Claimed : freshData.player2Claimed;
                                if (alreadyClaimed) {
                                    statusDiv.innerHTML += '<div style="color:#f87171; text-align:center; padding:20px;">–ü—Ä–∏–∑ —É–∂–µ –±—ã–ª –∑–∞–±—Ä–∞–Ω!</div>';
                                    return;
                                }

                                currentUser.balance += prize;
                                await saveUser();
                                updateBalance();

                      await saveUser();                    // ‚Üê –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ users/{uid}
            await updateDoc(battleRef, {         // ‚Üê –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ battles/{battleId}
        [isPlayer1 ? 'player1Claimed' : 'player2Claimed']: true
                                });

                                statusDiv.innerHTML = `
                                    <div style="text-align:center; padding:40px; color:#a78bfa; font-size:1.3rem;">
                                        –ü—Ä–∏–∑ —É—Å–ø–µ—à–Ω–æ –∑–∞–±—Ä–∞–Ω ‚úì<br><br>
                                        <button class="btn" onclick="location.reload()">–í–µ—Ä–Ω—É—Ç—å—Å—è</button>
                                    </div>`;
                            };
                        }
                    }
                } catch (err) {
                    console.error("–û—à–∏–±–∫–∞ –≤ onSnapshot –±–∞—Ç—Ç–ª–∞:", err);
                    document.getElementById('status').textContent = "–û—à–∏–±–∫–∞ –æ–Ω–ª–∞–π–Ω-–±–∞—Ç—Ç–ª–∞.";
                }
            });
        }

        async function loadBattles() {
            try {
                const q = query(collection(db, 'battles'), where('status', '==', 'open'));
                onSnapshot(q, (querySnap) => {
                    const listDiv = document.getElementById('battleList');
                    listDiv.innerHTML = '';
                    if (querySnap.empty) {
                        listDiv.innerHTML = '<div>–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –±–∞—Ç—Ç–ª–æ–≤</div>';
                        return;
                    }
                    querySnap.forEach(snap => {
                        const data = snap.data();
                        const div = document.createElement('div');
                        div.className = 'battle-item';
                        div.innerHTML = `
                            <div>–°–æ–∑–¥–∞—Ç–µ–ª—å: <span class="nickname">${data.creatorName || '???'}</span></div>
                            <div>–ö–µ–π—Å—ã: ${data.caseTypes.map(t => `${t} (${cases[t]?.price || '?'}‚ÇΩ)`).join(', ')}</div>
                            <div>–°—Ç–æ–∏–º–æ—Å—Ç—å: ${data.totalCost}‚ÇΩ</div>
                            <button class="join-btn" data-battle-id="${snap.id}">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
                        `;
                        if (data.creator === userId) {
                            const delBtn = document.createElement('button');
                            delBtn.className = 'delete-battle-btn';
                            delBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
                            delBtn.onclick = () => deleteBattle(snap.id);
                            div.appendChild(delBtn);
                        }
                        listDiv.appendChild(div);
                    });
                    document.querySelectorAll('.join-btn').forEach(btn => {
                        btn.addEventListener('click', () => joinBattle(btn.dataset.battleId));
                    });
                });
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –±–∞—Ç—Ç–ª–æ–≤:", err);
                document.getElementById('battleList').innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞—Ç—Ç–ª–æ–≤.";
            }
        }

        async function joinBattle(battleId) {
            try {
                const battleRef = doc(db, 'battles', battleId);
                const battleSnap = await getDoc(battleRef);
                const data = battleSnap.data();
                if (!data || data.status !== 'open') throw new Error('–ë–∞—Ç—Ç–ª —É–∂–µ –∑–∞–∫—Ä—ã—Ç');
                if (data.creator === userId) throw new Error('–ù–µ–ª—å–∑—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —Å–≤–æ–µ–º—É –±–∞—Ç—Ç–ª—É');
                const totalCost = data.totalCost;
                if (currentUser.balance < totalCost) throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');

                currentUser.balance -= totalCost;
                await saveUser();
                updateBalance();

                await updateDoc(battleRef, {
                    player2: userId,
                    player2Name: currentUser.username,
                    status: 'started'
                });

                subscribeToBattle(battleId);
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:", err);
                alert(err.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è");
            }
        }

        async function deleteBattle(battleId) {
            try {
                const battleRef = doc(db, 'battles', battleId);
                const battleSnap = await getDoc(battleRef);
                const data = battleSnap.data();
                if (!data || data.creator !== userId || data.status !== 'open') {
                    throw new Error('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –±–∞—Ç—Ç–ª');
                }
                currentUser.balance += data.totalCost;
                await saveUser();
                updateBalance();
                await deleteDoc(battleRef);
                alert('–ë–∞—Ç—Ç–ª —É–¥–∞–ª—ë–Ω, —Å—Ä–µ–¥—Å—Ç–≤–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã');
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:", err);
                alert(err.message || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –±–∞—Ç—Ç–ª–∞");
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            createParticles();
            loadCurrentUser();

            const vsBotBtn = document.getElementById('vsBotBtn');
            const vsPlayerBtn = document.getElementById('vsPlayerBtn');

            vsBotBtn.addEventListener('click', () => {
                vsBotBtn.classList.add('active');
                vsPlayerBtn.classList.remove('active');
                document.getElementById('vsBotSection').style.display = 'block';
                document.getElementById('vsPlayerSection').style.display = 'none';
            });

            vsPlayerBtn.addEventListener('click', () => {
                if (isGuest) {
                    alert('–¢–æ–ª—å–∫–æ –¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
                    return;
                }
                vsPlayerBtn.classList.add('active');
                vsBotBtn.classList.remove('active');
                document.getElementById('vsBotSection').style.display = 'none';
                document.getElementById('vsPlayerSection').style.display = 'block';
                loadBattles();
            });

            renderCaseGrid('botCaseGrid', (type) => addSelectedCase('bot', type));
            renderCaseGrid('playerCaseGrid', (type) => addSelectedCase('player', type));

            document.getElementById('playVsBot').addEventListener('click', () => playVsBot(false));
            document.getElementById('quickVsBot').addEventListener('click', () => playVsBot(true));

            document.getElementById('createBattleBtn').addEventListener('click', () => {
                document.getElementById('createForm').style.display = 'block';
            });

            document.getElementById('confirmCreate').addEventListener('click', createBattle);
        });
    </script>
</body>
</html>