<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>–ë–∞—Ç—Ç–ª—ã –ö–µ–π—Å–æ–≤ | DropWin</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        .mode-select {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin: 16px 0;
        }
        .mode-btn {
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            background: linear-gradient(135deg, #6d28d9, #4c1d95);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(167, 139, 250, 0.4);
            transition: all 0.3s ease;
        }
        .mode-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(167, 139, 250, 0.6); }
        .mode-btn.active {
            background: linear-gradient(135deg, #a855f7, #8b5cf6);
            box-shadow: 0 6px 16px rgba(192, 132, 252, 0.6);
        }

        .case-select-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }
        .case-card {
            background: #1e1b2e;
            border-radius: 16px;
            cursor: pointer;
            overflow: hidden;
            box-shadow: 0 4px 18px rgba(0,0,0,0.4);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255,255,255,0.05);
            /* aspect-ratio removed to allow content to dictate height */
        }
        .case-image-wrap {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            background: radial-gradient(circle at center, #2d2a4a 0%, #1e1b2e 70%);
            overflow: hidden;
            min-height: 180px; /* Ensure a decent height for the image part */
        }
        .case-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.05));
            position: absolute;
            top: 0; left: 0;
        }
        .case-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 28px rgba(139, 92, 246, 0.25);
            border-color: #8b5cf6;
        }
        .case-card:hover img {
            transform: scale(1.1) rotate(2deg);
        }
        .case-card.selected {
            border: 3px solid #d946ef;
            transform: scale(1.03);
            box-shadow: 0 0 25px #d946ef88;
        }
        .case-info {
            padding: 12px;
            background: #2a2640; /* Lighter background than #151322 */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            border-top: 1px solid rgba(255,255,255,0.05);
            z-index: 2;
            position: relative; /* Reset position */
            bottom: auto; left: auto; right: auto;
        }
        .case-card .name {
            font-weight: 700; color: white;
            font-size: 1.1rem;
            text-align: center;
            line-height: 1.2;
            margin: 0;
            text-shadow: none;
        }
        .case-card .item-count {
            color: #64748b;
            font-size: 0.8rem;
            font-weight: 500;
            background: transparent;
            padding: 0;
            backdrop-filter: none;
        }
        .case-card .price {
            background: #fbbf24;
            color: #111;
            padding: 8px 0;
            border-radius: 10px;
            font-weight: 800;
            font-size: 1rem;
            width: 100%;
            text-align: center;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
            margin-top: 4px;
        }

        .open-results {
            display: flex;
            justify-content: space-between;
            gap: 24px;
            margin: 24px 0;
            flex-wrap: wrap;
        }
        .player-opens, .opponent-opens {
            flex: 1;
            min-width: 300px;
            background: rgba(30, 30, 50, 0.75);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
        }
        .player-opens   { border: 2px solid #8b5cf6; }
        .opponent-opens { border: 2px solid #5b21b6; }

        .case-opening-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            min-height: 160px;
        }

        .case-box {
            width: 95px;
            height: 95px;
            background-size: cover;
            background-position: center;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0,0,0,0.6);
            opacity: 0;
            transform: scale(0.92);
            transition: opacity 0.5s ease, transform 0.5s ease;
            margin: 4px;
        }

        .case-box.visible {
            opacity: 1;
            transform: scale(1);
        }

        .case-box.revealed {
            transform: scale(1.12);
            box-shadow: 0 0 28px rgba(168, 85, 247, 0.75);
        }

        .case-box.opening {
            animation: dramaticOpen 2.8s ease-out forwards;
        }

        @keyframes dramaticOpen {
            0%   { transform: scale(0.75) rotate(-10deg); filter: brightness(0.7); }
            30%  { transform: scale(1.25) rotate(8deg);   filter: brightness(1.5); }
            55%  { transform: scale(1.05) rotate(-5deg);  filter: brightness(1.25); }
            80%  { transform: scale(1.12) rotate(4deg);   filter: brightness(1.4);  }
            100% { transform: scale(1.12) rotate(0deg);   filter: brightness(1.2);  }
        }

        .item-reveal {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3.6rem;
            opacity: 0;
            text-shadow: 0 0 16px rgba(0,0,0,0.9);
            animation: popIn 1s ease-out forwards;
            animation-delay: 0.7s;
        }

        @keyframes popIn {
            0%   { transform: translate(-50%, -50%) scale(0.4) rotate(-60deg); opacity: 0; }
            50%  { transform: translate(-50%, -50%) scale(1.55) rotate(20deg); opacity: 1; }
            80%  { transform: translate(-50%, -50%) scale(0.95) rotate(-8deg); }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg);     opacity: 1; }
        }

        .value-label {
            position: absolute;
            bottom: 8px; left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: #fde047;
            padding: 5px 12px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.1rem;
            display: none;
            box-shadow: 0 2px 8px black;
        }
        .case-box.revealed .value-label { display: block; }

        .remove-btn {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            color: white;
            padding: 6px 14px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            margin-left: 12px;
            transition: all 0.2s;
        }
        .remove-btn:hover { transform: scale(1.08); box-shadow: 0 0 14px #ef444499; }

        .claim-btn {
            background: linear-gradient(135deg, #34d399, #059669);
            color: white;
            padding: 14px 36px;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            font-weight: 800;
            margin: 24px auto;
            display: block;
            box-shadow: 0 6px 20px rgba(16,185,129,0.6);
            transition: all 0.3s;
        }
        .claim-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 32px rgba(16,185,129,0.8); }
        .claim-btn.disabled { background: #4b5563; cursor: not-allowed; box-shadow: none; }

        .btn, .join-btn {
            padding: 12px 28px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            border: none;
            transition: all 0.25s;
        }
        .btn { background: linear-gradient(135deg, #a855f7, #7e22ce); color: white; box-shadow: 0 5px 16px #a855f755; }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 10px 24px #a855f788; }

        .join-btn { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; box-shadow: 0 4px 14px #3b82f655; }
        .join-btn:hover { transform: scale(1.07); box-shadow: 0 8px 20px #3b82f688; }

      .battle-item {
    background: rgba(45, 40, 75, 0.85);
    border-radius: 16px;
    padding: 16px;
    margin: 12px 0;
    border-left: 5px solid #8b5cf6;
    font-size: 0.95rem;
}

.battle-item > div {
    margin: 8px 0;
}

.battle-item .nickname {
    color: #c084fc;
    font-weight: 700;
}

.battle-price {
    font-size: 1.25rem;
    font-weight: 800;
}

@media (max-width: 480px) {
    .battle-item {
        padding: 14px;
        font-size: 0.92rem;
    }
    .join-btn, .delete-battle-btn {
        width: 100%;
        margin-top: 12px;
        padding: 12px;
    }
    .battle-item > div {
        font-size: 0.9rem;
    }
}

        .nickname { color: #c084fc; font-weight: bold; }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>

    <div class="header">
        <div class="logo" onclick="location.href='../index.html'" style="cursor: pointer;">üíé DROPWIN</div>
        <div class="balance-container">
            <div class="balance">üí∞ <span id="balance">0</span>‚ÇΩ</div>
            <button class="auth-btn" id="authBtn">–ê–∫–∫–∞—É–Ω—Ç</button>
            <button class="auth-btn" onclick="window.open('https://t.me/DropWinHelp_bot','_blank')">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</button>
        </div>
    </div>

    <div class="content">
        <button class="back-btn" onclick="location.href='../index.html'">‚Üê –ù–∞–∑–∞–¥</button>

        <div class="game-card">
            <div class="game-title">‚öîÔ∏è –ë–∞—Ç—Ç–ª—ã –ö–µ–π—Å–æ–≤</div>

            <div class="mode-select">
                <button class="mode-btn active" id="vsBotBtn">Vs –ë–æ—Ç</button>
                <button class="mode-btn" id="vsPlayerBtn">Vs –ò–≥—Ä–æ–∫</button>
            </div>
<button id="showChancesBtn" title="–®–∞–Ω—Å—ã –≤—ã–ø–∞–¥–µ–Ω–∏—è –∏–∑ –∫–µ–π—Å–æ–≤" style="
    position: absolute;
    top: 14px;
    right: 16px;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #64748b, #475569);
    color: white;
    font-size: 1.2rem;
    line-height: 36px;
    text-align: center;
    border: none;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    transition: all 0.18s ease;
    z-index: 5;
  ">‚ÑπÔ∏è</button>

<div id="chancesModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.88); z-index:9999; justify-content:center; align-items:center;">
        <div style="background:#1e1b32; border-radius:16px; padding:20px; max-width:92%; max-height:90vh; overflow-y:auto; border:2px solid #8b5cf6; box-shadow:0 0 40px #8b5cf655;">
            <h2 style="text-align:center; margin:0 0 20px; color:#c4b5fd;">–®–∞–Ω—Å—ã –≤—ã–ø–∞–¥–µ–Ω–∏—è</h2>
            <div id="chancesContent"></div>
            <button class="btn" id="closeChances" style="margin:20px auto 8px; display:block; min-width:140px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
            <div id="vsBotSection">
                <div class="case-select-grid" id="botCaseGrid"></div>
                <div class="selected-cases" id="selectedBotCases"></div>
                <div id="botTotalCost" style="text-align:center; margin:12px 0; font-size:1.3rem;">–ò—Ç–æ–≥–æ: 0‚ÇΩ</div>
                <button class="btn" id="playVsBot">–ò–≥—Ä–∞—Ç—å</button>
                <button class="btn" id="quickVsBot" style="background: linear-gradient(135deg, #fbbf24, #d97706);">–ë—ã—Å—Ç—Ä–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ</button>
                <div id="botResults" style="margin-top:24px;"></div>
            </div>

            <div id="vsPlayerSection" style="display:none;">
                <button class="btn" id="createBattleBtn">–°–æ–∑–¥–∞—Ç—å –±–∞—Ç—Ç–ª</button>

                <div class="battle-form" id="createForm" style="display:none;">
                    <div class="charity-toggle">
                        <input type="checkbox" id="charityMode">
                        <label for="charityMode">–ë–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –±–∞—Ç—Ç–ª (–æ–ø–ª–∞—á–∏–≤–∞—é –∑–∞ –¥–≤–æ–∏—Ö)</label>
                    </div>

                    <div class="case-select-grid" id="playerCaseGrid"></div>
                    <div class="selected-cases" id="selectedPlayerCases"></div>
                    <div id="playerTotalCost" style="text-align:center; margin:16px 0; font-size:1.4rem;">–ò—Ç–æ–≥–æ: 0‚ÇΩ</div>
                    <button class="btn" id="confirmCreate">–°–æ–∑–¥–∞—Ç—å</button>
                </div>

                <div class="battle-list" id="battleList"></div>
            </div>

            <div id="status" style="margin-top:20px; text-align:center; min-height:28px; font-size:1.2rem;"></div>
        </div>
    </div>

    <div class="nav">
        <button class="nav-btn" onclick="location.href='../index.html'"><span>üè†</span><span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span></button>
        <button class="nav-btn" onclick="location.href='../profile.html'"><span>üë§</span><span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span></button>
        <button class="nav-btn" onclick="location.href='../register.html'"><span>üîë</span><span class="nav-label">–í—Ö–æ–¥</span></button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, addDoc, onSnapshot, getDocs, query, where, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBVra2JN-C7-1b_Qa4cU8--XvJ83lymiM8",
            authDomain: "dropwin-8d94b.firebaseapp.com",
            projectId: "dropwin-8d94b",
            storageBucket: "dropwin-8d94b.firebasestorage.app",
            messagingSenderId: "988974289403",
            appId: "1:988974289403:web:886d34e6f65920a105fb5e",
            measurementId: "G-BK010MHN8N"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        (function(){
          const orig = {
            error: console.error,
            warn: console.warn,
            log: console.log,
            info: console.info,
            debug: console.debug
          };
          const match = (args)=>{
            try{
              const s = args.map(x=>typeof x==='string'?x:(x&&x.message)?x.message:JSON.stringify(x)).join(' ');
              return s.includes('firestore.googleapis.com') && s.includes('documents:commit');
            }catch(_){return false;}
          };
          console.error = (...a)=>{ if(match(a)) return; orig.error(...a); };
          console.warn  = (...a)=>{ if(match(a)) return; orig.warn(...a);  };
          console.log   = (...a)=>{ if(match(a)) return; orig.log(...a);   };
          console.info  = (...a)=>{ if(match(a)) return; orig.info(...a);  };
          console.debug = (...a)=>{ if(match(a)) return; orig.debug(...a); };
        })();

        function createParticles() {
            const container = document.getElementById('particles');
            if (!container) return;
            for (let i = 0; i < 25; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.width = p.style.height = Math.random() * 2 + 1 + 'px';
                p.style.left = Math.random() * 100 + '%';
                p.style.animationDuration = Math.random() * 12 + 8 + 's';
                p.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(p);
            }
        }
function openCaseWithBotBoost(caseType) {
        const items = cases[caseType].items;
        const r = Math.random();
        let sum = 0;

        // –¥–∞—ë–º –±–æ—Ç—É ~4‚Äì6% –±—É—Å—Ç –Ω–∞ –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã
        for (let i = 0; i < items.length; i++) {
            let adjustedProb = items[i].prob;
            // —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —à–∞–Ω—Å –Ω–∞ –∫–∞–∂–¥—ã–π —Å–ª–µ–¥—É—é—â–∏–π –ø—Ä–µ–¥–º–µ—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ –Ω–∞ 4‚Äì7%
            if (i > 0) adjustedProb += 0.004 * (i + 1);
            sum += adjustedProb;
            if (r <= sum) return { ...items[i], caseType };
        }
        return { ...items[0], caseType };
    }
        let currentUser = null;
        let userId = null;
        let isGuest = false;
        let isCharityMode = false;

const cases = {
    bomj: {
        price: 6,
        items: [
            {emoji: 'üß¶', name: '–î—ã—Ä—è–≤—ã–π –Ω–æ—Å–æ–∫',      value: 1,   prob: 0.58},
            {emoji: 'üçû', name: '–ß—ë—Ä—Å—Ç–≤—ã–π —Ö–ª–µ–±',       value: 3,   prob: 0.22},
            {emoji: 'üóëÔ∏è', name: '–ú—É—Å–æ—Ä–Ω—ã–π –ø–∞–∫–µ—Ç',      value: 7,   prob: 0.11},
            {emoji: 'üç∫', name: '–¢—ë–ø–ª–æ–µ –ø–∏–≤–æ 0.5',     value: 12,  prob: 0.05},
            {emoji: 'ü™ô', name: '–ì–æ—Ä—Å—Ç–∫–∞ –º–µ–ª–æ—á–∏',      value: 25,  prob: 0.025},
            {emoji: 'üß•', name: '–°—Ç–∞—Ä–∞—è –∫—É—Ä—Ç–∫–∞',       value: 50,  prob: 0.012},
            {emoji: 'üì±', name: '–°–ª–æ–º–∞–Ω–Ω—ã–π Nokia',     value: 100, prob: 0.003},
            {emoji: 'üí∏', name: '–ó–∞–Ω–∞—á–∫–∞ –ø–æ–¥ –º–∞—Ç—Ä–∞—Å–æ–º',value: 180, prob: 0.0005},
        ],
        color: '#6b7280',
        icon: 'üóëÔ∏è'
    },
    vibe: {
        price: 49,
        items: [
            {emoji: 'üíñ', name: '–°–µ—Ä–¥—Ü–µ',          value: 15,  prob: 0.52},
            {emoji: 'üåπ', name: '–†–æ–∑–∞',            value: 25,  prob: 0.20},
            {emoji: 'üöÄ', name: '–†–∞–∫–µ—Ç–∞',          value: 50,  prob: 0.10},
            {emoji: 'üíê', name: '–¶–≤–µ—Ç—ã',           value: 50,  prob: 0.08},
            {emoji: 'üíç', name: '–ö–æ–ª—å—Ü–æ',          value: 100, prob: 0.035},
            {emoji: 'üíé', name: '–ê–ª–º–∞–∑',           value: 100, prob: 0.03},
            {emoji: 'üç≠', name: '–õ–æ–ª-–ø–æ–ø',         value: 325, prob: 0.015},
            {emoji: 'üê∂', name: '–°—É–ø –î–æ–≥',         value: 425, prob: 0.012},
            {emoji: 'ü§°', name: '–®–∞–ø–∫–∞ —à—É—Ç–∞',      value: 500, prob: 0.008},
            {emoji: '‚≠ê', name: '–ó–≤–µ–∑–¥–∞',           value: 200, prob: 0.01},
        ],
        color: '#ec4899',
        icon: 'üíñ'
    },
    santa: {
        price: 114,
        items: [
            {emoji: 'üç™', name: '–ü–µ—á–µ–Ω—å–µ', value: 30, prob: 0.50},
            {emoji: 'ü•õ', name: '–ú–æ–ª–æ–∫–æ', value: 60, prob: 0.30},
            {emoji: 'üéÖ', name: '–ö–æ–ª–ø–∞–∫', value: 120, prob: 0.15},
            {emoji: 'ü¶å', name: '–û–ª–µ–Ω—å', value: 300, prob: 0.04},
            {emoji: 'üéÅ', name: '–ë–æ–ª—å—à–æ–π –ø–æ–¥–∞—Ä–æ–∫', value: 1000, prob: 0.01},
        ],
        color: '#dc2626',
        icon: 'üéÖ'
    },
    c2024: {
        price: 1199,
        items: [
            {emoji: 'üêâ', name: '–î—Ä–∞–∫–æ–Ω', value: 300, prob: 0.4},
            {emoji: 'üçæ', name: '–®–∞–º–ø–∞–Ω—Å–∫–æ–µ', value: 600, prob: 0.3},
            {emoji: 'üéÅ', name: '–ü–æ–¥–∞—Ä–æ–∫ 2024', value: 1200, prob: 0.15},
            {emoji: 'üëë', name: '–ö–æ—Ä–æ–Ω–∞', value: 2500, prob: 0.08},
            {emoji: 'üíé', name: '–ê–ª–º–∞–∑', value: 5000, prob: 0.05},
            {emoji: 'üè∞', name: '–ó–∞–º–æ–∫', value: 15000, prob: 0.02}
        ],
        color: '#facc15',
        icon: 'üêâ'
    },
    c2025: {
        price: 799,
        items: [
            {emoji: 'üêç', name: '–ó–º–µ—è', value: 200, prob: 0.45},
            {emoji: 'üéä', name: '–•–ª–æ–ø—É—à–∫–∞', value: 400, prob: 0.3},
            {emoji: 'üé´', name: '–ë–∏–ª–µ—Ç 2025', value: 800, prob: 0.15},
            {emoji: 'ü§ñ', name: '–ö–∏–±–µ—Ä-–ó–º–µ—è', value: 2000, prob: 0.07},
            {emoji: 'üöÄ', name: '–†–∞–∫–µ—Ç–∞', value: 4000, prob: 0.03}
        ],
        color: '#22d3ee',
        icon: 'üêç'
    },
    battle: {
        price: 189,
        items: [
            {emoji: 'üõ°Ô∏è', name: '–©–∏—Ç', value: 50, prob: 0.45},
            {emoji: '‚öîÔ∏è', name: '–ú–µ—á', value: 100, prob: 0.30},
            {emoji: 'üíä', name: '–ê–ø—Ç–µ—á–∫–∞', value: 200, prob: 0.15},
            {emoji: 'üî´', name: '–ü–∏—Å—Ç–æ–ª–µ—Ç', value: 400, prob: 0.07},
            {emoji: 'üí£', name: '–ì—Ä–∞–Ω–∞—Ç–∞', value: 800, prob: 0.025},
            {emoji: 'üöÅ', name: '–í–µ—Ä—Ç–æ–ª–µ—Ç', value: 2000, prob: 0.005},
        ],
        color: '#ef4444',
        icon: '‚öîÔ∏è'
    },
    dvornik: {
        price: 29,
        items: [
            {emoji: 'üßπ', name: '–ú–µ—Ç–ª–∞', value: 5, prob: 0.30},
            {emoji: 'ü™£', name: '–í–µ–¥—Ä–æ', value: 10, prob: 0.25},
            {emoji: 'üßº', name: '–ú—ã–ª–æ', value: 15, prob: 0.18},
            {emoji: 'ü™ì', name: '–¢–æ–ø–æ—Ä —Å—Ç–∞—Ä—ã–π', value: 35, prob: 0.12},
            {emoji: 'üß§', name: '–ü–µ—Ä—á–∞—Ç–∫–∏ —Ä–∞–±–æ—á–∏–µ', value: 50, prob: 0.08},
            {emoji: '‚õèÔ∏è', name: '–õ–æ–ø–∞—Ç–∞', value: 80, prob: 0.04},
            {emoji: 'üõ†Ô∏è', name: '–ù–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤', value: 150, prob: 0.025},
            {emoji: 'üö≤', name: '–í–µ–ª–æ—Å–∏–ø–µ–¥ –±/—É', value: 400, prob: 0.005},
        ],
        color: '#eab308',
        icon: 'üßπ'
    },
    schoolboy: {
        price: 259,
        items: [
            {emoji: 'üìö', name: '–£—á–µ–±–Ω–∏–∫', value: 80, prob: 0.50},
            {emoji: 'üéí', name: '–†—é–∫–∑–∞–∫', value: 150, prob: 0.25},
            {emoji: 'üì±', name: '–°–º–∞—Ä—Ç—Ñ–æ–Ω', value: 400, prob: 0.12},
            {emoji: 'üíª', name: '–ù–æ—É—Ç–±—É–∫', value: 700, prob: 0.07},
            {emoji: 'üéÆ', name: 'PlayStation', value: 1000, prob: 0.03},
            {emoji: 'üöó', name: '–ú–∞—à–∏–Ω–∫–∞', value: 1300, prob: 0.02},
            {emoji: 'üè†', name: '–ö–≤–∞—Ä—Ç–∏—Ä–∞', value: 4000, prob: 0.005},
        ],
        color: '#3b82f6',
        icon: 'üìö'
    },
    event: {
        price: 519,
        items: [
            {emoji: 'üéâ', name: '–ö–æ–Ω—Ñ–µ—Ç—Ç–∏', value: 150, prob: 0.4},
            {emoji: 'üéÅ', name: '–ü–æ–¥–∞—Ä–æ–∫', value: 300, prob: 0.25},
            {emoji: 'üéà', name: '–í–æ–∑–¥—É—à–Ω—ã–π —à–∞—Ä', value: 400, prob: 0.15},
            {emoji: 'üçæ', name: '–®–∞–º–ø–∞–Ω—Å–∫–æ–µ', value: 600, prob: 0.1},
            {emoji: 'üé§', name: '–ú–∏–∫—Ä–æ—Ñ–æ–Ω', value: 900, prob: 0.04},
            {emoji: 'üé¨', name: '–ö–∏–Ω–æ', value: 1500, prob: 0.025},
            {emoji: '‚úàÔ∏è', name: '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ', value: 3000, prob: 0.01},
        ],
        color: '#ef4444',
        icon: 'üéâ'
    },
    milioner: {
        price: 1000,
        items: [
            {emoji: 'üíµ', name: '–î–µ–Ω—å–≥–∏', value: 300, prob: 0.52},
            {emoji: 'üè¶', name: '–ë–∞–Ω–∫', value: 600, prob: 0.26},
            {emoji: 'üí∞', name: '–ú–µ—à–æ–∫ –¥–µ–Ω–µ–≥', value: 1200, prob: 0.14},
            {emoji: 'üìà', name: '–ì—Ä–∞—Ñ–∏–∫ —Ä–æ—Å—Ç–∞', value: 2000, prob: 0.06},
            {emoji: 'ü§ë', name: '–ú–∏–ª–ª–∏–æ–Ω–µ—Ä', value: 3000, prob: 0.013},
            {emoji: 'üöÄ', name: '–†–∞–∫–µ—Ç–∞', value: 6000, prob: 0.005},
            {emoji: 'üè∞', name: '–î–≤–æ—Ä–µ—Ü', value: 25000, prob: 0.002},
        ],
        color: '#fbbf24',
        icon: 'üí∞'
    },
    neoprime: {
        price: 1555,
        items: [
            {emoji: 'üí°', name: '–ù–µ–æ–Ω–æ–≤–∞—è –ª–∞–º–ø–∞', value: 450, prob: 0.65},
            {emoji: 'üíæ', name: '–ö–∏–±–µ—Ä-—á–∏–ø', value: 1000, prob: 0.24},
            {emoji: 'ü•Ω', name: 'VR-–æ—á–∫–∏', value: 1600, prob: 0.07},
            {emoji: 'üöÅ', name: '–î—Ä–æ–Ω', value: 2200, prob: 0.025},
            {emoji: 'ü§ñ', name: '–†–æ–±–æ—Ç', value: 3500, prob: 0.01},
            {emoji: 'üöö', name: '–ö–∏–±–µ—Ä-—Ç—Ä–∞–∫', value: 7000, prob: 0.004},
            {emoji: 'üåå', name: 'Neo Prime', value: 30000, prob: 0.001},
        ],
        color: '#8b5cf6',
        icon: 'üåå'
    },
    grinch: {
        price: 2555,
        items: [
            {emoji: 'üßÖ', name: '–õ—É–∫', value: 500, prob: 0.40},
            {emoji: 'üêï', name: '–ú–∞–∫—Å', value: 1500, prob: 0.35},
            {emoji: 'üéÑ', name: '–£–∫—Ä–∞–¥–µ–Ω–Ω–∞—è –µ–ª–∫–∞', value: 3000, prob: 0.15},
            {emoji: 'üéÅ', name: '–ß—É–∂–∏–µ –ø–æ–¥–∞—Ä–∫–∏', value: 5000, prob: 0.08},
            {emoji: 'üíö', name: '–°–µ—Ä–¥—Ü–µ –ì—Ä–∏–Ω—á–∞', value: 15000, prob: 0.02},
        ],
        color: '#16a34a',
        icon: 'üíö'
    },
    maldives: {
        price: 2599,
        items: [
            {emoji: 'üêö', name: '–†–∞–∫—É—à–∫–∞', value: 700, prob: 0.60},
            {emoji: 'ü••', name: '–ö–æ–∫–æ—Å', value: 1600, prob: 0.28},
            {emoji: 'üçπ', name: '–ö–æ–∫—Ç–µ–π–ª—å', value: 2500, prob: 0.08},
            {emoji: 'üå¥', name: '–ü–∞–ª—å–º–∞', value: 4000, prob: 0.025},
            {emoji: 'üö§', name: '–ì–∏–¥—Ä–æ—Ü–∏–∫–ª', value: 7500, prob: 0.01},
            {emoji: 'üè†', name: '–ë—É–Ω–≥–∞–ª–æ', value: 18000, prob: 0.004},
            {emoji: 'üèùÔ∏è', name: '–õ–∏—á–Ω—ã–π –æ—Å—Ç—Ä–æ–≤', value: 65000, prob: 0.001},
        ],
        color: '#0ea5e9',
        icon: 'üèùÔ∏è'
    },
    elka: {
        price: 299,
        items: [
            {emoji: '‚ùÑÔ∏è', name: '–°–Ω–µ–∂–∏–Ω–∫–∞', value: 50, prob: 0.50},
            {emoji: 'üç¨', name: '–õ–µ–¥–µ–Ω–µ—Ü', value: 100, prob: 0.25},
            {emoji: 'üéÑ', name: '–ì–∏—Ä–ª—è–Ω–¥–∞', value: 200, prob: 0.15},
            {emoji: '‚≠ê', name: '–ó–≤–µ–∑–¥–∞', value: 400, prob: 0.06},
            {emoji: 'üéÖ', name: '–®–∞–ø–∫–∞ –°–∞–Ω—Ç—ã', value: 800, prob: 0.03},
            {emoji: 'üçæ', name: '–®–∞–º–ø–∞–Ω—Å–∫–æ–µ', value: 1500, prob: 0.008},
            {emoji: 'üéÜ', name: '–§–µ–π–µ—Ä–≤–µ—Ä–∫', value: 5000, prob: 0.002},
        ],
        color: '#10b981',
        icon: 'üéÑ'
    },
    snowman: {
        price: 1999,
        items: [
            {emoji: 'ü•ï', name: '–ú–æ—Ä–∫–æ–≤–∫–∞', value: 400, prob: 0.50},
            {emoji: 'üß£', name: '–®–∞—Ä—Ñ', value: 800, prob: 0.25},
            {emoji: 'üõ∑', name: '–°–∞–Ω–∫–∏', value: 1500, prob: 0.15},
            {emoji: '‚õ∏Ô∏è', name: '–ö–æ–Ω—å–∫–∏', value: 3000, prob: 0.06},
            {emoji: 'üå®Ô∏è', name: '–°–Ω–µ–≥–æ—Ö–æ–¥', value: 7000, prob: 0.03},
            {emoji: 'üßä', name: '–õ–µ–¥—è–Ω–æ–π —Ç—Ä–æ–Ω', value: 15000, prob: 0.008},
            {emoji: 'üè∞', name: '–õ–µ–¥—è–Ω–æ–π –¥–≤–æ—Ä–µ—Ü', value: 50000, prob: 0.002},
        ],
        color: '#38bdf8',
        icon: '‚õÑ'
    }
};

const caseBackgrounds = {
    bomj:     '../images/bomj.png',
    vibe:     '../images/vibe.png',
    dvornik:  '../images/dvornik.png',
    schoolboy:'../images/schoolboy.png',
    event:    '../images/event.png',
    milioner: '../images/milioner.png',
    neoprime: '../images/NeoPrime.png',
    maldives: '../images/Maldives.png',
    elka:     '../images/elka.png',
    snowman:  '../images/snowman.png',
    battle:   '../images/battles.png',
    grinch:   '../images/grinch.png',
    santa:    '../images/Santa.png',
    c2024:    '../images/2024.png',
    c2025:    '../images/2025.png'
};

const caseOpenedBackgrounds = {
    bomj:     '../images/bomj1.png',
    vibe:     '../images/vibe1.png',
    dvornik:  '../images/dvornik1.png',
    schoolboy:'../images/schoolboy1.png',
    event:    '../images/event1.png',
    milioner: '../images/milioner1.png',
    neoprime: '../images/NeoPrime1.png',
    maldives: '../images/Maldives1.png',
    elka:     '../images/elka.png',   // Fallback to closed image
    snowman:  '../images/snowman.png', // Fallback to closed image
    battle:   '../images/battles.png',
    grinch:   '../images/grinch.png',
    santa:    '../images/Santa.png',
    c2024:    '../images/2024.png',
    c2025:    '../images/2025.png'
};

const caseDisplayNames = {
    bomj:     "–ë–æ–º–∂",
    vibe:     "Vibe",
    dvornik:  "–î–≤–æ—Ä–Ω–∏–∫",
    schoolboy:"–®–∫–æ–ª—å–Ω–∏–∫",
    event:    "–ò–≤–µ–Ω—Ç",
    milioner: "–ú–∏–ª–ª–∏–æ–Ω–µ—Ä",
    neoprime: "Neo Prime",
    maldives: "–ú–∞–ª—å–¥–∏–≤—ã",
    elka:     "–Å–ª–∫–∞",
    snowman:  "–°–Ω–µ–≥–æ–≤–∏–∫",
    battle:   "–ö–µ–π—Å Battle",
    grinch:   "–ö–µ–π—Å –ì—Ä–∏–Ω—á",
    santa:    "–ö–µ–π—Å –°–∞–Ω—Ç–∞",
    c2024:    "–ö–µ–π—Å 2024",
    c2025:    "–ö–µ–π—Å 2025"
};

        const sortedCaseKeys = Object.keys(cases).sort((a, b) => cases[a].price - cases[b].price);

        function renderCaseGrid(containerId, onSelect) {
            const grid = document.getElementById(containerId);
            grid.innerHTML = '';
            sortedCaseKeys.forEach(key => {
                const c = cases[key];
                const card = document.createElement('div');
                card.className = `case-card ${key}`;
                card.innerHTML = `
                    <div class="case-image-wrap">
                        <img src="${caseBackgrounds[key]}" alt="${key}">
                    </div>
                    <div class="case-info">
                        <div class="name">${caseDisplayNames[key] || key}</div>
                        <div class="item-count">${c.items.length} –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>
                        <div class="price">${c.price}‚ÇΩ</div>
                    </div>
                `;
                card.onclick = () => onSelect(key);
                grid.appendChild(card);
            });
        }

        let selectedBotCases = [];
        let selectedPlayerCases = [];

        function addSelectedCase(section, caseType) {
            const arr = section === 'bot' ? selectedBotCases : selectedPlayerCases;
            arr.push(caseType);
            updateSelectedCases(section);
            updateTotalCost(section);
        }

        function updateSelectedCases(section) {
            const cont = document.getElementById(section === 'bot' ? 'selectedBotCases' : 'selectedPlayerCases');
            cont.innerHTML = '<h4>–í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–µ–π—Å—ã:</h4>';
            const arr = section === 'bot' ? selectedBotCases : selectedPlayerCases;
            arr.forEach((type, i) => {
                const div = document.createElement('div');
                div.textContent = `${caseDisplayNames[type] || type} (${cases[type].price}‚ÇΩ)`;
                const btn = document.createElement('button');
                btn.className = 'remove-btn';
                btn.textContent = '–£–¥–∞–ª–∏—Ç—å';
                btn.onclick = () => {
                    arr.splice(i, 1);
                    updateSelectedCases(section);
                    updateTotalCost(section);
                };
                div.appendChild(btn);
                cont.appendChild(div);
            });
        }

        function updateTotalCost(section) {
            const arr = section === 'bot' ? selectedBotCases : selectedPlayerCases;
            const total = arr.reduce((s, t) => s + cases[t].price, 0);
            const el = document.getElementById(section === 'bot' ? 'botTotalCost' : 'playerTotalCost');

            if (section === 'player' && isCharityMode) {
                el.innerHTML = `–ò—Ç–æ–≥–æ: ${total * 2}‚ÇΩ <span class="charity-label">–∑–∞ –¥–≤–æ–∏—Ö!</span>`;
            } else {
                el.textContent = `–ò—Ç–æ–≥–æ: ${total}‚ÇΩ`;
            }
        }

        function openCase(caseType) {
            const items = cases[caseType].items;
            const r = Math.random();
            let sum = 0;
            for (let it of items) {
                sum += it.prob;
                if (r <= sum) return { ...it, caseType };
            }
            return { ...items[0], caseType };
        }

     async function playVsBot(quick = false) {
    const totalCost = selectedBotCases.reduce((sum, type) => sum + cases[type].price, 0);
    if (currentUser.balance < totalCost) {
        alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞');
        return;
    }
    if (selectedBotCases.length === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∫–µ–π—Å');
        return;
    }

    currentUser.balance -= totalCost;
    await saveUser();
    updateBalance();

        const playerItems = selectedBotCases.map(type => openCase(type));
        const playerTotal = playerItems.reduce((sum, item) => sum + item.value, 0);
        const botItems    = selectedBotCases.map(type => openCaseWithBotBoost(type));
        const botTotal    = botItems.reduce((sum, item) => sum + item.value, 0);

    const resultsDiv = document.getElementById('botResults');
    if (!resultsDiv) return;

    resultsDiv.innerHTML = `
        <div class="open-results">
            <div class="player-opens">
                <h4>–í–∞—à–∏ –∫–µ–π—Å—ã (${currentUser?.username || '–ì–æ—Å—Ç—å'}):</h4>
                <div class="case-opening-container" id="playerCases"></div>
                <div class="total-value" id="playerTotal">–ò—Ç–æ–≥–æ: 0‚ÇΩ</div>
            </div>
            <div class="opponent-opens">
                <h4>–ë–æ—Ç:</h4>
                <div class="case-opening-container" id="botCases"></div>
                <div class="total-value" id="botTotal">–ò—Ç–æ–≥–æ: 0‚ÇΩ</div>
            </div>
        </div>
        <div id="resultText" style="text-align:center; margin-top:20px; font-size:1.4rem; min-height:40px;"></div>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:12px;">
            <button class="btn" id="sellBotBtn" style="background: linear-gradient(135deg, #34d399, #059669);">–ü—Ä–æ–¥–∞—Ç—å —Å—Ä–∞–∑—É</button>
            <button class="btn" id="stashBotBtn" style="background: linear-gradient(135deg, #a855f7, #7e22ce);">–û—Ç–ª–æ–∂–∏—Ç—å –≤—Å—ë</button>
        </div>
    `;

    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
    await Promise.all([
        animateBatchedOpenings('playerCases', selectedBotCases, playerItems, playerTotal, 'player', quick),
        animateBatchedOpenings('botCases', selectedBotCases, botItems, botTotal, 'bot', quick)
    ]);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±–µ–∏—Ö –∞–Ω–∏–º–∞—Ü–∏–π
    showBotResult(playerTotal, botTotal, totalCost);
}

async function animateBatchedOpenings(containerId, caseTypes, items, total, side, quick = false) {
    const container = document.getElementById(containerId);
    if (!container) return;

    container.innerHTML = '';

    const totalEl = document.getElementById(containerId === 'playerCases' ? 'playerTotal' : 'botTotal');
    if (totalEl) totalEl.textContent = `–ò—Ç–æ–≥–æ: ${total}‚ÇΩ`;

    // –°–æ–∑–¥–∞—ë–º –≤—Å–µ –∫–µ–π—Å—ã —Å—Ä–∞–∑—É
    caseTypes.forEach((type, index) => {
        const item = items[index];
        const box = document.createElement('div');
        box.className = `case-box ${type}`;
        box.dataset.type = type;
        box.style.backgroundImage = `url('${caseBackgrounds[type] || ''}')`;
        box.innerHTML = `
            <div class="item-reveal">${item.emoji}</div>
            <div class="value-label">${item.value}‚ÇΩ</div>
        `;
        container.appendChild(box);

        // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ
        setTimeout(() => box.classList.add('visible'), index * 80 + 100);
    });

    if (quick) {
        // –ë—ã—Å—Ç—Ä–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ ‚Äî –≤—Å—ë –ø–æ—á—Ç–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
        setTimeout(() => {
            container.querySelectorAll('.case-box').forEach(box => {
                const type = box.dataset.type;
                const opened = caseOpenedBackgrounds[type];
                if (opened) box.style.backgroundImage = `url('${opened}')`;
                box.classList.add('opening', 'revealed');
            });
        }, 600);
    } else {
        // –ù–æ—Ä–º–∞–ª—å–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è ‚Äî –ø–æ –æ–¥–Ω–æ–º—É —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        for (let i = 0; i < caseTypes.length; i++) {
            await new Promise(resolve => setTimeout(resolve, 700));
            const box = container.children[i];
            if (!box) continue;
            const type = box.dataset.type;
            const opened = caseOpenedBackgrounds[type];
            if (opened) box.style.backgroundImage = `url('${opened}')`;
            box.classList.add('opening');
            setTimeout(() => box.classList.add('revealed'), 1400);
        }
    }
}

let lastBotRun = null;
function showBotResult(playerTotal, botTotal, totalCost) {
    const resultTextEl = document.getElementById('resultText');
    if (!resultTextEl) return;

    let resultText = '';
    let prize = 0;

    if (playerTotal > botTotal) {
        prize = playerTotal + botTotal;
        resultText = `<span style="color:#34d399">–ü–æ–±–µ–¥–∞! –ü—Ä–∏–∑: ${prize}‚ÇΩ</span>`;
    } else if (playerTotal < botTotal) {
        resultText = `<span style="color:#f87171">–ü—Ä–æ–∏–≥—Ä—ã—à</span>`;
    } else {
        prize = playerTotal;
        resultText = `–ù–∏—á—å—è ‚Äî –¥–æ—Å—Ç—É–ø–Ω—ã –≤–∞—à–∏ –ø—Ä–µ–¥–º–µ—Ç—ã –Ω–∞ ${prize}‚ÇΩ`;
    }

    resultTextEl.innerHTML = resultText;
    lastBotRun = { prize, playerTotal, botTotal, processed: false, runId: (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString() + Math.random().toString(16).slice(2)) };

    const sellBtn = document.getElementById('sellBotBtn');
    const stashBtn = document.getElementById('stashBotBtn');
    // –°—Ä–∞–∑—É –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –ø–æ—Ä–∞–∂–µ–Ω–∏–∏
    if (sellBtn && stashBtn && playerTotal < botTotal) {
        sellBtn.disabled = true;
        stashBtn.disabled = true;
        sellBtn.style.background = '#6b7280';
        stashBtn.style.background = '#6b7280';
        sellBtn.style.cursor = 'not-allowed';
        stashBtn.style.cursor = 'not-allowed';
        return;
    }
    if (sellBtn) {
        sellBtn.onclick = async () => {
            if (lastBotRun.processed) return;
            sellBtn.disabled = true;
            stashBtn.disabled = true;
            if (prize > 0) {
                currentUser.balance += prize;
                await saveUser();
                updateBalance();
                resultTextEl.innerHTML += `<br><div style="color:#a78bfa; margin-top:12px;">–ü—Ä–æ–¥–∞–∂–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ (+${prize}‚ÇΩ)</div>`;
            } else {
                resultTextEl.innerHTML += `<br><div style="color:#f87171; margin-top:12px;">–ü—Ä–æ–¥–∞—Ç—å –Ω–µ—á–µ–≥–æ</div>`;
            }
            lastBotRun.processed = true;
        };
    }
    if (stashBtn) {
        stashBtn.onclick = async () => {
            if (lastBotRun.processed) return;
            sellBtn.disabled = true;
            stashBtn.disabled = true;
            if (isGuest) {
                const playerBoxes = document.querySelectorAll('#playerCases .case-box');
                const botBoxes = document.querySelectorAll('#botCases .case-box');
                const myItems = Array.from(playerBoxes).map(b => ({ emoji: b.querySelector('.item-reveal')?.textContent || '‚ùì', name: '–ü—Ä–µ–¥–º–µ—Ç', value: Number(b.querySelector('.value-label')?.textContent.replace('‚ÇΩ','')) || 0 }));
                const oppItems = Array.from(botBoxes).map(b => ({ emoji: b.querySelector('.item-reveal')?.textContent || '‚ùì', name: '–ü—Ä–µ–¥–º–µ—Ç', value: Number(b.querySelector('.value-label')?.textContent.replace('‚ÇΩ','')) || 0 }));
                const saveBoth = playerTotal > botTotal;
                const itemsToSave = saveBoth ? myItems.concat(oppItems) : myItems;
                let users = JSON.parse(localStorage.getItem('dropwin_users')) || [];
                const idx = users.findIndex(u => u.username === '–ì–æ—Å—Ç—å');
                let guest = idx !== -1 ? users[idx] : { username: '–ì–æ—Å—Ç—å', balance: 0, inventory: [] };
                const inventory = Array.isArray(guest.inventory) ? guest.inventory : [];
                const newItems = itemsToSave.map(it => ({
                    id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString() + Math.random().toString(16).slice(2)),
                    emoji: it.emoji,
                    name: it.name,
                    value: it.value,
                    source: '–ë–∞—Ç—Ç–ª:–ë–æ—Ç',
                    botRunId: lastBotRun.runId,
                    timestamp: Date.now()
                }));
                guest.inventory = inventory.concat(newItems);
                if (idx !== -1) users[idx] = guest; else users.push(guest);
                localStorage.setItem('dropwin_users', JSON.stringify(users));
                currentUser.inventory = guest.inventory;
                resultTextEl.innerHTML += `<br><div style="text-align:center; padding:12px; color:#a78bfa;">–û—Ç–ª–æ–∂–µ–Ω–æ: ${newItems.length} –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>`;
                lastBotRun.processed = true;
                return;
            }
            const playerBoxes = document.querySelectorAll('#playerCases .case-box');
            const botBoxes = document.querySelectorAll('#botCases .case-box');
            const myItems = Array.from(playerBoxes).map(b => ({ emoji: b.querySelector('.item-reveal')?.textContent || '‚ùì', name: '–ü—Ä–µ–¥–º–µ—Ç', value: Number(b.querySelector('.value-label')?.textContent.replace('‚ÇΩ','')) || 0 }));
            const oppItems = Array.from(botBoxes).map(b => ({ emoji: b.querySelector('.item-reveal')?.textContent || '‚ùì', name: '–ü—Ä–µ–¥–º–µ—Ç', value: Number(b.querySelector('.value-label')?.textContent.replace('‚ÇΩ','')) || 0 }));
            const saveBoth = playerTotal > botTotal;
            const itemsToSave = saveBoth ? myItems.concat(oppItems) : myItems;
            const userSnap = await getDoc(doc(db, 'users', userId));
            const userData = userSnap.exists() ? userSnap.data() : {};
            const inventory = Array.isArray(userData.inventory) ? userData.inventory : [];
            const newItems = itemsToSave.filter(it => !inventory.some(e => e.botRunId === lastBotRun.runId && e.name === it.name && e.value === it.value && e.source === '–ë–∞—Ç—Ç–ª:–ë–æ—Ç')).map(it => ({
                id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString() + Math.random().toString(16).slice(2)),
                emoji: it.emoji,
                name: it.name,
                value: it.value,
                source: '–ë–∞—Ç—Ç–ª:–ë–æ—Ç',
                botRunId: lastBotRun.runId,
                timestamp: Date.now()
            }));
            const updatedInv = inventory.concat(newItems);
            await updateDoc(doc(db, 'users', userId), { inventory: updatedInv });
            currentUser.inventory = updatedInv;
            resultTextEl.innerHTML += `<br><div style="text-align:center; padding:12px; color:#a78bfa;">–û—Ç–ª–æ–∂–µ–Ω–æ: ${newItems.length} –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>`;
            lastBotRun.processed = true;
        };
    }
}

        async function saveUser() {
            try {
                if (isGuest) {
                    let users = JSON.parse(localStorage.getItem('dropwin_users')) || [];
                    const idx = users.findIndex(u => u.username === '–ì–æ—Å—Ç—å');
                    if (idx !== -1) users[idx] = currentUser;
                    localStorage.setItem('dropwin_users', JSON.stringify(users));
                } else if (userId) {
                    await updateDoc(doc(db, 'users', userId), { balance: currentUser.balance });
                }
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", err);
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å.");
            }
        }

        function updateBalance() {
            document.getElementById('balance').textContent = currentUser ? currentUser.balance || 0 : 0;
            document.getElementById('authBtn').textContent = isGuest ? '–ì–æ—Å—Ç—å' : (currentUser ? currentUser.username : '–í–æ–π—Ç–∏');
            document.getElementById('authBtn').onclick = () => location.href = '../profile.html';
        }

        function loadCurrentUser() {
            onAuthStateChanged(auth, async (user) => {
                try {
                    if (user) {
                        userId = user.uid;
                        const snap = await getDoc(doc(db, 'users', user.uid));
                        if (snap.exists()) {
                            currentUser = snap.data();
                            isGuest = false;
                            updateBalance();
                            await awardPendingForUser();
                            if (document.getElementById('vsPlayerBtn')?.classList.contains('active')) {
                                loadBattles();
                            }
                        }
                    } else {
                        const username = localStorage.getItem('dropwin_current_username');
                        if (username === '–ì–æ—Å—Ç—å') {
                            const users = JSON.parse(localStorage.getItem('dropwin_users')) || [];
                            currentUser = users.find(u => u.username === '–ì–æ—Å—Ç—å');
                            isGuest = true;
                            updateBalance();
                        } else {
                            location.href = '../register.html';
                        }
                    }
                } catch (err) {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", err);
                    document.getElementById('status').textContent = "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∞–∫–∫–∞—É–Ω—Ç—É.";
                }
            });
        }

        async function createBattle() {
            try {
                if (isGuest) throw new Error('–¢–æ–ª—å–∫–æ –¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö');
                if (selectedPlayerCases.length === 0) throw new Error('–í—ã–±–µ—Ä–∏—Ç–µ –∫–µ–π—Å—ã');

                const singleCost = selectedPlayerCases.reduce((sum, type) => sum + cases[type].price, 0);
                const costToPay = isCharityMode ? singleCost * 2 : singleCost;

                if (currentUser.balance < costToPay) throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞');

                const existingQ = query(collection(db, 'battles'), where('creator', '==', userId), where('status', '==', 'open'));
                const existingSnap = await getDocs(existingQ);
                if (!existingSnap.empty) throw new Error('–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–π –±–∞—Ç—Ç–ª. –£–¥–∞–ª–∏—Ç–µ –µ–≥–æ —Å–Ω–∞—á–∞–ª–∞.');

                currentUser.balance -= costToPay;
                await saveUser();
                updateBalance();

                const battleDoc = await addDoc(collection(db, 'battles'), {
                    creator: userId,
                    creatorName: currentUser.username,
                    caseTypes: selectedPlayerCases,
                    totalCost: singleCost,          // —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞
                    isCharity: isCharityMode,
                    creatorPaid: costToPay,         // —Å–∫–æ–ª—å–∫–æ –∑–∞–ø–ª–∞—Ç–∏–ª —Å–æ–∑–¥–∞—Ç–µ–ª—å
                    player1: userId,
                    player1Name: currentUser.username,
                    player2: null,
                    player2Name: null,
                    status: 'open',
                    player1Items: [],
                    player2Items: [],
                    player1Total: 0,
                    player2Total: 0,
                    player1Claimed: false,
                    player2Claimed: false,
                    player1Saved: false,
                    player2Saved: false,
                    createdAt: new Date()
                });

                subscribeToBattle(battleDoc.id);

                // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
                selectedPlayerCases = [];
                updateSelectedCases('player');
                updateTotalCost('player');
                document.getElementById('createForm').style.display = 'none';
                document.getElementById('charityMode').checked = false;
                isCharityMode = false;
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–∞—Ç—Ç–ª–∞:", err);
                alert(err.message || "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–∞—Ç—Ç–ª–∞");
            }
        }

        function subscribeToBattle(battleId) {
            onSnapshot(doc(db, 'battles', battleId), async (snap) => {
                try {
                    const data = snap.data();
                    if (!data) return;

                    const statusDiv = document.getElementById('status');
                    statusDiv.innerHTML = '';

                    if (data.status === 'open') {
                        statusDiv.innerHTML = `<div style="color:#fbbf24;">–ë–∞—Ç—Ç–ª —Å–æ–∑–¥–∞–Ω! –û–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞...</div>`;
                    } else if (data.status === 'started') {
                        statusDiv.innerHTML = `<div style="color:#34d399;">–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è! –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–µ–π—Å–æ–≤...</div>`;
                        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ –ª—é–±—ã–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–º
                        if (data.player1Items.length === 0 && (userId === data.player1 || userId === data.player2)) {
                            try {
                                await runTransaction(db, async (tx) => {
                                    const freshRef = snap.ref;
                                    const freshSnap = await tx.get(freshRef);
                                    const freshData = freshSnap.data();
                                    if (!freshData) return;
                                    if (freshData.status !== 'started') return;
                                    if ((freshData.player1Items || []).length > 0 || (freshData.player2Items || []).length > 0) return;
                                    const p1Items = freshData.caseTypes.map(type => openCase(type));
                                    const p1Total = p1Items.reduce((sum, item) => sum + item.value, 0);
                                    const p2Items = freshData.caseTypes.map(type => openCase(type));
                                    const p2Total = p2Items.reduce((sum, item) => sum + item.value, 0);
                                    const winner = p1Total > p2Total ? freshData.player1 : (p2Total > p1Total ? freshData.player2 : null);
                                    tx.update(freshRef, {
                                        player1Items: p1Items.map(item => ({emoji: item.emoji, name: item.name, value: item.value})),
                                        player2Items: p2Items.map(item => ({emoji: item.emoji, name: item.name, value: item.value})),
                                        player1Total: p1Total,
                                        player2Total: p2Total,
                                        winner: winner,
                                        finishedAt: Date.now(),
                                        status: 'finished'
                                    });
                                });
                            } catch (e) {}
                        }
                    } else if (data.status === 'finished') {
                        const p1Total = data.player1Total;
                        const p2Total = data.player2Total;
                        let winner = null;
                        if (p1Total > p2Total) winner = data.player1;
                        else if (p2Total > p1Total) winner = data.player2;

                        const isPlayer1 = userId === data.player1;
                        const myItems = isPlayer1 ? data.player1Items : data.player2Items;
                        const oppItems = isPlayer1 ? data.player2Items : data.player1Items;
                        const myTotal = isPlayer1 ? p1Total : p2Total;
                        const oppTotal = isPlayer1 ? p2Total : p1Total;
                        const opponentName = isPlayer1 ? data.player2Name : data.player1Name;
                        const myClaimed = isPlayer1 ? data.player1Claimed : data.player2Claimed;
                        const mySaved = isPlayer1 ? data.player1Saved : data.player2Saved;
                        const oppClaimed = isPlayer1 ? data.player2Claimed : data.player1Claimed;
                        const oppSaved = isPlayer1 ? data.player2Saved : data.player1Saved;

                        let resultText = '';
                        let prize = 0;
                        if (winner === userId) {
                            prize = myTotal + oppTotal;
                            resultText = `<span style="color:#34d399">–ü–æ–±–µ–¥–∞! –ü—Ä–∏–∑: ${prize}‚ÇΩ</span>`;
                        } else if (winner) {
                            resultText = `<span style="color:#f87171">–ü—Ä–æ–∏–≥—Ä—ã—à</span>`;
                        } else {
                            prize = myTotal;
                            resultText = `–ù–∏—á—å—è ‚Äî –∑–∞–±–∏—Ä–∞–µ—à—å —Å–≤–æ–∏ ${prize}‚ÇΩ`;
                        }

                        statusDiv.innerHTML = `
                            <div class="open-results">
                                <div class="player-opens">
                                    <h4>–í–∞—à–∏ (<span class="nickname">${currentUser.username}</span>):</h4>
                                    <div class="case-opening-container" id="myBattleCases"></div>
                                    <div class="total-value">–ò—Ç–æ–≥–æ: ${myTotal}‚ÇΩ</div>
                                </div>
                                <div class="opponent-opens">
                                    <h4>${opponentName || '–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫'}:</h4>
                                    <div class="case-opening-container" id="oppBattleCases"></div>
                                    <div class="total-value">–ò—Ç–æ–≥–æ: ${oppTotal}‚ÇΩ</div>
                                </div>
                            </div>
                            <div id="battleResultText" style="text-align:center; margin-top:12px;">${resultText}</div>
                            <div style="display:flex; gap:10px; justify-content:center; margin-top:12px;">
                              <button class="btn" id="sellItemsBtn" style="background: linear-gradient(135deg, #34d399, #059669);">–ü—Ä–æ–¥–∞—Ç—å —Å—Ä–∞–∑—É</button>
                              <button class="btn" id="stashItemsBtn" style="background: linear-gradient(135deg, #a855f7, #7e22ce);">–û—Ç–ª–æ–∂–∏—Ç—å –≤—Å—ë</button>
                            </div>
                        `;

                        await animateBatchedOpenings('myBattleCases', data.caseTypes, myItems, myTotal, 'my', false);
                        await animateBatchedOpenings('oppBattleCases', data.caseTypes, oppItems, oppTotal, 'opp', false);

                        const sellBtn = document.getElementById('sellItemsBtn');
                        const stashBtn = document.getElementById('stashItemsBtn');
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–µ—Ä–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –ø–æ—Ä–∞–∂–µ–Ω–∏–∏ –∏–ª–∏ –µ—Å–ª–∏ —É–∂–µ –±—ã–ª–æ –¥–µ–π—Å—Ç–≤–∏–µ
                        if (sellBtn && stashBtn) {
                            const iLost = !!winner && winner !== userId;
                            const iDone = !!myClaimed || !!mySaved;
                            if (iLost || iDone) {
                                sellBtn.disabled = true;
                                stashBtn.disabled = true;
                                sellBtn.style.background = '#6b7280';
                                stashBtn.style.background = '#6b7280';
                                sellBtn.style.cursor = 'not-allowed';
                                stashBtn.style.cursor = 'not-allowed';
                            }
                        }
                        if (sellBtn) {
                            sellBtn.onclick = async () => {
                                sellBtn.disabled = true;
                                stashBtn.disabled = true;
                                const claimedField = isPlayer1 ? 'player1Claimed' : 'player2Claimed';
                                const savedField = isPlayer1 ? 'player1Saved' : 'player2Saved';
                                try {
                                    await runTransaction(db, async (tx) => {
                                        const freshBattle = await tx.get(snap.ref);
                                        const fData = freshBattle.data();
                                        if (!fData) return;
                                        if (fData[claimedField] || fData[savedField]) {
                                            statusDiv.innerHTML += '<div style="color:#f87171; text-align:center; padding:10px;">–î–µ–π—Å—Ç–≤–∏–µ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.</div>';
                                            return;
                                        }
                                        if (prize > 0) {
                                            const userRef = doc(db, 'users', userId);
                                            const userSnap = await tx.get(userRef);
                                            const uData = userSnap.data() || {};
                                            const newBalance = (uData.balance || 0) + prize;
                                            tx.update(userRef, { balance: newBalance });
                                            tx.update(snap.ref, { [claimedField]: true });
                                            currentUser.balance = newBalance;
                                            updateBalance();
                                            statusDiv.innerHTML += `<div style="text-align:center; padding:12px; color:#a78bfa;">–ü—Ä–æ–¥–∞–∂–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ (+${prize}‚ÇΩ)</div>`;
                                        } else {
                                            statusDiv.innerHTML += `<div style="text-align:center; padding:12px; color:#f87171;">–ü—Ä–æ–¥–∞—Ç—å –Ω–µ—á–µ–≥–æ</div>`;
                                        }
                                    });
                                } catch (e) {}
                            };
                        }
                        if (stashBtn) {
                            stashBtn.onclick = async () => {
                                stashBtn.disabled = true;
                                sellBtn.disabled = true;
                                const claimedField = isPlayer1 ? 'player1Claimed' : 'player2Claimed';
                                const savedFlagField = isPlayer1 ? 'player1Saved' : 'player2Saved';
                                try {
                                    await runTransaction(db, async (tx) => {
                                        const freshBattle = await tx.get(snap.ref);
                                        const fData = freshBattle.data();
                                        if (!fData) return;
                                        if (fData[savedFlagField] || fData[claimedField]) {
                                            statusDiv.innerHTML += '<div style="color:#fbbf24; text-align:center; padding:10px;">–î–µ–π—Å—Ç–≤–∏–µ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.</div>';
                                            return;
                                        }
                                        const itemsToSave = winner === userId ? myItems.concat(oppItems) : myItems;
                                        const userRef = doc(db, 'users', userId);
                                        const userSnap = await tx.get(userRef);
                                        const userData = userSnap.data() || {};
                                        const inventory = Array.isArray(userData.inventory) ? userData.inventory : [];
                                        const newItems = itemsToSave.filter(it => !inventory.some(e =>
                                            e.battleId === snap.id && e.name === it.name && e.value === it.value
                                        )).map(it => ({
                                            id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString() + Math.random().toString(16).slice(2)),
                                            emoji: it.emoji,
                                            name: it.name,
                                            value: it.value,
                                            source: '–ë–∞—Ç—Ç–ª',
                                            battleId: snap.id,
                                            timestamp: Date.now()
                                        }));
                                        const updatedInv = inventory.concat(newItems);
                                        tx.update(userRef, { inventory: updatedInv });
                                        tx.update(snap.ref, { [savedFlagField]: true });
                                        currentUser.inventory = updatedInv;
                                        statusDiv.innerHTML += `<div style="text-align:center; padding:12px; color:#a78bfa;">–û—Ç–ª–æ–∂–µ–Ω–æ: ${newItems.length} –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>`;
                                    });
                                } catch (e) {}
                            };
                        }
                        // –ê–≤—Ç–æ–≤—ã–¥–∞—á–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª—é, –µ—Å–ª–∏ –Ω–∏–∫—Ç–æ –Ω–µ –≤—ã–ø–æ–ª–Ω–∏–ª –¥–µ–π—Å—Ç–≤–∏–µ
                        if (winner && !data.player1Saved && !data.player1Claimed && !data.player2Saved && !data.player2Claimed) {
                            const winnerId = winner;
                            const winnerItems = winnerId === data.player1
                                ? (data.player1Items || []).concat(data.player2Items || [])
                                : (data.player2Items || []).concat(data.player1Items || []);
                            const winnerFlagField = winnerId === data.player1 ? 'player1Saved' : 'player2Saved';
                            try {
                                await runTransaction(db, async (tx) => {
                                    const freshBattle = await tx.get(snap.ref);
                                    const fData = freshBattle.data();
                                    if (!fData) return;
                                    if (fData.player1Saved || fData.player1Claimed || fData.player2Saved || fData.player2Claimed) return;
                                    const wRef = doc(db, 'users', winnerId);
                                    const wSnap = await tx.get(wRef);
                                    const wData = wSnap.data() || {};
                                    const inv = Array.isArray(wData.inventory) ? wData.inventory : [];
                                    const newItems = winnerItems.filter(it => !inv.some(e =>
                                        e.battleId === snap.id && e.name === it.name && e.value === it.value
                                    )).map(it => ({
                                        id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString() + Math.random().toString(16).slice(2)),
                                        emoji: it.emoji,
                                        name: it.name,
                                        value: it.value,
                                        source: '–ë–∞—Ç—Ç–ª',
                                        battleId: snap.id,
                                        timestamp: Date.now()
                                    }));
                                    const updatedInv = inv.concat(newItems);
                                    tx.update(wRef, { inventory: updatedInv });
                                    tx.update(snap.ref, { [winnerFlagField]: true });
                                });
                            } catch (e) {}
                        }
                    }
                } catch (err) {
                    console.error("–û—à–∏–±–∫–∞ –≤ onSnapshot –±–∞—Ç—Ç–ª–∞:", err);
                    document.getElementById('status').textContent = "–û—à–∏–±–∫–∞ –æ–Ω–ª–∞–π–Ω-–±–∞—Ç—Ç–ª–∞.";
                }
            });
        }

        async function loadBattles() {
            try {
                const q = query(collection(db, 'battles'), where('status', '==', 'open'));
                onSnapshot(q, (querySnap) => {
                    const listDiv = document.getElementById('battleList');
                    listDiv.innerHTML = '';
                    if (querySnap.empty) {
                        listDiv.innerHTML = '<div>–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –±–∞—Ç—Ç–ª–æ–≤</div>';
                        return;
                    }
                    querySnap.forEach(snap => {
                        const data = snap.data();
                        const priceText = data.isCharity
                            ? '<span class="battle-price free">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>'
                            : `<span class="battle-price paid">${data.totalCost}‚ÇΩ</span>`;

                        const charityBadge = data.isCharity
                            ? '<span class="charity-label">–ë–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–π</span>'
                            : '';

                        const div = document.createElement('div');
                        div.className = 'battle-item';
                        div.innerHTML = `
                            <div>–°–æ–∑–¥–∞—Ç–µ–ª—å: <span class="nickname">${data.creatorName || '???'}</span> ${charityBadge}</div>
                            <div>–ö–µ–π—Å—ã: ${data.caseTypes.map(t => `${caseDisplayNames[t] || t} (${cases[t]?.price || '?'}‚ÇΩ)`).join(', ')}</div>
                            <div>${priceText}</div>
                            <button class="join-btn" data-battle-id="${snap.id}">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
                        `;
                        if (data.creator === userId) {
                            const delBtn = document.createElement('button');
                            delBtn.className = 'delete-battle-btn';
                            delBtn.innerHTML = 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å';
                            delBtn.onclick = () => deleteBattle(snap.id);
                            div.appendChild(delBtn);
                        }
                        listDiv.appendChild(div);
                    });
                    document.querySelectorAll('.join-btn').forEach(btn => {
                        btn.addEventListener('click', () => joinBattle(btn.dataset.battleId));
                    });
                });
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –±–∞—Ç—Ç–ª–æ–≤:", err);
                document.getElementById('battleList').innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞—Ç—Ç–ª–æ–≤.";
            }
        }

        async function joinBattle(battleId) {
            try {
                if (isGuest || !userId) throw new Error('–¢–æ–ª—å–∫–æ –¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö');
                const battleRef = doc(db, 'battles', battleId);
                await runTransaction(db, async (tx) => {
                    const bSnap = await tx.get(battleRef);
                    const data = bSnap.data();
                    if (!data || data.status !== 'open') throw new Error('–ë–∞—Ç—Ç–ª —É–∂–µ –∑–∞–∫—Ä—ã—Ç');
                    if (data.creator === userId) throw new Error('–ù–µ–ª—å–∑—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —Å–≤–æ–µ–º—É –±–∞—Ç—Ç–ª—É');
                    if (data.player2) throw new Error('–ë–∞—Ç—Ç–ª —É–∂–µ –∑–∞–Ω—è—Ç');
                    if (!data.isCharity) {
                        const userRef = doc(db, 'users', userId);
                        const uSnap = await tx.get(userRef);
                        const uData = uSnap.data() || {};
                        const totalCost = data.totalCost;
                        if ((uData.balance || 0) < totalCost) throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
                        tx.update(userRef, { balance: (uData.balance || 0) - totalCost });
                        currentUser.balance = (uData.balance || 0) - totalCost;
                        updateBalance();
                    }
                    tx.update(battleRef, {
                        player2: userId,
                        player2Name: currentUser.username,
                        status: 'started'
                    });
                });
                subscribeToBattle(battleId);
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:", err);
                alert(err.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è");
            }
        }

        async function awardPendingForUser() {
            try {
                if (!userId || isGuest) return;
                const myBattles1 = query(collection(db, 'battles'), where('player1', '==', userId), where('status', '==', 'finished'));
                const myBattles2 = query(collection(db, 'battles'), where('player2', '==', userId), where('status', '==', 'finished'));
                const [snap1, snap2] = await Promise.all([getDocs(myBattles1), getDocs(myBattles2)]);
                const processBattle = async (snap) => {
                    const data = snap.data();
                    if (!data) return;
                    const isP1 = data.player1 === userId;
                    const mySaved = isP1 ? data.player1Saved : data.player2Saved;
                    const myClaimed = isP1 ? data.player1Claimed : data.player2Claimed;
                    if (mySaved || myClaimed) return;
                    const myTotal = isP1 ? data.player1Total : data.player2Total;
                    const oppTotal = isP1 ? data.player2Total : data.player1Total;
                    const myItems = isP1 ? data.player1Items || [] : data.player2Items || [];
                    const oppItems = isP1 ? data.player2Items || [] : data.player1Items || [];
                    const iWin = data.winner === userId;
                    const isDraw = !data.winner;
                    const itemsToSave = iWin ? myItems.concat(oppItems) : (isDraw ? myItems : []);
                    if (itemsToSave.length === 0) return;
                    await runTransaction(db, async (tx) => {
                        const userRef = doc(db, 'users', userId);
                        const uSnap = await tx.get(userRef);
                        const uData = uSnap.data() || {};
                        const inventory = Array.isArray(uData.inventory) ? uData.inventory : [];
                        const newItems = itemsToSave.filter(it => !inventory.some(e =>
                            e.battleId === snap.id && e.name === it.name && e.value === it.value
                        )).map(it => ({
                            id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString() + Math.random().toString(16).slice(2)),
                            emoji: it.emoji,
                            name: it.name,
                            value: it.value,
                            source: '–ë–∞—Ç—Ç–ª',
                            battleId: snap.id,
                            timestamp: Date.now()
                        }));
                        const updatedInv = inventory.concat(newItems);
                        tx.update(userRef, { inventory: updatedInv });
                        tx.update(doc(db, 'battles', snap.id), { [isP1 ? 'player1Saved' : 'player2Saved']: true });
                        currentUser.inventory = updatedInv;
                    });
                };
                const promises = [];
                snap1.forEach(s => promises.push(processBattle(s)));
                snap2.forEach(s => promises.push(processBattle(s)));
                await Promise.all(promises);
            } catch (e) {}
        }

        async function deleteBattle(battleId) {
            try {
                const battleRef = doc(db, 'battles', battleId);
                const battleSnap = await getDoc(battleRef);
                const data = battleSnap.data();
                if (!data || data.creator !== userId || data.status !== 'open') {
                    throw new Error('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –±–∞—Ç—Ç–ª');
                }
                const refund = data.creatorPaid || data.totalCost;
                currentUser.balance += refund;
                await saveUser();
                updateBalance();
                await deleteDoc(battleRef);
                alert(`–ë–∞—Ç—Ç–ª —É–¥–∞–ª—ë–Ω, –≤–æ–∑–≤—Ä–∞—â–µ–Ω–æ ${refund}‚ÇΩ`);
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:", err);
                alert(err.message || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –±–∞—Ç—Ç–ª–∞");
            }
        }

document.addEventListener('DOMContentLoaded', () => {
    createParticles();
    loadCurrentUser();

    renderCaseGrid('botCaseGrid', type => addSelectedCase('bot', type));
    renderCaseGrid('playerCaseGrid', type => addSelectedCase('player', type));

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤
    const vsBotBtn      = document.getElementById('vsBotBtn');
    const vsPlayerBtn   = document.getElementById('vsPlayerBtn');
    const botSection    = document.getElementById('vsBotSection');
    const playerSection = document.getElementById('vsPlayerSection');

    function setBotMode() {
        vsBotBtn.classList.add('active');
        vsPlayerBtn.classList.remove('active');
        botSection.style.display = 'block';
        playerSection.style.display = 'none';
    }

    function setPlayerMode() {
        if (isGuest) {
            alert('–¢–æ–ª—å–∫–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∏–≥—Ä–∞—Ç—å Vs –ò–≥—Ä–æ–∫');
            return;
        }
        vsPlayerBtn.classList.add('active');
        vsBotBtn.classList.remove('active');
        botSection.style.display = 'none';
        playerSection.style.display = 'block';
        loadBattles();
    }

    vsBotBtn.addEventListener('click', setBotMode);
    vsPlayerBtn.addEventListener('click', setPlayerMode);
    setBotMode(); // –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

    // ‚îÄ‚îÄ‚îÄ –ö–Ω–æ–ø–∫–∏ "–ò–≥—Ä–∞—Ç—å" –∏ "–ë—ã—Å—Ç—Ä–æ" ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const playBtn = document.getElementById('playVsBot');
    const quickBtn = document.getElementById('quickVsBot');

    if (playBtn) {
        // –ö–ª–æ–Ω–∏—Ä—É–µ–º ‚Üí —É–±–∏—Ä–∞–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏
        const cleanPlay = playBtn.cloneNode(true);
        playBtn.parentNode.replaceChild(cleanPlay, playBtn);
        cleanPlay.addEventListener('click', () => playVsBot(false));
    }

    if (quickBtn) {
        const cleanQuick = quickBtn.cloneNode(true);
        quickBtn.parentNode.replaceChild(cleanQuick, quickBtn);
        cleanQuick.addEventListener('click', () => playVsBot(true));
    }

    // –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏
    document.getElementById('createBattleBtn')?.addEventListener('click', () => {
        document.getElementById('createForm').style.display = 'block';
    });

    document.getElementById('confirmCreate')?.addEventListener('click', createBattle);

    document.getElementById('charityMode')?.addEventListener('change', e => {
        isCharityMode = e.target.checked;
        updateTotalCost('player');
    });

    // –∫–Ω–æ–ø–∫–∞ —à–∞–Ω—Å–æ–≤
    document.getElementById('showChancesBtn')?.addEventListener('click', () => {
        const modal = document.getElementById('chancesModal');
        const content = document.getElementById('chancesContent');
        if (!modal || !content) return;

        content.innerHTML = '';
        sortedCaseKeys.forEach(key => {
            const c = cases[key];
            let html = `<div style="margin:14px 0; padding:14px; background:rgba(35,30,60,0.65); border-radius:10px; border-left:4px solid ${c.color}">
                <h3 style="margin:0 0 10px; color:${c.color}">${caseDisplayNames[key] || key} ‚Äî ${c.price}‚ÇΩ</h3>`;

            c.items.forEach(it => {
                const percent = (it.prob * 100).toFixed(2).replace(/\.?0+$/, "");
                html += `<div style="display:flex; justify-content:space-between; margin:5px 0; font-size:0.96rem;">
                    <span>${it.emoji} ${it.name}</span>
                    <span style="color:#fde047; font-weight:600;">${it.value}‚ÇΩ ‚Äî ${percent}%</span>
                </div>`;
            });
            html += '</div>';
            content.innerHTML += html;
        });
        modal.style.display = 'flex';
    });

    document.getElementById('closeChances')?.addEventListener('click', () => {
        document.getElementById('chancesModal').style.display = 'none';
    });
});
    </script>
</body>
</html>
