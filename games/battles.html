<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>–ë–∞—Ç—Ç–ª—ã –ö–µ–π—Å–æ–≤ | DropWin</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        /* ... existing styles ... */
        .mode-select {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin: 16px 0;
        }
        /* Re-added Mode Button Styles */
        .mode-btn {
            padding: 10px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            background: rgba(139, 92, 246, 0.1);
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.3);
            transition: all 0.2s ease;
        }
        .mode-btn:hover { background: rgba(139, 92, 246, 0.2); color: white; transform: translateY(-2px); }
        .mode-btn.active {
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        /* New Battle Card Styles */
        .battle-card {
            background: rgba(30, 27, 46, 0.7);
            border: 1px solid rgba(139, 92, 246, 0.15);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        .battle-card:hover {
            border-color: #8b5cf6;
            box-shadow: 0 12px 35px rgba(139, 92, 246, 0.25);
            transform: translateY(-2px);
        }
        
        .battle-round {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #4c1d95;
            background: rgba(76, 29, 149, 0.3);
            flex-shrink: 0;
        }
        .round-num { font-size: 1.2rem; font-weight: 800; color: #fff; }
        .round-label { font-size: 0.6rem; color: #a78bfa; text-transform: uppercase; }

        .battle-cases {
            flex: 1;
            display: flex;
            gap: 4px;
            overflow-x: auto;
            padding: 4px 0;
            scrollbar-width: none;
        }
        .battle-cases::-webkit-scrollbar { display: none; }
        
        .battle-case-img {
            width: 48px;
            height: 48px;
            object-fit: contain;
            transition: transform 0.2s;
            will-change: transform;
            backface-visibility: hidden;
        }
        .battle-case-img:hover { transform: scale(1.1); }

        .battle-info-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            min-width: 100px;
        }
        .battle-price-tag {
            background: rgba(251, 191, 36, 0.1);
            color: #fbbf24;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.95rem;
            white-space: nowrap;
        }
        .battle-users {
            display: flex;
            align-items: center;
        }
        .battle-user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #1e1b2e;
            background: #2a2640;
            margin-left: -10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #ccc;
            overflow: hidden;
        }
        .battle-user-avatar:first-child { margin-left: 0; }
        .battle-user-avatar img { width: 100%; height: 100%; object-fit: cover; }

        .battle-action-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            transition: all 0.2s;
            will-change: transform;
            backface-visibility: hidden;
        }
        .battle-action-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(59, 130, 246, 0.5); }
        .battle-action-btn.delete { background: linear-gradient(135deg, #ef4444, #dc2626); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); }

        @media (max-width: 480px) {
            .case-select-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }
            .case-card .price {
                font-size: 0.85rem !important;
                padding: 4px 0 !important;
            }
            .case-image-wrap {
                min-height: 100px !important;
            }
            .battle-card { flex-wrap: wrap; gap: 12px; }
            .battle-cases { width: 100%; order: 3; margin-top: 5px; justify-content: center; }
            .battle-info-right { flex-direction: row; justify-content: space-between; width: 100%; align-items: center; order: 2; }
            .battle-round { order: 1; }
        }
        
        /* ... existing styles ... */
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            background: linear-gradient(135deg, #6d28d9, #4c1d95);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(167, 139, 250, 0.4);
            transition: all 0.3s ease;
        }
        .mode-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(167, 139, 250, 0.6); }
        .mode-btn.active {
            background: linear-gradient(135deg, #a855f7, #8b5cf6);
            box-shadow: 0 6px 16px rgba(192, 132, 252, 0.6);
        }

        .case-select-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }
        .case-card {
            background: rgba(30, 27, 46, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 18px;
            cursor: pointer;
            overflow: hidden;
            box-shadow: 0 4px 18px rgba(0,0,0,0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(139, 92, 246, 0.2);
            /* aspect-ratio removed to allow content to dictate height */
            contain: paint;
            will-change: transform;
        }
        .case-card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: #8b5cf6;
            box-shadow: 0 12px 30px rgba(139, 92, 246, 0.3);
            background: rgba(30, 27, 46, 0.8);
        }
        .case-image-wrap {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px 0;
            background: radial-gradient(circle at center, rgba(139, 92, 246, 0.15), transparent 70%);
            overflow: hidden;
            min-height: 190px; /* Taller for –≤–µ—Ä—Ç–∏–∫–∞–ª—å */
        }
        .case-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
            position: absolute;
            top: 0;
            left: 0;
            will-change: transform;
            backface-visibility: hidden;
        }
        .case-card:hover img {
            transform: scale(1.08) rotate(2deg);
            filter: drop-shadow(0 0 15px rgba(139, 92, 246, 0.5));
        }
        .case-card.selected {
            border: 3px solid #d946ef;
            transform: scale(1.03);
            box-shadow: 0 0 25px #d946ef88;
        }
        .case-info {
            padding: 12px;
            background: rgba(15, 11, 21, 0.4);
            border-top: 1px solid rgba(255,255,255,0.05);
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: center;
        }
        .case-card .name {
            font-weight: 700; color: white;
            font-size: 1.1rem;
            text-align: center;
            line-height: 1.2;
            margin: 0;
            text-shadow: none;
        }
        .case-card .item-count {
            color: #64748b;
            font-size: 0.8rem;
            font-weight: 500;
            background: transparent;
            padding: 0;
            backdrop-filter: none;
        }
        .case-card .price {
            background: linear-gradient(135deg, #fbbf24, #d97706);
            color: #000;
            font-weight: 800;
            padding: 6px 14px;
            border-radius: 8px;
            display: inline-block;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
            font-size: 0.95rem;
            width: auto;
            margin-top: 4px;
        }

        .open-results {
            display: flex;
            justify-content: space-between;
            gap: 24px;
            margin: 24px 0;
            flex-wrap: wrap;
        }
        .player-opens, .opponent-opens {
            flex: 1;
            min-width: 300px;
            background: rgba(30, 30, 50, 0.75);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
        }
        .player-opens   { border: 2px solid #8b5cf6; }
        .opponent-opens { border: 2px solid #5b21b6; }

        .case-opening-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            min-height: 160px;
        }

        .case-box {
            width: 110px;
            height: 110px;
            background-size: cover;
            background-position: center;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 6px 18px rgba(0,0,0,0.6);
            border: 2px solid rgba(139, 92, 246, 0.25);
            opacity: 0;
            transform: scale(0.92);
            transition: opacity 0.5s ease, transform 0.5s ease;
            margin: 4px;
        }

        .case-box.visible {
            opacity: 1;
            transform: scale(1);
        }

        .case-box.revealed {
            transform: scale(1.12);
            box-shadow: 0 0 32px rgba(168, 85, 247, 0.85);
            border-color: #8b5cf6;
        }

        .case-box.opening {
            animation: dramaticOpen 0.4s ease-out forwards;
            will-change: transform, opacity, filter;
        }

        @keyframes dramaticOpen {
            0%   { transform: scale(0.75) rotate(-10deg); filter: brightness(0.7); }
            50%  { transform: scale(1.15) rotate(5deg);   filter: brightness(1.3); }
            100% { transform: scale(1.1) rotate(0deg);    filter: brightness(1.2);  }
        }

        .item-reveal {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3.6rem;
            opacity: 0;
            text-shadow: 0 0 16px rgba(0,0,0,0.9);
            animation: popIn 0.3s ease-out forwards;
            animation-delay: 0.2s;
            z-index: 2;
        }

        .dim-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.35);
            opacity: 0;
            animation: fadeInDim 0.25s ease forwards;
            z-index: 1;
        }

        @keyframes popIn {
            0%   { transform: translate(-50%, -50%) scale(0.4) rotate(-60deg); opacity: 0; }
            70%  { transform: translate(-50%, -50%) scale(1.3) rotate(10deg); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg);     opacity: 1; }
        }

        @keyframes fadeInDim {
            100% { opacity: 1; }
        }

        /* Mobile & Retina Optimizations */
        @media (min-width: 320px) {
            html { font-size: 16px; }
            .btn, .join-btn, .mode-btn, .battle-action-btn {
                min-height: 48px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                touch-action: manipulation;
            }
        }

        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .case-box { image-rendering: -webkit-optimize-contrast; }
            .battle-case-img { image-rendering: -webkit-optimize-contrast; }
        }

        .roulette-wrap {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            border-radius: 12px;
        }
        .roulette-strip {
            position: absolute;
            left: 0;
            top: 0;
            display: flex;
            gap: 6px;
            padding: 8px;
            will-change: transform;
        }
        .roulette-item {
            flex: 0 0 110px;
            height: 110px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.06);
            border-radius: 10px;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08), 0 4px 12px rgba(0,0,0,0.3);
            color: #fff;
            font-size: 2.4rem;
            user-select: none;
        }
        .roulette-marker {
            position: absolute;
            top: 6px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: calc(100% - 12px);
            background: linear-gradient(180deg, #fbbf24, #d97706);
            box-shadow: 0 0 12px rgba(251, 191, 36, 0.7);
            border-radius: 2px;
        }

        /* Result Modal Styles */
        .result-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .result-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .result-modal {
            background: linear-gradient(145deg, #1e1b2e, #2d2a4a);
            border: 2px solid #8b5cf6;
            border-radius: 24px;
            padding: 32px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 0 50px rgba(139, 92, 246, 0.4);
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .result-modal-overlay.active .result-modal {
            transform: scale(1);
        }
        .result-emoji { font-size: 4rem; margin-bottom: 16px; display: block; }
        .result-title { font-size: 1.8rem; font-weight: 800; margin-bottom: 8px; color: white; }
        .result-prize { font-size: 2.2rem; font-weight: 900; color: #fbbf24; text-shadow: 0 0 20px rgba(251, 191, 36, 0.4); margin-bottom: 24px; }
        .result-actions { display: flex; flex-direction: column; gap: 12px; }


        .value-label {
            position: absolute;
            top: 8px; left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: #fde047;
            padding: 5px 12px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.1rem;
            display: none;
            box-shadow: 0 2px 8px black;
            z-index: 3;
        }
        .case-box.revealed .value-label { display: block; }

        .remove-btn {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            color: white;
            padding: 6px 14px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            margin-left: 12px;
            transition: all 0.2s;
        }
        .remove-btn:hover { transform: scale(1.08); box-shadow: 0 0 14px #ef444499; }

        .claim-btn {
            background: linear-gradient(135deg, #34d399, #059669);
            color: white;
            padding: 14px 36px;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            font-weight: 800;
            margin: 24px auto;
            display: block;
            box-shadow: 0 6px 20px rgba(16,185,129,0.6);
            transition: all 0.3s;
        }
        .claim-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 32px rgba(16,185,129,0.8); }
        .claim-btn.disabled { background: #4b5563; cursor: not-allowed; box-shadow: none; }

        .btn, .join-btn {
            padding: 12px 28px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            border: none;
            transition: all 0.25s;
            will-change: transform;
            backface-visibility: hidden;
        }
        .btn { background: linear-gradient(135deg, #a855f7, #7e22ce); color: white; box-shadow: 0 5px 16px #a855f755; }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 10px 24px #a855f788; }

        .join-btn { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; box-shadow: 0 4px 14px #3b82f655; }
        .join-btn:hover { transform: scale(1.07); box-shadow: 0 8px 20px #3b82f688; }

      .battle-item {
    background: rgba(45, 40, 75, 0.85);
    border-radius: 16px;
    padding: 16px;
    margin: 12px 0;
    border-left: 5px solid #8b5cf6;
    font-size: 0.95rem;
}

.battle-item > div {
    margin: 8px 0;
}

.battle-item .nickname {
    color: #c084fc;
    font-weight: 700;
}

.battle-price {
    font-size: 1.25rem;
    font-weight: 800;
}

@media (max-width: 480px) {
    .battle-item {
        padding: 14px;
        font-size: 0.92rem;
    }
    .join-btn, .delete-battle-btn {
        width: 100%;
        margin-top: 12px;
        padding: 12px;
    }
    .battle-item > div {
        font-size: 0.9rem;
    }
}

        .nickname { color: #c084fc; font-weight: bold; }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>

    <div class="header">
        <div class="logo" onclick="location.href='../index.html'" style="cursor: pointer;">üíé DROPWIN</div>
        <button class="hamburger" id="hamburgerBtn"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>
        <div class="balance-container">
            <div class="balance">üí∞ <span id="balance">0</span>‚ÇΩ</div>
            <button class="auth-btn" id="authBtn">–ê–∫–∫–∞—É–Ω—Ç</button>
            <button class="auth-btn" onclick="window.open('https://t.me/DropWinHelp_bot','_blank')">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</button>
        </div>
    </div>
    <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
    <div class="mobile-drawer" id="mobileDrawer">
        <a href="../inventory.html"><span>üéí</span> –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</a>
        <a href="../leaderboard.html"><span>üèÜ</span> –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤</a>
        <a href="../raffles.html"><span>üéÅ</span> –†–æ–∑—ã–≥—Ä—ã—à–∏</a>
        <a href="../freebet.html"><span>‚ö°</span> –ë–æ–Ω—É—Å—ã</a>
        <a href="../profile.html"><span>üë§</span> –ü—Ä–æ—Ñ–∏–ª—å</a>
        <a href="https://t.me/DropWinHelp_bot" target="_blank"><span>üí¨</span> –ü–æ–¥–¥–µ—Ä–∂–∫–∞</a>
    </div>

    <div class="content">
        <button class="back-btn" onclick="location.href='../index.html'">‚Üê –ù–∞–∑–∞–¥</button>

        <div class="game-card">
            <div class="game-title">‚öîÔ∏è –ë–∞—Ç—Ç–ª—ã –ö–µ–π—Å–æ–≤</div>

            <div class="mode-select">
                <button class="mode-btn active" id="vsBotBtn">Vs –ë–æ—Ç</button>
                <button class="mode-btn" id="vsPlayerBtn">Vs –ò–≥—Ä–æ–∫</button>
            </div>
<button id="showChancesBtn" title="–®–∞–Ω—Å—ã –≤—ã–ø–∞–¥–µ–Ω–∏—è –∏–∑ –∫–µ–π—Å–æ–≤" style="
    position: absolute;
    top: 14px;
    right: 16px;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #64748b, #475569);
    color: white;
    font-size: 1.2rem;
    line-height: 36px;
    text-align: center;
    border: none;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    transition: all 0.18s ease;
    z-index: 5;
  ">‚ÑπÔ∏è</button>

<div id="chancesModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.88); z-index:9999; justify-content:center; align-items:center;">
        <div style="background:#1e1b32; border-radius:16px; padding:20px; max-width:92%; max-height:90vh; overflow-y:auto; border:2px solid #8b5cf6; box-shadow:0 0 40px #8b5cf655;">
            <h2 style="text-align:center; margin:0 0 20px; color:#c4b5fd;">–®–∞–Ω—Å—ã –≤—ã–ø–∞–¥–µ–Ω–∏—è</h2>
            <div id="chancesContent"></div>
            <button class="btn" id="closeChances" style="margin:20px auto 8px; display:block; min-width:140px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    <div id="resultModalOverlay" class="result-modal-overlay">
        <div class="result-modal" id="resultModal">
            <div id="resultModalContent"></div>
            <button class="btn" style="margin-top:16px; width:100%; background: #4b5563;" onclick="closeResultModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
            <div id="vsBotSection">
                <div class="case-select-grid" id="botCaseGrid"></div>
                <div class="selected-cases" id="selectedBotCases"></div>
                <div id="botTotalCost" style="text-align:center; margin:12px 0; font-size:1.3rem;">–ò—Ç–æ–≥–æ: 0‚ÇΩ</div>
                <button class="btn" id="playVsBot">–ò–≥—Ä–∞—Ç—å</button>
                <button class="btn" id="quickVsBot" style="background: linear-gradient(135deg, #fbbf24, #d97706);">–ë—ã—Å—Ç—Ä–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ</button>
                <div id="botResults" style="margin-top:24px;"></div>
            </div>

            <div id="vsPlayerSection" style="display:none;">
                <button class="btn" id="createBattleBtn">–°–æ–∑–¥–∞—Ç—å –±–∞—Ç—Ç–ª</button>

                <div class="battle-form" id="createForm" style="display:none;">
                    <div class="charity-toggle">
                        <input type="checkbox" id="charityMode">
                        <label for="charityMode">–ë–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –±–∞—Ç—Ç–ª (–æ–ø–ª–∞—á–∏–≤–∞—é –∑–∞ –¥–≤–æ–∏—Ö)</label>
                    </div>

                    <div class="case-select-grid" id="playerCaseGrid"></div>
                    <div class="selected-cases" id="selectedPlayerCases"></div>
                    <div id="playerTotalCost" style="text-align:center; margin:16px 0; font-size:1.4rem;">–ò—Ç–æ–≥–æ: 0‚ÇΩ</div>
                    <button class="btn" id="confirmCreate">–°–æ–∑–¥–∞—Ç—å</button>
                </div>

                <div class="game-title" style="margin-top:16px; text-align:center;">–û—Ç–∫—Ä—ã—Ç—ã–µ –±–∞—Ç—Ç–ª—ã</div>
                <div class="battle-list" id="battleList"></div>
            </div>

            <div id="status" style="margin-top:20px; text-align:center; min-height:28px; font-size:1.2rem;"></div>
        </div>
    </div>

    <div class="nav">
        <button class="nav-btn" onclick="location.href='../index.html'"><span>üè†</span><span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span></button>
        <button class="nav-btn" onclick="location.href='../profile.html'"><span>üë§</span><span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span></button>
        <button class="nav-btn" onclick="location.href='../register.html'"><span>üîë</span><span class="nav-label">–í—Ö–æ–¥</span></button>
    </div>
    <script>
        const hb = document.getElementById('hamburgerBtn');
        const overlay = document.getElementById('mobileMenuOverlay');
        function toggleDrawer() {
            document.body.classList.toggle('drawer-open');
            hb && hb.classList.toggle('active');
        }
        hb && hb.addEventListener('click', toggleDrawer);
        overlay && overlay.addEventListener('click', toggleDrawer);
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, addDoc, onSnapshot, getDocs, query, where, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

        const ROULETTE_FAIR = true;
        const ROULETTE_LOCKS = {};
        const BATTLE_RENDERED = {};

        const audioCtx = typeof window !== 'undefined' && (window.AudioContext || window.webkitAudioContext) ? new (window.AudioContext || window.webkitAudioContext)() : null;
        function playTick() {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(1200, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.0001, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.06, audioCtx.currentTime + 0.01);
            gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.08);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.09);
        }
        function playWinSound() {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(500, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.35);
            gain.gain.setValueAtTime(0.0001, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.08, audioCtx.currentTime + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.5);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.52);
        }
        function startTickLoop(ms) {
            const start = performance.now();
            const id = setInterval(() => {
                const elapsed = performance.now() - start;
                if (elapsed >= ms) { clearInterval(id); return; }
                playTick();
            }, 110);
            return id;
        }

        async function computeHash(text) {
            try {
                if (crypto && crypto.subtle) {
                    const enc = new TextEncoder();
                    const buf = await crypto.subtle.digest('SHA-256', enc.encode(text));
                    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
                }
            } catch (_) {}
            let h = 0; for (let i = 0; i < text.length; i++) { h = (h << 5) - h + text.charCodeAt(i); h |= 0; }
            return String(h);
        }

        function uniformPick(items) {
            const idx = Math.floor(Math.random() * items.length);
            return items[idx];
        }
        function weightedPick(items) {
            const r = Math.random();
            let sum = 0;
            for (let it of items) { sum += it.prob; if (r <= sum) return it; }
            return items[0];
        }
        function normalizeProbs(items) {
            const total = items.reduce((s, it) => s + (it.prob || 0), 0) || 1;
            return items.map(it => ({ ...it, prob: Math.max(0, (it.prob || 0) / total) }));
        }
        function adjustItemsForPlayer(items) {
            const adjusted = items.map((it, i) => {
                // NERF: Significant reduction for player
                // Stronger decay for higher index (better items)
                const decreaseFactor = 1 - Math.min(0.25 * i, 0.95); 
                const newProb = (it.prob || 0) * decreaseFactor;
                // Reduce value slightly to favor site
                const newVal = Math.round((it.value || 0) * 0.90);
                return { ...it, prob: newProb, value: newVal };
            });
            return normalizeProbs(adjusted);
        }
        function adjustItemsForBot(items) {
            const adjusted = items.map((it, i) => {
                // EXTREME BUFF: Bot gets massive advantage
                const boostFactor = 1 + (i * i * 1.5); 
                const newProb = (it.prob || 0) * boostFactor;
                return { ...it, prob: newProb };
            });
            return normalizeProbs(adjusted);
        }
        function openCaseUniform(caseType) {
            const items = cases[caseType].items;
            return { ...uniformPick(items), caseType };
        }
        function getItemVisual(caseType, item) {
            const img = (item.img) ? item.img : (caseOpenedBackgrounds[caseType] || caseBackgrounds[caseType] || '');
            const desc = item.desc || `${item.name} –∏–∑ –∫–µ–π—Å–∞ ${caseDisplayNames[caseType] || caseType}`;
            return { img, desc };
        }

        const firebaseConfig = {
            apiKey: "AIzaSyBVra2JN-C7-1b_Qa4cU8--XvJ83lymiM8",
            authDomain: "dropwin-8d94b.firebaseapp.com",
            projectId: "dropwin-8d94b",
            storageBucket: "dropwin-8d94b.firebasestorage.app",
            messagingSenderId: "988974289403",
            appId: "1:988974289403:web:886d34e6f65920a105fb5e",
            measurementId: "G-BK010MHN8N"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        (function(){
          const orig = {
            error: console.error,
            warn: console.warn,
            log: console.log,
            info: console.info,
            debug: console.debug
          };
          const match = (args)=>{
            try{
              const s = args.map(x=>typeof x==='string'?x:(x&&x.message)?x.message:JSON.stringify(x)).join(' ');
              return s.includes('firestore.googleapis.com') && s.includes('documents:commit');
            }catch(_){return false;}
          };
          console.error = (...a)=>{ if(match(a)) return; orig.error(...a); };
          console.warn  = (...a)=>{ if(match(a)) return; orig.warn(...a);  };
          console.log   = (...a)=>{ if(match(a)) return; orig.log(...a);   };
          console.info  = (...a)=>{ if(match(a)) return; orig.info(...a);  };
          console.debug = (...a)=>{ if(match(a)) return; orig.debug(...a); };
        })();

        function createParticles() {
            const container = document.getElementById('particles');
            if (!container) return;
            for (let i = 0; i < 25; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.width = p.style.height = Math.random() * 2 + 1 + 'px';
                p.style.left = Math.random() * 100 + '%';
                p.style.animationDuration = Math.random() * 12 + 8 + 's';
                p.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(p);
            }
        }
function openCaseWithBotBoost(caseType) {
        const base = cases[caseType].items;
        const items = adjustItemsForBot(base);
        return { ...weightedPick(items), caseType };
    }
        let currentUser = null;
        let userId = null;
        let isGuest = false;
        let isCharityMode = false;

const cases = {
    agent: {
        price: 117,
        items: [
            {emoji: 'üßî', name: '–ë–æ–º–∂', value: 10, prob: 0.80, type: 'agent', img: '../images/games/bomj.png', desc: '–°–∫–∏–Ω –ë–æ–º–∂–∞'},
            {emoji: 'üë¶', name: '–ü–∞—Ü–∞–Ω', value: 60, prob: 0.18, type: 'agent', img: '../images/games/boy.png', desc: '–°–∫–∏–Ω –ü–∞—Ü–∞–Ω–∞'},
            {emoji: 'üßë', name: '–ß–µ–ª–æ–≤–µ–∫', value: 150, prob: 0.018, type: 'agent', img: '../images/games/people.png'},
            {emoji: 'üßô‚Äç‚ôÇÔ∏è', name: '–ì–Ω–æ–º', value: 300, prob: 0.002, type: 'agent', img: '../images/games/gnom.png'}
        ],
        color: '#374151',
        icon: 'üïµÔ∏è'
    },
    background: {
        price: 99,
        items: [
            {emoji: 'üèôÔ∏è', name: '–ì–æ—Ä–æ–¥', value: 25, prob: 0.60, type: 'bg', img: '../images/background.png', desc: '–§–æ–Ω: –ì–æ—Ä–æ–¥'},
            {emoji: 'üå®Ô∏è', name: '–°–Ω–µ–≥', value: 50, prob: 0.30, type: 'bg', img: '../images/background.png', desc: '–§–æ–Ω: –°–Ω–µ–≥'},
            {emoji: 'üèúÔ∏è', name: '–ü—É—Å—Ç—ã–Ω—è', value: 100, prob: 0.09, type: 'bg', img: '../images/background.png', desc: '–§–æ–Ω: –ü—É—Å—Ç—ã–Ω—è'},
            {emoji: 'üå≤', name: '–õ–µ—Å', value: 250, prob: 0.01, type: 'bg', img: '../images/background.png', desc: '–§–æ–Ω: –õ–µ—Å'}
        ],
        color: '#6366f1',
        icon: 'üñºÔ∏è'
    },
    keychain: {
        price: 88,
        items: [
            {emoji: 'üîë', name: '–ë—Ä–µ–ª–æ–∫-–∫–ª—é—á', value: 10, prob: 0.70, type: 'charm'},
            {emoji: 'üêæ', name: '–ë—Ä–µ–ª–æ–∫ –ª–∞–ø–∫–∞', value: 20, prob: 0.25, type: 'charm'},
            {emoji: 'üéñÔ∏è', name: '–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–π –±—Ä–µ–ª–æ–∫', value: 50, prob: 0.04, type: 'charm'},
            {emoji: 'üíé', name: '–†–µ–¥–∫–∏–π –±—Ä–µ–ª–æ–∫', value: 120, prob: 0.009, type: 'charm'},
            {emoji: 'üåü', name: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –±—Ä–µ–ª–æ–∫', value: 400, prob: 0.001, type: 'charm'}
        ],
        color: '#f59e0b',
        icon: 'üîë'
    },
    skin: {
        price: 175,
        items: [
            {emoji: 'üî´', name: '–°—Ç–∞–Ω–¥–∞—Ä—Ç', value: 30, prob: 0.70, type: 'skin'},
            {emoji: 'üé®', name: '–ì—Ä–∞—Ñ—Ñ–∏—Ç–∏', value: 100, prob: 0.25, type: 'skin'},
            {emoji: '‚ú®', name: '–°–Ω–µ–∂–Ω—ã–π', value: 180, prob: 0.045, type: 'skin'},
            {emoji: 'üåü', name: '–ó–æ–ª–æ—Ç–æ–π', value: 500, prob: 0.005, type: 'skin'}
        ],
        color: '#4ade80',
        icon: 'üé®'
    },
    bomj: {
        price: 6,
        items: [
            {emoji: 'üß¶', name: '–î—ã—Ä—è–≤—ã–π –Ω–æ—Å–æ–∫',      value: 1,   prob: 0.58},
            {emoji: 'üçû', name: '–ß—ë—Ä—Å—Ç–≤—ã–π —Ö–ª–µ–±',       value: 3,   prob: 0.22},
            {emoji: 'üóëÔ∏è', name: '–ú—É—Å–æ—Ä–Ω—ã–π –ø–∞–∫–µ—Ç',      value: 7,   prob: 0.11},
            {emoji: 'üç∫', name: '–¢—ë–ø–ª–æ–µ –ø–∏–≤–æ 0.5',     value: 12,  prob: 0.05},
            {emoji: 'ü™ô', name: '–ì–æ—Ä—Å—Ç–∫–∞ –º–µ–ª–æ—á–∏',      value: 25,  prob: 0.025},
            {emoji: 'üß•', name: '–°—Ç–∞—Ä–∞—è –∫—É—Ä—Ç–∫–∞',       value: 50,  prob: 0.012},
            {emoji: 'üì±', name: '–°–ª–æ–º–∞–Ω–Ω—ã–π Nokia',     value: 100, prob: 0.002},
            {emoji: 'üí∏', name: '–ó–∞–Ω–∞—á–∫–∞ –ø–æ–¥ –º–∞—Ç—Ä–∞—Å–æ–º',value: 180, prob: 0.0001},
        ],
        color: '#6b7280',
        icon: 'üóëÔ∏è'
    },
    vibe: {
        price: 77,
        items: [
            {emoji: 'üíñ', name: '–°–µ—Ä–¥—Ü–µ',          value: 15,  prob: 0.60},
            {emoji: 'üåπ', name: '–†–æ–∑–∞',            value: 25,  prob: 0.25},
            {emoji: 'üöÄ', name: '–†–∞–∫–µ—Ç–∞',          value: 50,  prob: 0.08},
            {emoji: 'üíê', name: '–¶–≤–µ—Ç—ã',           value: 50,  prob: 0.05},
            {emoji: 'üíç', name: '–ö–æ–ª—å—Ü–æ',          value: 100, prob: 0.01},
            {emoji: 'üíé', name: '–ê–ª–º–∞–∑',           value: 100, prob: 0.005},
            {emoji: 'üç≠', name: '–õ–æ–ª-–ø–æ–ø',         value: 325, prob: 0.001},
            {emoji: 'üê∂', name: '–°—É–ø –î–æ–≥',         value: 425, prob: 0.0005},
            {emoji: 'ü§°', name: '–®–∞–ø–∫–∞ —à—É—Ç–∞',      value: 500, prob: 0.0001},
            {emoji: '‚≠ê', name: '–ó–≤–µ–∑–¥–∞',           value: 200, prob: 0.0001},
        ],
        color: '#ec4899',
        icon: 'üíñ'
    },
    santa: {
        price: 114,
        items: [
            {emoji: 'üç™', name: '–ü–µ—á–µ–Ω—å–µ', value: 30, prob: 0.55},
            {emoji: 'ü•õ', name: '–ú–æ–ª–æ–∫–æ', value: 60, prob: 0.30},
            {emoji: 'üéÖ', name: '–ö–æ–ª–ø–∞–∫', value: 120, prob: 0.12},
            {emoji: 'ü¶å', name: '–û–ª–µ–Ω—å', value: 300, prob: 0.025},
            {emoji: 'üéÅ', name: '–ë–æ–ª—å—à–æ–π –ø–æ–¥–∞—Ä–æ–∫', value: 1000, prob: 0.005},
        ],
        color: '#dc2626',
        icon: 'üéÖ'
    },
    c2024: {
        price: 1199,
        items: [
            {emoji: 'üêâ', name: '–î—Ä–∞–∫–æ–Ω', value: 300, prob: 0.50},
            {emoji: 'üçæ', name: '–®–∞–º–ø–∞–Ω—Å–∫–æ–µ', value: 600, prob: 0.35},
            {emoji: 'üéÅ', name: '–ü–æ–¥–∞—Ä–æ–∫ 2024', value: 1200, prob: 0.12},
            {emoji: 'üëë', name: '–ö–æ—Ä–æ–Ω–∞', value: 2500, prob: 0.025},
            {emoji: 'üíé', name: '–ê–ª–º–∞–∑', value: 5000, prob: 0.004},
            {emoji: 'üè∞', name: '–ó–∞–º–æ–∫', value: 15000, prob: 0.0001}
        ],
        color: '#facc15',
        icon: 'üêâ'
    },
    c2025: {
        price: 799,
        items: [
            {emoji: 'üêç', name: '–ó–º–µ—è', value: 200, prob: 0.55},
            {emoji: 'üéä', name: '–•–ª–æ–ø—É—à–∫–∞', value: 400, prob: 0.30},
            {emoji: 'üé´', name: '–ë–∏–ª–µ—Ç 2025', value: 800, prob: 0.14},
            {emoji: 'ü§ñ', name: '–ö–∏–±–µ—Ä-–ó–º–µ—è', value: 2000, prob: 0.009},
            {emoji: 'üöÄ', name: '–†–∞–∫–µ—Ç–∞', value: 4000, prob: 0.001}
        ],
        color: '#22d3ee',
        icon: 'üêç'
    },
    battle: {
        price: 189,
        items: [
            {emoji: 'üõ°Ô∏è', name: '–©–∏—Ç', value: 50, prob: 0.55},
            {emoji: '‚öîÔ∏è', name: '–ú–µ—á', value: 100, prob: 0.30},
            {emoji: 'üíä', name: '–ê–ø—Ç–µ—á–∫–∞', value: 200, prob: 0.12},
            {emoji: 'üî´', name: '–ü–∏—Å—Ç–æ–ª–µ—Ç', value: 400, prob: 0.025},
            {emoji: 'üí£', name: '–ì—Ä–∞–Ω–∞—Ç–∞', value: 800, prob: 0.004},
            {emoji: 'üöÅ', name: '–í–µ—Ä—Ç–æ–ª–µ—Ç', value: 2000, prob: 0.001},
        ],
        color: '#ef4444',
        icon: '‚öîÔ∏è'
    },
    dvornik: {
        price: 29,
        items: [
            {emoji: 'üßπ', name: '–ú–µ—Ç–ª–∞', value: 5, prob: 0.35},
            {emoji: 'ü™£', name: '–í–µ–¥—Ä–æ', value: 10, prob: 0.28},
            {emoji: 'üßº', name: '–ú—ã–ª–æ', value: 15, prob: 0.20},
            {emoji: 'ü™ì', name: '–¢–æ–ø–æ—Ä —Å—Ç–∞—Ä—ã–π', value: 35, prob: 0.10},
            {emoji: 'üß§', name: '–ü–µ—Ä—á–∞—Ç–∫–∏ —Ä–∞–±–æ—á–∏–µ', value: 50, prob: 0.06},
            {emoji: '‚õèÔ∏è', name: '–õ–æ–ø–∞—Ç–∞', value: 80, prob: 0.009},
            {emoji: 'üõ†Ô∏è', name: '–ù–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤', value: 150, prob: 0.0009},
            {emoji: 'üö≤', name: '–í–µ–ª–æ—Å–∏–ø–µ–¥ –±/—É', value: 400, prob: 0.0001},
        ],
        color: '#eab308',
        icon: 'üßπ'
    },
    schoolboy: {
        price: 259,
        items: [
            {emoji: 'üìö', name: '–£—á–µ–±–Ω–∏–∫', value: 80, prob: 0.55},
            {emoji: 'üéí', name: '–†—é–∫–∑–∞–∫', value: 150, prob: 0.30},
            {emoji: 'üì±', name: '–°–º–∞—Ä—Ç—Ñ–æ–Ω', value: 400, prob: 0.10},
            {emoji: 'üíª', name: '–ù–æ—É—Ç–±—É–∫', value: 700, prob: 0.04},
            {emoji: 'üéÆ', name: 'PlayStation', value: 1000, prob: 0.008},
            {emoji: 'üöó', name: '–ú–∞—à–∏–Ω–∫–∞', value: 1300, prob: 0.001},
            {emoji: 'üè†', name: '–ö–≤–∞—Ä—Ç–∏—Ä–∞', value: 4000, prob: 0.0001},
        ],
        color: '#3b82f6',
        icon: 'üìö'
    },
    event: {
        price: 519,
        items: [
            {emoji: 'üéâ', name: '–ö–æ–Ω—Ñ–µ—Ç—Ç–∏', value: 150, prob: 0.45},
            {emoji: 'üéÅ', name: '–ü–æ–¥–∞—Ä–æ–∫', value: 300, prob: 0.30},
            {emoji: 'üéà', name: '–í–æ–∑–¥—É—à–Ω—ã–π —à–∞—Ä', value: 400, prob: 0.15},
            {emoji: 'üçæ', name: '–®–∞–º–ø–∞–Ω—Å–∫–æ–µ', value: 600, prob: 0.08},
            {emoji: 'üé§', name: '–ú–∏–∫—Ä–æ—Ñ–æ–Ω', value: 900, prob: 0.015},
            {emoji: 'üé¨', name: '–ö–∏–Ω–æ', value: 1500, prob: 0.004},
            {emoji: '‚úàÔ∏è', name: '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ', value: 3000, prob: 0.001},
        ],
        color: '#ef4444',
        icon: 'üéâ'
    },
    milioner: {
        price: 1000,
        items: [
            {emoji: 'üíµ', name: '–î–µ–Ω—å–≥–∏', value: 300, prob: 0.60},
            {emoji: 'üè¶', name: '–ë–∞–Ω–∫', value: 600, prob: 0.25},
            {emoji: 'üí∞', name: '–ú–µ—à–æ–∫ –¥–µ–Ω–µ–≥', value: 1200, prob: 0.12},
            {emoji: 'üìà', name: '–ì—Ä–∞—Ñ–∏–∫ —Ä–æ—Å—Ç–∞', value: 2000, prob: 0.025},
            {emoji: 'ü§ë', name: '–ú–∏–ª–ª–∏–æ–Ω–µ—Ä', value: 3000, prob: 0.004},
            {emoji: 'üöÄ', name: '–†–∞–∫–µ—Ç–∞', value: 6000, prob: 0.0005},
            {emoji: 'üè∞', name: '–î–≤–æ—Ä–µ—Ü', value: 25000, prob: 0.00001},
        ],
        color: '#fbbf24',
        icon: 'üí∞'
    },
    neoprime: {
        price: 1555,
        items: [
            {emoji: 'üí°', name: '–ù–µ–æ–Ω–æ–≤–∞—è –ª–∞–º–ø–∞', value: 450, prob: 0.70},
            {emoji: 'üíæ', name: '–ö–∏–±–µ—Ä-—á–∏–ø', value: 1000, prob: 0.25},
            {emoji: 'ü•Ω', name: 'VR-–æ—á–∫–∏', value: 1600, prob: 0.04},
            {emoji: 'üöÅ', name: '–î—Ä–æ–Ω', value: 2200, prob: 0.008},
            {emoji: 'ü§ñ', name: '–†–æ–±–æ—Ç', value: 3500, prob: 0.001},
            {emoji: 'üöö', name: '–ö–∏–±–µ—Ä-—Ç—Ä–∞–∫', value: 7000, prob: 0.0001},
            {emoji: 'üåå', name: 'Neo Prime', value: 30000, prob: 0.00001},
        ],
        color: '#8b5cf6',
        icon: 'üåå'
    },
    grinch: {
        price: 2555,
        items: [
            {emoji: 'üßÖ', name: '–õ—É–∫', value: 500, prob: 0.50},
            {emoji: 'üêï', name: '–ú–∞–∫—Å', value: 1500, prob: 0.35},
            {emoji: 'üéÑ', name: '–£–∫—Ä–∞–¥–µ–Ω–Ω–∞—è –µ–ª–∫–∞', value: 3000, prob: 0.14},
            {emoji: 'üéÅ', name: '–ß—É–∂–∏–µ –ø–æ–¥–∞—Ä–∫–∏', value: 5000, prob: 0.009},
            {emoji: 'üíö', name: '–°–µ—Ä–¥—Ü–µ –ì—Ä–∏–Ω—á–∞', value: 15000, prob: 0.001},
        ],
        color: '#16a34a',
        icon: 'üíö'
    },
    maldives: {
        price: 2599,
        items: [
            {emoji: 'üêö', name: '–†–∞–∫—É—à–∫–∞', value: 700, prob: 0.65},
            {emoji: 'ü••', name: '–ö–æ–∫–æ—Å', value: 1600, prob: 0.29},
            {emoji: 'üçπ', name: '–ö–æ–∫—Ç–µ–π–ª—å', value: 2500, prob: 0.05},
            {emoji: 'üå¥', name: '–ü–∞–ª—å–º–∞', value: 4000, prob: 0.009},
            {emoji: 'üö§', name: '–ì–∏–¥—Ä–æ—Ü–∏–∫–ª', value: 7500, prob: 0.0009},
            {emoji: 'üè†', name: '–ë—É–Ω–≥–∞–ª–æ', value: 18000, prob: 0.00009},
            {emoji: 'üèùÔ∏è', name: '–õ–∏—á–Ω—ã–π –æ—Å—Ç—Ä–æ–≤', value: 65000, prob: 0.00001},
        ],
        color: '#0ea5e9',
        icon: 'üèùÔ∏è'
    },
    elka: {
        price: 299,
        items: [
            {emoji: '‚ùÑÔ∏è', name: '–°–Ω–µ–∂–∏–Ω–∫–∞', value: 50, prob: 0.55},
            {emoji: 'üç¨', name: '–õ–µ–¥–µ–Ω–µ—Ü', value: 100, prob: 0.28},
            {emoji: 'üéÑ', name: '–ì–∏—Ä–ª—è–Ω–¥–∞', value: 200, prob: 0.15},
            {emoji: '‚≠ê', name: '–ó–≤–µ–∑–¥–∞', value: 400, prob: 0.019},
            {emoji: 'üéÖ', name: '–®–∞–ø–∫–∞ –°–∞–Ω—Ç—ã', value: 800, prob: 0.0009},
            {emoji: 'üçæ', name: '–®–∞–º–ø–∞–Ω—Å–∫–æ–µ', value: 1500, prob: 0.00009},
            {emoji: 'üéÜ', name: '–§–µ–π–µ—Ä–≤–µ—Ä–∫', value: 5000, prob: 0.00001},
        ],
        color: '#10b981',
        icon: 'üéÑ'
    },
    snowman: {
        price: 1999,
        items: [
            {emoji: 'ü•ï', name: '–ú–æ—Ä–∫–æ–≤–∫–∞', value: 400, prob: 0.55},
            {emoji: 'üß£', name: '–®–∞—Ä—Ñ', value: 800, prob: 0.28},
            {emoji: 'üõ∑', name: '–°–∞–Ω–∫–∏', value: 1500, prob: 0.15},
            {emoji: '‚õ∏Ô∏è', name: '–ö–æ–Ω—å–∫–∏', value: 3000, prob: 0.019},
            {emoji: 'üå®Ô∏è', name: '–°–Ω–µ–≥–æ—Ö–æ–¥', value: 7000, prob: 0.0009},
            {emoji: 'üßä', name: '–õ–µ–¥—è–Ω–æ–π —Ç—Ä–æ–Ω', value: 15000, prob: 0.00009},
            {emoji: 'üè∞', name: '–õ–µ–¥—è–Ω–æ–π –¥–≤–æ—Ä–µ—Ü', value: 50000, prob: 0.00001},
        ],
        color: '#38bdf8',
        icon: '‚õÑ'
    }
};

const caseBackgrounds = {
    keychain:  '../images/keychain.png',
    weapon:    '../images/weapon.png',
    skin:      '../images/skin.png',
    agent:    '../images/agent.png',
    bomj:     '../images/bomj.png',
    vibe:     '../images/vibe.png',
    dvornik:  '../images/dvornik.png',
    schoolboy:'../images/schoolboy.png',
    event:    '../images/event.png',
    milioner: '../images/milioner.png',
    neoprime: '../images/NeoPrime.png',
    maldives: '../images/Maldives.png',
    elka:     '../images/elka.png',
    snowman:  '../images/snowman.png',
    battle:   '../images/battles.png',
    grinch:   '../images/grinch.png',
    santa:    '../images/Santa.png',
    c2024:    '../images/2024.png',
    c2025:    '../images/2025.png',
    background:    '../images/background.png'
};

const caseOpenedBackgrounds = {
    bomj:     '../images/bomj1.png',
    vibe:     '../images/vibe1.png',
    dvornik:  '../images/dvornik1.png',
    schoolboy:'../images/schoolboy1.png',
    event:    '../images/event1.png',
    milioner: '../images/milioner1.png',
    neoprime: '../images/NeoPrime1.png',
    maldives: '../images/Maldives1.png',
    elka:     '../images/elka.png',   // Fallback to closed image
    snowman:  '../images/snowman.png', // Fallback to closed image
    battle:   '../images/battles.png',
    grinch:   '../images/grinch.png',
    santa:    '../images/Santa.png',
    c2024:    '../images/2024.png',
    c2025:    '../images/keychain.png',
    agent:    '../images/agent.png',
    weapon_skin:    '../images/weapon_skin.png',
    background:    '../images/background.png'
};

const caseDisplayNames = {
    agent:    "–ê–≥–µ–Ω—Ç",
    weapon_skin: "–°–∫–∏–Ω –û—Ä—É–∂–∏—è",
    background: "–§–æ–Ω",
    keychain: "–ë—Ä–µ–ª–æ–∫",
    weapon:   "–û—Ä—É–∂–∏–µ",
    skin:     "–°–∫–∏–Ω",
    bomj:     "–ë–æ–º–∂",
    vibe:     "Vibe",
    dvornik:  "–î–≤–æ—Ä–Ω–∏–∫",
    schoolboy:"–®–∫–æ–ª—å–Ω–∏–∫",
    event:    "–ò–≤–µ–Ω—Ç",
    milioner: "–ú–∏–ª–ª–∏–æ–Ω–µ—Ä",
    neoprime: "Neo Prime",
    maldives: "–ú–∞–ª—å–¥–∏–≤—ã",
    elka:     "–Å–ª–∫–∞",
    snowman:  "–°–Ω–µ–≥–æ–≤–∏–∫",
    battle:   "–ö–µ–π—Å Battle",
    grinch:   "–ö–µ–π—Å –ì—Ä–∏–Ω—á",
    santa:    "–ö–µ–π—Å –°–∞–Ω—Ç–∞",
    c2024:    "–ö–µ–π—Å 2024",
    c2025:    "–ö–µ–π—Å 2025"
};

        const sortedCaseKeys = Object.keys(cases).sort((a, b) => cases[a].price - cases[b].price);

        function renderCaseGrid(containerId, onSelect) {
            const grid = document.getElementById(containerId);
            grid.innerHTML = '';
            sortedCaseKeys.forEach(key => {
                const c = cases[key];
                const card = document.createElement('div');
                card.className = `case-card ${key}`;
                card.innerHTML = `
                    <div class="case-image-wrap">
                        <img src="${caseBackgrounds[key]}" alt="${key}" loading="lazy" decoding="async">
                    </div>
                    <div class="case-info">
                        <div class="name">${caseDisplayNames[key] || key}</div>
                        <div class="item-count">${c.items.length} –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>
                        <div class="price">${c.price}‚ÇΩ</div>
                    </div>
                `;
                card.onclick = () => onSelect(key);
                grid.appendChild(card);
            });
        }

        let selectedBotCases = [];
        let selectedPlayerCases = [];

        function addSelectedCase(section, caseType) {
            const arr = section === 'bot' ? selectedBotCases : selectedPlayerCases;
            if (arr.length >= 10) {
                alert('–ú–∞–∫—Å–∏–º—É–º 10 —Ä–∞—É–Ω–¥–æ–≤');
                return;
            }
            arr.push(caseType);
            updateSelectedCases(section);
            updateTotalCost(section);
        }

        function updateSelectedCases(section) {
            const cont = document.getElementById(section === 'bot' ? 'selectedBotCases' : 'selectedPlayerCases');
            cont.innerHTML = '<h4>–í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–µ–π—Å—ã:</h4>';
            const arr = section === 'bot' ? selectedBotCases : selectedPlayerCases;
            arr.forEach((type, i) => {
                const div = document.createElement('div');
                div.textContent = `${caseDisplayNames[type] || type} (${cases[type].price}‚ÇΩ)`;
                const btn = document.createElement('button');
                btn.className = 'remove-btn';
                btn.textContent = '–£–¥–∞–ª–∏—Ç—å';
                btn.onclick = () => {
                    arr.splice(i, 1);
                    updateSelectedCases(section);
                    updateTotalCost(section);
                };
                div.appendChild(btn);
                cont.appendChild(div);
            });
        }

        function updateTotalCost(section) {
            const arr = section === 'bot' ? selectedBotCases : selectedPlayerCases;
            const total = arr.reduce((s, t) => s + cases[t].price, 0);
            const el = document.getElementById(section === 'bot' ? 'botTotalCost' : 'playerTotalCost');

            if (section === 'player' && isCharityMode) {
                el.innerHTML = `–ò—Ç–æ–≥–æ: ${total * 2}‚ÇΩ <span class="charity-label">–∑–∞ –¥–≤–æ–∏—Ö!</span>`;
            } else {
                el.textContent = `–ò—Ç–æ–≥–æ: ${total}‚ÇΩ`;
            }
        }

        function openCase(caseType) {
            const base = cases[caseType].items;
            const items = adjustItemsForPlayer(base);
            return { ...weightedPick(items), caseType };
        }

 async function playVsBot(quick = false) {
    if (botRunInProgress) return;
    botRunInProgress = true;
    document.getElementById('playVsBot')?.setAttribute('disabled', 'true');
    document.getElementById('quickVsBot')?.setAttribute('disabled', 'true');
    if (!currentUser) {
        isGuest = true;
        currentUser = { username: '–ì–æ—Å—Ç—å', balance: 0, inventory: [] };
    }
    const totalCost = selectedBotCases.reduce((sum, type) => sum + cases[type].price, 0);
    const balance = Number(currentUser?.balance || 0);
    if (balance < totalCost) {
        alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞');
        botRunInProgress = false;
        return;
    }
    if (selectedBotCases.length === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∫–µ–π—Å');
        botRunInProgress = false;
        return;
    }

    currentUser.balance -= totalCost;

    // Calendar Bet Tracking
    const todayStr = new Date().toDateString();
    if (currentUser.lastDailyReset !== todayStr) {
        currentUser.dailyBet = 0;
        currentUser.lastDailyReset = todayStr;
    }
    currentUser.dailyBet = (currentUser.dailyBet || 0) + totalCost;
    currentUser.totalBet = (currentUser.totalBet || 0) + totalCost;

    await saveUser();
    updateBalance();

        const playerItems = selectedBotCases.map(type => ROULETTE_FAIR ? openCaseUniform(type) : openCase(type));
        const playerTotal = playerItems.reduce((sum, item) => sum + item.value, 0);
        const botItems    = selectedBotCases.map(type => ROULETTE_FAIR ? openCaseUniform(type) : openCaseWithBotBoost(type));
        lastPlayerItems = playerItems;
        lastBotItems = botItems;

    const resultsDiv = document.getElementById('botResults');
    if (!resultsDiv) return;

    resultsDiv.innerHTML = `
        <div class="open-results">
            <div class="player-opens">
                <h4>–í–∞—à–∏ –∫–µ–π—Å—ã (${currentUser?.username || '–ì–æ—Å—Ç—å'}):</h4>
                <div class="case-opening-container" id="playerCases"></div>
                <div class="total-value" id="playerTotal">–ò—Ç–æ–≥–æ: 0‚ÇΩ</div>
            </div>
            <div class="opponent-opens">
                <h4>–ë–æ—Ç:</h4>
                <div class="case-opening-container" id="botCases"></div>
                <div class="total-value" id="botTotal">–ò—Ç–æ–≥–æ: 0‚ÇΩ</div>
            </div>
        </div>
        <div id="resultText" style="text-align:center; margin-top:20px; font-size:1.4rem; min-height:40px;"></div>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:12px;">
            <button class="btn" id="sellBotBtn" style="background: linear-gradient(135deg, #34d399, #059669);">–ü—Ä–æ–¥–∞—Ç—å —Å—Ä–∞–∑—É</button>
            <button class="btn" id="stashBotBtn" style="background: linear-gradient(135deg, #a855f7, #7e22ce);">–û—Ç–ª–æ–∂–∏—Ç—å –≤—Å—ë</button>
        </div>
    `;

    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
    const dual = await animateDualOpenings('playerCases', selectedBotCases, playerItems, playerTotal, 'botCases', selectedBotCases, botItems, 0, quick);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±–µ–∏—Ö –∞–Ω–∏–º–∞—Ü–∏–π
    const realPlayerTotal = (dual?.leftResults || []).reduce((s, it) => s + Number(it.value || 0), 0);
    const realBotTotal = (dual?.rightResults || []).reduce((s, it) => s + Number(it.value || 0), 0);
    lastPlayerItems = dual?.leftResults || [];
    lastBotItems = dual?.rightResults || [];
    showBotResult(realPlayerTotal, realBotTotal, totalCost);
    botRunInProgress = false;
    document.getElementById('playVsBot')?.removeAttribute('disabled');
    document.getElementById('quickVsBot')?.removeAttribute('disabled');
}

function buildRouletteSequence(caseType, targetItem) {
    const src = cases[caseType].items;
    const pick = () => src[Math.floor(Math.random() * src.length)];
    const seq = [];
    for (let i = 0; i < 20; i++) seq.push(pick());
    seq.push(targetItem);
    for (let i = 0; i < 4; i++) seq.push(pick());
    return seq;
}

function renderRoulette(box, caseType, targetItem) {
    const wrap = document.createElement('div');
    wrap.className = 'roulette-wrap';
    const strip = document.createElement('div');
    strip.className = 'roulette-strip';
    const marker = document.createElement('div');
    marker.className = 'roulette-marker';
    const seq = buildRouletteSequence(caseType, targetItem);
    {
        const frag = document.createDocumentFragment();
        for (let i = 0; i < seq.length; i++) {
            const cell = document.createElement('div');
            cell.className = 'roulette-item';
            cell.textContent = seq[i].emoji;
            frag.appendChild(cell);
        }
        strip.appendChild(frag);
    }
    wrap.appendChild(strip);
    wrap.appendChild(marker);
    box.innerHTML = '';
    box.appendChild(wrap);
    const val = document.createElement('div');
    val.className = 'value-label';
    val.textContent = '';
    box.appendChild(val);
    box.dataset.itemEmoji = targetItem.emoji || '';
    box.dataset.itemName = targetItem.name || '';
    box.dataset.itemValue = String(targetItem.value || 0);
    box._seq = seq;
    box._valEl = val;
    box._padLeft = parseFloat(getComputedStyle(strip).paddingLeft) || 0;
    const items = strip.children;
    let step = 92;
    if (items.length >= 2) {
        const a = items[0].getBoundingClientRect();
        const b = items[1].getBoundingClientRect();
        step = Math.abs(b.left - a.left);
    }
    const targetIndex = seq.findIndex(s => s === targetItem);
    box._step = step;
    return { strip, step, targetIndex };
}

function spinRoulette(box, strip, step, targetIndex, quick) {
    return new Promise(resolve => {
        const boxRect = box.getBoundingClientRect();
        const paddingLeft = box._padLeft || 0;
        const finalX = -((paddingLeft) + (targetIndex * step) + (step / 2) - (boxRect.width / 2));
        const duration = quick ? 800 : 2800;
        strip.style.transition = `transform ${duration/1000}s cubic-bezier(0.15, 0.85, 0.35, 1)`;
        const tickId = startTickLoop(duration);
        requestAnimationFrame(() => {
            strip.style.transform = `translate3d(${finalX}px,0,0)`;
        });
        strip.addEventListener('transitionend', () => {
            box.classList.add('revealed');
            playWinSound();
            const selIndex = Math.max(0, Math.min((box._seq ? box._seq.length - 1 : 0),
                Math.round((boxRect.width / 2 - finalX - paddingLeft - (step / 2)) / step)
            ));
            const selectedItem = box._seq ? box._seq[selIndex] : { emoji: box.dataset.itemEmoji || '‚ùì', value: Number(box.dataset.itemValue || 0) };
            const dim = document.createElement('div');
            dim.className = 'dim-overlay';
            const emoji = document.createElement('div');
            emoji.className = 'item-reveal';
            emoji.textContent = selectedItem.emoji || '‚ùì';
            if (box._valEl) box._valEl.textContent = `${Number(selectedItem.value || 0)}‚ÇΩ`;
            box.appendChild(dim);
            box.appendChild(emoji);
            clearInterval(tickId);
            resolve(selectedItem);
        }, { once: true });
    });
}

async function animateBatchedOpenings(containerId, caseTypes, items, total, side, quick = false) {
    const container = document.getElementById(containerId);
    if (!container) return;
    if (ROULETTE_LOCKS[containerId]) return;
    ROULETTE_LOCKS[containerId] = true;
    container.innerHTML = '';
    const totalEl = document.getElementById(containerId === 'playerCases' ? 'playerTotal' : 'botTotal');
    if (totalEl) totalEl.textContent = `–ò—Ç–æ–≥–æ: 0‚ÇΩ`;
    const boxes = [];
    caseTypes.forEach((type, index) => {
        const item = items[index];
        const box = document.createElement('div');
        box.className = `case-box ${type}`;
        box.dataset.type = type;
        box.style.backgroundImage = `url('${caseBackgrounds[type] || ''}')`;
        container.appendChild(box);
        const { strip, step, targetIndex } = renderRoulette(box, type, item);
        boxes.push({ box, strip, step, targetIndex });
        setTimeout(() => box.classList.add('visible'), index * 60 + 80);
    });
    let results = [];
    if (quick) {
        results = await Promise.all(boxes.map(b => spinRoulette(b.box, b.strip, b.step, b.targetIndex, true)));
    } else {
        for (let i = 0; i < boxes.length; i += 2) {
            const p = [spinRoulette(boxes[i].box, boxes[i].strip, boxes[i].step, boxes[i].targetIndex, false)];
            if (boxes[i + 1]) p.push(spinRoulette(boxes[i + 1].box, boxes[i + 1].strip, boxes[i + 1].step, boxes[i + 1].targetIndex, false));
            const batch = await Promise.all(p);
            results.push(...batch);
        }
    }
    ROULETTE_LOCKS[containerId] = false;
    const newTotal = results.reduce((s, it) => s + Number(it.value || 0), 0);
    if (totalEl) totalEl.textContent = `–ò—Ç–æ–≥–æ: ${newTotal}‚ÇΩ`;
    return results;
}

async function animateDualOpenings(leftId, leftTypes, leftItems, leftTotal, rightId, rightTypes, rightItems, rightTotal, quick = false) {
    const left = document.getElementById(leftId);
    const right = document.getElementById(rightId);
    if (!left || !right) return;
    if (ROULETTE_LOCKS[leftId] || ROULETTE_LOCKS[rightId]) return;
    ROULETTE_LOCKS[leftId] = true;
    ROULETTE_LOCKS[rightId] = true;
    left.innerHTML = '';
    right.innerHTML = '';
    const lTotalEl = document.getElementById((leftId === 'playerCases' || leftId === 'myBattleCases') ? 'playerTotal' : 'botTotal');
    const rTotalEl = document.getElementById((rightId === 'botCases' || rightId === 'oppBattleCases') ? 'botTotal' : 'playerTotal');
    if (lTotalEl) lTotalEl.textContent = `–ò—Ç–æ–≥–æ: 0‚ÇΩ`;
    if (rTotalEl) rTotalEl.textContent = `–ò—Ç–æ–≥–æ: 0‚ÇΩ`;
    const leftBoxes = [];
    const rightBoxes = [];
    leftTypes.forEach((type, index) => {
        const item = leftItems[index];
        const box = document.createElement('div');
        box.className = `case-box ${type}`;
        box.dataset.type = type;
        box.style.backgroundImage = `url('${caseBackgrounds[type] || ''}')`;
        left.appendChild(box);
        const { strip, step, targetIndex } = renderRoulette(box, type, item);
        leftBoxes.push({ box, strip, step, targetIndex });
        setTimeout(() => box.classList.add('visible'), index * 60 + 80);
    });
    rightTypes.forEach((type, index) => {
        const item = rightItems[index];
        const box = document.createElement('div');
        box.className = `case-box ${type}`;
        box.dataset.type = type;
        box.style.backgroundImage = `url('${caseBackgrounds[type] || ''}')`;
        right.appendChild(box);
        const { strip, step, targetIndex } = renderRoulette(box, type, item);
        rightBoxes.push({ box, strip, step, targetIndex });
        setTimeout(() => box.classList.add('visible'), index * 60 + 80);
    });
    let leftResults = [];
    let rightResults = [];
    if (quick) {
        [leftResults, rightResults] = await Promise.all([
            Promise.all(leftBoxes.map(b => spinRoulette(b.box, b.strip, b.step, b.targetIndex, true))),
            Promise.all(rightBoxes.map(b => spinRoulette(b.box, b.strip, b.step, b.targetIndex, true)))
        ]);
    } else {
        const maxLen = Math.max(leftBoxes.length, rightBoxes.length);
        for (let i = 0; i < maxLen; i += 2) {
            const tasks = [];
            if (leftBoxes[i]) tasks.push(spinRoulette(leftBoxes[i].box, leftBoxes[i].strip, leftBoxes[i].step, leftBoxes[i].targetIndex, false));
            if (leftBoxes[i + 1]) tasks.push(spinRoulette(leftBoxes[i + 1].box, leftBoxes[i + 1].strip, leftBoxes[i + 1].step, leftBoxes[i + 1].targetIndex, false));
            if (rightBoxes[i]) tasks.push(spinRoulette(rightBoxes[i].box, rightBoxes[i].strip, rightBoxes[i].step, rightBoxes[i].targetIndex, false));
            if (rightBoxes[i + 1]) tasks.push(spinRoulette(rightBoxes[i + 1].box, rightBoxes[i + 1].strip, rightBoxes[i + 1].step, rightBoxes[i + 1].targetIndex, false));
            const batch = await Promise.all(tasks);
            const leftCountInBatch = (leftBoxes[i] ? 1 : 0) + (leftBoxes[i + 1] ? 1 : 0);
            leftResults.push(...batch.slice(0, leftCountInBatch));
            rightResults.push(...batch.slice(leftCountInBatch));
        }
    }
    ROULETTE_LOCKS[leftId] = false;
    ROULETTE_LOCKS[rightId] = false;
    const lTotal = leftResults.reduce((s, it) => s + Number(it.value || 0), 0);
    const rTotal = rightResults.reduce((s, it) => s + Number(it.value || 0), 0);
    if (lTotalEl) lTotalEl.textContent = `–ò—Ç–æ–≥–æ: ${lTotal}‚ÇΩ`;
    if (rTotalEl) rTotalEl.textContent = `–ò—Ç–æ–≥–æ: ${rTotal}‚ÇΩ`;
    return { leftResults, rightResults };
}
let lastBotRun = null;
let lastPlayerItems = [];
let lastBotItems = [];
let botRunInProgress = false;
let botRunCompleted = false;
function showBotResult(playerTotal, botTotal, totalCost) {
    const resultTextEl = document.getElementById('resultText');
    if (!resultTextEl) return;

    let resultText = '';
    let prize = 0;

    if (playerTotal > botTotal) {
        prize = playerTotal + botTotal;
        resultText = `<span style="color:#34d399">–ü–æ–±–µ–¥–∞! –ü—Ä–∏–∑: ${prize}‚ÇΩ</span>`;
    } else if (playerTotal < botTotal) {
        resultText = `<span style="color:#f87171">–ü—Ä–æ–∏–≥—Ä—ã—à</span>`;
    } else {
        prize = playerTotal;
        resultText = `–ù–∏—á—å—è ‚Äî –¥–æ—Å—Ç—É–ø–Ω—ã –≤–∞—à–∏ –ø—Ä–µ–¥–º–µ—Ç—ã –Ω–∞ ${prize}‚ÇΩ`;
    }

    resultTextEl.innerHTML = resultText;
    lastBotRun = { prize, playerTotal, botTotal, processed: false, runId: (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString() + Math.random().toString(16).slice(2)) };

    const sellBtn = document.getElementById('sellBotBtn');
    const stashBtn = document.getElementById('stashBotBtn');
    // –°—Ä–∞–∑—É –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –ø–æ—Ä–∞–∂–µ–Ω–∏–∏
    if (sellBtn && stashBtn && playerTotal < botTotal) {
        sellBtn.disabled = true;
        stashBtn.disabled = true;
        sellBtn.style.background = '#6b7280';
        stashBtn.style.background = '#6b7280';
        sellBtn.style.cursor = 'not-allowed';
        stashBtn.style.cursor = 'not-allowed';
        return;
    }
    if (sellBtn) {
        sellBtn.onclick = async () => {
            if (lastBotRun.processed) return;
            sellBtn.disabled = true;
            stashBtn.disabled = true;
            if (prize > 0) {
                currentUser.balance += prize;
                await saveUser();
                updateBalance();
                resultTextEl.innerHTML += `<br><div style="color:#a78bfa; margin-top:12px;">–ü—Ä–æ–¥–∞–∂–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ (+${prize}‚ÇΩ)</div>`;
            } else {
                resultTextEl.innerHTML += `<br><div style="color:#f87171; margin-top:12px;">–ü—Ä–æ–¥–∞—Ç—å –Ω–µ—á–µ–≥–æ</div>`;
            }
            lastBotRun.processed = true;
        };
    }
    if (stashBtn) {
        stashBtn.onclick = async () => {
            if (lastBotRun.processed) return;
            sellBtn.disabled = true;
            stashBtn.disabled = true;
            openResultModal({ emoji: 'üéÅ', title: '–û—Ç–ª–æ–∂–µ–Ω–æ', prize: lastBotRun.prize });
            if (isGuest) {
                const myItems = lastPlayerItems.map(it => ({ emoji: it.emoji, name: it.name, value: it.value }));
                const oppItems = lastBotItems.map(it => ({ emoji: it.emoji, name: it.name, value: it.value }));
                const saveBoth = playerTotal > botTotal;
                const itemsToSave = saveBoth ? myItems.concat(oppItems) : myItems;
                let users = JSON.parse(localStorage.getItem('dropwin_users')) || [];
                const idx = users.findIndex(u => u.username === '–ì–æ—Å—Ç—å');
                let guest = idx !== -1 ? users[idx] : { username: '–ì–æ—Å—Ç—å', balance: 0, inventory: [] };
                const inventory = Array.isArray(guest.inventory) ? guest.inventory : [];
                const newItems = itemsToSave.map(it => ({
                    id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString() + Math.random().toString(16).slice(2)),
                    emoji: it.emoji,
                    name: it.name,
                    value: it.value,
                    source: '–ë–∞—Ç—Ç–ª:–ë–æ—Ç',
                    botRunId: lastBotRun.runId,
                    timestamp: Date.now()
                }));
                guest.inventory = inventory.concat(newItems);
                if (idx !== -1) users[idx] = guest; else users.push(guest);
                localStorage.setItem('dropwin_users', JSON.stringify(users));
                currentUser.inventory = guest.inventory;
                resultTextEl.innerHTML += `<br><div style="text-align:center; padding:12px; color:#a78bfa;">–û—Ç–ª–æ–∂–µ–Ω–æ: ${newItems.length} –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>`;
                lastBotRun.processed = true;
                return;
            }
            const myItems = lastPlayerItems.map(it => ({ emoji: it.emoji, name: it.name, value: it.value }));
            const oppItems = lastBotItems.map(it => ({ emoji: it.emoji, name: it.name, value: it.value }));
            const saveBoth = playerTotal > botTotal;
            const itemsToSave = saveBoth ? myItems.concat(oppItems) : myItems;
            const userSnap = await getDoc(doc(db, 'users', userId));
            const userData = userSnap.exists() ? userSnap.data() : {};
            const inventory = Array.isArray(userData.inventory) ? userData.inventory : [];
            const newItems = itemsToSave.filter(it => !inventory.some(e => e.botRunId === lastBotRun.runId && e.name === it.name && e.value === it.value && e.source === '–ë–∞—Ç—Ç–ª:–ë–æ—Ç')).map(it => ({
                id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString() + Math.random().toString(16).slice(2)),
                emoji: it.emoji,
                name: it.name,
                value: it.value,
                source: '–ë–∞—Ç—Ç–ª:–ë–æ—Ç',
                botRunId: lastBotRun.runId,
                timestamp: Date.now()
            }));
            try {
                const updatedInv = inventory.concat(newItems);
                await updateDoc(doc(db, 'users', userId), { inventory: updatedInv });
                currentUser.inventory = updatedInv;
                resultTextEl.innerHTML += `<br><div style="text-align:center; padding:12px; color:#a78bfa;">–û—Ç–ª–æ–∂–µ–Ω–æ: ${newItems.length} –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>`;
                lastBotRun.processed = true;
            } catch (e) {
                let users = JSON.parse(localStorage.getItem('dropwin_users')) || [];
                const idx = users.findIndex(u => u.username === currentUser.username);
                let entry = idx !== -1 ? users[idx] : { username: currentUser.username, balance: currentUser.balance || 0, inventory: [] };
                entry.inventory = (Array.isArray(entry.inventory) ? entry.inventory : []).concat(newItems);
                if (idx !== -1) users[idx] = entry; else users.push(entry);
                localStorage.setItem('dropwin_users', JSON.stringify(users));
                currentUser.inventory = entry.inventory;
                resultTextEl.innerHTML += `<br><div style="text-align:center; padding:12px; color:#fbbf24;">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ: ${newItems.length} –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>`;
                lastBotRun.processed = true;
            }
        };
    }
}

function openResultModal(opts) {
    const overlay = document.getElementById('resultModalOverlay');
    const content = document.getElementById('resultModalContent');
    if (!overlay || !content) return;
    const emoji = opts.emoji || 'üéâ';
    const title = opts.title || '–†–µ–∑—É–ª—å—Ç–∞—Ç';
    const prize = typeof opts.prize === 'number' ? opts.prize : 0;
    content.innerHTML = `
        <span class="result-emoji">${emoji}</span>
        <div class="result-title">${title}</div>
        <div class="result-prize">${prize}‚ÇΩ</div>
        <div class="result-actions">
            <button class="btn" style="width:100%;">–û–∫–µ–π</button>
        </div>
    `;
    overlay.classList.add('active');
}
function closeResultModal() {
    const overlay = document.getElementById('resultModalOverlay');
    if (overlay) overlay.classList.remove('active');
}
window.closeResultModal = closeResultModal;

function autoSaveBotRun() {
    try {
        if (!lastBotRun || lastBotRun.processed) return;
        const saveBoth = (lastBotRun.playerTotal || 0) > (lastBotRun.botTotal || 0);
        const myItems = (lastPlayerItems || []).map(it => ({ emoji: it.emoji, name: it.name, value: it.value }));
        const oppItems = (lastBotItems || []).map(it => ({ emoji: it.emoji, name: it.name, value: it.value }));
        const itemsToSave = saveBoth ? myItems.concat(oppItems) : myItems;
        if (isGuest) {
            let users = JSON.parse(localStorage.getItem('dropwin_users')) || [];
            const idx = users.findIndex(u => u.username === '–ì–æ—Å—Ç—å');
            let guest = idx !== -1 ? users[idx] : { username: '–ì–æ—Å—Ç—å', balance: 0, inventory: [] };
            const inventory = Array.isArray(guest.inventory) ? guest.inventory : [];
            const newItems = itemsToSave.map(it => ({
                id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString() + Math.random().toString(16).slice(2)),
                emoji: it.emoji,
                name: it.name,
                value: it.value,
                source: '–ë–∞—Ç—Ç–ª:–ë–æ—Ç',
                botRunId: lastBotRun.runId,
                timestamp: Date.now()
            }));
            guest.inventory = inventory.concat(newItems);
            if (idx !== -1) users[idx] = guest; else users.push(guest);
            localStorage.setItem('dropwin_users', JSON.stringify(users));
            currentUser = guest;
            lastBotRun.processed = true;
        } else if (userId) {
            // –ë—ã—Å—Ç—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ‚Äî –∑–∞–ø—É—Å–∫–∞–µ–º –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è
            (async () => {
                try {
                    const userSnap = await getDoc(doc(db, 'users', userId));
                    const userData = userSnap.exists() ? userSnap.data() : {};
                    const inventory = Array.isArray(userData.inventory) ? userData.inventory : [];
                    const newItems = itemsToSave.filter(it => !inventory.some(e => e.botRunId === lastBotRun.runId && e.name === it.name && e.value === it.value && e.source === '–ë–∞—Ç—Ç–ª:–ë–æ—Ç')).map(it => ({
                        id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString() + Math.random().toString(16).slice(2)),
                        emoji: it.emoji,
                        name: it.name,
                        value: it.value,
                        source: '–ë–∞—Ç—Ç–ª:–ë–æ—Ç',
                        botRunId: lastBotRun.runId,
                        timestamp: Date.now()
                    }));
                    const updatedInv = inventory.concat(newItems);
                    try {
                        await updateDoc(doc(db, 'users', userId), { inventory: updatedInv });
                        currentUser.inventory = updatedInv;
                        lastBotRun.processed = true;
                    } catch (e) {
                        let users = JSON.parse(localStorage.getItem('dropwin_users')) || [];
                        const idx = users.findIndex(u => u.username === currentUser.username);
                        let entry = idx !== -1 ? users[idx] : { username: currentUser.username, balance: currentUser.balance || 0, inventory: [] };
                        entry.inventory = (Array.isArray(entry.inventory) ? entry.inventory : []).concat(newItems);
                        if (idx !== -1) users[idx] = entry; else users.push(entry);
                        localStorage.setItem('dropwin_users', JSON.stringify(users));
                        currentUser.inventory = entry.inventory;
                        lastBotRun.processed = true;
                    }
                } catch (e) {}
            })();
        }
    } catch (e) {}
}
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') autoSaveBotRun();
});
window.addEventListener('beforeunload', () => {
    autoSaveBotRun();
});

        async function saveUser() {
            try {
                if (isGuest) {
                    let users = JSON.parse(localStorage.getItem('dropwin_users')) || [];
                    const idx = users.findIndex(u => u.username === '–ì–æ—Å—Ç—å');
                    if (idx !== -1) users[idx] = currentUser;
                    localStorage.setItem('dropwin_users', JSON.stringify(users));
                } else if (userId) {
                    await updateDoc(doc(db, 'users', userId), { balance: currentUser.balance });
                }
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", err);
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å.");
            }
        }

        function updateBalance() {
            document.getElementById('balance').textContent = currentUser ? currentUser.balance || 0 : 0;
            document.getElementById('authBtn').textContent = isGuest ? '–ì–æ—Å—Ç—å' : (currentUser ? currentUser.username : '–í–æ–π—Ç–∏');
            document.getElementById('authBtn').onclick = () => location.href = '../profile.html';
        }

        function loadCurrentUser() {
            onAuthStateChanged(auth, async (user) => {
                try {
                    if (user) {
                        userId = user.uid;
                        const snap = await getDoc(doc(db, 'users', user.uid));
                        if (snap.exists()) {
                            currentUser = snap.data();
                            isGuest = false;
                            updateBalance();
                            await awardPendingForUser();
                            if (document.getElementById('vsPlayerBtn')?.classList.contains('active')) {
                                loadBattles();
                            }
                        }
                    } else {
                        const username = localStorage.getItem('dropwin_current_username');
                        if (username === '–ì–æ—Å—Ç—å') {
                            const users = JSON.parse(localStorage.getItem('dropwin_users')) || [];
                            currentUser = users.find(u => u.username === '–ì–æ—Å—Ç—å');
                            isGuest = true;
                            updateBalance();
                        } else {
                            location.href = '../register.html';
                        }
                    }
                } catch (err) {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", err);
                    document.getElementById('status').textContent = "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∞–∫–∫–∞—É–Ω—Ç—É.";
                }
            });
        }

        async function createBattle() {
            try {
                if (isGuest) throw new Error('–¢–æ–ª—å–∫–æ –¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö');
                if (selectedPlayerCases.length === 0) throw new Error('–í—ã–±–µ—Ä–∏—Ç–µ –∫–µ–π—Å—ã');

                const singleCost = selectedPlayerCases.reduce((sum, type) => sum + cases[type].price, 0);
                const costToPay = isCharityMode ? singleCost * 2 : singleCost;

                if (currentUser.balance < costToPay) throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞');

                const existingQ = query(collection(db, 'battles'), where('creator', '==', userId), where('status', '==', 'open'));
                const existingSnap = await getDocs(existingQ);
                if (!existingSnap.empty) throw new Error('–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–π –±–∞—Ç—Ç–ª. –£–¥–∞–ª–∏—Ç–µ –µ–≥–æ —Å–Ω–∞—á–∞–ª–∞.');

                currentUser.balance -= costToPay;

                // Calendar Bet Tracking
                const todayStr = new Date().toDateString();
                if (currentUser.lastDailyReset !== todayStr) {
                    currentUser.dailyBet = 0;
                    currentUser.lastDailyReset = todayStr;
                }
                currentUser.dailyBet = (currentUser.dailyBet || 0) + costToPay;
                currentUser.totalBet = (currentUser.totalBet || 0) + costToPay;

                await saveUser();
                updateBalance();

                const battleDoc = await addDoc(collection(db, 'battles'), {
                    creator: userId,
                    creatorName: currentUser.username,
                    creatorAvatar: currentUser.avatarUrl || null,
                    caseTypes: selectedPlayerCases,
                    totalCost: singleCost,          // —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞
                    isCharity: isCharityMode,
                    creatorPaid: costToPay,         // —Å–∫–æ–ª—å–∫–æ –∑–∞–ø–ª–∞—Ç–∏–ª —Å–æ–∑–¥–∞—Ç–µ–ª—å
                    player1: userId,
                    player1Name: currentUser.username,
                    player2: null,
                    player2Name: null,
                    status: 'open',
                    player1Items: [],
                    player2Items: [],
                    player1Total: 0,
                    player2Total: 0,
                    player1Claimed: false,
                    player2Claimed: false,
                    player1Saved: false,
                    player2Saved: false,
                    createdAt: new Date()
                });

                subscribeToBattle(battleDoc.id);

                // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
                selectedPlayerCases = [];
                updateSelectedCases('player');
                updateTotalCost('player');
                document.getElementById('createForm').style.display = 'none';
                document.getElementById('charityMode').checked = false;
                isCharityMode = false;
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–∞—Ç—Ç–ª–∞:", err);
                alert(err.message || "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–∞—Ç—Ç–ª–∞");
            }
        }

        function subscribeToBattle(battleId) {
            onSnapshot(doc(db, 'battles', battleId), async (snap) => {
                try {
                    const data = snap.data();
                    if (!data) return;

                    const statusDiv = document.getElementById('status');
                    statusDiv.innerHTML = '';

                    if (data.status === 'open') {
                        statusDiv.innerHTML = `<div style="color:#fbbf24;">–ë–∞—Ç—Ç–ª —Å–æ–∑–¥–∞–Ω! –û–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞...</div>`;
                    } else if (data.status === 'started') {
                        statusDiv.innerHTML = `<div style="color:#34d399;">–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è! –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–µ–π—Å–æ–≤...</div>`;
                        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ –ª—é–±—ã–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–º
                        if (data.player1Items.length === 0 && (userId === data.player1 || userId === data.player2)) {
                            try {
                                await runTransaction(db, async (tx) => {
                                    const freshRef = snap.ref;
                                    const freshSnap = await tx.get(freshRef);
                                    const freshData = freshSnap.data();
                                    if (!freshData) return;
                                    if (freshData.status !== 'started') return;
                                    if ((freshData.player1Items || []).length > 0 || (freshData.player2Items || []).length > 0) return;
                                    const p1Items = freshData.caseTypes.map(type => openCase(type));
                                    const p1Total = p1Items.reduce((sum, item) => sum + item.value, 0);
                                    const p2Items = freshData.caseTypes.map(type => openCase(type));
                                    const p2Total = p2Items.reduce((sum, item) => sum + item.value, 0);
                                    const winner = p1Total > p2Total ? freshData.player1 : (p2Total > p1Total ? freshData.player2 : null);
                                    tx.update(freshRef, {
                                        player1Items: p1Items.map(item => ({emoji: item.emoji, name: item.name, value: item.value})),
                                        player2Items: p2Items.map(item => ({emoji: item.emoji, name: item.name, value: item.value})),
                                        player1Total: p1Total,
                                        player2Total: p2Total,
                                        winner: winner,
                                        finishedAt: Date.now(),
                                        status: 'finished'
                                    });
                                });
                            } catch (e) {}
                        }
                    } else if (data.status === 'finished') {
                        if (BATTLE_RENDERED[battleId]) return;
                        const p1Total = data.player1Total;
                        const p2Total = data.player2Total;
                        let winner = null;
                        if (p1Total > p2Total) winner = data.player1;
                        else if (p2Total > p1Total) winner = data.player2;

                        const isPlayer1 = userId === data.player1;
                        const myItems = isPlayer1 ? data.player1Items : data.player2Items;
                        const oppItems = isPlayer1 ? data.player2Items : data.player1Items;
                        const myTotal = isPlayer1 ? p1Total : p2Total;
                        const oppTotal = isPlayer1 ? p2Total : p1Total;
                        const opponentName = isPlayer1 ? data.player2Name : data.player1Name;
                        const myClaimed = isPlayer1 ? data.player1Claimed : data.player2Claimed;
                        const mySaved = isPlayer1 ? data.player1Saved : data.player2Saved;
                        const oppClaimed = isPlayer1 ? data.player2Claimed : data.player1Claimed;
                        const oppSaved = isPlayer1 ? data.player2Saved : data.player1Saved;

                        let resultText = '';
                        let prize = 0;
                        if (winner === userId) {
                            prize = myTotal + oppTotal;
                            resultText = `<span style="color:#34d399">–ü–æ–±–µ–¥–∞! –ü—Ä–∏–∑: ${prize}‚ÇΩ</span>`;
                        } else if (winner) {
                            resultText = `<span style="color:#f87171">–ü—Ä–æ–∏–≥—Ä—ã—à</span>`;
                        } else {
                            prize = myTotal;
                            resultText = `–ù–∏—á—å—è ‚Äî –∑–∞–±–∏—Ä–∞–µ—à—å —Å–≤–æ–∏ ${prize}‚ÇΩ`;
                        }

                        statusDiv.innerHTML = `
                            <div class="open-results">
                                <div class="player-opens">
                                    <h4>–í–∞—à–∏ (<span class="nickname">${currentUser.username}</span>):</h4>
                                    <div class="case-opening-container" id="myBattleCases"></div>
                                    <div class="total-value">–ò—Ç–æ–≥–æ: ${myTotal}‚ÇΩ</div>
                                </div>
                                <div class="opponent-opens">
                                    <h4>${opponentName || '–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫'}:</h4>
                                    <div class="case-opening-container" id="oppBattleCases"></div>
                                    <div class="total-value">–ò—Ç–æ–≥–æ: ${oppTotal}‚ÇΩ</div>
                                </div>
                            </div>
                            <div id="battleResultText" style="text-align:center; margin-top:12px;">${resultText}</div>
                            <div style="display:flex; gap:10px; justify-content:center; margin-top:12px;">
                              <button class="btn" id="sellItemsBtn" style="background: linear-gradient(135deg, #34d399, #059669);">–ü—Ä–æ–¥–∞—Ç—å —Å—Ä–∞–∑—É</button>
                              <button class="btn" id="stashItemsBtn" style="background: linear-gradient(135deg, #a855f7, #7e22ce);">–û—Ç–ª–æ–∂–∏—Ç—å –≤—Å—ë</button>
                            </div>
                        `;

                        await animateDualOpenings('myBattleCases', data.caseTypes, myItems, myTotal, 'oppBattleCases', data.caseTypes, oppItems, oppTotal, false);
                        BATTLE_RENDERED[battleId] = true;

                        const sellBtn = document.getElementById('sellItemsBtn');
                        const stashBtn = document.getElementById('stashItemsBtn');
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–µ—Ä–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –ø–æ—Ä–∞–∂–µ–Ω–∏–∏ –∏–ª–∏ –µ—Å–ª–∏ —É–∂–µ –±—ã–ª–æ –¥–µ–π—Å—Ç–≤–∏–µ
                        if (sellBtn && stashBtn) {
                            const iLost = !!winner && winner !== userId;
                            const iDone = !!myClaimed || !!mySaved;
                            if (iLost || iDone) {
                                sellBtn.disabled = true;
                                stashBtn.disabled = true;
                                sellBtn.style.background = '#6b7280';
                                stashBtn.style.background = '#6b7280';
                                sellBtn.style.cursor = 'not-allowed';
                                stashBtn.style.cursor = 'not-allowed';
                            }
                        }
                        if (sellBtn) {
                            sellBtn.onclick = async () => {
                                sellBtn.disabled = true;
                                stashBtn.disabled = true;
                                const claimedField = isPlayer1 ? 'player1Claimed' : 'player2Claimed';
                                const savedField = isPlayer1 ? 'player1Saved' : 'player2Saved';
                                try {
                                    await runTransaction(db, async (tx) => {
                                        const freshBattle = await tx.get(snap.ref);
                                        const fData = freshBattle.data();
                                        if (!fData) return;
                                        if (fData[claimedField] || fData[savedField]) {
                                            statusDiv.innerHTML += '<div style="color:#f87171; text-align:center; padding:10px;">–î–µ–π—Å—Ç–≤–∏–µ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.</div>';
                                            return;
                                        }
                                        if (prize > 0) {
                                            const userRef = doc(db, 'users', userId);
                                            const userSnap = await tx.get(userRef);
                                            const uData = userSnap.data() || {};
                                            const newBalance = (uData.balance || 0) + prize;
                                            tx.update(userRef, { balance: newBalance });
                                            tx.update(snap.ref, { [claimedField]: true });
                                            currentUser.balance = newBalance;
                                            updateBalance();
                                            statusDiv.innerHTML += `<div style="text-align:center; padding:12px; color:#a78bfa;">–ü—Ä–æ–¥–∞–∂–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ (+${prize}‚ÇΩ)</div>`;
                                        } else {
                                            statusDiv.innerHTML += `<div style="text-align:center; padding:12px; color:#f87171;">–ü—Ä–æ–¥–∞—Ç—å –Ω–µ—á–µ–≥–æ</div>`;
                                        }
                                    });
                                } catch (e) {}
                            };
                        }
                        if (stashBtn) {
                            stashBtn.onclick = async () => {
                                stashBtn.disabled = true;
                                sellBtn.disabled = true;
                                const claimedField = isPlayer1 ? 'player1Claimed' : 'player2Claimed';
                                const savedFlagField = isPlayer1 ? 'player1Saved' : 'player2Saved';
                                const modalPrize = winner === userId ? (myTotal + oppTotal) : (!winner ? myTotal : myTotal);
                                openResultModal({ emoji: 'üéÅ', title: '–û—Ç–ª–æ–∂–µ–Ω–æ', prize: modalPrize });
                                try {
                                    await runTransaction(db, async (tx) => {
                                        const freshBattle = await tx.get(snap.ref);
                                        const fData = freshBattle.data();
                                        if (!fData) return;
                                        if (fData[savedFlagField] || fData[claimedField]) {
                                            statusDiv.innerHTML += '<div style="color:#fbbf24; text-align:center; padding:10px;">–î–µ–π—Å—Ç–≤–∏–µ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.</div>';
                                            return;
                                        }
                                        const itemsToSave = winner === userId ? myItems.concat(oppItems) : myItems;
                                        const userRef = doc(db, 'users', userId);
                                        const userSnap = await tx.get(userRef);
                                        const userData = userSnap.data() || {};
                                        const inventory = Array.isArray(userData.inventory) ? userData.inventory : [];
                                        const newItems = itemsToSave.filter(it => !inventory.some(e =>
                                            e.battleId === snap.id && e.name === it.name && e.value === it.value
                                        )).map(it => ({
                                            id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString() + Math.random().toString(16).slice(2)),
                                            emoji: it.emoji,
                                            name: it.name,
                                            value: it.value,
                                            source: '–ë–∞—Ç—Ç–ª',
                                            battleId: snap.id,
                                            timestamp: Date.now()
                                        }));
                                        const updatedInv = inventory.concat(newItems);
                                        tx.update(userRef, { inventory: updatedInv });
                                        tx.update(snap.ref, { [savedFlagField]: true });
                                        currentUser.inventory = updatedInv;
                                        statusDiv.innerHTML += `<div style="text-align:center; padding:12px; color:#a78bfa;">–û—Ç–ª–æ–∂–µ–Ω–æ: ${newItems.length} –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>`;
                                    });
                                } catch (e) {}
                            };
                        }
                        // –ê–≤—Ç–æ–≤—ã–¥–∞—á–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª—é, –µ—Å–ª–∏ –Ω–∏–∫—Ç–æ –Ω–µ –≤—ã–ø–æ–ª–Ω–∏–ª –¥–µ–π—Å—Ç–≤–∏–µ
                        if (winner && !data.player1Saved && !data.player1Claimed && !data.player2Saved && !data.player2Claimed) {
                            const winnerId = winner;
                            const winnerItems = winnerId === data.player1
                                ? (data.player1Items || []).concat(data.player2Items || [])
                                : (data.player2Items || []).concat(data.player1Items || []);
                            const winnerFlagField = winnerId === data.player1 ? 'player1Saved' : 'player2Saved';
                            try {
                                await runTransaction(db, async (tx) => {
                                    const freshBattle = await tx.get(snap.ref);
                                    const fData = freshBattle.data();
                                    if (!fData) return;
                                    if (fData.player1Saved || fData.player1Claimed || fData.player2Saved || fData.player2Claimed) return;
                                    const wRef = doc(db, 'users', winnerId);
                                    const wSnap = await tx.get(wRef);
                                    const wData = wSnap.data() || {};
                                    const inv = Array.isArray(wData.inventory) ? wData.inventory : [];
                                    const newItems = winnerItems.filter(it => !inv.some(e =>
                                        e.battleId === snap.id && e.name === it.name && e.value === it.value
                                    )).map(it => ({
                                        id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString() + Math.random().toString(16).slice(2)),
                                        emoji: it.emoji,
                                        name: it.name,
                                        value: it.value,
                                        source: '–ë–∞—Ç—Ç–ª',
                                        battleId: snap.id,
                                        timestamp: Date.now()
                                    }));
                                    const updatedInv = inv.concat(newItems);
                                    tx.update(wRef, { inventory: updatedInv });
                                    tx.update(snap.ref, { [winnerFlagField]: true });
                                });
                            } catch (e) {}
                        }
                    }
                } catch (err) {
                    console.error("–û—à–∏–±–∫–∞ –≤ onSnapshot –±–∞—Ç—Ç–ª–∞:", err);
                    document.getElementById('status').textContent = "–û—à–∏–±–∫–∞ –æ–Ω–ª–∞–π–Ω-–±–∞—Ç—Ç–ª–∞.";
                }
            });
        }

        let battlesUnsubscribe = null;

        async function loadBattles() {
            try {
                if (battlesUnsubscribe) {
                    battlesUnsubscribe();
                    battlesUnsubscribe = null;
                }
                
                const q = query(collection(db, 'battles'), where('status', '==', 'open'));
                battlesUnsubscribe = onSnapshot(q, (querySnap) => {
                    const listDiv = document.getElementById('battleList');
                    if (!listDiv) return;
                    listDiv.innerHTML = '';
                    if (querySnap.empty) {
                        listDiv.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:20px;">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –±–∞—Ç—Ç–ª–æ–≤</div>';
                        return;
                    }
                    querySnap.forEach(snap => {
                        const data = snap.data();
                        const rounds = data.caseTypes ? data.caseTypes.length : 0;
                        const price = data.isCharity ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : `${data.totalCost}‚ÇΩ`;
                        
                        const div = document.createElement('div');
                        div.className = 'battle-card';
                        
                        // Case Images
                        let casesHtml = '';
                        if (data.caseTypes) {
                            data.caseTypes.forEach(t => {
                                casesHtml += `<img src="${caseBackgrounds[t] || ''}" class="battle-case-img" title="${caseDisplayNames[t] || t}" loading="lazy" decoding="async">`;
                            });
                        }

                        // Creator Avatar
                        const creatorLetter = (data.creatorName || '?').charAt(0).toUpperCase();
                        let avatarHtml = '';
                        if (data.creatorAvatar) {
                            avatarHtml = `<img src="${data.creatorAvatar}" style="width:100%;height:100%;object-fit:cover;" loading="lazy" decoding="async">`;
                        } else {
                            avatarHtml = `<span>${creatorLetter}</span>`;
                        }
                        
                        // Action Button
                        let actionBtn = '';
                        if (data.creator === userId) {
                            actionBtn = `<button class="battle-action-btn delete" onclick="deleteBattle('${snap.id}')">–£–¥–∞–ª–∏—Ç—å</button>`;
                        } else {
                            actionBtn = `<button class="battle-action-btn" onclick="joinBattle('${snap.id}')">–°–º–æ—Ç—Ä–µ—Ç—å / –í–æ–π—Ç–∏</button>`;
                        }

                        div.innerHTML = `
                            <div class="battle-round">
                                <span class="round-num">${rounds}</span>
                                <span class="round-label">–†–∞—É–Ω–¥–æ–≤</span>
                            </div>
                            <div class="battle-cases">
                                ${casesHtml}
                            </div>
                            <div class="battle-info-right">
                                <div class="battle-price-tag">${price}</div>
                                <div class="battle-users">
                                    <div class="battle-user-avatar" title="${data.creatorName}">
                                        ${avatarHtml}
                                    </div>
                                    <div class="battle-user-avatar" style="border-style:dashed; opacity:0.5;">
                                        <span>+</span>
                                    </div>
                                </div>
                                ${actionBtn}
                            </div>
                        `;
                        listDiv.appendChild(div);
                    });
                });
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –±–∞—Ç—Ç–ª–æ–≤:", err);
                const listDiv = document.getElementById('battleList');
                if (listDiv) listDiv.innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞—Ç—Ç–ª–æ–≤.";
            }
        }

        async function joinBattle(battleId) {
            try {
                if (isGuest || !userId) throw new Error('–¢–æ–ª—å–∫–æ –¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö');
                const battleRef = doc(db, 'battles', battleId);
                await runTransaction(db, async (tx) => {
                    const bSnap = await tx.get(battleRef);
                    const data = bSnap.data();
                    if (!data || data.status !== 'open') throw new Error('–ë–∞—Ç—Ç–ª —É–∂–µ –∑–∞–∫—Ä—ã—Ç');
                    if (data.creator === userId) throw new Error('–ù–µ–ª—å–∑—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —Å–≤–æ–µ–º—É –±–∞—Ç—Ç–ª—É');
                    if (data.player2) throw new Error('–ë–∞—Ç—Ç–ª —É–∂–µ –∑–∞–Ω—è—Ç');
                    if (!data.isCharity) {
                        const userRef = doc(db, 'users', userId);
                        const uSnap = await tx.get(userRef);
                        const uData = uSnap.data() || {};
                        const totalCost = data.totalCost;
                        if ((uData.balance || 0) < totalCost) throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
                        
                        // Bet tracking logic
                        const updates = { balance: (uData.balance || 0) - totalCost };
                        const todayStr = new Date().toDateString();
                        if (uData.lastDailyReset !== todayStr) {
                            updates.dailyBet = totalCost;
                            updates.lastDailyReset = todayStr;
                        } else {
                            updates.dailyBet = (uData.dailyBet || 0) + totalCost;
                        }
                        updates.totalBet = (uData.totalBet || 0) + totalCost;
                        
                        tx.update(userRef, updates);
                        currentUser.balance = (uData.balance || 0) - totalCost;
                        updateBalance();
                    }
                    tx.update(battleRef, {
                        player2: userId,
                        player2Name: currentUser.username,
                        status: 'started'
                    });
                });
                subscribeToBattle(battleId);
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:", err);
                alert(err.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è");
            }
        }

        // Expose functions to window for onclick handlers
        window.joinBattle = joinBattle;
        window.deleteBattle = deleteBattle;

        async function awardPendingForUser() {
            try {
                if (!userId || isGuest) return;
                const myBattles1 = query(collection(db, 'battles'), where('player1', '==', userId), where('status', '==', 'finished'));
                const myBattles2 = query(collection(db, 'battles'), where('player2', '==', userId), where('status', '==', 'finished'));
                const [snap1, snap2] = await Promise.all([getDocs(myBattles1), getDocs(myBattles2)]);
                let savedCount = 0;

                const processBattle = async (snap) => {
                    const data = snap.data();
                    if (!data) return;
                    const isP1 = data.player1 === userId;
                    const mySaved = isP1 ? data.player1Saved : data.player2Saved;
                    const myClaimed = isP1 ? data.player1Claimed : data.player2Claimed;
                    if (mySaved || myClaimed) return;
                    const myTotal = isP1 ? data.player1Total : data.player2Total;
                    const oppTotal = isP1 ? data.player2Total : data.player1Total;
                    const myItems = isP1 ? data.player1Items || [] : data.player2Items || [];
                    const oppItems = isP1 ? data.player2Items || [] : data.player1Items || [];
                    const iWin = data.winner === userId;
                    const isDraw = !data.winner;
                    const itemsToSave = iWin ? myItems.concat(oppItems) : (isDraw ? myItems : []);
                    if (itemsToSave.length === 0) return;
                    await runTransaction(db, async (tx) => {
                        const userRef = doc(db, 'users', userId);
                        const uSnap = await tx.get(userRef);
                        const uData = uSnap.data() || {};
                        const inventory = Array.isArray(uData.inventory) ? uData.inventory : [];
                        const newItems = itemsToSave.filter(it => !inventory.some(e =>
                            e.battleId === snap.id && e.name === it.name && e.value === it.value
                        )).map(it => ({
                            id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString() + Math.random().toString(16).slice(2)),
                            emoji: it.emoji,
                            name: it.name,
                            value: it.value,
                            source: '–ë–∞—Ç—Ç–ª',
                            battleId: snap.id,
                            timestamp: Date.now()
                        }));
                        const updatedInv = inventory.concat(newItems);
                        tx.update(userRef, { inventory: updatedInv });
                        tx.update(doc(db, 'battles', snap.id), { [isP1 ? 'player1Saved' : 'player2Saved']: true });
                        currentUser.inventory = updatedInv;
                        savedCount += newItems.length;
                    });
                };
                const promises = [];
                snap1.forEach(s => promises.push(processBattle(s)));
                snap2.forEach(s => promises.push(processBattle(s)));
                await Promise.all(promises);

                if (savedCount > 0) {
                    const toast = document.createElement('div');
                    toast.style.position = 'fixed';
                    toast.style.bottom = '20px';
                    toast.style.left = '50%';
                    toast.style.transform = 'translateX(-50%)';
                    toast.style.background = '#10b981';
                    toast.style.color = 'white';
                    toast.style.padding = '12px 24px';
                    toast.style.borderRadius = '12px';
                    toast.style.zIndex = '9999';
                    toast.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.4)';
                    toast.style.fontWeight = 'bold';
                    toast.innerHTML = `‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤: ${savedCount}`;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 4000);
                }
            } catch (e) {}
        }

        async function deleteBattle(battleId) {
            try {
                const battleRef = doc(db, 'battles', battleId);
                await runTransaction(db, async (tx) => {
                    const battleSnap = await tx.get(battleRef);
                    const data = battleSnap.data();
                    if (!data) throw new Error('–ë–∞—Ç—Ç–ª –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    if (data.creator !== userId) throw new Error('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –±–∞—Ç—Ç–ª');
                    if (data.status !== 'open') throw new Error('–ë–∞—Ç—Ç–ª —É–∂–µ –Ω–∞—á–∞–ª—Å—è –∏–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω');

                    const refund = data.creatorPaid || data.totalCost;
                    const userRef = doc(db, 'users', userId);
                    const userSnap = await tx.get(userRef);
                    if (!userSnap.exists()) throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    
                    const currentBalance = userSnap.data().balance || 0;
                    const newBalance = currentBalance + refund;

                    tx.update(userRef, { balance: newBalance });
                    tx.delete(battleRef);
                    
                    // Update local state only after successful transaction
                    currentUser.balance = newBalance;
                });
                
                updateBalance();
                alert(`–ë–∞—Ç—Ç–ª —É–¥–∞–ª—ë–Ω, —Å—Ä–µ–¥—Å—Ç–≤–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã`);
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:", err);
                alert(err.message || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –±–∞—Ç—Ç–ª–∞");
            }
        }

document.addEventListener('DOMContentLoaded', () => {
    createParticles();
    loadCurrentUser();

    renderCaseGrid('botCaseGrid', type => addSelectedCase('bot', type));
    renderCaseGrid('playerCaseGrid', type => addSelectedCase('player', type));

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤
    const vsBotBtn      = document.getElementById('vsBotBtn');
    const vsPlayerBtn   = document.getElementById('vsPlayerBtn');
    const botSection    = document.getElementById('vsBotSection');
    const playerSection = document.getElementById('vsPlayerSection');

    function setBotMode() {
        vsBotBtn.classList.add('active');
        vsPlayerBtn.classList.remove('active');
        botSection.style.display = 'block';
        playerSection.style.display = 'none';
    }

    function setPlayerMode() {
        if (isGuest) {
            alert('–¢–æ–ª—å–∫–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∏–≥—Ä–∞—Ç—å Vs –ò–≥—Ä–æ–∫');
            return;
        }
        vsPlayerBtn.classList.add('active');
        vsBotBtn.classList.remove('active');
        botSection.style.display = 'none';
        playerSection.style.display = 'block';
        loadBattles();
    }

    vsBotBtn.addEventListener('click', setBotMode);
    vsPlayerBtn.addEventListener('click', setPlayerMode);
    setBotMode(); // –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

    // ‚îÄ‚îÄ‚îÄ –ö–Ω–æ–ø–∫–∏ "–ò–≥—Ä–∞—Ç—å" –∏ "–ë—ã—Å—Ç—Ä–æ" ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const playBtn = document.getElementById('playVsBot');
    const quickBtn = document.getElementById('quickVsBot');

    if (playBtn) {
        // –ö–ª–æ–Ω–∏—Ä—É–µ–º ‚Üí —É–±–∏—Ä–∞–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏
        const cleanPlay = playBtn.cloneNode(true);
        playBtn.parentNode.replaceChild(cleanPlay, playBtn);
        cleanPlay.addEventListener('click', () => playVsBot(false));
        cleanPlay.addEventListener('touchstart', (e) => { e.preventDefault(); cleanPlay.click(); }, { passive: false });
    }

    if (quickBtn) {
        const cleanQuick = quickBtn.cloneNode(true);
        quickBtn.parentNode.replaceChild(cleanQuick, quickBtn);
        cleanQuick.addEventListener('click', () => playVsBot(true));
        cleanQuick.addEventListener('touchstart', (e) => { e.preventDefault(); cleanQuick.click(); }, { passive: false });
    }

    // –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏
    document.getElementById('createBattleBtn')?.addEventListener('click', () => {
        document.getElementById('createForm').style.display = 'block';
    });

    document.getElementById('confirmCreate')?.addEventListener('click', createBattle);

    document.getElementById('charityMode')?.addEventListener('change', e => {
        isCharityMode = e.target.checked;
        updateTotalCost('player');
    });

    // –∫–Ω–æ–ø–∫–∞ —à–∞–Ω—Å–æ–≤
    document.getElementById('showChancesBtn')?.addEventListener('click', () => {
        const modal = document.getElementById('chancesModal');
        const content = document.getElementById('chancesContent');
        if (!modal || !content) return;

        content.innerHTML = '';
        sortedCaseKeys.forEach(key => {
            const c = cases[key];
            let html = `<div style="margin:14px 0; padding:14px; background:rgba(35,30,60,0.65); border-radius:10px; border-left:4px solid ${c.color}">
                <h3 style="margin:0 0 10px; color:${c.color}">${caseDisplayNames[key] || key} ‚Äî ${c.price}‚ÇΩ</h3>`;

            c.items.forEach(it => {
                const percent = (it.prob * 100).toFixed(2).replace(/\.?0+$/, "");
                html += `<div style="display:flex; justify-content:space-between; margin:5px 0; font-size:0.96rem;">
                    <span>${it.emoji} ${it.name}</span>
                    <span style="color:#fde047; font-weight:600;">${it.value}‚ÇΩ ‚Äî ${percent}%</span>
                </div>`;
            });
            html += '</div>';
            content.innerHTML += html;
        });
        modal.style.display = 'flex';
    });

    document.getElementById('closeChances')?.addEventListener('click', () => {
        document.getElementById('chancesModal').style.display = 'none';
    });
});
    </script>
</body>
</html>
