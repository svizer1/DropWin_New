<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>–ë–∞—Ç—Ç–ª—ã –ö–µ–π—Å–æ–≤ | DropWin</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        .mode-select {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin: 16px 0;
        }
        .mode-btn {
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            background: linear-gradient(135deg, #6d28d9, #4c1d95);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(167, 139, 250, 0.4);
            transition: all 0.3s ease;
        }
        .mode-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(167, 139, 250, 0.6); }
        .mode-btn.active {
            background: linear-gradient(135deg, #a855f7, #8b5cf6);
            box-shadow: 0 6px 16px rgba(192, 132, 252, 0.6);
        }

        .case-select-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 14px;
            margin: 16px 0;
        }
        .case-card {
            background: transparent;
            padding: 10px;
            border-radius: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s ease;
            box-shadow: 0 4px 18px rgba(0,0,0,0.5);
            overflow: hidden;
            aspect-ratio: 1 / 1;
            position: relative;
        }
        .case-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }
        .case-card.selected {
            border: 3px solid #d946ef;
            transform: scale(1.06);
            box-shadow: 0 0 25px #d946ef88;
        }
        .case-card .name {
            position: absolute;
            bottom: 36px; left: 0; right: 0;
            font-weight: 700; color: white;
            text-shadow: 0 0 6px black; font-size: 1.1rem;
        }
        .case-card .price {
            position: absolute;
            bottom: 8px; left: 0; right: 0;
            color: #fde047; text-shadow: 0 0 6px black; font-size: 1.05rem;
        }

        .open-results {
            display: flex;
            justify-content: space-between;
            gap: 24px;
            margin: 24px 0;
            flex-wrap: wrap;
        }
        .player-opens, .opponent-opens {
            flex: 1;
            min-width: 300px;
            background: rgba(30, 30, 50, 0.75);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
        }
        .player-opens   { border: 2px solid #8b5cf6; }
        .opponent-opens { border: 2px solid #5b21b6; }

        .case-opening-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            min-height: 160px;
        }

        .case-box {
            width: 95px;
            height: 95px;
            background-size: cover;
            background-position: center;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0,0,0,0.6);
            opacity: 0;
            transform: scale(0.92);
            transition: opacity 0.5s ease, transform 0.5s ease;
            margin: 4px;
        }

        .case-box.visible {
            opacity: 1;
            transform: scale(1);
        }

        .case-box.revealed {
            transform: scale(1.12);
            box-shadow: 0 0 28px rgba(168, 85, 247, 0.75);
        }

        .case-box.opening {
            animation: dramaticOpen 2.8s ease-out forwards;
        }

        @keyframes dramaticOpen {
            0%   { transform: scale(0.75) rotate(-10deg); filter: brightness(0.7); }
            30%  { transform: scale(1.25) rotate(8deg);   filter: brightness(1.5); }
            55%  { transform: scale(1.05) rotate(-5deg);  filter: brightness(1.25); }
            80%  { transform: scale(1.12) rotate(4deg);   filter: brightness(1.4);  }
            100% { transform: scale(1.12) rotate(0deg);   filter: brightness(1.2);  }
        }

        .item-reveal {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3.6rem;
            opacity: 0;
            text-shadow: 0 0 16px rgba(0,0,0,0.9);
            animation: popIn 1s ease-out forwards;
            animation-delay: 0.7s;
        }

        @keyframes popIn {
            0%   { transform: translate(-50%, -50%) scale(0.4) rotate(-60deg); opacity: 0; }
            50%  { transform: translate(-50%, -50%) scale(1.55) rotate(20deg); opacity: 1; }
            80%  { transform: translate(-50%, -50%) scale(0.95) rotate(-8deg); }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg);     opacity: 1; }
        }

        .value-label {
            position: absolute;
            bottom: 8px; left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: #fde047;
            padding: 5px 12px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.1rem;
            display: none;
            box-shadow: 0 2px 8px black;
        }
        .case-box.revealed .value-label { display: block; }

        .remove-btn {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            color: white;
            padding: 6px 14px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            margin-left: 12px;
            transition: all 0.2s;
        }
        .remove-btn:hover { transform: scale(1.08); box-shadow: 0 0 14px #ef444499; }

        .claim-btn {
            background: linear-gradient(135deg, #34d399, #059669);
            color: white;
            padding: 14px 36px;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            font-weight: 800;
            margin: 24px auto;
            display: block;
            box-shadow: 0 6px 20px rgba(16,185,129,0.6);
            transition: all 0.3s;
        }
        .claim-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 32px rgba(16,185,129,0.8); }
        .claim-btn.disabled { background: #4b5563; cursor: not-allowed; box-shadow: none; }

        .btn, .join-btn {
            padding: 12px 28px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            border: none;
            transition: all 0.25s;
        }
        .btn { background: linear-gradient(135deg, #a855f7, #7e22ce); color: white; box-shadow: 0 5px 16px #a855f755; }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 10px 24px #a855f788; }

        .join-btn { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; box-shadow: 0 4px 14px #3b82f655; }
        .join-btn:hover { transform: scale(1.07); box-shadow: 0 8px 20px #3b82f688; }

        .battle-item {
            background: rgba(45, 40, 75, 0.8);
            border-radius: 16px;
            padding: 20px;
            margin: 16px 0;
            border-left: 6px solid #8b5cf6;
        }
        .battle-price {
            font-size: 1.4rem;
            font-weight: 800;
            margin: 12px 0;
        }
        .battle-price.free  { color: #34d399; }
        .battle-price.paid  { color: #c4b5fd; }

        .delete-battle-btn {
            background: linear-gradient(135deg, #ef4444, #991b1b);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 12px;
            font-weight: 700;
            margin-top: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.25s;
        }
        .delete-battle-btn:hover {
            transform: scale(1.06);
            box-shadow: 0 0 20px #ef4444bb;
        }

        .charity-label {
            background: linear-gradient(135deg, #10b981, #047857);
            color: white;
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: bold;
            margin-left: 14px;
        }

        .charity-toggle {
            margin: 24px auto;
            text-align: center;
            font-size: 1.2rem;
            color: #e5e7eb;
        }
        .charity-toggle input[type="checkbox"] {
            transform: scale(1.6);
            margin-right: 14px;
        }

        .nickname { color: #c084fc; font-weight: bold; }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>

    <div class="header">
        <div class="logo">üíé DROPWIN</div>
        <div class="balance-container">
            <div class="balance">üí∞ <span id="balance">0</span>‚ÇΩ</div>
            <button class="auth-btn" id="authBtn">–ê–∫–∫–∞—É–Ω—Ç</button>
        </div>
    </div>

    <div class="content">
        <button class="back-btn" onclick="location.href='../index.html'">‚Üê –ù–∞–∑–∞–¥</button>

        <div class="game-card">
            <div class="game-title">‚öîÔ∏è –ë–∞—Ç—Ç–ª—ã –ö–µ–π—Å–æ–≤</div>

            <div class="mode-select">
                <button class="mode-btn active" id="vsBotBtn">Vs –ë–æ—Ç</button>
                <button class="mode-btn" id="vsPlayerBtn">Vs –ò–≥—Ä–æ–∫</button>
            </div>

            <div id="vsBotSection">
                <div class="case-select-grid" id="botCaseGrid"></div>
                <button class="btn add-case-btn" id="addBotCase">–î–æ–±–∞–≤–∏—Ç—å –∫–µ–π—Å</button>
                <div class="selected-cases" id="selectedBotCases"></div>
                <div id="botTotalCost" style="text-align:center; margin:12px 0; font-size:1.3rem;">–ò—Ç–æ–≥–æ: 0‚ÇΩ</div>
                <button class="btn" id="playVsBot">–ò–≥—Ä–∞—Ç—å</button>
                <button class="btn" id="quickVsBot" style="background: linear-gradient(135deg, #fbbf24, #d97706);">–ë—ã—Å—Ç—Ä–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ</button>
                <div id="botResults" style="margin-top:24px;"></div>
            </div>

            <div id="vsPlayerSection" style="display:none;">
                <button class="btn" id="createBattleBtn">–°–æ–∑–¥–∞—Ç—å –±–∞—Ç—Ç–ª</button>

                <div class="battle-form" id="createForm" style="display:none;">
                    <div class="charity-toggle">
                        <input type="checkbox" id="charityMode">
                        <label for="charityMode">–ë–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –±–∞—Ç—Ç–ª (–æ–ø–ª–∞—á–∏–≤–∞—é –∑–∞ –¥–≤–æ–∏—Ö)</label>
                    </div>

                    <div class="case-select-grid" id="playerCaseGrid"></div>
                    <button class="btn add-case-btn" id="addPlayerCase">–î–æ–±–∞–≤–∏—Ç—å –∫–µ–π—Å</button>
                    <div class="selected-cases" id="selectedPlayerCases"></div>
                    <div id="playerTotalCost" style="text-align:center; margin:16px 0; font-size:1.4rem;">–ò—Ç–æ–≥–æ: 0‚ÇΩ</div>
                    <button class="btn" id="confirmCreate">–°–æ–∑–¥–∞—Ç—å</button>
                </div>

                <div class="battle-list" id="battleList"></div>
            </div>

            <div id="status" style="margin-top:20px; text-align:center; min-height:28px; font-size:1.2rem;"></div>
        </div>
    </div>

    <div class="nav">
        <button class="nav-btn" onclick="location.href='../index.html'"><span>üè†</span><span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span></button>
        <button class="nav-btn" onclick="location.href='../profile.html'"><span>üë§</span><span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span></button>
        <button class="nav-btn" onclick="location.href='../register.html'"><span>üîë</span><span class="nav-label">–í—Ö–æ–¥</span></button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, addDoc, onSnapshot, getDocs, query, where, deleteDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBVra2JN-C7-1b_Qa4cU8--XvJ83lymiM8",
            authDomain: "dropwin-8d94b.firebaseapp.com",
            projectId: "dropwin-8d94b",
            storageBucket: "dropwin-8d94b.firebasestorage.app",
            messagingSenderId: "988974289403",
            appId: "1:988974289403:web:886d34e6f65920a105fb5e",
            measurementId: "G-BK010MHN8N"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        function createParticles() {
            const container = document.getElementById('particles');
            if (!container) return;
            for (let i = 0; i < 40; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.width = p.style.height = Math.random() * 3 + 1 + 'px';
                p.style.left = Math.random() * 100 + '%';
                p.style.animationDuration = Math.random() * 15 + 10 + 's';
                p.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(p);
            }
        }

        let currentUser = null;
        let userId = null;
        let isGuest = false;
        let isCharityMode = false;

        const cases = {
            bomj: {
                price: 5,
                items: [
                    {emoji: 'üß¶', name: '–î—ã—Ä—è–≤—ã–π –Ω–æ—Å–æ–∫', value: 1, prob: 0.42},
                    {emoji: 'üçû', name: '–ß—ë—Ä—Å—Ç–≤—ã–π —Ö–ª–µ–±', value: 3, prob: 0.24},
                    {emoji: 'üóëÔ∏è', name: '–ú—É—Å–æ—Ä–Ω—ã–π –ø–∞–∫–µ—Ç', value: 7, prob: 0.14},
                    {emoji: 'üç∫', name: '–¢—ë–ø–ª–æ–µ –ø–∏–≤–æ 0.5', value: 12, prob: 0.09},
                    {emoji: 'ü™ô', name: '–ì–æ—Ä—Å—Ç–∫–∞ –º–µ–ª–æ—á–∏', value: 25, prob: 0.055},
                    {emoji: 'üß•', name: '–°—Ç–∞—Ä–∞—è –∫—É—Ä—Ç–∫–∞', value: 50, prob: 0.025},
                    {emoji: 'üì±', name: '–°–ª–æ–º–∞–Ω–Ω—ã–π Nokia', value: 100, prob: 0.015},
                    {emoji: 'üí∏', name: '–ó–∞–Ω–∞—á–∫–∞ –ø–æ–¥ –º–∞—Ç—Ä–∞—Å–æ–º', value: 180, prob: 0.006},
                ],
                color: '#6b7280',
                icon: 'üóëÔ∏è'
            },
            vibe: {
                price: 45,
                items: [
                    {emoji: 'üíñ', name: '–°–µ—Ä–¥—Ü–µ', value: 15, prob: 0.65},
                    {emoji: 'üåπ', name: '–†–æ–∑–∞', value: 25, prob: 0.17},
                    {emoji: 'üöÄ', name: '–†–∞–∫–µ—Ç–∞', value: 50, prob: 0.07},
                    {emoji: 'üíê', name: '–¶–≤–µ—Ç—ã', value: 50, prob: 0.07},
                    {emoji: 'üíç', name: '–ö–æ–ª—å—Ü–æ', value: 100, prob: 0.015},
                    {emoji: 'üíé', name: '–ê–ª–º–∞–∑', value: 100, prob: 0.015},
                    {emoji: 'üç≠', name: '–õ–æ–ª-–ø–æ–ø', value: 325, prob: 0.0075},
                    {emoji: 'üê∂', name: '–°—É–ø –î–æ–≥', value: 425, prob: 0.005},
                    {emoji: 'ü§°', name: '–®–∞–ø–∫–∞ —à—É—Ç–∞', value: 500, prob: 0.0025},
                    {emoji: '‚≠ê', name: '–ó–≤–µ–∑–¥–∞', value: 200, prob: 0.0025},
                ],
                color: '#ec4899',
                icon: 'üíñ'
            },
            dvornik: {
                price: 25,
                items: [
                    {emoji: 'üßπ', name: '–ú–µ—Ç–ª–∞', value: 5, prob: 0.30},
                    {emoji: 'ü™£', name: '–í–µ–¥—Ä–æ', value: 10, prob: 0.25},
                    {emoji: 'üßº', name: '–ú—ã–ª–æ', value: 15, prob: 0.18},
                    {emoji: 'ü™ì', name: '–¢–æ–ø–æ—Ä —Å—Ç–∞—Ä—ã–π', value: 35, prob: 0.12},
                    {emoji: 'üß§', name: '–ü–µ—Ä—á–∞—Ç–∫–∏ —Ä–∞–±–æ—á–∏–µ', value: 50, prob: 0.08},
                    {emoji: '‚õèÔ∏è', name: '–õ–æ–ø–∞—Ç–∞', value: 80, prob: 0.04},
                    {emoji: 'üõ†Ô∏è', name: '–ù–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤', value: 150, prob: 0.025},
                    {emoji: 'üö≤', name: '–í–µ–ª–æ—Å–∏–ø–µ–¥ –±/—É', value: 400, prob: 0.005},
                ],
                color: '#eab308',
                icon: 'üßπ'
            },
            schoolboy: {
                price: 250,
                items: [
                    {emoji: 'üìö', name: '–£—á–µ–±–Ω–∏–∫', value: 80, prob: 0.50},
                    {emoji: 'üéí', name: '–†—é–∫–∑–∞–∫', value: 150, prob: 0.25},
                    {emoji: 'üì±', name: '–°–º–∞—Ä—Ç—Ñ–æ–Ω', value: 400, prob: 0.12},
                    {emoji: 'üíª', name: '–ù–æ—É—Ç–±—É–∫', value: 700, prob: 0.07},
                    {emoji: 'üéÆ', name: 'PlayStation', value: 1000, prob: 0.03},
                    {emoji: 'üöó', name: '–ú–∞—à–∏–Ω–∫–∞', value: 1300, prob: 0.02},
                    {emoji: 'üè†', name: '–ö–≤–∞—Ä—Ç–∏—Ä–∞', value: 4000, prob: 0.005},
                ],
                color: '#3b82f6',
                icon: 'üìö'
            },
            event: {
                price: 500,
                items: [
                    {emoji: 'üéâ', name: '–ö–æ–Ω—Ñ–µ—Ç—Ç–∏', value: 150, prob: 0.4},
                    {emoji: 'üéÅ', name: '–ü–æ–¥–∞—Ä–æ–∫', value: 300, prob: 0.25},
                    {emoji: 'üéà', name: '–í–æ–∑–¥—É—à–Ω—ã–π —à–∞—Ä', value: 400, prob: 0.15},
                    {emoji: 'üçæ', name: '–®–∞–º–ø–∞–Ω—Å–∫–æ–µ', value: 600, prob: 0.1},
                    {emoji: 'üé§', name: '–ú–∏–∫—Ä–æ—Ñ–æ–Ω', value: 900, prob: 0.04},
                    {emoji: 'üé¨', name: '–ö–∏–Ω–æ', value: 1500, prob: 0.025},
                    {emoji: '‚úàÔ∏è', name: '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ', value: 3000, prob: 0.01},
                ],
                color: '#ef4444',
                icon: 'üéâ'
            },
            milioner: {
                price: 1000,
                items: [
                    {emoji: 'üíµ', name: '–î–µ–Ω—å–≥–∏', value: 500, prob: 0.48},
                    {emoji: 'üè¶', name: '–ë–∞–Ω–∫', value: 1000, prob: 0.24},
                    {emoji: 'üí∞', name: '–ú–µ—à–æ–∫ –¥–µ–Ω–µ–≥', value: 2000, prob: 0.18},
                    {emoji: 'üìà', name: '–ì—Ä–∞—Ñ–∏–∫ —Ä–æ—Å—Ç–∞', value: 3000, prob: 0.08},
                    {emoji: 'ü§ë', name: '–ú–∏–ª–ª–∏–æ–Ω–µ—Ä', value: 5000, prob: 0.015},
                    {emoji: 'üöÄ', name: '–†–∞–∫–µ—Ç–∞', value: 10000, prob: 0.007},
                    {emoji: 'üè∞', name: '–î–≤–æ—Ä–µ—Ü', value: 50000, prob: 0.003},
                ],
                color: '#fbbf24',
                icon: 'üí∞'
            }
        };

        const caseBackgrounds = {
            bomj:     '../images/bomj.png',
            vibe:     '../images/vibe.png',
            dvornik:  '../images/dvornik.png',
            schoolboy:'../images/schoolboy.png',
            event:    '../images/event.png',
            milioner: '../images/milioner.png'
        };

        const caseOpenedBackgrounds = {
            bomj:     '../images/bomj1.png',
            vibe:     '../images/vibe1.png',
            dvornik:  '../images/dvornik1.png',
            schoolboy:'../images/schoolboy1.png',
            event:    '../images/event1.png',
            milioner: '../images/milioner1.png'
        };

        const caseDisplayNames = {
            bomj:     "–ë–æ–º–∂",
            vibe:     "Vibe",
            dvornik:  "–î–≤–æ—Ä–Ω–∏–∫",
            schoolboy:"–®–∫–æ–ª—å–Ω–∏–∫",
            event:    "–ò–≤–µ–Ω—Ç",
            milioner: "–ú–∏–ª–ª–∏–æ–Ω–µ—Ä"
        };

        const sortedCaseKeys = Object.keys(cases).sort((a, b) => cases[a].price - cases[b].price);

        function renderCaseGrid(containerId, onSelect) {
            const grid = document.getElementById(containerId);
            grid.innerHTML = '';
            sortedCaseKeys.forEach(key => {
                const c = cases[key];
                const card = document.createElement('div');
                card.className = `case-card ${key}`;
                card.innerHTML = `
                    <img src="${caseBackgrounds[key]}" alt="${key}">
                    <div class="name">${caseDisplayNames[key] || key}</div>
                    <div class="price">${c.price}‚ÇΩ</div>
                `;
                card.onclick = () => onSelect(key);
                grid.appendChild(card);
            });
        }

        let selectedBotCases = [];
        let selectedPlayerCases = [];

        function addSelectedCase(section, caseType) {
            const arr = section === 'bot' ? selectedBotCases : selectedPlayerCases;
            arr.push(caseType);
            updateSelectedCases(section);
            updateTotalCost(section);
        }

        function updateSelectedCases(section) {
            const cont = document.getElementById(section === 'bot' ? 'selectedBotCases' : 'selectedPlayerCases');
            cont.innerHTML = '<h4>–í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–µ–π—Å—ã:</h4>';
            const arr = section === 'bot' ? selectedBotCases : selectedPlayerCases;
            arr.forEach((type, i) => {
                const div = document.createElement('div');
                div.textContent = `${caseDisplayNames[type] || type} (${cases[type].price}‚ÇΩ)`;
                const btn = document.createElement('button');
                btn.className = 'remove-btn';
                btn.textContent = '–£–¥–∞–ª–∏—Ç—å';
                btn.onclick = () => {
                    arr.splice(i, 1);
                    updateSelectedCases(section);
                    updateTotalCost(section);
                };
                div.appendChild(btn);
                cont.appendChild(div);
            });
        }

        function updateTotalCost(section) {
            const arr = section === 'bot' ? selectedBotCases : selectedPlayerCases;
            const total = arr.reduce((s, t) => s + cases[t].price, 0);
            const el = document.getElementById(section === 'bot' ? 'botTotalCost' : 'playerTotalCost');

            if (section === 'player' && isCharityMode) {
                el.innerHTML = `–ò—Ç–æ–≥–æ: ${total * 2}‚ÇΩ <span class="charity-label">–∑–∞ –¥–≤–æ–∏—Ö!</span>`;
            } else {
                el.textContent = `–ò—Ç–æ–≥–æ: ${total}‚ÇΩ`;
            }
        }

        function openCase(caseType) {
            const items = cases[caseType].items;
            const r = Math.random();
            let sum = 0;
            for (let it of items) {
                sum += it.prob;
                if (r <= sum) return { ...it, caseType };
            }
            return { ...items[0], caseType };
        }

     async function playVsBot(quick = false) {
    const totalCost = selectedBotCases.reduce((sum, type) => sum + cases[type].price, 0);
    if (currentUser.balance < totalCost) {
        alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞');
        return;
    }
    if (selectedBotCases.length === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∫–µ–π—Å');
        return;
    }

    currentUser.balance -= totalCost;
    await saveUser();
    updateBalance();

    const playerItems = selectedBotCases.map(type => openCase(type));
    const playerTotal = playerItems.reduce((sum, item) => sum + item.value, 0);
    const botItems    = selectedBotCases.map(type => openCase(type));
    const botTotal    = botItems.reduce((sum, item) => sum + item.value, 0);

    const resultsDiv = document.getElementById('botResults');
    if (!resultsDiv) return;

    resultsDiv.innerHTML = `
        <div class="open-results">
            <div class="player-opens">
                <h4>–í–∞—à–∏ –∫–µ–π—Å—ã (${currentUser?.username || '–ì–æ—Å—Ç—å'}):</h4>
                <div class="case-opening-container" id="playerCases"></div>
                <div class="total-value" id="playerTotal">–ò—Ç–æ–≥–æ: 0‚ÇΩ</div>
            </div>
            <div class="opponent-opens">
                <h4>–ë–æ—Ç:</h4>
                <div class="case-opening-container" id="botCases"></div>
                <div class="total-value" id="botTotal">–ò—Ç–æ–≥–æ: 0‚ÇΩ</div>
            </div>
        </div>
        <div id="resultText" style="text-align:center; margin-top:20px; font-size:1.4rem; min-height:40px;"></div>
    `;

    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
    await Promise.all([
        animateBatchedOpenings('playerCases', selectedBotCases, playerItems, playerTotal, 'player', quick),
        animateBatchedOpenings('botCases', selectedBotCases, botItems, botTotal, 'bot', quick)
    ]);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±–µ–∏—Ö –∞–Ω–∏–º–∞—Ü–∏–π
    showBotResult(playerTotal, botTotal, totalCost);
}

async function animateBatchedOpenings(containerId, caseTypes, items, total, side, quick = false) {
    const container = document.getElementById(containerId);
    if (!container) return;

    container.innerHTML = '';

    const totalEl = document.getElementById(containerId === 'playerCases' ? 'playerTotal' : 'botTotal');
    if (totalEl) totalEl.textContent = `–ò—Ç–æ–≥–æ: ${total}‚ÇΩ`;

    // –°–æ–∑–¥–∞—ë–º –≤—Å–µ –∫–µ–π—Å—ã —Å—Ä–∞–∑—É
    caseTypes.forEach((type, index) => {
        const item = items[index];
        const box = document.createElement('div');
        box.className = `case-box ${type}`;
        box.dataset.type = type;
        box.style.backgroundImage = `url('${caseBackgrounds[type] || ''}')`;
        box.innerHTML = `
            <div class="item-reveal">${item.emoji}</div>
            <div class="value-label">${item.value}‚ÇΩ</div>
        `;
        container.appendChild(box);

        // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ
        setTimeout(() => box.classList.add('visible'), index * 80 + 100);
    });

    if (quick) {
        // –ë—ã—Å—Ç—Ä–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ ‚Äî –≤—Å—ë –ø–æ—á—Ç–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
        setTimeout(() => {
            container.querySelectorAll('.case-box').forEach(box => {
                const type = box.dataset.type;
                const opened = caseOpenedBackgrounds[type];
                if (opened) box.style.backgroundImage = `url('${opened}')`;
                box.classList.add('opening', 'revealed');
            });
        }, 600);
    } else {
        // –ù–æ—Ä–º–∞–ª—å–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è ‚Äî –ø–æ –æ–¥–Ω–æ–º—É —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        for (let i = 0; i < caseTypes.length; i++) {
            await new Promise(resolve => setTimeout(resolve, 700));
            const box = container.children[i];
            if (!box) continue;
            const type = box.dataset.type;
            const opened = caseOpenedBackgrounds[type];
            if (opened) box.style.backgroundImage = `url('${opened}')`;
            box.classList.add('opening');
            setTimeout(() => box.classList.add('revealed'), 1400);
        }
    }
}

function showBotResult(playerTotal, botTotal, totalCost) {
    const resultTextEl = document.getElementById('resultText');
    if (!resultTextEl) return;

    let resultText = '';
    let prize = 0;

    if (playerTotal > botTotal) {
        prize = playerTotal + botTotal;
        resultText = `<span style="color:#34d399">–ü–æ–±–µ–¥–∞! +${prize}‚ÇΩ</span>`;
    } else if (playerTotal < botTotal) {
        resultText = `<span style="color:#f87171">–ü—Ä–æ–∏–≥—Ä—ã—à</span>`;
    } else {
        prize = playerTotal;
        resultText = `–ù–∏—á—å—è ‚Äî –≤–æ–∑–≤—Ä–∞—Ç ${prize}‚ÇΩ`;
    }

    resultTextEl.innerHTML = resultText;

    if (prize > 0) {
        currentUser.balance += prize;
        saveUser();
        updateBalance();
        resultTextEl.innerHTML += `<br><div style="color:#a78bfa; margin-top:12px;">–ü—Ä–∏–∑ –ø–æ–ª—É—á–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (+${prize}‚ÇΩ)</div>`;
    }
}

        async function saveUser() {
            try {
                if (isGuest) {
                    let users = JSON.parse(localStorage.getItem('dropwin_users')) || [];
                    const idx = users.findIndex(u => u.username === '–ì–æ—Å—Ç—å');
                    if (idx !== -1) users[idx] = currentUser;
                    localStorage.setItem('dropwin_users', JSON.stringify(users));
                } else if (userId) {
                    await updateDoc(doc(db, 'users', userId), { balance: currentUser.balance });
                }
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", err);
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å.");
            }
        }

        function updateBalance() {
            document.getElementById('balance').textContent = currentUser ? currentUser.balance || 0 : 0;
            document.getElementById('authBtn').textContent = isGuest ? '–ì–æ—Å—Ç—å' : (currentUser ? currentUser.username : '–í–æ–π—Ç–∏');
            document.getElementById('authBtn').onclick = () => location.href = '../profile.html';
        }

        function loadCurrentUser() {
            onAuthStateChanged(auth, async (user) => {
                try {
                    if (user) {
                        userId = user.uid;
                        const snap = await getDoc(doc(db, 'users', user.uid));
                        if (snap.exists()) {
                            currentUser = snap.data();
                            isGuest = false;
                            updateBalance();
                            if (document.getElementById('vsPlayerBtn')?.classList.contains('active')) {
                                loadBattles();
                            }
                        }
                    } else {
                        const username = localStorage.getItem('dropwin_current_username');
                        if (username === '–ì–æ—Å—Ç—å') {
                            const users = JSON.parse(localStorage.getItem('dropwin_users')) || [];
                            currentUser = users.find(u => u.username === '–ì–æ—Å—Ç—å');
                            isGuest = true;
                            updateBalance();
                        } else {
                            location.href = '../register.html';
                        }
                    }
                } catch (err) {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", err);
                    document.getElementById('status').textContent = "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∞–∫–∫–∞—É–Ω—Ç—É.";
                }
            });
        }

        async function createBattle() {
            try {
                if (isGuest) throw new Error('–¢–æ–ª—å–∫–æ –¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö');
                if (selectedPlayerCases.length === 0) throw new Error('–í—ã–±–µ—Ä–∏—Ç–µ –∫–µ–π—Å—ã');

                const singleCost = selectedPlayerCases.reduce((sum, type) => sum + cases[type].price, 0);
                const costToPay = isCharityMode ? singleCost * 2 : singleCost;

                if (currentUser.balance < costToPay) throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞');

                const existingQ = query(collection(db, 'battles'), where('creator', '==', userId), where('status', '==', 'open'));
                const existingSnap = await getDocs(existingQ);
                if (!existingSnap.empty) throw new Error('–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–π –±–∞—Ç—Ç–ª. –£–¥–∞–ª–∏—Ç–µ –µ–≥–æ —Å–Ω–∞—á–∞–ª–∞.');

                currentUser.balance -= costToPay;
                await saveUser();
                updateBalance();

                const battleDoc = await addDoc(collection(db, 'battles'), {
                    creator: userId,
                    creatorName: currentUser.username,
                    caseTypes: selectedPlayerCases,
                    totalCost: singleCost,          // —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞
                    isCharity: isCharityMode,
                    creatorPaid: costToPay,         // —Å–∫–æ–ª—å–∫–æ –∑–∞–ø–ª–∞—Ç–∏–ª —Å–æ–∑–¥–∞—Ç–µ–ª—å
                    player1: userId,
                    player1Name: currentUser.username,
                    player2: null,
                    player2Name: null,
                    status: 'open',
                    player1Items: [],
                    player2Items: [],
                    player1Total: 0,
                    player2Total: 0,
                    player1Claimed: false,
                    player2Claimed: false,
                    createdAt: new Date()
                });

                subscribeToBattle(battleDoc.id);

                // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
                selectedPlayerCases = [];
                updateSelectedCases('player');
                updateTotalCost('player');
                document.getElementById('createForm').style.display = 'none';
                document.getElementById('charityMode').checked = false;
                isCharityMode = false;
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–∞—Ç—Ç–ª–∞:", err);
                alert(err.message || "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–∞—Ç—Ç–ª–∞");
            }
        }

        function subscribeToBattle(battleId) {
            onSnapshot(doc(db, 'battles', battleId), async (snap) => {
                try {
                    const data = snap.data();
                    if (!data) return;

                    const statusDiv = document.getElementById('status');
                    statusDiv.innerHTML = '';

                    if (data.status === 'open') {
                        statusDiv.innerHTML = `<div style="color:#fbbf24;">–ë–∞—Ç—Ç–ª —Å–æ–∑–¥–∞–Ω! –û–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞...</div>`;
                    } else if (data.status === 'started') {
                        statusDiv.innerHTML = `<div style="color:#34d399;">–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è! –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–µ–π—Å–æ–≤...</div>`;
                        if (data.player1Items.length === 0 && userId === data.player1) {
                            const p1Items = data.caseTypes.map(type => openCase(type));
                            const p1Total = p1Items.reduce((sum, item) => sum + item.value, 0);
                            const p2Items = data.caseTypes.map(type => openCase(type));
                            const p2Total = p2Items.reduce((sum, item) => sum + item.value, 0);

                            await updateDoc(snap.ref, {
                                player1Items: p1Items.map(item => ({emoji: item.emoji, name: item.name, value: item.value})),
                                player2Items: p2Items.map(item => ({emoji: item.emoji, name: item.name, value: item.value})),
                                player1Total: p1Total,
                                player2Total: p2Total,
                                status: 'finished'
                            });
                        }
                    } else if (data.status === 'finished') {
                        const p1Total = data.player1Total;
                        const p2Total = data.player2Total;
                        let winner = null;
                        if (p1Total > p2Total) winner = data.player1;
                        else if (p2Total > p1Total) winner = data.player2;

                        const isPlayer1 = userId === data.player1;
                        const myItems = isPlayer1 ? data.player1Items : data.player2Items;
                        const oppItems = isPlayer1 ? data.player2Items : data.player1Items;
                        const myTotal = isPlayer1 ? p1Total : p2Total;
                        const oppTotal = isPlayer1 ? p2Total : p1Total;
                        const opponentName = isPlayer1 ? data.player2Name : data.player1Name;
                        const myClaimed = isPlayer1 ? data.player1Claimed : data.player2Claimed;

                        let resultText = '';
                        let prize = 0;
                        if (winner === userId) {
                            prize = myTotal + oppTotal;
                            resultText = `<span style="color:#34d399">–ü–æ–±–µ–¥–∞! –ü—Ä–∏–∑: ${prize}‚ÇΩ</span>`;
                        } else if (winner) {
                            resultText = `<span style="color:#f87171">–ü—Ä–æ–∏–≥—Ä—ã—à</span>`;
                        } else {
                            prize = myTotal;
                            resultText = `–ù–∏—á—å—è ‚Äî –∑–∞–±–∏—Ä–∞–µ—à—å —Å–≤–æ–∏ ${prize}‚ÇΩ`;
                        }

                        statusDiv.innerHTML = `
                            <div class="open-results">
                                <div class="player-opens">
                                    <h4>–í–∞—à–∏ (<span class="nickname">${currentUser.username}</span>):</h4>
                                    <div class="case-opening-container" id="myBattleCases"></div>
                                    <div class="total-value">–ò—Ç–æ–≥–æ: ${myTotal}‚ÇΩ</div>
                                </div>
                                <div class="opponent-opens">
                                    <h4>${opponentName || '–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫'}:</h4>
                                    <div class="case-opening-container" id="oppBattleCases"></div>
                                    <div class="total-value">–ò—Ç–æ–≥–æ: ${oppTotal}‚ÇΩ</div>
                                </div>
                            </div>
                            <div id="battleResultText" style="text-align:center; margin-top:12px;">${resultText}</div>
                            <button class="claim-btn ${myClaimed ? 'disabled' : ''}" id="claimPrizeBtn">
                                ${prize > 0 ? `–ó–∞–±—Ä–∞—Ç—å ${prize}‚ÇΩ` : '–ù–µ—Ç –ø—Ä–∏–∑–∞'}
                            </button>
                        `;

                        await animateBatchedOpenings('myBattleCases', data.caseTypes, myItems, myTotal, 'my', false);
                        await animateBatchedOpenings('oppBattleCases', data.caseTypes, oppItems, oppTotal, 'opp', false);

                        const claimBtn = document.getElementById('claimPrizeBtn');
                        if (myClaimed || prize === 0) {
                            claimBtn.disabled = true;
                            if (prize === 0) claimBtn.remove();
                        } else {
                            claimBtn.onclick = async () => {
                                claimBtn.disabled = true;
                                claimBtn.classList.add('disabled');
                                claimBtn.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';

                                const freshSnap = await getDoc(snap.ref);
                                const freshData = freshSnap.data();
                                if (!freshData) return;

                                const alreadyClaimed = isPlayer1 ? freshData.player1Claimed : freshData.player2Claimed;
                                if (alreadyClaimed) {
                                    statusDiv.innerHTML += '<div style="color:#f87171; text-align:center; padding:20px;">–ü—Ä–∏–∑ —É–∂–µ –±—ã–ª –∑–∞–±—Ä–∞–Ω!</div>';
                                    return;
                                }

                                currentUser.balance += prize;
                                await saveUser();
                                updateBalance();

                                await updateDoc(snap.ref, {
                                    [isPlayer1 ? 'player1Claimed' : 'player2Claimed']: true
                                });

                                statusDiv.innerHTML = `
                                    <div style="text-align:center; padding:30px; color:#a78bfa; font-size:1.4rem;">
                                        –ü—Ä–∏–∑ –ø–æ–ª—É—á–µ–Ω (+${prize}‚ÇΩ)
                                    </div>`;
                                setTimeout(() => { statusDiv.innerHTML = ''; }, 2200);
                            };
                        }
                    }
                } catch (err) {
                    console.error("–û—à–∏–±–∫–∞ –≤ onSnapshot –±–∞—Ç—Ç–ª–∞:", err);
                    document.getElementById('status').textContent = "–û—à–∏–±–∫–∞ –æ–Ω–ª–∞–π–Ω-–±–∞—Ç—Ç–ª–∞.";
                }
            });
        }

        async function loadBattles() {
            try {
                const q = query(collection(db, 'battles'), where('status', '==', 'open'));
                onSnapshot(q, (querySnap) => {
                    const listDiv = document.getElementById('battleList');
                    listDiv.innerHTML = '';
                    if (querySnap.empty) {
                        listDiv.innerHTML = '<div>–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –±–∞—Ç—Ç–ª–æ–≤</div>';
                        return;
                    }
                    querySnap.forEach(snap => {
                        const data = snap.data();
                        const priceText = data.isCharity
                            ? '<span class="battle-price free">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>'
                            : `<span class="battle-price paid">${data.totalCost}‚ÇΩ</span>`;

                        const charityBadge = data.isCharity
                            ? '<span class="charity-label">–ë–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–π</span>'
                            : '';

                        const div = document.createElement('div');
                        div.className = 'battle-item';
                        div.innerHTML = `
                            <div>–°–æ–∑–¥–∞—Ç–µ–ª—å: <span class="nickname">${data.creatorName || '???'}</span> ${charityBadge}</div>
                            <div>–ö–µ–π—Å—ã: ${data.caseTypes.map(t => `${caseDisplayNames[t] || t} (${cases[t]?.price || '?'}‚ÇΩ)`).join(', ')}</div>
                            <div>${priceText}</div>
                            <button class="join-btn" data-battle-id="${snap.id}">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
                        `;
                        if (data.creator === userId) {
                            const delBtn = document.createElement('button');
                            delBtn.className = 'delete-battle-btn';
                            delBtn.innerHTML = 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å';
                            delBtn.onclick = () => deleteBattle(snap.id);
                            div.appendChild(delBtn);
                        }
                        listDiv.appendChild(div);
                    });
                    document.querySelectorAll('.join-btn').forEach(btn => {
                        btn.addEventListener('click', () => joinBattle(btn.dataset.battleId));
                    });
                });
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –±–∞—Ç—Ç–ª–æ–≤:", err);
                document.getElementById('battleList').innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞—Ç—Ç–ª–æ–≤.";
            }
        }

        async function joinBattle(battleId) {
            try {
                const battleRef = doc(db, 'battles', battleId);
                const battleSnap = await getDoc(battleRef);
                const data = battleSnap.data();
                if (!data || data.status !== 'open') throw new Error('–ë–∞—Ç—Ç–ª —É–∂–µ –∑–∞–∫—Ä—ã—Ç');
                if (data.creator === userId) throw new Error('–ù–µ–ª—å–∑—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —Å–≤–æ–µ–º—É –±–∞—Ç—Ç–ª—É');

                if (!data.isCharity) {
                    const totalCost = data.totalCost;
                    if (currentUser.balance < totalCost) throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
                    currentUser.balance -= totalCost;
                    await saveUser();
                    updateBalance();
                }

                await updateDoc(battleRef, {
                    player2: userId,
                    player2Name: currentUser.username,
                    status: 'started'
                });

                subscribeToBattle(battleId);
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:", err);
                alert(err.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è");
            }
        }

        async function deleteBattle(battleId) {
            try {
                const battleRef = doc(db, 'battles', battleId);
                const battleSnap = await getDoc(battleRef);
                const data = battleSnap.data();
                if (!data || data.creator !== userId || data.status !== 'open') {
                    throw new Error('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –±–∞—Ç—Ç–ª');
                }
                const refund = data.creatorPaid || data.totalCost;
                currentUser.balance += refund;
                await saveUser();
                updateBalance();
                await deleteDoc(battleRef);
                alert(`–ë–∞—Ç—Ç–ª —É–¥–∞–ª—ë–Ω, –≤–æ–∑–≤—Ä–∞—â–µ–Ω–æ ${refund}‚ÇΩ`);
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:", err);
                alert(err.message || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –±–∞—Ç—Ç–ª–∞");
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            createParticles();
            loadCurrentUser();

            const vsBotBtn = document.getElementById('vsBotBtn');
            const vsPlayerBtn = document.getElementById('vsPlayerBtn');

            vsBotBtn.addEventListener('click', () => {
                vsBotBtn.classList.add('active');
                vsPlayerBtn.classList.remove('active');
                document.getElementById('vsBotSection').style.display = 'block';
                document.getElementById('vsPlayerSection').style.display = 'none';
            });

            vsPlayerBtn.addEventListener('click', () => {
                if (isGuest) {
                    alert('–¢–æ–ª—å–∫–æ –¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
                    return;
                }
                vsPlayerBtn.classList.add('active');
                vsBotBtn.classList.remove('active');
                document.getElementById('vsBotSection').style.display = 'none';
                document.getElementById('vsPlayerSection').style.display = 'block';
                loadBattles();
            });

            document.getElementById('charityMode')?.addEventListener('change', (e) => {
                isCharityMode = e.target.checked;
                updateTotalCost('player');
            });

            renderCaseGrid('botCaseGrid', (type) => addSelectedCase('bot', type));
            renderCaseGrid('playerCaseGrid', (type) => addSelectedCase('player', type));

            document.getElementById('playVsBot').addEventListener('click', () => playVsBot(false));
            document.getElementById('quickVsBot').addEventListener('click', () => playVsBot(true));

            document.getElementById('createBattleBtn').addEventListener('click', () => {
                document.getElementById('createForm').style.display = 'block';
            });

            document.getElementById('confirmCreate').addEventListener('click', createBattle);
        });
    </script>
</body>

</html>
