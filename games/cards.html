<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>21 (–ë–ª—ç–∫–¥–∂–µ–∫) | DropWin</title>
  <link rel="stylesheet" href="../style.css">
  <style>
    .card-container {
      display: flex;
      flex-direction: row;
      justify-content: center;
      gap: 18px;               /* –±–æ–ª—å—à–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –∫–∞—Ä—Ç–∞–º–∏ */
      margin: 20px 0;
      max-width: 380px;
      margin-left: auto;
      margin-right: auto;
      overflow-x: hidden;      /* —É–±–∏—Ä–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä –ø–æ–ª–Ω–æ—Å—Ç—å—é */
      padding: 0 10px;
    }
    .card {
      width: 78px;             /* —á—É—Ç—å –∫—Ä—É–ø–Ω–µ–µ */
      height: 110px;
      background: linear-gradient(135deg, #f8fafc, #e2e8f0);
      border-radius: 12px;
      border: 2.5px solid #1e293b;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.4rem;
      font-weight: bold;
      box-shadow: 0 5px 14px rgba(0,0,0,0.45);
      color: black;
      position: relative;
      overflow: hidden;
      flex-shrink: 0;
    }
    .card::before {
      content: attr(data-suit);
      position: absolute;
      top: 6px;
      left: 8px;
      font-size: 1.3rem;
    }
    .card::after {
      content: attr(data-suit);
      position: absolute;
      bottom: 6px;
      right: 8px;
      font-size: 1.3rem;
      transform: rotate(180deg);
    }
    .card.red { color: #dc2626; }
    .card.red::before, .card.red::after { color: #dc2626; }
  </style>
</head>
<body>
<div class="particles" id="particles"></div>

<div class="header">
  <div class="logo">üíé DROPWIN</div>
  <div class="balance-container">
    <div class="balance">üí∞ <span id="balance">0</span>‚ÇΩ</div>
    <button class="auth-btn" id="authBtn">–ê–∫–∫–∞—É–Ω—Ç</button>
  </div>
</div>

<div class="content">
  <button class="back-btn" onclick="location.href='../index.html'">‚Üê –ù–∞–∑–∞–¥</button>

  <div class="game-card">
    <div class="game-title">üÉè 21 (–ë–ª—ç–∫–¥–∂–µ–∫)</div>

    <div class="card-container" id="playerCards"></div>
    <div id="playerScore" style="font-size:1.4rem; margin:10px 0; text-align:center; font-weight:700;">–í–∞—à —Å—á—ë—Ç: 0</div>

    <div class="card-container" id="dealerCards"></div>
    <div id="dealerScore" style="font-size:1.2rem; color:#94a3b8; text-align:center; margin:10px 0;">–°—á—ë—Ç –¥–∏–ª–µ—Ä–∞: ?</div>

    <div class="input-group" style="margin:20px 0; max-width:280px; margin-left:auto; margin-right:auto;">
      <label class="input-label">–°—Ç–∞–≤–∫–∞</label>
      <input type="number" id="bet21" value="100" min="10">
    </div>

    <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
      <button class="btn" onclick="start21()" id="startBtn">–ù–∞—á–∞—Ç—å</button>
      <button class="btn" onclick="hit()" id="hitBtn" style="display:none">–ï—â—ë</button>
      <button class="btn cashout-btn" onclick="stand()" id="standBtn" style="display:none">–•–≤–∞—Ç–∏—Ç</button>
    </div>

    <div class="result" id="result21" style="margin-top:20px; text-align:center; min-height:60px;">–ì–æ—Ç–æ–≤—ã —Å—ã–≥—Ä–∞—Ç—å?</div>
  </div>
</div>

<div class="nav">
  <button class="nav-btn" onclick="location.href='../index.html'"><span>üè†</span><span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span></button>
  <button class="nav-btn" onclick="location.href='../profile.html'"><span>üë§</span><span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span></button>
  <button class="nav-btn" onclick="location.href='../register.html'"><span>üîë</span><span class="nav-label">–í—Ö–æ–¥</span></button>
</div>

<script>
function createParticles() {
  const container = document.getElementById('particles');
  for (let i = 0; i < 40; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    p.style.width = p.style.height = Math.random() * 3 + 1 + 'px';
    p.style.left = Math.random() * 100 + '%';
    p.style.animationDuration = Math.random() * 15 + 10 + 's';
    p.style.animationDelay = Math.random() * 5 + 's';
    container.appendChild(p);
  }
}

let currentUser = null;
let currentUsername = null;

function loadCurrentUser() {
  currentUsername = localStorage.getItem('dropwin_current_username');

  if (!currentUsername) {
    location.href = '../register.html';
    return;
  }

  const users = JSON.parse(localStorage.getItem('dropwin_users')) || [];
  currentUser = users.find(u => u.username === currentUsername);

  if (!currentUser) {
    localStorage.removeItem('dropwin_current_username');
    location.href = '../register.html';
    return;
  }

  document.getElementById('balance').textContent = currentUser.balance;

  const btn = document.getElementById('authBtn');
  btn.textContent = currentUser.isGuest ? '–ì–æ—Å—Ç—å' : currentUser.username;
  btn.onclick = () => location.href = '../profile.html';
}

function saveUser() {
  if (!currentUser) return;
  const users = JSON.parse(localStorage.getItem('dropwin_users')) || [];
  const idx = users.findIndex(u => u.username === currentUsername);
  if (idx !== -1) {
    users[idx] = currentUser;
    localStorage.setItem('dropwin_users', JSON.stringify(users));
  }
}

function addToHistory(game, winAmount) {
  const entry = {
    game: game,
    time: new Date().toLocaleString('ru-RU'),
    win: winAmount,
    result: winAmount > 0 ? 'win' : 'loss'
  };
  currentUser.history = currentUser.history || [];
  currentUser.history.unshift(entry);
  if (currentUser.history.length > 20) currentUser.history.pop();
  saveUser();
}

const suits = ['‚ô•','‚ô¶','‚ô£','‚ô†'];
const values = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];

function getCardValue(card) {
  if (['J','Q','K'].includes(card.value)) return 10;
  if (card.value === 'A') return 11;
  return Number(card.value);
}

function calculateScore(cards) {
  let score = 0, aces = 0;
  cards.forEach(c => {
    const val = getCardValue(c);
    if (val === 11) aces++;
    score += val;
  });
  while (score > 21 && aces > 0) { score -= 10; aces--; }
  return score;
}

function drawCard() {
  const value = values[Math.floor(Math.random() * values.length)];
  const suit = suits[Math.floor(Math.random() * suits.length)];
  return { value, suit };
}

function renderCards(containerId, cards, hideFirst = false) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  cards.forEach((card, i) => {
    const div = document.createElement('div');
    div.className = 'card' + ((card.suit === '‚ô•' || card.suit === '‚ô¶') ? ' red' : '');
    div.dataset.suit = card.suit;
    div.innerHTML = hideFirst && i === 0 ? '?' : card.value;
    container.appendChild(div);
  });
}

let playerHand = [], dealerHand = [], bet21 = 0;

function start21() {
  if (!currentUser) return alert('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.');
  bet21 = Number(document.getElementById('bet21').value);
  if (bet21 < 10 || bet21 > currentUser.balance || isNaN(bet21)) return alert('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç–∞–≤–∫–∞');

  currentUser.balance -= bet21;
  currentUser.totalBet = (currentUser.totalBet || 0) + bet21;
  currentUser.gamesPlayed = (currentUser.gamesPlayed || 0) + 1;
  saveUser();
  document.getElementById('balance').textContent = currentUser.balance;

  playerHand = [drawCard(), drawCard()];
  dealerHand = [drawCard(), drawCard()];

  renderCards('playerCards', playerHand);
  renderCards('dealerCards', dealerHand, true);

  document.getElementById('playerScore').textContent = `–í–∞—à —Å—á—ë—Ç: ${calculateScore(playerHand)}`;
  document.getElementById('dealerScore').textContent = `–°—á—ë—Ç –¥–∏–ª–µ—Ä–∞: ?`;

  document.getElementById('startBtn').style.display = 'none';
  document.getElementById('hitBtn').style.display = 'inline-block';
  document.getElementById('standBtn').style.display = 'inline-block';

  document.getElementById('result21').textContent = '–í–∞—à —Ö–æ–¥...';

  if (calculateScore(playerHand) === 21) stand();
}

function hit() {
  playerHand.push(drawCard());
  renderCards('playerCards', playerHand);
  const score = calculateScore(playerHand);
  document.getElementById('playerScore').textContent = `–í–∞—à —Å—á—ë—Ç: ${score}`;
  if (score > 21) {
    document.getElementById('result21').innerHTML = '<span style="color:#ef4444">–ü–µ—Ä–µ–±–æ—Ä! –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏</span>';
    currentUser.losses = (currentUser.losses || 0) + 1;
    addToHistory('21 (–ë–ª—ç–∫–¥–∂–µ–∫)', -bet21);
    endGame();
  }
}

function stand() {
  document.getElementById('hitBtn').style.display = 'none';
  document.getElementById('standBtn').style.display = 'none';

  let dealerScore = calculateScore(dealerHand);
  while (dealerScore < 17) {
    dealerHand.push(drawCard());
    dealerScore = calculateScore(dealerHand);
  }
  renderCards('dealerCards', dealerHand, false);
  document.getElementById('dealerScore').textContent = `–°—á—ë—Ç –¥–∏–ª–µ—Ä–∞: ${dealerScore}`;

  const playerScore = calculateScore(playerHand);
  let resultText = '';
  let net = 0;

  if (playerScore > 21) {
    resultText = '<span style="color:#ef4444">–ü–µ—Ä–µ–±–æ—Ä! –ü—Ä–æ–∏–≥—Ä—ã—à</span>';
    net = -bet21;
    currentUser.losses = (currentUser.losses || 0) + 1;
  } else if (dealerScore > 21 || playerScore > dealerScore) {
    resultText = `<span style="color:#10b981">–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏! +${bet21}‚ÇΩ</span>`;
    currentUser.balance += bet21 * 2;
    currentUser.wins = (currentUser.wins || 0) + 1;
    currentUser.totalWin = (currentUser.totalWin || 0) + bet21 * 2;
    net = bet21;
  } else if (playerScore < dealerScore) {
    resultText = '<span style="color:#ef4444">–ü—Ä–æ–∏–≥—Ä—ã—à</span>';
    net = -bet21;
    currentUser.losses = (currentUser.losses || 0) + 1;
  } else {
    resultText = '–ù–∏—á—å—è ‚Äî —Å—Ç–∞–≤–∫–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞';
    currentUser.balance += bet21;
    net = 0;
  }

  document.getElementById('result21').innerHTML = resultText;
  addToHistory('21 (–ë–ª—ç–∫–¥–∂–µ–∫)', net);
  saveUser();
  document.getElementById('balance').textContent = currentUser.balance;

  document.getElementById('startBtn').style.display = 'inline-block';
}

function endGame() {
  document.getElementById('hitBtn').style.display = 'none';
  document.getElementById('standBtn').style.display = 'none';
  document.getElementById('startBtn').style.display = 'inline-block';
}

document.addEventListener('DOMContentLoaded', () => {
  createParticles();
  loadCurrentUser();
});
</script>
</body>
</html>