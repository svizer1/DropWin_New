<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>21 (Ğ‘Ğ»ÑĞºĞ´Ğ¶ĞµĞº) | DropWin</title>
  <link rel="stylesheet" href="../style.css">

  <style>
    .card-container {
      display: flex;
      flex-direction: row;
      justify-content: center;
      gap: 20px;
      margin: 24px 0;
      max-width: 420px;
      margin-left: auto;
      margin-right: auto;
      padding: 0 12px;
    }

    .card {
      width: 92px;
      height: 130px;
      background: linear-gradient(135deg, #fefefe, #f1f5f9);
      border-radius: 14px;
      border: 1px solid #cbd5e1;
      box-shadow: 0 6px 16px rgba(0,0,0,0.38), 0 2px 6px rgba(0,0,0,0.22), inset 0 1px 2px rgba(255,255,255,0.8);
      position: relative;
      overflow: hidden;
      color: #111827;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      transition: all 0.18s ease;
      flex-shrink: 0;
      user-select: none;
    }

    .card:hover {
      transform: translateY(-8px) scale(1.05);
      box-shadow: 0 14px 32px rgba(0,0,0,0.45);
    }

    .card.red   { color: #dc2626; }
    .card.black { color: #111827; }

    .card::before,
    .card::after {
      position: absolute;
      font-size: 1.95rem;
      font-weight: 900;
      line-height: 1.05;
      letter-spacing: -0.5px;
    }

    .card::before {
      top: 8px;
      left: 10px;
      content: attr(data-value) "\a" attr(data-suit);
      white-space: pre;
      text-align: left;
    }

    .card::after {
      bottom: 8px;
      right: 10px;
      content: attr(data-value) "\a" attr(data-suit);
      white-space: pre;
      text-align: right;
      transform: rotate(180deg);
    }

    .card .center-suit {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 5.2rem;
      font-weight: 900;
      opacity: 0.14;
      pointer-events: none;
    }

    .card.red .center-suit {
      opacity: 0.24;
      color: #dc2626;
    }

    .card[data-value="A"] .center-suit {
      font-size: 5.8rem;
      opacity: 0.26;
    }

    .card-back {
      background: linear-gradient(145deg, #1e293b 0%, #111827 100%);
      color: #64748b;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4.2rem;
      opacity: 0.9;
      box-shadow: inset 0 0 20px rgba(0,0,0,0.6);
    }

    .card-back::before,
    .card-back::after {
      content: none;
    }
  </style>
</head>
<body>

<div class="particles" id="particles"></div>

<div class="header">
  <div class="logo" onclick="location.href='../index.html'" style="cursor: pointer;">ğŸ’ DROPWIN</div>
  <div class="balance-container">
    <div class="balance">ğŸ’° <span id="balance">0</span>â‚½</div>
    <button class="auth-btn" id="authBtn">ĞĞºĞºĞ°ÑƒĞ½Ñ‚</button>
  </div>
</div>

<div class="content">
  <button class="back-btn" onclick="location.href='../index.html'">â† ĞĞ°Ğ·Ğ°Ğ´</button>

  <div class="game-card">
    <div class="game-title">ğŸƒ 21 (Ğ‘Ğ»ÑĞºĞ´Ğ¶ĞµĞº)</div>

    <div class="card-container" id="playerCards"></div>
    <div id="playerScore" style="font-size:1.4rem; margin:12px 0; text-align:center; font-weight:700;">Ğ’Ğ°Ñˆ ÑÑ‡Ñ‘Ñ‚: 0</div>

    <div class="card-container" id="dealerCards"></div>
    <div id="dealerScore" style="font-size:1.2rem; color:#94a3b8; text-align:center; margin:12px 0;">Ğ¡Ñ‡Ñ‘Ñ‚ Ğ´Ğ¸Ğ»ĞµÑ€Ğ°: ?</div>

    <div class="input-group" style="margin:24px 0; max-width:280px; margin-left:auto; margin-right:auto;">
      <label class="input-label">Ğ¡Ñ‚Ğ°Ğ²ĞºĞ°</label>
      <input type="number" id="bet21" value="100" min="10">
    </div>

    <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
      <button class="btn" id="startBtn">ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ</button>
      <button class="btn" id="hitBtn" style="display:none">Ğ•Ñ‰Ñ‘</button>
      <button class="btn cashout-btn" id="standBtn" style="display:none">Ğ¥Ğ²Ğ°Ñ‚Ğ¸Ñ‚</button>
    </div>

    <div class="result" id="result21" style="margin-top:24px; text-align:center; min-height:60px;">Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ñ‹ ÑÑ‹Ğ³Ñ€Ğ°Ñ‚ÑŒ?</div>
  </div>
</div>

<div class="nav">
  <button class="nav-btn" onclick="location.href='../index.html'"><span>ğŸ </span><span class="nav-label">Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ</span></button>
  <button class="nav-btn" onclick="location.href='../profile.html'"><span>ğŸ‘¤</span><span class="nav-label">ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</span></button>
  <button class="nav-btn" onclick="location.href='../register.html'"><span>ğŸ”‘</span><span class="nav-label">Ğ’Ñ…Ğ¾Ğ´</span></button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBVra2JN-C7-1b_Qa4cU8--XvJ83lymiM8",
    authDomain: "dropwin-8d94b.firebaseapp.com",
    projectId: "dropwin-8d94b",
    storageBucket: "dropwin-8d94b.firebasestorage.app",
    messagingSenderId: "988974289403",
    appId: "1:988974289403:web:886d34e6f65920a105fb5e",
    measurementId: "G-BK010MHN8N"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let isGuest = false;
  let userId = null;

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  Ğ§Ğ°ÑÑ‚Ğ¸Ñ†Ñ‹
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function createParticles() {
    const container = document.getElementById('particles');
    if (!container) return;
    for (let i = 0; i < 40; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      p.style.width = p.style.height = Math.random() * 3 + 1 + 'px';
      p.style.left = Math.random() * 100 + '%';
      p.style.animationDuration = Math.random() * 15 + 10 + 's';
      p.style.animationDelay = Math.random() * 5 + 's';
      container.appendChild(p);
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ / Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function loadCurrentUser() {
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userId = user.uid;
        isGuest = false;
        getDoc(doc(db, 'users', user.uid)).then(docSnap => {
          if (docSnap.exists()) {
            currentUser = docSnap.data();
            renderUser();
          } else {
            goToLogin();
          }
        }).catch(err => console.error("Firestore error:", err));
      } else {
        // Ğ“Ğ¾ÑÑ‚ÑŒ
        const username = localStorage.getItem('dropwin_current_username');
        if (username === 'Ğ“Ğ¾ÑÑ‚ÑŒ') {
          isGuest = true;
          const users = JSON.parse(localStorage.getItem('dropwin_users') || '[]');
          currentUser = users.find(u => u.username === 'Ğ“Ğ¾ÑÑ‚ÑŒ');
          if (currentUser) {
            renderUser();
          } else {
            goToLogin();
          }
        } else {
          goToLogin();
        }
      }
    });
  }

  function renderUser() {
    document.getElementById('balance').textContent = Math.floor(currentUser.balance || 0);
    const btn = document.getElementById('authBtn');
    btn.textContent = isGuest ? 'Ğ“Ğ¾ÑÑ‚ÑŒ' : (currentUser.username || 'Ğ˜Ğ³Ñ€Ğ¾Ğº');
    btn.onclick = () => location.href = '../profile.html';
  }

  function goToLogin() {
    alert('ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ğ² Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚');
    location.href = '../register.html';
  }

  function saveUser(updates = {}) {
    if (!currentUser) return;
    Object.assign(currentUser, updates);

    if (isGuest) {
      let users = JSON.parse(localStorage.getItem('dropwin_users') || '[]');
      const idx = users.findIndex(u => u.username === 'Ğ“Ğ¾ÑÑ‚ÑŒ');
      if (idx !== -1) {
        users[idx] = { ...currentUser };
      }
      localStorage.setItem('dropwin_users', JSON.stringify(users));
    } else if (userId) {
      updateDoc(doc(db, 'users', userId), updates)
        .catch(err => console.error("ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ:", err));
    }
  }

  function addToHistory(game, change) {
    const entry = {
      game,
      time: new Date().toLocaleString('ru-RU'),
      win: change,
      result: change > 0 ? 'win' : (change < 0 ? 'loss' : 'draw')
    };
    currentUser.history = currentUser.history || [];
    currentUser.history.unshift(entry);
    if (currentUser.history.length > 30) currentUser.history = currentUser.history.slice(0, 30);
    saveUser({ history: currentUser.history });
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ±Ğ»ÑĞºĞ´Ğ¶ĞµĞºĞ°
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const suits = ['â™¥','â™¦','â™£','â™ '];
  const values = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];

  function getCardValue(card) {
    if (['J','Q','K'].includes(card.value)) return 10;
    if (card.value === 'A') return 11;
    return Number(card.value);
  }

  function calculateScore(cards) {
    let score = 0, aces = 0;
    cards.forEach(c => {
      const val = getCardValue(c);
      if (val === 11) aces++;
      score += val;
    });
    while (score > 21 && aces > 0) { score -= 10; aces--; }
    return score;
  }

  function drawCard() {
    const value = values[Math.floor(Math.random() * values.length)];
    const suit  = suits[Math.floor(Math.random() * suits.length)];
    return { value, suit };
  }

  function renderCards(containerId, cards, hideFirst = false) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';

    cards.forEach((card, i) => {
      const isHidden = hideFirst && i === 0;
      const div = document.createElement('div');

      if (isHidden) {
        div.className = 'card card-back';
        div.innerHTML = '<div style="font-size:4.8rem; opacity:0.35;">?</div>';
      } else {
        div.className = `card ${ (card.suit === 'â™¥' || card.suit === 'â™¦') ? 'red' : 'black' }`;
        div.dataset.value = card.value;
        div.dataset.suit  = card.suit;

        const center = document.createElement('div');
        center.className = 'center-suit';
        center.textContent = card.suit;
        div.appendChild(center);
      }

      container.appendChild(div);
    });
  }

  let playerHand = [], dealerHand = [], bet21 = 0;

  function start21() {
    if (!currentUser) return alert('Ğ¡ĞµÑÑĞ¸Ñ Ğ¸ÑÑ‚ĞµĞºĞ»Ğ°. Ğ’Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾.');

    bet21 = Number(document.getElementById('bet21').value);
    if (bet21 < 10 || bet21 > (currentUser.balance || 0) || isNaN(bet21)) {
      return alert('ĞĞµĞ²ĞµÑ€Ğ½Ğ°Ñ ÑÑ‚Ğ°Ğ²ĞºĞ° (Ğ¼Ğ¸Ğ½ 10 â‚½, Ğ½Ğµ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°)');
    }

    currentUser.balance = (currentUser.balance || 0) - bet21;
    currentUser.totalBet   = (currentUser.totalBet   || 0) + bet21;
    currentUser.gamesPlayed = (currentUser.gamesPlayed || 0) + 1;

    saveUser({
      balance: currentUser.balance,
      totalBet: currentUser.totalBet,
      gamesPlayed: currentUser.gamesPlayed
    });

    document.getElementById('balance').textContent = Math.floor(currentUser.balance);

    playerHand = [drawCard(), drawCard()];
    dealerHand = [drawCard(), drawCard()];

    renderCards('playerCards', playerHand);
    renderCards('dealerCards', dealerHand, true);

    document.getElementById('playerScore').textContent = `Ğ’Ğ°Ñˆ ÑÑ‡Ñ‘Ñ‚: ${calculateScore(playerHand)}`;
    document.getElementById('dealerScore').textContent = `Ğ¡Ñ‡Ñ‘Ñ‚ Ğ´Ğ¸Ğ»ĞµÑ€Ğ°: ?`;

    document.getElementById('startBtn').style.display = 'none';
    document.getElementById('hitBtn').style.display   = 'inline-block';
    document.getElementById('standBtn').style.display = 'inline-block';

    document.getElementById('result21').textContent = 'Ğ’Ğ°Ñˆ Ñ…Ğ¾Ğ´...';

    if (calculateScore(playerHand) === 21) stand();
  }

  function hit() {
    playerHand.push(drawCard());
    renderCards('playerCards', playerHand);
    const score = calculateScore(playerHand);
    document.getElementById('playerScore').textContent = `Ğ’Ğ°Ñˆ ÑÑ‡Ñ‘Ñ‚: ${score}`;

    if (score > 21) {
      document.getElementById('result21').innerHTML = '<span style="color:#ef4444">ĞŸĞµÑ€ĞµĞ±Ğ¾Ñ€! Ğ’Ñ‹ Ğ¿Ñ€Ğ¾Ğ¸Ğ³Ñ€Ğ°Ğ»Ğ¸</span>';
      currentUser.losses = (currentUser.losses || 0) + 1;
      addToHistory('21 (Ğ‘Ğ»ÑĞºĞ´Ğ¶ĞµĞº)', -bet21);
      saveUser({ losses: currentUser.losses });
      endGame();
    }
  }

  function stand() {
    document.getElementById('hitBtn').style.display = 'none';
    document.getElementById('standBtn').style.display = 'none';

    let dealerScore = calculateScore(dealerHand);
    while (dealerScore < 17) {
      dealerHand.push(drawCard());
      dealerScore = calculateScore(dealerHand);
    }

    renderCards('dealerCards', dealerHand, false);
    document.getElementById('dealerScore').textContent = `Ğ¡Ñ‡Ñ‘Ñ‚ Ğ´Ğ¸Ğ»ĞµÑ€Ğ°: ${dealerScore}`;

    const playerScore = calculateScore(playerHand);
    let resultText = '';
    let net = 0;

    if (playerScore > 21) {
      resultText = '<span style="color:#ef4444">ĞŸĞµÑ€ĞµĞ±Ğ¾Ñ€! ĞŸÑ€Ğ¾Ğ¸Ğ³Ñ€Ñ‹Ñˆ</span>';
      net = -bet21;
      currentUser.losses = (currentUser.losses || 0) + 1;
    } else if (dealerScore > 21 || playerScore > dealerScore) {
      const win = bet21 * 2;
      resultText = `<span style="color:#10b981">Ğ’Ñ‹ Ğ²Ñ‹Ğ¸Ğ³Ñ€Ğ°Ğ»Ğ¸! +${bet21}â‚½</span>`;
      currentUser.balance = (currentUser.balance || 0) + win;
      currentUser.wins = (currentUser.wins || 0) + 1;
      currentUser.totalWin = (currentUser.totalWin || 0) + win;
      net = bet21;
    } else if (playerScore < dealerScore) {
      resultText = '<span style="color:#ef4444">ĞŸÑ€Ğ¾Ğ¸Ğ³Ñ€Ñ‹Ñˆ</span>';
      net = -bet21;
      currentUser.losses = (currentUser.losses || 0) + 1;
    } else {
      resultText = 'ĞĞ¸Ñ‡ÑŒÑ â€” ÑÑ‚Ğ°Ğ²ĞºĞ° Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ°';
      currentUser.balance = (currentUser.balance || 0) + bet21;
      net = 0;
    }

    document.getElementById('result21').innerHTML = resultText;
    addToHistory('21 (Ğ‘Ğ»ÑĞºĞ´Ğ¶ĞµĞº)', net);

    saveUser({
      balance: currentUser.balance,
      wins: currentUser.wins,
      losses: currentUser.losses,
      totalWin: currentUser.totalWin
    });

    document.getElementById('balance').textContent = Math.floor(currentUser.balance);

    document.getElementById('startBtn').style.display = 'inline-block';
  }

  function endGame() {
    document.getElementById('hitBtn').style.display = 'none';
    document.getElementById('standBtn').style.display = 'none';
    document.getElementById('startBtn').style.display = 'inline-block';
  }

  // â”€â”€â”€ Ğ—Ğ°Ğ¿ÑƒÑĞº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.addEventListener('DOMContentLoaded', () => {
    createParticles();
    loadCurrentUser();

    document.getElementById('startBtn').onclick = start21;
    document.getElementById('hitBtn').onclick   = hit;
    document.getElementById('standBtn').onclick = stand;
  });
</script>
</body>
</html>