<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>–ö—Ä–∞—à | DropWin</title>
  <link rel="stylesheet" href="../style.css">
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(to bottom, #0f172a, #020617);
      color: white;
      min-height: 100vh;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: rgba(15, 23, 42, 0.8);
      border-bottom: 1px solid #334155;
    }
    .logo { font-size: 1.6rem; font-weight: bold; }
    .balance-container { display: flex; align-items: center; gap: 16px; }
    .balance { font-size: 1.3rem; font-weight: 600; }
    .auth-btn {
      padding: 8px 16px;
      background: #334155;
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
    }
    #crashGraph {
      width: 100%;
      height: 280px;
      background: rgba(15,23,42,0.7);
      border-radius: 16px;
      border: 2px solid #334155;
      margin: 20px 0;
      position: relative;
      overflow: hidden;
    }
    #crashLine {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 100%;
      stroke: #fbbf24;
      stroke-width: 6;
      fill: none;
      filter: drop-shadow(0 0 14px #fbbf24);
      transition: transform 0.12s;
    }
    #crashGraph.shake {
      animation: shake 0.7s cubic-bezier(.36,.07,.19,.97) both;
    }
    @keyframes shake {
      10%, 90% { transform: translate3d(-3px, 1px, 0); }
      20%, 80% { transform: translate3d(5px, -1px, 0); }
      30%, 50%, 70% { transform: translate3d(-7px, 2px, 0); }
      40%, 60% { transform: translate3d(7px, -2px, 0); }
    }
    #crashMultiplier {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 6rem;
      font-weight: 900;
      color: #fef08a;
      text-shadow: 0 0 30px #fbbf24, 0 0 70px #f97316;
      z-index: 10;
      transition: all 0.3s;
    }
    .crashed {
      color: #f87171 !important;
      text-shadow: 0 0 50px #ef4444, 0 0 100px #b91c1c;
      animation: flash 0.6s infinite alternate;
    }
    @keyframes flash { to { opacity: 0.65; } }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-width: 380px;
      margin: 24px auto;
    }
    .cashout-btn {
      padding: 18px 40px;
      font-size: 1.5rem;
      font-weight: bold;
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      transition: all 0.25s;
    }
    .cashout-btn:disabled {
      background: #4b5563;
      cursor: not-allowed;
      opacity: 0.6;
    }
    .result {
      font-size: 1.45rem;
      font-weight: 600;
      text-align: center;
      margin: 20px 0;
      min-height: 70px;
      line-height: 1.4;
    }
    .last-crashes {
      margin: 28px auto;
      padding: 16px;
      background: rgba(30,41,59,0.5);
      border-radius: 14px;
      border: 1px solid #334155;
      max-width: 380px;
    }
    .last-crashes-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 14px;
      color: #94a3b8;
      text-align: center;
    }
    .crash-history-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    .crash-item {
      padding: 8px 16px;
      border-radius: 999px;
      font-weight: bold;
      font-size: 1.1rem;
      min-width: 74px;
      text-align: center;
      background: #1e293b;
      border: 1px solid #475569;
    }
    .crash-item.low    { color: #fca5a5; border-color: #fca5a5; }
    .crash-item.medium { color: #fbbf24; border-color: #fbbf24; }
    .crash-item.high   { color: #6ee7b7; border-color: #6ee7b7; }
    .crash-item.very-high {
      color: #60a5fa;
      border-color: #60a5fa;
      background: rgba(96,165,250,0.15);
    }
    #explosion {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 0;
      height: 0;
      background: radial-gradient(circle at 35% 35%, #fef08a 10%, #fbbf24 30%, #f97316 60%, #ef4444 85%, transparent 100%);
      border-radius: 50%;
      opacity: 0;
      z-index: 5;
      pointer-events: none;
      box-shadow: 0 0 100px #ef4444, 0 0 180px #991b1b;
    }
    .explode {
      animation: explodeAnim 1.5s ease-out forwards;
    }
    @keyframes explodeAnim {
      0%   { width:0; height:0; opacity:0.95; transform:translate(-50%,-50%) scale(0.05); }
      35%  { width:420px; height:420px; opacity:0.92; transform:translate(-50%,-50%) scale(1.15); }
      65%  { width:620px; height:620px; opacity:0.65; transform:translate(-50%,-50%) scale(1.4); }
      100% { width:900px; height:900px; opacity:0; transform:translate(-50%,-50%) scale(1.8); }
    }
    .particle-expl {
      position: absolute;
      width: 7px;
      height: 7px;
      background: #fbbf24;
      border-radius: 50%;
      pointer-events: none;
      z-index: 6;
      opacity: 0;
      will-change: transform, opacity;
    }
  </style>
</head>
<body>

  <div class="header">
    <div class="logo">üíé DROPWIN</div>
    <div class="balance-container">
      <div class="balance">üí∞ <span id="balance">0</span>‚ÇΩ</div>
      <button class="auth-btn" id="authBtn">–ê–∫–∫–∞—É–Ω—Ç</button>
    </div>
  </div>

  <div class="content">
    <button class="back-btn" onclick="location.href='../index.html'">‚Üê –ù–∞–∑–∞–¥</button>

    <div class="game-card">
      <div class="game-title">üöÄ –ö—Ä–∞—à</div>

      <div id="crashGraph">
        <svg id="graphSvg" width="100%" height="100%" preserveAspectRatio="none">
          <polyline id="crashLine" points="0,280" />
        </svg>
        <div id="crashMultiplier">1.00√ó</div>
        <div id="explosion"></div>
      </div>

      <div class="controls">
        <div class="input-group">
          <label class="input-label">–°—Ç–∞–≤–∫–∞</label>
          <input type="number" id="betCrash" value="100" min="10">
        </div>
        <button class="btn" id="startBtn" onclick="startCrash()">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
        <button class="cashout-btn" id="cashoutBtn" disabled onclick="cashOut()">
          –ó–∞–±—Ä–∞—Ç—å √ó<span id="currentMult">1.00</span>
        </button>
      </div>

      <div class="result" id="crashResult">–ì–æ—Ç–æ–≤ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞–∫–µ—Ç—É?</div>

      <div class="last-crashes" id="lastCrashes">
        <div class="last-crashes-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 –∫—Ä–∞—à–µ–π</div>
        <div id="crashHistory" class="crash-history-list"></div>
      </div>
    </div>
  </div>

  <script>
    // ‚îÄ‚îÄ‚îÄ User & Save ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let currentUser = null;
    let currentUsername = null;

    function loadCurrentUser() {
      currentUsername = localStorage.getItem('dropwin_current_username');
      if (!currentUsername) {
        alert('–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç');
        location.href = '../register.html';
        return;
      }
      let users = JSON.parse(localStorage.getItem('dropwin_users') || '[]');
      currentUser = users.find(u => u.username === currentUsername);
      if (!currentUser) {
        localStorage.removeItem('dropwin_current_username');
        alert('–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
        location.href = '../register.html';
        return;
      }
      currentUser.balance    = Number(currentUser.balance)    || 0;
      currentUser.gamesPlayed = Number(currentUser.gamesPlayed) || 0;
      currentUser.wins       = Number(currentUser.wins)       || 0;
      currentUser.losses     = Number(currentUser.losses)     || 0;
      currentUser.totalBet   = Number(currentUser.totalBet)   || 0;
      currentUser.totalWin   = Number(currentUser.totalWin)   || 0;
      currentUser.history    = Array.isArray(currentUser.history) ? currentUser.history : [];

      const balanceEl = document.getElementById('balance');
      if (balanceEl) balanceEl.textContent = currentUser.balance.toFixed(0);

      const authBtn = document.getElementById('authBtn');
      if (authBtn) {
        authBtn.textContent = currentUser.isGuest ? '–ì–æ—Å—Ç—å' : currentUser.username;
        authBtn.onclick = () => location.href = '../profile.html';
      }
    }

    function saveUser() {
      if (!currentUser) return;
      let users = JSON.parse(localStorage.getItem('dropwin_users') || '[]');
      const idx = users.findIndex(u => u.username === currentUser.username);
      if (idx !== -1) users[idx] = { ...currentUser };
      else users.push({ ...currentUser });
      localStorage.setItem('dropwin_users', JSON.stringify(users));
      localStorage.setItem('dropwin_crash_history', JSON.stringify(crashHistory));
    }

    // ‚îÄ‚îÄ‚îÄ Crash Game ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let gameRunning = false;
    let multiplier = 1.00;
    let crashPoint = 0;
    let animationFrame;
    let betAmount = 0;
    let crashHistory = [];
    const MAX_HISTORY = 5;

    function updateCrashHistoryDisplay() {
      const container = document.getElementById('crashHistory');
      if (!container) return;
      container.innerHTML = '';
      crashHistory.slice(0, MAX_HISTORY).reverse().forEach(point => {
        const item = document.createElement('div');
        item.className = 'crash-item';
        if      (point < 1.4)  item.classList.add('low');
        else if (point < 2.8)  item.classList.add('medium');
        else if (point < 7.5)  item.classList.add('high');
        else                   item.classList.add('very-high');
        item.textContent = point.toFixed(2) + '√ó';
        container.appendChild(item);
      });
    }

    function startCrash() {
      if (gameRunning) return;

      betAmount = Number(document.getElementById('betCrash').value);
      if (betAmount < 10 || betAmount > currentUser.balance || isNaN(betAmount)) {
        alert('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç–∞–≤–∫–∞ (–º–∏–Ω 10‚ÇΩ, –Ω–µ –±–æ–ª—å—à–µ –±–∞–ª–∞–Ω—Å–∞)');
        return;
      }

      currentUser.balance -= betAmount;
      document.getElementById('balance').textContent = currentUser.balance.toFixed(0);
      saveUser();

      gameRunning = true;
      multiplier = 1.00;

    // –ë–æ–ª–µ–µ –∂—ë—Å—Ç–∫–∏–µ —à–∞–Ω—Å—ã ‚Äî —á–∞—â–µ —Ä–∞–Ω–Ω–∏–µ/—Å—Ä–µ–¥–Ω–∏–µ –∫—Ä–∞—à–∏, —Ä–µ–∂–µ —É–ª–µ—Ç–∞–µ—Ç –¥–∞–ª–µ–∫–æ
const r = Math.random();

if (r < 0.38) {
    // 38% ‚Äî –æ—á–µ–Ω—å —Ä–∞–Ω–Ω–∏–π –∫—Ä–∞—à (1.00‚Äì1.40√ó)
    crashPoint = 1.00 + Math.random() * 0.40;
}
else if (r < 0.68) {
    // 30% ‚Äî 1.40‚Äì2.20√ó
    crashPoint = 1.40 + Math.random() * 0.80;
}
else if (r < 0.88) {
    // 20% ‚Äî 2.20‚Äì4.70√ó
    crashPoint = 2.20 + Math.random() * 2.50;
}
else if (r < 0.97) {
    // 9% ‚Äî 4.70‚Äì10.0√ó
    crashPoint = 4.70 + Math.random() * 5.30;
}
else {
    // 3% ‚Äî 10.0‚Äì30.0+ (–æ—á–µ–Ω—å —Ä–µ–¥–∫–æ –∂–∏—Ä–Ω—ã–µ)
    crashPoint = 10.0 + Math.random() * 20.0;
}

      document.getElementById('startBtn').disabled = true;
      document.getElementById('cashoutBtn').disabled = false;
      document.getElementById('crashResult').textContent = '–†–∞–∫–µ—Ç–∞ –∑–∞–ø—É—â–µ–Ω–∞...';
      document.getElementById('crashMultiplier').classList.remove('crashed');

      animateCrash();
    }

    function animateCrash() {
      if (!gameRunning) return;

      multiplier += 0.0013 + multiplier * 0.0026;
      if (multiplier >= crashPoint) {
        crash();
        return;
      }

      document.getElementById('crashMultiplier').textContent = multiplier.toFixed(2) + '√ó';
      document.getElementById('currentMult').textContent = multiplier.toFixed(2);

      const x = multiplier * 34;
      const y = 280 - multiplier * 30;
      document.getElementById('crashLine').setAttribute('points', `0,280 ${x},${y}`);

      animationFrame = requestAnimationFrame(animateCrash);
    }

    function createExplosionParticles() {
      const graph = document.getElementById('crashGraph');
      for (let i = 0; i < 28; i++) {
        const p = document.createElement('div');
        p.className = 'particle-expl';
        const angle = Math.random() * Math.PI * 2;
        const dist = 60 + Math.random() * 180;
        const size = 4 + Math.random() * 11;
        const hue = 15 + Math.random() * 50;
        p.style.background = `hsl(${hue}, 100%, 65%)`;
        p.style.width = p.style.height = size + 'px';
        p.style.left = '50%';
        p.style.top = '50%';
        graph.appendChild(p);

        setTimeout(() => {
          p.style.transition = 'all 1.3s ease-out';
          p.style.transform = `translate(-50%, -50%) translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px) scale(0.2)`;
          p.style.opacity = '0';
        }, 30 + Math.random() * 80);

        setTimeout(() => p.remove(), 1600);
      }
    }

    function cashOut() {
      if (!gameRunning) return;
      gameRunning = false;
      cancelAnimationFrame(animationFrame);

      const win = Math.round(betAmount * multiplier);
      const profit = win - betAmount;

      currentUser.balance += win;
      currentUser.totalWin = (currentUser.totalWin || 0) + win;
      currentUser.wins = (currentUser.wins || 0) + 1;
      currentUser.gamesPlayed = (currentUser.gamesPlayed || 0) + 1;
      currentUser.totalBet = (currentUser.totalBet || 0) + betAmount;

      document.getElementById('crashResult').innerHTML =
        `‚úÖ –ó–∞–±—Ä–∞–ª–∏ <b>${win}‚ÇΩ</b> (+${profit}‚ÇΩ) –Ω–∞ <b>${multiplier.toFixed(2)}√ó</b>`;
      crashHistory.unshift(crashPoint);
      saveUser();

      document.getElementById('crashResult').innerHTML +=
        `<br><small style="color:#94a3b8">–î–æ–ª–µ—Ç–µ–ª–æ –±—ã –¥–æ ${crashPoint.toFixed(2)}√ó</small>`;

      updateCrashHistoryDisplay();
      document.getElementById('balance').textContent = currentUser.balance.toFixed(0);
      resetGame();
    }

    function crash() {
      gameRunning = false;
      cancelAnimationFrame(animationFrame);

      const multEl = document.getElementById('crashMultiplier');
      multEl.textContent = crashPoint.toFixed(2) + '√ó';
      multEl.classList.add('crashed');

      document.getElementById('crashResult').innerHTML =
        `üí• –ö—Ä–∞—à –Ω–∞ <b>${crashPoint.toFixed(2)}√ó</b> ‚Äî –ø—Ä–æ–∏–≥—Ä–∞–Ω–æ ${betAmount}‚ÇΩ`;

      document.getElementById('crashGraph').classList.add('shake');
      document.getElementById('explosion').classList.add('explode');
      createExplosionParticles();

      setTimeout(() => {
        document.getElementById('crashGraph').classList.remove('shake');
      }, 900);

      crashHistory.unshift(crashPoint);
      saveUser();

      document.getElementById('crashResult').innerHTML +=
        `<br><small style="color:#94a3b8">(—ç—Ç–æ –∏ –±—ã–ª –ø—Ä–µ–¥–µ–ª —Ä–∞—É–Ω–¥–∞)</small>`;

      updateCrashHistoryDisplay();
      resetGame();
    }

    function resetGame() {
      setTimeout(() => {
        multiplier = 1.00;
        document.getElementById('crashMultiplier').textContent = '1.00√ó';
        document.getElementById('crashLine').setAttribute('points', '0,280');
        document.getElementById('crashMultiplier').classList.remove('crashed');
        document.getElementById('startBtn').disabled = false;
        document.getElementById('cashoutBtn').disabled = true;
        document.getElementById('crashResult').textContent = '–ì–æ—Ç–æ–≤ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–Ω–æ–≤–∞?';
      }, 4200);
    }

    // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.addEventListener('DOMContentLoaded', () => {
      loadCurrentUser();
      const saved = localStorage.getItem('dropwin_crash_history');
      if (saved) {
        crashHistory = JSON.parse(saved);
        updateCrashHistoryDisplay();
      }
      window.addEventListener('storage', e => {
        if (e.key === 'dropwin_users' || e.key === 'dropwin_current_username') {
          loadCurrentUser();
        }
      });
    });
  </script>
</body>
</html>