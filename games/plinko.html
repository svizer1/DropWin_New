<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Plinko | DropWin</title>
  <link rel="stylesheet" href="../style.css">

  <style>
    .plinko-board {
      width: 100%;
      height: 500px;
      background: linear-gradient(180deg, #1a1f35 0%, #0d1117 100%);
      border-radius: 24px;
      position: relative;
      overflow: hidden;
      margin: 24px 0;
      border: 2px solid rgba(99,102,241,0.3);
      box-shadow: 0 15px 50px rgba(0,0,0,0.7), inset 0 0 30px rgba(99,102,241,0.1);
    }

    .pins {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .pin {
      position: absolute;
      width: 9px;
      height: 9px;
      background: radial-gradient(circle, #e2e8f0 0%, #94a3b8 100%);
      border-radius: 50%;
      box-shadow: 0 0 12px rgba(148,163,184,0.5), 0 2px 4px rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.3);
    }

    .ball {
      position: absolute;
      width: 18px;
      height: 18px;
      background: radial-gradient(circle at 30% 30%, #fde047, #facc15, #eab308);
      border-radius: 50%;
      border: 2px solid #ca8a04;
      box-shadow:
        0 0 20px rgba(250,204,21,0.8),
        0 4px 8px rgba(0,0,0,0.4),
        inset -2px -2px 4px rgba(0,0,0,0.2),
        inset 2px 2px 4px rgba(255,255,255,0.3);
      transform: translate(-50%, -50%);
      z-index: 20;
      transition: none;
      will-change: transform;
    }

    .bucket {
      position: absolute;
      bottom: 0;
      height: 60px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      color: white;
      text-shadow: 0 2px 6px rgba(0,0,0,0.9);
      border-radius: 8px 8px 0 0;
      transition: all 0.3s;
      backdrop-filter: blur(8px);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.2),
        inset 0 -1px 0 rgba(0,0,0,0.3),
        0 -2px 10px rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      border-bottom: none;
    }

    .bucket:hover {
      transform: translateY(-3px);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.3),
        inset 0 -1px 0 rgba(0,0,0,0.3),
        0 -4px 15px rgba(0,0,0,0.4);
    }

    .bucket-multiplier {
      font-size: 1rem;
      font-weight: 900;
      margin-bottom: 2px;
      letter-spacing: 0.3px;
      filter: drop-shadow(0 0 8px rgba(0,0,0,0.5));
    }

    .bucket-label {
      font-size: 0.5rem;
      opacity: 0.95;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 700;
    }

    /* 11 –±–∞–∫–µ—Ç–æ–≤ - –±–æ–ª—å—à–∏–µ –º–Ω–æ–∂–∏—Ç–µ–ª–∏ –ø–æ –∫—Ä–∞—è–º */
    .bucket.b0 {
      background: linear-gradient(180deg, #7c3aed 0%, #6d28d9 100%);
      width: 8.5%;
      left: 0.5%;
    }
    .bucket.b1 {
      background: linear-gradient(180deg, #15803d 0%, #16a34a 100%);
      width: 8.5%;
      left: 9.5%;
    }
    .bucket.b2 {
      background: linear-gradient(180deg, #0284c7 0%, #0369a1 100%);
      width: 8.5%;
      left: 18.5%;
    }
    .bucket.b3 {
      background: linear-gradient(180deg, #a16207 0%, #ca8a04 100%);
      width: 8.5%;
      left: 27.5%;
    }
    .bucket.b4 {
      background: linear-gradient(180deg, #9a3412 0%, #c2410c 100%);
      width: 8.5%;
      left: 36.5%;
    }
    .bucket.b5 {
      background: linear-gradient(180deg, #7f1d1d 0%, #991b1b 100%);
      width: 8.5%;
      left: 45.5%;
    }
    .bucket.b6 {
      background: linear-gradient(180deg, #9a3412 0%, #c2410c 100%);
      width: 8.5%;
      left: 54.5%;
    }
    .bucket.b7 {
      background: linear-gradient(180deg, #a16207 0%, #ca8a04 100%);
      width: 8.5%;
      left: 63.5%;
    }
    .bucket.b8 {
      background: linear-gradient(180deg, #0284c7 0%, #0369a1 100%);
      width: 8.5%;
      left: 72.5%;
    }
    .bucket.b9 {
      background: linear-gradient(180deg, #15803d 0%, #16a34a 100%);
      width: 8.5%;
      left: 81.5%;
    }
    .bucket.b10 {
      background: linear-gradient(180deg, #7c3aed 0%, #6d28d9 100%);
      width: 8.5%;
      left: 90.5%;
    }

    .bucket.active {
      animation: bucketGlow 0.6s ease-out;
    }

    @keyframes bucketGlow {
      0%, 100% { transform: translateY(0); box-shadow: none; }
      50% { transform: translateY(-8px); box-shadow: 0 12px 30px rgba(251,191,36,0.6); }
    }

    .ball-trail {
      position: absolute;
      width: 10px;
      height: 10px;
      background: radial-gradient(circle, rgba(250,204,21,0.5), transparent);
      border-radius: 50%;
      pointer-events: none;
      animation: trailFade 0.4s ease-out forwards;
      z-index: 15;
    }

    @keyframes trailFade {
      to { opacity: 0; transform: scale(0.3); }
    }

  @media (max-width: 520px) {
      .plinko-board {
        height: 400px; /* Smaller height for mobile */
      }
      .pin {
        width: 6px;
        height: 6px; /* Smaller pins */
      }
      .ball {
        width: 14px;
        height: 14px; /* Smaller ball */
      }
      .ball {
        box-shadow:
          0 0 14px rgba(250,204,21,0.7),
          0 3px 6px rgba(0,0,0,0.35);
      }
    }

    @media (min-width: 1024px) {
        .plinko-board {
            width: 800px;
            height: 600px;
            margin: 0 auto;
        }
        .bucket {
            width: 7%;
            height: 70px;
        }
    }

    .info-text {
      text-align: center;
      font-size: 0.85rem;
      color: #94a3b8;
      margin-bottom: 12px;
      padding: 10px;
      background: rgba(30,41,59,0.4);
      border-radius: 10px;
    }
  </style>
</head>
<body>

<div class="particles" id="particles"></div>

<div class="header">
  <div class="logo" onclick="location.href='../index.html'" style="cursor: pointer;">üíé DROPWIN</div>
  <div class="balance-container">
    <div class="balance">üí∞ <span id="balance">0</span>‚ÇΩ</div>
    <button class="auth-btn" id="authBtn">–ê–∫–∫–∞—É–Ω—Ç</button>
    <button class="auth-btn" onclick="window.open('https://t.me/DropWinHelp_bot','_blank')">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</button>
  </div>
</div>

<div class="content">
  <button class="back-btn" onclick="location.href='../index.html'">‚Üê –ù–∞–∑–∞–¥</button>

  <div class="game-card">
    <div class="game-title">üéØ Plinko</div>

    <div class="info-text">
      –ú–Ω–æ–∂–∏—Ç–µ–ª—å —É–º–Ω–æ–∂–∞–µ—Ç –≤–∞—à—É —Å—Ç–∞–≤–∫—É. –ú–æ–∂–Ω–æ –±—Ä–æ—Å–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —à–∞—Ä–∏–∫–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ!
    </div>

    <div class="plinko-board" id="plinkoBoard"></div>

    <div class="input-group">
      <label class="input-label">–°—Ç–∞–≤–∫–∞</label>
      <input type="number" id="bet" value="50" min="10" step="10">
    </div>

    <div class="input-group">
      <label class="input-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞—Ä–∏–∫–æ–≤ (1-5)</label>
      <input type="number" id="ballCount" value="1" min="1" max="5" step="1">
    </div>

    <button class="btn" id="dropBtn">–ë—Ä–æ—Å–∏—Ç—å —à–∞—Ä–∏–∫</button>

    <div class="result" id="result">–°–¥–µ–ª–∞–π—Ç–µ —Å—Ç–∞–≤–∫—É –∏ –±—Ä–æ—Å–∞–π—Ç–µ!</div>
  </div>
</div>

<div class="nav">
  <button class="nav-btn" onclick="location.href='../index.html'"><span>üè†</span><span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span></button>
  <button class="nav-btn" onclick="location.href='../profile.html'"><span>üë§</span><span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span></button>
  <button class="nav-btn" onclick="location.href='../register.html'"><span>üîê</span><span class="nav-label">–í—Ö–æ–¥</span></button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBVra2JN-C7-1b_Qa4cU8--XvJ83lymiM8",
    authDomain: "dropwin-8d94b.firebaseapp.com",
    projectId: "dropwin-8d94b",
    storageBucket: "dropwin-8d94b.firebasestorage.app",
    messagingSenderId: "988974289403",
    appId: "1:988974289403:web:886d34e6f65920a105fb5e",
    measurementId: "G-BK010MHN8N"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let isGuest = false;
  let userId = null;

  // ‚îÄ‚îÄ‚îÄ Particles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function createParticles() {
    const container = document.getElementById('particles');
    if (!container) return;
    for (let i = 0; i < 60; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      p.style.width = p.style.height = (Math.random()*4 + 1.5)+'px';
      p.style.left = Math.random()*100 + '%';
      p.style.animationDuration  = (Math.random()*25 + 15)+'s';
      p.style.animationDelay     = Math.random()*10 + 's';
      container.appendChild(p);
    }
  }

  // ‚îÄ‚îÄ‚îÄ User loading ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function loadCurrentUser() {
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userId = user.uid;
        isGuest = false;
        getDoc(doc(db, 'users', user.uid)).then(docSnap => {
          if (docSnap.exists()) {
            currentUser = docSnap.data();
            renderUser();
          } else {
            goToLogin();
          }
        }).catch(err => console.error("Firestore load error:", err));
      } else {
        const username = localStorage.getItem('dropwin_current_username');
        if (username === '–ì–æ—Å—Ç—å') {
          isGuest = true;
          const users = JSON.parse(localStorage.getItem('dropwin_users') || '[]');
          currentUser = users.find(u => u.username === '–ì–æ—Å—Ç—å');
          if (currentUser) {
            renderUser();
          } else {
            goToLogin();
          }
        } else {
          goToLogin();
        }
      }
    });
  }

  function renderUser() {
    document.getElementById('balance').textContent = Math.floor(currentUser.balance || 0);
    const btn = document.getElementById('authBtn');
    btn.textContent = isGuest ? '–ì–æ—Å—Ç—å' : (currentUser.username || '–ò–≥—Ä–æ–∫');
    btn.onclick = () => location.href = '../profile.html';
  }

  function goToLogin() {
    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç');
    location.href = '../register.html';
  }

  function saveUser(updates = {}) {
    if (!currentUser) return;
    Object.assign(currentUser, updates);

    if (isGuest) {
      let users = JSON.parse(localStorage.getItem('dropwin_users') || '[]');
      const idx = users.findIndex(u => u.username === '–ì–æ—Å—Ç—å');
      if (idx !== -1) {
        users[idx] = { ...currentUser };
      }
      localStorage.setItem('dropwin_users', JSON.stringify(users));
    } else if (userId) {
      updateDoc(doc(db, 'users', userId), updates)
        .catch(err => console.error("Firestore save error:", err));
    }
  }

  function addToHistory(game, change) {
    const entry = {
      game,
      time: new Date().toLocaleString('ru-RU'),
      win: change,
      result: change > 0 ? 'win' : (change < 0 ? 'loss' : 'draw')
    };
    currentUser.history = currentUser.history || [];
    currentUser.history.unshift(entry);
    if (currentUser.history.length > 30) currentUser.history = currentUser.history.slice(0, 30);
    saveUser({ history: currentUser.history });
  }

  // ‚îÄ‚îÄ‚îÄ Plinko logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let activeDrops = 0;
  const maxActiveDrops = 10; // Increased for better gameplay
  const rAF = window.requestAnimationFrame || (cb => setTimeout(cb, 16));
  let pinPositions = [];
  let boardWidth = 0;
  let boardHeight = 0;

  function initBoard() {
      const board = document.getElementById('plinkoBoard');
      if (!board) return;
      
      board.innerHTML = '';
      boardWidth = board.clientWidth;
      boardHeight = board.clientHeight;

      // Pins —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ - –ø–∏—Ä–∞–º–∏–¥–∞ (Triangle Shape)
      const rows = 14; 
      const spacing = boardWidth / (rows + 2); // Dynamic spacing

      const pinsDiv = document.createElement('div');
      pinsDiv.className = 'pins';
      pinsDiv.id = 'pinsContainer';

      for (let row = 0; row < rows; row++) {
        const cols = row + 3; // Pyramid: 3, 4, 5...
        const rowWidth = (cols - 1) * spacing;
        const startX = (boardWidth - rowWidth) / 2;
        
        for (let col = 0; col < cols; col++) {
          const x = startX + col * spacing;
          const y = (boardHeight / (rows + 2)) * (row + 1); // Start a bit lower

          const pin = document.createElement('div');
          pin.className = 'pin';
          pin.style.left = x + 'px';
          pin.style.top = y + 'px';
          pinsDiv.appendChild(pin);
        }
      }
      board.appendChild(pinsDiv);

      // 11 –±–∞–∫–µ—Ç–æ–≤ —Å –º–Ω–æ–∂–∏—Ç–µ–ª—è–º–∏ - —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–≥—Ä–∞
      const multipliers = [5, 2, 1.5, 0.8, 0.5, 0.3, 0.5, 0.8, 1.5, 2, 5];
      const labels = ['üî•', '', '', '', '', '', '', '', '', '', 'üî•'];

      for (let i = 0; i < 11; i++) {
        const bucket = document.createElement('div');
        bucket.className = `bucket b${i}`;
        bucket.id = `bucket${i}`;
        bucket.innerHTML = `
          <div class="bucket-multiplier">√ó${multipliers[i]}</div>
          <div class="bucket-label">${labels[i]}</div>
        `;
        bucket.dataset.index = i;
        bucket.dataset.multiplier = multipliers[i];
        board.appendChild(bucket);
      }

      // Cache pin positions
      const pins = document.querySelectorAll('.pin');
      pinPositions = Array.from(pins).map(pin => ({
        x: parseFloat(pin.style.left) + 4.5, // Center of pin
        y: parseFloat(pin.style.top) + 4.5,
        r: 6 // Approx radius including glow
      }));
  }

  window.addEventListener('resize', () => {
      // Debounce resize
      clearTimeout(window.resizeTimer);
      window.resizeTimer = setTimeout(initBoard, 200);
  });

  // –§–∏–∑–∏–∫–∞ Plinko
  function dropBall() {
    if (!currentUser) return alert('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.');

    const betInput = document.getElementById('bet');
    const ballCountInput = document.getElementById('ballCount');
    const bet = Number(betInput.value);
    const ballCount = Math.min(10, Math.max(1, Number(ballCountInput.value) || 1));

    if (isNaN(bet) || bet < 10) {
      return alert('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞ 10 ‚ÇΩ');
    }

    const totalBet = bet * ballCount;
    if (totalBet > currentUser.balance) {
      return alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ù—É–∂–Ω–æ ${totalBet}‚ÇΩ –¥–ª—è ${ballCount} —à–∞—Ä–∏–∫–æ–≤`);
    }

    if (activeDrops + ballCount > maxActiveDrops) {
      return alert(`–ú–∞–∫—Å–∏–º—É–º ${maxActiveDrops} —à–∞—Ä–∏–∫–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ`);
    }

    // –°–Ω–∏–º–∞–µ–º –æ–±—â—É—é —Å—Ç–∞–≤–∫—É —Å—Ä–∞–∑—É
    currentUser.balance = (currentUser.balance || 0) - totalBet;
    
    // Daily Bet Logic
    const todayStr = new Date().toDateString();
    if (currentUser.lastDailyReset !== todayStr) {
        currentUser.dailyBet = 0;
        currentUser.lastDailyReset = todayStr;
    }
    currentUser.dailyBet = (currentUser.dailyBet || 0) + totalBet;
    currentUser.totalBet = (currentUser.totalBet || 0) + totalBet;
    currentUser.gamesPlayed = (currentUser.gamesPlayed || 0) + ballCount;

    saveUser({
      balance: currentUser.balance,
      dailyBet: currentUser.dailyBet, // Save daily bet
      lastDailyReset: todayStr,
      totalBet: currentUser.totalBet,
      gamesPlayed: currentUser.gamesPlayed
    });

    document.getElementById('balance').textContent = Math.floor(currentUser.balance);
    document.getElementById('result').textContent = `–ó–∞–ø—É—â–µ–Ω–æ ${ballCount} —à–∞—Ä–∏–∫–æ–≤...`;

    // –ë—Ä–æ—Å–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —à–∞—Ä–∏–∫–æ–≤ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
    for (let i = 0; i < ballCount; i++) {
      setTimeout(() => {
        dropSingleBall(bet);
      }, i * 120);
    }
  }

  function dropBallAt(e) {
      if (!currentUser) return;
      
      // Prevent rapid firing on touch
      if (Date.now() - (window.lastDropTime || 0) < 300) return;
      window.lastDropTime = Date.now();

      const rect = document.getElementById('plinkoBoard').getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const relativeX = clientX - rect.left;
      
      // Use existing bet value
      const betInput = document.getElementById('bet');
      const bet = Number(betInput.value);

      if (isNaN(bet) || bet < 10) return; // Silent fail if invalid
      if (bet > currentUser.balance) return alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ù—É–∂–Ω–æ ${bet}‚ÇΩ`);
      if (activeDrops + 1 > maxActiveDrops) return;

      currentUser.balance = (currentUser.balance || 0) - bet;
      currentUser.totalBet = (currentUser.totalBet || 0) + bet;
      currentUser.gamesPlayed = (currentUser.gamesPlayed || 0) + 1;
      saveUser({
        balance: currentUser.balance,
        totalBet: currentUser.totalBet,
        gamesPlayed: currentUser.gamesPlayed
      });
      document.getElementById('balance').textContent = Math.floor(currentUser.balance);
      
      dropSingleBall(bet, relativeX);
  }

  function dropSingleBall(bet, spawnX) {
    activeDrops++;

    const board = document.getElementById('plinkoBoard');
    // Ensure board is initialized
    if (pinPositions.length === 0) initBoard();

    const ball = document.createElement('div');
    ball.className = 'ball';
    board.appendChild(ball);

    let x = typeof spawnX === 'number'
      ? Math.max(12, Math.min(boardWidth - 12, spawnX))
      : (boardWidth / 2 + (Math.random() - 0.5) * 60);
    let y = 30;
    let vx = (Math.random() - 0.5) * 2.2;
    let vy = 0.4;
    const gravity = 0.85;
    const bounce = 0.6;
    const friction = 0.995;

    ball.style.transform = `translate(-50%, -50%) translate3d(${x}px, ${y}px, 0)`;

    let lastTrail = 0;
    let frameCount = 0;
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

    const animate = () => {
      frameCount++;

      // –ü—Ä–∏–º–µ–Ω—è–µ–º –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏—é –∏ –¥–≤–∏–∂–µ–Ω–∏–µ
      vy += gravity;
      x += vx;
      y += vy;

      // –ê–Ω—Ç–∏-–∑–∞–ª–∏–ø–∞–Ω–∏–µ
      const speed = Math.sqrt(vx * vx + vy * vy);
      if (speed < 0.12) {
        vx += (Math.random() - 0.5) * 0.6;
        vy += gravity * 0.8;
      }

      // –û—Ç—Å–∫–æ–∫ –æ—Ç —Å—Ç–µ–Ω–æ–∫
      const wallPadding = 12;
      if (x < wallPadding) {
        x = wallPadding;
        vx = Math.abs(vx) * bounce;
      }
      if (x > boardWidth - wallPadding) {
        x = boardWidth - wallPadding;
        vx = -Math.abs(vx) * bounce;
      }

      // Optimized Collision Detection
      // Check only pins close to the ball
      for(let i = 0; i < pinPositions.length; i++) {
          const pin = pinPositions[i];
          // Quick bounding box check
          if (Math.abs(x - pin.x) > 20 || Math.abs(y - pin.y) > 20) continue;

          const dx = x - pin.x;
          const dy = y - pin.y;
          const distSq = dx*dx + dy*dy;
          const minDist = 13;
          
          if (distSq < minDist * minDist) {
             const dist = Math.sqrt(distSq);
             const angle = Math.atan2(dy, dx);
             const overlap = minDist - dist;

             x += Math.cos(angle) * overlap;
             y += Math.sin(angle) * overlap;

             const hitSpeed = Math.sqrt(vx * vx + vy * vy);
             const newSpeed = Math.max(hitSpeed * bounce, 0.6);
             vx = Math.cos(angle) * newSpeed;
             vy = Math.sin(angle) * newSpeed;
             vy += gravity * 0.2;

             // Zone attraction logic remains...
             const zones = [
                { pos: boardWidth * 0.14, strength: 0.006 },
                { pos: boardWidth * 0.23, strength: 0.008 },
                { pos: boardWidth * 0.77, strength: 0.008 },
                { pos: boardWidth * 0.86, strength: 0.006 }
             ];
             zones.forEach(zone => {
                if (Math.abs(x - zone.pos) < boardWidth * 0.15) {
                   vx += (zone.pos - x) * zone.strength;
                }
             });

             vx += (Math.random() - 0.5) * 0.6;
          }
      }

      // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç—Ä–µ–Ω–∏–µ
      vx *= friction;
      vy *= friction;

      // –¢—Ä–µ–π–ª —ç—Ñ—Ñ–µ–∫—Ç (reduced frequency on mobile)
      if (!isMobile) {
        if (frameCount % 4 === 0 && Date.now() - lastTrail > 40) {
          const trail = document.createElement('div');
          trail.className = 'ball-trail';
          trail.style.left = x + 'px';
          trail.style.top = y + 'px';
          board.appendChild(trail);
          setTimeout(() => trail.remove(), 350);
          lastTrail = Date.now();
        }
      }

      ball.style.transform = `translate(-50%, -50%) translate3d(${x}px, ${y}px, 0)`;

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –¥–Ω–∞
      if (y < boardHeight - 65) {
        rAF(animate);
      } else {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤ –∫–∞–∫–æ–π –±–∞–∫–µ—Ç –ø–æ–ø–∞–ª (11 –±–∞–∫–µ—Ç–æ–≤)
        const bucketIndex = Math.floor((x / boardWidth) * 11);
        const finalIndex = Math.max(0, Math.min(10, bucketIndex));

        // –ê–Ω–∏–º–∞—Ü–∏—è –±–∞–∫–µ—Ç–∞
        const buckets = document.querySelectorAll('.bucket');
        if (buckets[finalIndex]) {
            buckets[finalIndex].classList.add('active');
            setTimeout(() => buckets[finalIndex].classList.remove('active'), 500);
        
            const mult = parseFloat(buckets[finalIndex].dataset.multiplier);
            let payout = Math.round(bet * mult);
            let net = payout - bet;

            currentUser.balance = (currentUser.balance || 0) + payout;
            if (net > 0) {
                currentUser.totalWin = (currentUser.totalWin || 0) + net;
                currentUser.wins = (currentUser.wins || 0) + 1;
            } else if (net < 0) {
                currentUser.losses = (currentUser.losses || 0) + 1;
            }

            document.getElementById('balance').textContent = Math.floor(currentUser.balance);
            addToHistory('Plinko', net);
            saveUser({
                balance: currentUser.balance,
                totalWin: currentUser.totalWin,
                wins: currentUser.wins,
                losses: currentUser.losses
            });

            activeDrops--;

            if (activeDrops === 0) {
                let message = '';
                if (net > 0) {
                message = `<span style="color:#34d399; font-size:1.15rem">–í—ã–∏–≥—Ä—ã—à! +${net}‚ÇΩ (√ó${mult}) üéâ</span>`;
                } else if (net === 0) {
                message = `<span style="color:#fbbf24">–í–æ–∑–≤—Ä–∞—Ç ${payout}‚ÇΩ (√ó${mult})</span>`;
                } else {
                message = `<span style="color:#f87171">–ü–æ—Ç–µ—Ä—è ${Math.abs(net)}‚ÇΩ (√ó${mult})</span>`;
                }
                document.getElementById('result').innerHTML = message;
            }
        } else {
            activeDrops--;
        }
        
        ball.remove(); // Remove ball from DOM
      }
    };

    rAF(animate);
  }

  // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.addEventListener('DOMContentLoaded', () => {
    createParticles();
    loadCurrentUser();
    initBoard();

    document.getElementById('dropBtn').onclick = dropBall;
    
    // Add touch support to board
    const board = document.getElementById('plinkoBoard');
    board.addEventListener('click', dropBallAt);
    board.addEventListener('touchstart', (e) => {
        if (e.target.closest('.bucket')) return; // Allow bucket interaction if any
        e.preventDefault(); 
        dropBallAt(e); 
    }, { passive: false });
  });
</script>
</body>
</html>
