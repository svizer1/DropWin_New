<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>–†—É–ª–µ—Ç–∫–∞ | DropWin</title>
  <link rel="stylesheet" href="../style.css">
  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #0f172a;
      color: white;
    }
    .particles {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 1;
    }
    .particle {
      position: absolute;
      background: #fbbf24;
      border-radius: 50%;
      opacity: 0.6;
      animation: float linear infinite;
    }
    @keyframes float {
      0%   { transform: translateY(100vh) scale(0.5); opacity: 0; }
      10%  { opacity: 0.8; }
      90%  { opacity: 0.8; }
      100% { transform: translateY(-20vh) scale(1.2); opacity: 0; }
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(8px);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .logo { font-size: 1.5rem; font-weight: bold; }
    .balance-container { display: flex; gap: 12px; align-items: center; }
    .balance { font-weight: bold; }
    .auth-btn {
      padding: 8px 16px;
      border-radius: 50px;
      background: #6366f1;
      border: none;
      color: white;
      cursor: pointer;
    }
    .content { padding: 16px; position: relative; z-index: 10; }
    .back-btn {
      margin-bottom: 16px;
      background: transparent;
      border: none;
      color: #fbbf24;
      font-size: 1.1rem;
      cursor: pointer;
    }
    .game-card {
      background: rgba(30,41,59,0.7);
      border-radius: 16px;
      padding: 20px;
      backdrop-filter: blur(10px);
    }
    .game-title {
      text-align: center;
      font-size: 2rem;
      margin-bottom: 16px;
    }
    .roulette-type-selector {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin: 12px 0;
    }
    .roulette-type-btn {
      padding: 8px 16px;
      border-radius: 50px;
      border: 2px solid #6366f1;
      background: transparent;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .roulette-type-btn.active {
      background: #6366f1;
    }

    .roulette-wheel-container {
      position: relative;
      width: 260px;
      height: 260px;
      margin: 50px auto 30px;
    }
    .roulette-wheel {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      position: absolute;
      inset: 0;
      border: 10px solid #fbbf24;
      box-shadow: 0 0 60px rgba(251,191,36,0.7), inset 0 0 40px rgba(0,0,0,0.6);
      background: conic-gradient(
        #10b981 0deg 9.73deg, #ef4444 9.73deg 19.46deg, #1f2937 19.46deg 29.19deg,
        #ef4444 29.19deg 38.92deg, #1f2937 38.92deg 48.65deg, #ef4444 48.65deg 58.38deg,
        #1f2937 58.38deg 68.11deg, #ef4444 68.11deg 77.84deg, #1f2937 77.84deg 87.57deg,
        #ef4444 87.57deg 97.3deg,  #1f2937 97.3deg 107.03deg, #ef4444 107.03deg 116.76deg,
        #1f2937 116.76deg 126.49deg, #ef4444 126.49deg 136.22deg, #1f2937 136.22deg 145.95deg,
        #ef4444 145.95deg 155.68deg, #1f2937 155.68deg 165.41deg, #ef4444 165.41deg 175.14deg,
        #1f2937 175.14deg 184.87deg, #ef4444 184.87deg 194.6deg,  #1f2937 194.6deg 204.33deg,
        #ef4444 204.33deg 214.06deg, #1f2937 214.06deg 223.79deg, #ef4444 223.79deg 233.52deg,
        #1f2937 233.52deg 243.25deg, #ef4444 243.25deg 252.98deg, #1f2937 252.98deg 262.71deg,
        #ef4444 262.71deg 272.44deg, #1f2937 272.44deg 282.17deg, #ef4444 282.17deg 291.9deg,
        #1f2937 291.9deg 301.63deg, #ef4444 301.63deg 311.36deg, #1f2937 311.36deg 321.09deg,
        #ef4444 321.09deg 330.82deg, #1f2937 330.82deg 340.55deg, #ef4444 340.55deg 350.28deg,
        #1f2937 350.28deg 360deg
      );
      transition: transform 4.8s cubic-bezier(0.22, 0.61, 0.36, 1);
      transform: rotate(0deg);
    }
    .roulette-pointer {
      position: absolute;
      top: -18px;
      left: 50%;
      transform: translateX(-50%) rotate(180deg);
      width: 0;
      height: 0;
      border-left: 16px solid transparent;
      border-right: 16px solid transparent;
      border-bottom: 34px solid #fbbf24;
      filter: drop-shadow(0 0 12px #fbbf24);
      z-index: 20;
      pointer-events: none;
    }

    .roulette-container {
      overflow: hidden;
      width: 100%;
      max-width: 380px;
      margin: 30px auto;
      position: relative;
      height: 160px;
      border: 5px solid #fbbf24;
      border-radius: 16px;
      box-shadow: 0 0 50px rgba(251,191,36,0.5);
      display: none;
    }
    .roulette-tape {
      display: flex;
      height: 100%;
      transition: none;
      will-change: transform;
    }
    .roulette-cell {
      flex: 0 0 110px;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: bold;
      color: white;
      border-right: 3px solid #fbbf24;
      box-sizing: border-box;
    }
    .roulette-cell.red   { background: #ef4444; }
    .roulette-cell.black { background: #1f2937; }
    .roulette-cell.green { background: #10b981; }

    .roulette-pointer-line {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 6px;
      height: 200px;
      background: #fbbf24;
      box-shadow: 0 0 18px #fbbf24, 0 0 32px #fbbf24;
      z-index: 10;
      pointer-events: none;
    }

    .fast-spin-btn {
      margin: 20px auto;
      padding: 12px 24px;
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      border: none;
      border-radius: 50px;
      color: #111;
      font-weight: bold;
      font-size: 1.1rem;
      cursor: pointer;
      display: block;
    }
    .input-group {
      max-width: 300px;
      margin: 20px auto;
    }
    .input-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    input[type=number] {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: none;
      font-size: 1.2rem;
      background: #1e293b;
      color: white;
    }
    .bet-options {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin: 24px 0;
    }
    .bet-btn {
      padding: 14px 24px;
      border-radius: 12px;
      border: none;
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
      min-width: 110px;
    }
    .red   { background: #ef4444; color: white; }
    .black { background: #1f2937; color: white; }
    .green { background: #10b981; color: white; }
    .number-bet { background: #6366f1; color: white; }
    .result {
      text-align: center;
      font-size: 1.4rem;
      min-height: 80px;
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <div class="particles" id="particles"></div>

  <div class="header">
    <div class="logo" onclick="location.href='../index.html'" style="cursor: pointer;">üíé DROPWIN</div>
    <div class="balance-container">
      <div class="balance">üí∞ <span id="balance">0</span>‚ÇΩ</div>
      <button class="auth-btn" id="authBtn">–ê–∫–∫–∞—É–Ω—Ç</button>
    </div>
  </div>

  <div class="content">
    <button class="back-btn" onclick="location.href='../index.html'">‚Üê –ù–∞–∑–∞–¥</button>

    <div class="game-card">
      <div class="game-title">üé° –†—É–ª–µ—Ç–∫–∞</div>

      <div class="roulette-type-selector">
        <button class="roulette-type-btn active" data-type="wheel">–ö—Ä—É–≥</button>
        <button class="roulette-type-btn" data-type="tape">–õ–µ–Ω—Ç–∞</button>
      </div>

      <div id="wheelContainer">
        <div class="roulette-wheel-container">
          <div class="roulette-wheel" id="wheel"></div>
          <div class="roulette-pointer"></div>
        </div>
      </div>

      <div id="tapeContainer" class="roulette-container">
        <div class="roulette-tape" id="tape"></div>
        <div class="roulette-pointer-line"></div>
      </div>

      <button class="fast-spin-btn" id="fastSpinBtn">–ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ (2.5—Å)</button>

      <div class="input-group">
        <label class="input-label">–°—Ç–∞–≤–∫–∞</label>
        <input type="number" id="betAmount" value="50" min="10">
      </div>

      <div class="bet-options">
        <button class="bet-btn red"    data-bet="red">–ö—Ä–∞—Å–Ω–æ–µ</button>
        <button class="bet-btn black"  data-bet="black">–ß—ë—Ä–Ω–æ–µ</button>
        <button class="bet-btn green"  data-bet="green">–ó–µ–ª—ë–Ω–æ–µ</button>
        <button class="bet-btn number-bet" data-bet="number">–ß–∏—Å–ª–æ</button>
      </div>

      <div class="result" id="rouletteResult">–ì–æ—Ç–æ–≤—ã –∫ —Å—Ç–∞–≤–∫–µ?</div>
    </div>
  </div>

  <div class="nav">
    <button class="nav-btn" onclick="location.href='../index.html'"><span>üè†</span><span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span></button>
    <button class="nav-btn" onclick="location.href='../profile.html'"><span>üë§</span><span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span></button>
    <button class="nav-btn" onclick="location.href='../register.html'"><span>üîë</span><span class="nav-label">–í—Ö–æ–¥</span></button>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBVra2JN-C7-1b_Qa4cU8--XvJ83lymiM8",
    authDomain: "dropwin-8d94b.firebaseapp.com",
    projectId: "dropwin-8d94b",
    storageBucket: "dropwin-8d94b.firebasestorage.app",
    messagingSenderId: "988974289403",
    appId: "1:988974289403:web:886d34e6f65920a105fb5e",
    measurementId: "G-BK010MHN8N"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  function createParticles() {
    const container = document.getElementById('particles');
    for (let i = 0; i < 50; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      p.style.width = p.style.height = Math.random() * 3 + 1 + 'px';
      p.style.left = Math.random() * 100 + '%';
      p.style.animationDuration = Math.random() * 20 + 15 + 's';
      p.style.animationDelay = Math.random() * 8 + 's';
      container.appendChild(p);
    }
  }

  let currentUser = null;
  let userId = null;
  let isSpinning = false;
  let fastSpin = false;

  const rouletteNumbers = [0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26];
  const redNumbers = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];

  function getCellColor(num) {
    if (num === 0) return 'green';
    return redNumbers.includes(num) ? 'red' : 'black';
  }

  function loadCurrentUser() {
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userId = user.uid;
        getDoc(doc(db, 'users', user.uid)).then((docSnap) => {
          if (docSnap.exists()) {
            currentUser = docSnap.data();
            document.getElementById('balance').textContent = currentUser.balance || 0;
            const btn = document.getElementById('authBtn');
            btn.textContent = currentUser.isGuest ? '–ì–æ—Å—Ç—å' : currentUser.username;
            btn.onclick = () => location.href = '../profile.html';
          } else {
            location.href = '../register.html';
          }
        }).catch(err => console.error("Firestore error:", err));
      } else {
        const username = localStorage.getItem('dropwin_current_username');
        if (username !== '–ì–æ—Å—Ç—å') {
          location.href = '../register.html';
          return;
        }
        const users = JSON.parse(localStorage.getItem('dropwin_users')) || [];
        currentUser = users.find(u => u.username === username);
        if (!currentUser) {
          location.href = '../register.html';
          return;
        }
        document.getElementById('balance').textContent = currentUser.balance || 0;
        const btn = document.getElementById('authBtn');
        btn.textContent = '–ì–æ—Å—Ç—å';
        btn.onclick = () => location.href = '../profile.html';
      }
    });
  }

  async function saveUser() {
    if (!currentUser) return;
    if (userId) {
      try {
        await updateDoc(doc(db, 'users', userId), currentUser);
      } catch (err) {
        console.error("Save user error:", err);
      }
    } else if (currentUser.isGuest) {
      let users = JSON.parse(localStorage.getItem('dropwin_users')) || [];
      const idx = users.findIndex(u => u.username === currentUser.username);
      if (idx !== -1) users[idx] = currentUser;
      localStorage.setItem('dropwin_users', JSON.stringify(users));
    }
  }

  function addToHistory(game, change) {
    const entry = {
      game,
      time: new Date().toLocaleString('ru-RU'),
      win: change,
      result: change > 0 ? 'win' : 'loss'
    };
    currentUser.history = currentUser.history || [];
    currentUser.history.unshift(entry);
    if (currentUser.history.length > 20) currentUser.history.pop();
    saveUser();
  }

  function generateTape() {
    const tape = document.getElementById('tape');
    if (!tape) return;
    tape.innerHTML = '';
    for (let rep = 0; rep < 15; rep++) {
      rouletteNumbers.forEach(num => {
        const cell = document.createElement('div');
        cell.className = `roulette-cell ${getCellColor(num)}`;
        cell.textContent = num;
        tape.appendChild(cell);
      });
    }
    tape.style.width = `${rouletteNumbers.length * 15 * 110}px`;
  }

  function switchType(type) {
    document.querySelectorAll('.roulette-type-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`[data-type="${type}"]`)?.classList.add('active');
    document.getElementById('wheelContainer').style.display = type === 'wheel' ? 'block' : 'none';
    document.getElementById('tapeContainer').style.display = type === 'tape' ? 'block' : 'none';
    if (type === 'tape' && document.getElementById('tape').children.length === 0) {
      generateTape();
    }
  }

  async function placeBet(type) {
    if (isSpinning) return alert('–ü–æ–¥–æ–∂–¥–∏—Ç–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤—Ä–∞—â–µ–Ω–∏—è');
    if (!currentUser) return alert('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ');

    let betNumber = null;
    if (type === 'number') {
      const num = prompt("–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ (0‚Äì36):");
      if (num === null) return;
      betNumber = Number(num);
      if (isNaN(betNumber) || betNumber < 0 || betNumber > 36) {
        return alert('–ù–µ–≤–µ—Ä–Ω–æ–µ —á–∏—Å–ª–æ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 0 –¥–æ 36)');
      }
    }

    const betInput = document.getElementById('betAmount');
    const bet = Number(betInput.value);
    if (bet < 10 || bet > (currentUser.balance || 0) || isNaN(bet)) {
      return alert('–°—Ç–∞–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 10 ‚ÇΩ –∏ –Ω–µ –±–æ–ª—å—à–µ –±–∞–ª–∞–Ω—Å–∞');
    }

    isSpinning = true;
    currentUser.balance -= bet;
    currentUser.totalBet = (currentUser.totalBet || 0) + bet;

    // Calendar Daily Bet Logic
    const todayStr = new Date().toDateString();
    if (currentUser.lastDailyReset !== todayStr) {
        currentUser.dailyBet = 0;
        currentUser.lastDailyReset = todayStr;
    }
    currentUser.dailyBet = (currentUser.dailyBet || 0) + bet;

    currentUser.gamesPlayed = (currentUser.gamesPlayed || 0) + 1;
    await saveUser();
    document.getElementById('balance').textContent = currentUser.balance;
    document.getElementById('rouletteResult').textContent = '–ö—Ä—É—Ç–∏–º –∫–æ–ª–µ—Å–æ...';

    const isWheel = document.getElementById('wheelContainer').style.display !== 'none';

    if (isWheel) {
      const wheel = document.getElementById('wheel');
      if (!wheel) return;
      wheel.style.transition = fastSpin ? 'transform 2.5s ease-out' : 'transform 4.8s cubic-bezier(0.22, 0.61, 0.36, 1)';
      wheel.style.transform = 'rotate(0deg)';

      setTimeout(() => {
        const result = Math.floor(Math.random() * 37);
        const anglePerNumber = 360 / 37;
        const base = 90 - (anglePerNumber / 2);
        const fullTurns = fastSpin ? 8 : 12;
        const finalAngle = 360 * fullTurns + (base - result * anglePerNumber);
        wheel.style.transform = `rotate(${finalAngle}deg)`;
        setTimeout(() => finishSpin(result, bet, type, betNumber), fastSpin ? 2600 : 5000);
      }, 120);
    } else {
      const tape = document.getElementById('tape');
      if (!tape) return;

      tape.style.transition = 'none';
      tape.style.transform = 'translateX(0px)';
      void tape.offsetWidth;

      tape.style.transition = fastSpin
        ? 'transform 2.5s ease-out'
        : 'transform 5.5s cubic-bezier(0.11, 0.89, 0.32, 1.00)';

      setTimeout(() => {
        const result = Math.floor(Math.random() * 37);
        const per = rouletteNumbers.length;
        const indexInSet = rouletteNumbers.indexOf(result);
        const targetIndex = per * (fastSpin ? 8 : 12) + indexInSet;
        const container = document.getElementById('tapeContainer');
        const cells = tape.children;
        const targetEl = cells[targetIndex];
        const containerRect = container.getBoundingClientRect();
        const targetRect = targetEl.getBoundingClientRect();
        const markerX = containerRect.left + (containerRect.width / 2);
        const cellCenterX = targetRect.left + (targetRect.width / 2);
        const offset = -(cellCenterX - markerX);
        tape.style.transform = `translateX(${offset}px)`;
        setTimeout(() => finishSpin(result, bet, type, betNumber), fastSpin ? 2600 : 5600);
      }, 60);
    }
  }

  async function finishSpin(result, bet, type, betNumber) {
    const color = result === 0 ? 'green' : (redNumbers.includes(result) ? 'red' : 'black');
    let win = 0;

    if (type === 'red'   && color === 'red')   win = bet * 2;
    if (type === 'black' && color === 'black') win = bet * 2;
    if (type === 'green' && color === 'green') win = bet * 14;
    if (type === 'number' && result === betNumber) win = bet * 36;

    if (win > 0) {
      currentUser.balance += win;
      currentUser.totalWin = (currentUser.totalWin || 0) + win;
      currentUser.wins     = (currentUser.wins     || 0) + 1;
      document.getElementById('rouletteResult').innerHTML =
        `<span style="color:#22c55e; font-weight:bold;">–í—ã–∏–≥—Ä—ã—à +${win}‚ÇΩ</span> (${result})`;
      addToHistory('–†—É–ª–µ—Ç–∫–∞', win - bet);
    } else {
      currentUser.losses = (currentUser.losses || 0) + 1;
      document.getElementById('rouletteResult').innerHTML =
        `<span style="color:#ef4444; font-weight:bold;">–ü—Ä–æ–∏–≥—Ä—ã—à (${result})</span>`;
      addToHistory('–†—É–ª–µ—Ç–∫–∞', -bet);
    }

    await saveUser();
    document.getElementById('balance').textContent = currentUser.balance;
    isSpinning = false;
  }

  document.addEventListener('DOMContentLoaded', () => {
    createParticles();
    loadCurrentUser();

    document.querySelectorAll('.roulette-type-btn').forEach(btn => {
      btn.addEventListener('click', () => switchType(btn.dataset.type));
    });

    document.getElementById('fastSpinBtn').addEventListener('click', () => {
      fastSpin = !fastSpin;
      const btn = document.getElementById('fastSpinBtn');
      btn.textContent = fastSpin
        ? '–û–±—ã—á–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ (5.5—Å)'
        : '–ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ (2.5—Å)';
      btn.style.background = fastSpin
        ? 'linear-gradient(135deg, #ef4444, #b91c1c)'
        : 'linear-gradient(135deg, #fbbf24, #f59e0b)';
    });

    // –ü—Ä–∏–≤—è–∑–∫–∞ –∫–Ω–æ–ø–æ–∫ —Å—Ç–∞–≤–æ–∫
    document.querySelectorAll('.bet-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const type = btn.dataset.bet;
        placeBet(type);
      });
    });

    switchType('wheel');
  });
</script>
</body>
</html>
