<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Ğ¡Ğ»Ğ¾Ñ‚Ñ‹ | DropWin</title>
  <link rel="stylesheet" href="../style.css">
</head>
<body>
<div class="particles" id="particles"></div>

<div class="header">
  <div class="logo" onclick="location.href='../index.html'" style="cursor: pointer;">ğŸ’ DROPWIN</div>
  <div class="balance-container">
    <div class="balance">ğŸ’° <span id="balance">0</span>â‚½</div>
    <button class="auth-btn" id="authBtn">ĞĞºĞºĞ°ÑƒĞ½Ñ‚</button>
  </div>
</div>

<div class="content" style="min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding-top: 80px;">
  
  <button class="back-btn" onclick="location.href='../index.html'" style="align-self: flex-start; margin-left: 20px;">â† ĞĞ°Ğ·Ğ°Ğ´</button>

  <div class="game-card" style="max-width: 500px; width: 90%; background: rgba(30, 27, 41, 0.9); border: 2px solid #7c3aed; box-shadow: 0 0 40px rgba(124, 58, 237, 0.3);">
    <div class="game-title" style="text-shadow: 0 0 10px #7c3aed;">ğŸ° Ğ¡Ğ»Ğ¾Ñ‚Ñ‹</div>

    <div class="slot-machine">
      <div class="reel" id="reel1">
        <div class="slot-item" id="slot1">?</div>
      </div>
      <div class="reel" id="reel2">
        <div class="slot-item" id="slot2">?</div>
      </div>
      <div class="reel" id="reel3">
        <div class="slot-item" id="slot3">?</div>
      </div>
    </div>

    <div class="input-group">
      <label class="input-label">Ğ¡Ñ‚Ğ°Ğ²ĞºĞ°</label>
      <input type="number" id="bet" value="50" min="10">
    </div>
    <button class="btn" id="spinBtn">ĞšÑ€ÑƒÑ‚Ğ¸Ñ‚ÑŒ</button>
    <div class="result" id="result">Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ñ‹?</div>
  </div>
</div>

<div class="nav">
  <button class="nav-btn" onclick="location.href='../index.html'"><span>ğŸ </span><span class="nav-label">Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ</span></button>
  <button class="nav-btn" onclick="location.href='../profile.html'"><span>ğŸ‘¤</span><span class="nav-label">ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</span></button>
  <button class="nav-btn" onclick="location.href='../register.html'"><span>ğŸ”‘</span><span class="nav-label">Ğ’Ñ…Ğ¾Ğ´</span></button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBVra2JN-C7-1b_Qa4cU8--XvJ83lymiM8",
    authDomain: "dropwin-8d94b.firebaseapp.com",
    projectId: "dropwin-8d94b",
    storageBucket: "dropwin-8d94b.firebasestorage.app",
    messagingSenderId: "988974289403",
    appId: "1:988974289403:web:886d34e6f65920a105fb5e",
    measurementId: "G-BK010MHN8N"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  function createParticles() {
    const container = document.getElementById('particles');
    for (let i = 0; i < 50; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      p.style.width = p.style.height = Math.random() * 3 + 1 + 'px';
      p.style.left = Math.random() * 100 + '%';
      p.style.animationDuration = Math.random() * 20 + 12 + 's';
      p.style.animationDelay = Math.random() * 6 + 's';
      container.appendChild(p);
    }
  }

  let currentUser = null;
  let userId = null;

  function sanitizeData(obj) {
    const out = {};
    Object.entries(obj).forEach(([k, v]) => {
      if (v !== undefined) out[k] = v;
    });
    return out;
  }

  function loadCurrentUser() {
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userId = user.uid;
        getDoc(doc(db, 'users', user.uid)).then((docSnap) => {
          if (docSnap.exists()) {
            currentUser = docSnap.data();
            document.getElementById('balance').textContent = currentUser.balance || 0;
            const btn = document.getElementById('authBtn');
            btn.textContent = currentUser.isGuest ? 'Ğ“Ğ¾ÑÑ‚ÑŒ' : currentUser.username;
            btn.onclick = () => location.href = '../profile.html';
          } else {
            location.href = '../register.html';
          }
        });
      } else {
        // Ğ“Ğ¾ÑÑ‚ÑŒ
        const username = localStorage.getItem('dropwin_current_username');
        if (username !== 'Ğ“Ğ¾ÑÑ‚ÑŒ') {
          location.href = '../register.html';
          return;
        }
        const users = JSON.parse(localStorage.getItem('dropwin_users')) || [];
        currentUser = users.find(u => u.username === username);
        if (!currentUser) {
          location.href = '../register.html';
          return;
        }
        document.getElementById('balance').textContent = currentUser.balance || 0;
        const btn = document.getElementById('authBtn');
        btn.textContent = 'Ğ“Ğ¾ÑÑ‚ÑŒ';
        btn.onclick = () => location.href = '../profile.html';
      }
    });
  }

  async function saveUser() {
    if (userId) {
      await updateDoc(doc(db, 'users', userId), sanitizeData(currentUser));
    } else if (currentUser.isGuest) {
      let users = JSON.parse(localStorage.getItem('dropwin_users')) || [];
      const idx = users.findIndex(u => u.username === currentUser.username);
      if (idx !== -1) users[idx] = currentUser;
      localStorage.setItem('dropwin_users', JSON.stringify(users));
    }
  }

  function addToHistory(game, winAmount) {
    const entry = {
      game: game,
      time: new Date().toLocaleString('ru-RU'),
      win: winAmount,
      result: winAmount > 0 ? 'win' : 'loss'
    };
    currentUser.history = currentUser.history || [];
    currentUser.history.unshift(entry);
    if (currentUser.history.length > 20) currentUser.history.pop();
    saveUser();
  }

  const symbols = ['ğŸ’','ğŸ‹','ğŸŠ','ğŸ‰','ğŸ””','â­','ğŸ’','7'];

  async function spin() {
    if (!currentUser) return alert('Ğ¡ĞµÑÑĞ¸Ñ Ğ¸ÑÑ‚ĞµĞºĞ»Ğ°. Ğ’Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾');

    let bet = Number(document.getElementById('bet').value);
    if (bet < 10 || bet > currentUser.balance || isNaN(bet)) {
      alert('Ğ¡Ñ‚Ğ°Ğ²ĞºĞ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ¾Ñ‚ 10 â‚½ Ğ¸ Ğ½Ğµ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°');
      return;
    }

    currentUser.balance -= bet;
    currentUser.totalBet = (currentUser.totalBet || 0) + bet;
    currentUser.gamesPlayed = (currentUser.gamesPlayed || 0) + 1;
    await saveUser();
    document.getElementById('balance').textContent = currentUser.balance;

    document.getElementById('result').textContent = 'ĞšÑ€ÑƒÑ‚Ğ¸Ğ¼...';

    const reels = [document.getElementById('reel1'), document.getElementById('reel2'), document.getElementById('reel3')];
    const items = [document.getElementById('slot1'), document.getElementById('slot2'), document.getElementById('slot3')];

    reels.forEach(reel => reel.classList.add('spinning'));

    const spinInterval = setInterval(() => {
      items.forEach(item => {
        if (item.parentElement.classList.contains('spinning')) {
          item.textContent = symbols[Math.floor(Math.random() * symbols.length)];
        }
      });
    }, 70);

    const totalSpinTime = 2200;
    const stopDelays = [0, 450, 900];

    setTimeout(() => stopReel(0, spinInterval), totalSpinTime + stopDelays[0]);
    setTimeout(() => stopReel(1, spinInterval), totalSpinTime + stopDelays[1]);
    setTimeout(() => stopReel(2, spinInterval), totalSpinTime + stopDelays[2]);

    function stopReel(index, interval) {
      const reel = reels[index];
      const item = items[index];

      reel.classList.remove('spinning');
      reel.classList.add('stopping');

      setTimeout(() => {
        item.textContent = symbols[Math.floor(Math.random() * symbols.length)];
      }, 100);

      if (index === 2) {
        clearInterval(interval);
        setTimeout(checkWin, 800);
      }
    }

    async function checkWin() {
      const s1 = items[0].textContent;
      const s2 = items[1].textContent;
      const s3 = items[2].textContent;

      let win = 0;
      if (s1 === s2 && s2 === s3) win = bet * 10;
      else if (s1 === s2 || s2 === s3 || s1 === s3) win = bet * 2;

      if (win > 0) {
        currentUser.balance += win;
        currentUser.totalWin = (currentUser.totalWin || 0) + win;
        currentUser.wins = (currentUser.wins || 0) + 1;
        document.getElementById('result').innerHTML = `<span style="color:#10b981">Ğ’Ñ‹Ğ¸Ğ³Ñ€Ñ‹Ñˆ +${win}â‚½ ğŸ‰</span>`;
        addToHistory('Ğ¡Ğ»Ğ¾Ñ‚Ñ‹', win);
      } else {
        currentUser.losses = (currentUser.losses || 0) + 1;
        document.getElementById('result').innerHTML = '<span style="color:#ef4444">ĞŸÑ€Ğ¾Ğ¸Ğ³Ñ€Ñ‹Ñˆ ğŸ˜”</span>';
        addToHistory('Ğ¡Ğ»Ğ¾Ñ‚Ñ‹', -bet);
      }

      await saveUser();
      document.getElementById('balance').textContent = currentUser.balance;

      setTimeout(() => {
        reels.forEach(r => r.classList.remove('stopping'));
      }, 1200);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    createParticles();
    loadCurrentUser();
  });
  document.getElementById('spinBtn').addEventListener('click', spin);
</script>
</body>
</html>
