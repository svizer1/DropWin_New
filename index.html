<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>DropWin - –õ—É—á—à–∏–µ –∫–µ–π—Å—ã –∏ –∏–≥—Ä—ã</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/x-icon" href="logo.ico">
  <style>
      .toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
      .toast { pointer-events: auto; background: rgba(20, 20, 30, 0.95); border: 1px solid rgba(34, 197, 94, 0.5); color: #fff; padding: 16px 24px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); backdrop-filter: blur(12px); min-width: 300px; display: flex; align-items: center; gap: 12px; animation: slideDown 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
      .toast-icon { font-size: 1.5rem; }
      .toast-content { display: flex; flex-direction: column; }
      .toast-title { font-weight: 800; font-size: 1rem; color: #4ade80; margin-bottom: 2px; }
      .toast-msg { font-size: 0.9rem; color: #cbd5e1; }
      @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
      .chat-suggestions { display: flex; flex-wrap: wrap; gap: 8px; padding: 10px 16px; border-top: 1px solid var(--border, rgba(255,255,255,0.1)); background: rgba(0,0,0,0.2); max-height: 100px; overflow-y: auto; }
      .chat-chip { background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); color: #d8b4fe; padding: 6px 12px; border-radius: 16px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
      .chat-chip:hover { background: rgba(139, 92, 246, 0.4); color: white; }
      .nav-badge {
          position: absolute;
          top: 4px;
          right: 4px;
          width: 8px;
          height: 8px;
          background: #ef4444;
          border-radius: 50%;
          border: 1px solid #1e1b2e;
          display: none;
          z-index: 10;
          box-shadow: 0 0 8px #ef4444;
      }
      .nav-badge.active { display: block; }

      .notification-widget {
          position: fixed;
          top: 60px;
          right: 12px;
          width: 300px;
          background: #1e1b2e;
          border: 1px solid rgba(139, 92, 246, 0.3);
          border-radius: 12px;
          padding: 12px;
          display: none;
          flex-direction: column;
          gap: 8px;
          z-index: 1000;
          box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      }
      .notification-widget.active { display: flex; }
      .notif-header { font-weight: 700; color: white; display: flex; justify-content: space-between; align-items: center; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }
      .notif-list { max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
      .badge-count {
          background: #ef4444;
          color: white;
          font-size: 0.7rem;
          padding: 2px 6px;
          border-radius: 10px;
          margin-left: auto;
          display: none;
      }
  </style>
</head>
<body>
<div class="toast-container" id="toastContainer"></div>

<!-- Age Verification Modal -->
<div class="age-modal-overlay" id="ageModalOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
    <div class="age-modal" style="background: #1e1b2e; padding: 30px; border-radius: 20px; border: 1px solid rgba(139, 92, 246, 0.3); max-width: 400px; width: 90%; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.8);">
        <div style="font-size: 4rem; margin-bottom: 20px;">üîû</div>
        <h2 style="color: white; margin-bottom: 15px; font-weight: 800;">–í–∞–º –µ—Å—Ç—å 18 –ª–µ—Ç?</h2>
        <p style="color: #cbd5e1; margin-bottom: 25px; line-height: 1.5;">
            –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–∞–π—Ç—É –≤—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å—Ç–∞—Ä—à–µ 18 –ª–µ—Ç –∏ –ø—Ä–∏–Ω—è—Ç—å —É—Å–ª–æ–≤–∏—è <a href="#" style="color: #8b5cf6; text-decoration: underline;">–ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω–æ–≥–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è</a>.
        </p>
        <button onclick="acceptAge()" style="background: linear-gradient(135deg, #8b5cf6, #db2777); color: white; border: none; padding: 12px 30px; border-radius: 12px; font-weight: 700; font-size: 1.1rem; cursor: pointer; width: 100%; transition: transform 0.2s;">
            –î–∞, –º–Ω–µ –µ—Å—Ç—å 18 –ª–µ—Ç
        </button>
    </div>
</div>

<script>
    // Check Age Verification
    document.addEventListener('DOMContentLoaded', () => {
        if (!localStorage.getItem('ageVerified')) {
            document.getElementById('ageModalOverlay').style.display = 'flex';
        }
    });

    function acceptAge() {
        localStorage.setItem('ageVerified', 'true');
        document.getElementById('ageModalOverlay').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('ageModalOverlay').style.display = 'none';
        }, 300);
    }
</script>

<!-- Live Feed Strip -->
<div class="live-feed">
  <div class="live-feed-track">
    <!-- Set 1 -->
    <div class="live-item gold">
        <img src="images/index/inventory.png" alt="Item">
    </div>
    <div class="live-item purple">
        <img src="images/index/battles.png" alt="Item">
    </div>
    <div class="live-item red">
        <img src="images/index/crash.png" alt="Item">
    </div>
    <div class="live-item gold">
        <img src="images/index/dice.png" alt="Item">
    </div>
    <div class="live-item purple">
        <img src="images/index/miner.png" alt="Item">
    </div>
    <div class="live-item red">
        <img src="images/index/roulette.png" alt="Item">
    </div>
    <div class="live-item gold">
        <img src="images/index/slots.png" alt="Item">
    </div>
    <div class="live-item purple">
        <img src="images/index/inventory.png" alt="Item">
    </div>
    <div class="live-item red">
        <img src="images/index/battles.png" alt="Item">
    </div>
    
    <!-- Set 2 -->
    <div class="live-item gold">
        <img src="images/index/crash.png" alt="Item">
    </div>
    <div class="live-item purple">
        <img src="images/index/dice.png" alt="Item">
    </div>
    <div class="live-item red">
        <img src="images/index/miner.png" alt="Item">
    </div>
    <div class="live-item gold">
        <img src="images/index/inventory.png" alt="Item">
    </div>
    <div class="live-item purple">
        <img src="images/index/battles.png" alt="Item">
    </div>
    <div class="live-item red">
        <img src="images/index/crash.png" alt="Item">
    </div>
    <div class="live-item gold">
        <img src="images/index/dice.png" alt="Item">
    </div>
    <div class="live-item purple">
        <img src="images/index/miner.png" alt="Item">
    </div>
    <div class="live-item red">
        <img src="images/index/roulette.png" alt="Item">
    </div>
    <div class="live-item gold">
        <img src="images/index/slots.png" alt="Item">
    </div>

    <!-- Set 3 -->
    <div class="live-item gold"><img src="images/index/inventory.png" alt="Item"></div>
    <div class="live-item purple"><img src="images/index/battles.png" alt="Item"></div>
    <div class="live-item red"><img src="images/index/crash.png" alt="Item"></div>
    <div class="live-item gold"><img src="images/index/dice.png" alt="Item"></div>
    <div class="live-item purple"><img src="images/index/miner.png" alt="Item"></div>
    <div class="live-item red"><img src="images/index/roulette.png" alt="Item"></div>
    <div class="live-item gold"><img src="images/index/slots.png" alt="Item"></div>
    <div class="live-item purple"><img src="images/index/inventory.png" alt="Item"></div>
    <div class="live-item red"><img src="images/index/battles.png" alt="Item"></div>
    <div class="live-item gold"><img src="images/index/crash.png" alt="Item"></div>
    <div class="live-item purple"><img src="images/index/dice.png" alt="Item"></div>
    <div class="live-item red"><img src="images/index/miner.png" alt="Item"></div>

    <!-- Set 4 -->
    <div class="live-item gold"><img src="images/index/inventory.png" alt="Item"></div>
    <div class="live-item purple"><img src="images/index/battles.png" alt="Item"></div>
    <div class="live-item red"><img src="images/index/crash.png" alt="Item"></div>
    <div class="live-item gold"><img src="images/index/dice.png" alt="Item"></div>
    <div class="live-item purple"><img src="images/index/miner.png" alt="Item"></div>
    <div class="live-item red"><img src="images/index/roulette.png" alt="Item"></div>
    <div class="live-item gold"><img src="images/index/slots.png" alt="Item"></div>
    <div class="live-item purple"><img src="images/index/inventory.png" alt="Item"></div>
    <div class="live-item red"><img src="images/index/battles.png" alt="Item"></div>
    <div class="live-item gold"><img src="images/index/crash.png" alt="Item"></div>
    <div class="live-item purple"><img src="images/index/dice.png" alt="Item"></div>
    <div class="live-item red"><img src="images/index/miner.png" alt="Item"></div>
  </div>
</div>

<!-- Header -->
<header class="header">
  <div class="header-left">
    <div class="logo" onclick="location.href='index.html'" style="cursor: pointer;">üíé DROP<span>WIN</span></div>
    <button class="hamburger" id="hamburgerBtn">
        <span class="bar"></span><span class="bar"></span><span class="bar"></span>
        <span class="nav-badge" id="menuBadge"></span>
    </button>
    <nav class="main-nav">
      <a href="inventory.html"><span class="nav-icon">üéí</span> –ò–ù–í–ï–ù–¢–ê–†–¨</a>
      <a href="leaderboard.html"><span class="nav-icon">üèÜ</span> –¢–û–ü –ò–ì–†–û–ö–û–í</a>
      <a href="raffles.html"><span class="nav-icon">üéÅ</span> –†–û–ó–´–ì–†–´–®–ò</a>
      <a href="freebet.html" class="nav-bonus-btn"><span class="nav-icon">‚ö°</span> –ë–û–ù–£–°–´</a>
      <a href="https://t.me/DropWinHelp_bot" target="_blank"><span class="nav-icon">üí¨</span> –ü–û–î–î–ï–†–ñ–ö–ê</a>
    </nav>
  </div>
  
  <div class="header-right">
    <div class="balance-box">
      <span id="balance">0</span> ‚ÇΩ
      <button class="add-funds-btn" onclick="location.href='dep.html'">+</button>
    </div>
    
    <!-- Notification Bell -->
    <button class="icon-btn" id="notifyBtn" style="background: rgba(255,255,255,0.1); border: none; width: 36px; height: 36px; border-radius: 10px; cursor: pointer; margin-right: 8px; position: relative; display: flex; align-items: center; justify-content: center; color: #cbd5e1;">
        üîî
        <span class="notify-badge" style="position: absolute; top: 8px; right: 8px; width: 6px; height: 6px; background: #ef4444; border-radius: 50%; display: block;"></span>
    </button>

    <!-- Notification Widget -->
    <div class="notification-widget" id="notificationWidget">
        <div class="notif-header">
            –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            <button onclick="clearNotifications()" style="background:none; border:none; color:var(--text-sec); cursor:pointer; font-size:0.8rem;">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div class="notif-list" id="notifList">
            <div style="text-align:center; padding:20px; color:var(--text-sec);">–ù–µ—Ç –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
        </div>
    </div>

    <!-- Auth Button / Profile -->
    <button class="btn" id="authBtn" style="width: auto; padding: 8px 16px; font-size: 0.9rem;">–í–æ–π—Ç–∏</button>
  </div>
</header>

<div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
<div class="mobile-drawer" id="mobileDrawer">
  <a href="#" onclick="toggleNotifications(); return false;"><span>üîî</span> –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</a>
  <a href="inventory.html"><span>üéí</span> –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</a>
  <a href="contracts.html"><span>üìú</span> –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã</a>
  <a href="leaderboard.html"><span>üèÜ</span> –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤</a>
  <a href="raffles.html"><span>üéÅ</span> –†–æ–∑—ã–≥—Ä—ã—à–∏</a>
  <a href="freebet.html"><span>‚ö°</span> –ë–æ–Ω—É—Å—ã</a>
  <a href="profile.html"><span>üë§</span> –ü—Ä–æ—Ñ–∏–ª—å</a>
  <a href="https://t.me/DropWinHelp_bot" target="_blank"><span>üí¨</span> –ü–æ–¥–¥–µ—Ä–∂–∫–∞</a>
</div>

<!-- Hero Section -->
<div class="hero">
  <div class="hero-slider-container">
    <div class="hero-slides" id="heroSlides">
        <!-- Slide 1: Calendar -->
        <div class="hero-slide active">
            <div class="hero-banner calendar-slide">
                <div class="slide-bg">
                   <img src="images/calendar.png" style="width: 100%; height: 100%; object-fit: cover; display: block; max-width: none;" onerror="this.src='images/case-bg.jpg'" alt="Calendar">
                   <div class="overlay"></div>
                </div>
                <div class="slide-content">
                    <div class="hero-title">–ü—Ä–∏–∑–æ–≤–æ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å</div>
                    <div class="hero-subtitle">–ó–∞—Ö–æ–¥–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –∏ –ø–æ–ª—É—á–∞–π –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –±–æ–Ω—É—Å—ã!</div>
                    <button class="hero-btn" onclick="location.href='calendar.html'">–ü–µ—Ä–µ–π—Ç–∏</button>
                </div>
            </div>
        </div>
        <!-- Slide 2: Dino Welcome -->
        <div class="hero-slide">
            <div class="hero-banner dino-slide" style="background: linear-gradient(to right, #2563eb, #1e40af);">
                <div class="slide-bg">
                    <img src="images/tg.png" style="width: 100%; height: 100%; object-fit: cover; display: block; max-width: none;" onerror="this.src='images/index/dino-throw.png'" alt="Telegram">
                    <div class="overlay" style="background: linear-gradient(to right, rgba(30, 64, 175, 0.9), transparent);"></div>
                </div>
                <div class="slide-content">
                    <div class="hero-title">–ó–∞—Ö–æ–¥–∏ –∏ –∑–∞–±–∏—Ä–∞–π!</div>
                    <div class="hero-subtitle">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –±–æ–Ω—É—Å—ã, —Å–∫–∏–¥–∫–∏ –∏ –ø—Ä–æ–º–æ–∫–æ–¥—ã —É–∂–µ –∂–¥—É—Ç —Ç–µ–±—è –≤ –Ω–∞—à–∏—Ö —Å–æ—Ü. —Å–µ—Ç—è—Ö</div>
                    <button class="hero-btn" onclick="window.open('https://t.me/Drop_Vins', '_blank')">–ó–∞–±—Ä–∞—Ç—å</button>
                </div>
            </div>
        </div>
        <!-- Slide 3: Battles -->
        <div class="hero-slide">
            <div class="hero-banner battles-slide">
                <div class="slide-bg">
                    <img src="images/battles2.png" style="width: 100%; height: 100%; object-fit: cover; display: block; max-width: none;" onerror="this.src='images/case-bg.jpg'" alt="Battles">
                    <div class="overlay"></div>
                </div>
                <div class="slide-content">
                    <div class="hero-title">–ë–∞—Ç—Ç–ª—ã –ö–µ–π—Å–æ–≤</div>
                    <div class="hero-subtitle">–°—Ä–∞–∂–∞–π—Å—è —Å –¥—Ä—É–≥–∏–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏ –∏ –∑–∞–±–∏—Ä–∞–π –≤–µ—Å—å –¥—Ä–æ–ø!</div>
                    <button class="hero-btn" onclick="location.href='games/battles.html'">–ò–≥—Ä–∞—Ç—å</button>
                </div>
            </div>
        </div>
    </div>
    <div class="slider-controls">
        <button class="slider-arrow prev" id="prevSlide">‚ùÆ</button>
        <button class="slider-arrow next" id="nextSlide">‚ùØ</button>
    </div>
    <div class="slider-dots" id="sliderDots"></div>
  </div>
  
  <div class="promo-grid">
    <div class="promo-card purple" onclick="location.href='games/battles.html'" style="background: radial-gradient(circle at top right, rgba(168,85,247,0.4), #2e1065);">
      <div class="promo-label" style="font-size: 1.1rem; color: #fff;">–ë–∞—Ç—Ç–ª—ã</div>
      <img src="images/battles3.png" class="promo-img" alt="Battles">
      <div class="arrow-btn" style="background: #a855f7;">‚ûú</div>
    </div>
    <div class="promo-card orange" onclick="location.href='games/roulette.html'" style="background: radial-gradient(circle at top right, rgba(251,191,36,0.4), #451a03);">
      <div class="promo-label" style="font-size: 1.1rem; color: #fff;">–ö–æ–ª–µ—Å–æ —É–¥–∞—á–∏</div>
      <img src="images/luckyspin.png" class="promo-img" alt="Lucky Spin" style="width: 200px;">
      <div class="arrow-btn" style="background: #fbbf24; color: black;">‚ûú</div>
    </div>

    <!-- Promo Banner (inside grid) -->
    <div class="promo-banner-card" style="grid-column: 1 / -1; background: linear-gradient(90deg, #b45309, #78350f); border-radius: 16px; padding: 16px; position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: center; min-height: 100px;">
       <img src="images/money.png" class="promo-banner-img" alt="Money">
       <div style="position: relative; z-index: 2;">
           <div style="font-weight: 800; font-size: 1rem; margin-bottom: 8px; color: white;">–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</div>
           <div style="display: flex; gap: 8px;">
               <input type="text" id="mainPromoInput" placeholder="PROMOCODE_DAY_670" style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.15); color: white; padding: 10px 14px; border-radius: 10px; flex: 1; font-weight: 600; font-size: 0.9rem;">
               <button onclick="redeemPromoFromMain()" style="background: rgba(255,255,255,0.15); border: none; width: 42px; border-radius: 10px; color: white; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;">‚ûú</button>
           </div>
       </div>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="content">
  <div class="section-header">
    <span class="section-icon">üéÆ</span>
    <div class="section-title">–í—Å–µ —Ä–µ–∂–∏–º—ã</div>
  </div>

  <div class="games-list">
    
    <div class="game-icon" onclick="location.href='games/battles.html'" style="grid-column: span 2; aspect-ratio: 1.8/1.3;">
      <div class="recommended-badge" style="z-index: 10; background: linear-gradient(135deg, #ef4444, #b91c1c); color: white; padding: 8px 16px; border-radius: 8px; position: absolute; top: 12px; right: 12px; font-size: 1rem; font-weight: 800; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.6); display: flex; align-items: center; gap: 6px;">üî• –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ</div>
      <div class="image-container"><img src="images/battles2.png" alt="–ë–∞—Ç—Ç–ª—ã"></div>
      <div class="game-icon-name" style="font-size: 1.2rem;">–ë–∞—Ç—Ç–ª—ã –ö–µ–π—Å–æ–≤</div>
    </div>

    <div class="game-icon" onclick="location.href='games/sport.html'">
      <div class="image-container"><img src="images/index/sports.png" alt="Sport"></div>
      <div class="game-icon-name">Sport</div>
    </div>

    <div class="game-icon" onclick="location.href='games/crismos-shoot.html'">
      <div class="image-container"><img src="images/index/christmas shoot.png" alt="Christmas Shoot"></div>
      <div class="game-icon-name">Christmas Shoot</div>
    </div>

    

    <div class="game-icon" onclick="location.href='games/slots.html'">
      <div class="image-container"><img src="images/index/slots.png" alt="Slots"></div>
      <div class="game-icon-name">Slots</div>
    </div>

    <div class="game-icon" onclick="location.href='games/miner.html'">
      <div class="image-container"><img src="images/index/miner.png" alt="Miner"></div>
      <div class="game-icon-name">Miner</div>
    </div>

 <div class="game-icon" onclick="location.href='games/Fortune.html'">
      <div class="image-container"><img class="contain" src="images/index/fortune.png" alt="Fortune"></div>
      <div class="game-icon-name">Fortune</div>
    </div>

    <div class="game-icon" onclick="location.href='games/roulette.html'">
      <div class="image-container"><img class="contain" src="images/index/roulette.png" alt="Roulette"></div>
      <div class="game-icon-name">Roulette</div>
    </div>

    <div class="game-icon" onclick="location.href='games/cards.html'">
      <div class="image-container"><img src="images/index/cards.png" alt="Cards"></div>
      <div class="game-icon-name">Cards</div>
    </div>

    <div class="game-icon" onclick="location.href='games/dice.html'">
      <div class="image-container"><img src="images/index/dice.png" alt="Dice"></div>
      <div class="game-icon-name">Dice</div>
    </div>

    <div class="game-icon" onclick="location.href='games/crash.html'">
      <div class="image-container"><img src="images/index/crash.png" alt="Crash"></div>
      <div class="game-icon-name">Crash</div>
    </div>

    <div class="game-icon" onclick="location.href='games/plinko.html'">
      <div class="image-container"><img src="images/index/plinko.png" alt="Plinko"></div>
      <div class="game-icon-name">Plinko</div>
    </div>

    <div class="game-icon" onclick="location.href='games/mines.html'">
      <div class="image-container"><img src="images/index/mines.png" alt="Mines"></div>
      <div class="game-icon-name">Mines</div>
    </div>

    <div class="game-icon" onclick="location.href='crypto.html'">
      <div class="image-container"><img src="images/index/crypto.png" alt="Crypto"></div>
      <div class="game-icon-name">Crypto</div>
    </div>

    <div class="game-icon" onclick="location.href='games/rooster-run.html'">
      <div class="image-container"><img src="images/index/rooster-run.png" alt="Chicken Road"></div>
      <div class="game-icon-name">Chicken Road</div>
    </div>

  </div>
</div>

<!-- Bottom Nav (Mobile) -->
<nav class="nav">
  <button class="nav-btn active">
    <span>üè†</span>
    –ì–ª–∞–≤–Ω–∞—è
  </button>
  <button class="nav-btn" onclick="location.href='leaderboard.html'">
    <span>üèÜ</span>
    –¢–æ–ø
  </button>
  <button class="nav-btn" onclick="location.href='inventory.html'">
    <span>üéí</span>
    –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å
  </button>
  <button class="nav-btn" onclick="location.href='profile.html'">
    <span>üë§</span>
    –ü—Ä–æ—Ñ–∏–ª—å
  </button>
</nav>

<!-- Footer -->
<footer style="background: #0f0b15; border-top: 1px solid rgba(255,255,255,0.05); padding: 40px 20px 100px 20px; margin-top: 60px;">
    <div style="max-width: 1200px; margin: 0 auto; text-align: center;">
        <div class="logo" style="justify-content: center; margin-bottom: 20px; opacity: 0.7;">üíé DROP<span>WIN</span></div>
        <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-bottom: 30px; font-size: 0.9rem; color: #94a3b8;">
            <a href="#">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ</a>
            <a href="#">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>
            <a href="#">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
            <a href="#">–ß–µ—Å—Ç–Ω–∞—è –∏–≥—Ä–∞</a>
        </div>
        <p style="color: #64748b; font-size: 0.8rem; line-height: 1.6; max-width: 600px; margin: 0 auto;">
            DropWin.gg &copy; 2026. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã. –°–∞–π—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–º –∞–∑–∞—Ä—Ç–Ω—ã—Ö –∏–≥—Ä. 
            –í—Å–µ –≤—ã–ø–∞–¥–∞—é—â–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã —è–≤–ª—è—é—Ç—Å—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º–∏ —Å–∫–∏–Ω–∞–º–∏ –∏ –Ω–µ –∏–º–µ—é—Ç —Ä–µ–∞–ª—å–Ω–æ–π –¥–µ–Ω–µ–∂–Ω–æ–π —Ü–µ–Ω–Ω–æ—Å—Ç–∏.
        </p>
    </div>
</footer>

<!-- Particles Background -->
<div class="particles" id="particles"></div>

<!-- Admin Chat Button & Widget -->
<div class="admin-chat-btn" id="adminChatBtn">
    <span style="font-size: 30px;">üí¨</span>
    <div class="badge"></div>
</div>

<div class="chat-widget" id="chatWidget">
    <div class="chat-header">
        <div class="chat-title">
            <span class="chat-status"></span>
            –ü–æ–¥–¥–µ—Ä–∂–∫–∞
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
             <button class="chat-suggestions-toggle" id="chatSuggestionsToggle" title="–°–≤–µ—Ä–Ω—É—Ç—å/–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –º–µ–Ω—é">‚ñº</button>
             <button class="chat-close" id="chatClose">‚úï</button>
        </div>
    </div>
    <div class="chat-user-list" id="chatUserList" style="display: none; flex: 1; overflow-y: auto; padding: 10px;"></div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-suggestions" id="chatSuggestions">
        <div class="chat-chip" data-question="–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –±–æ–Ω—É—Å?">–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –±–æ–Ω—É—Å?</div>
        <div class="chat-chip" data-question="–ö–∞–∫ –≤—ã–≤–µ—Å—Ç–∏ –¥–µ–Ω—å–≥–∏?">–ö–∞–∫ –≤—ã–≤–µ—Å—Ç–∏ –¥–µ–Ω—å–≥–∏?</div>
        <div class="chat-chip" data-question="–ù–µ –ø—Ä–∏—à–µ–ª –¥–µ–ø–æ–∑–∏—Ç">–ù–µ –ø—Ä–∏—à–µ–ª –¥–µ–ø–æ–∑–∏—Ç</div>
        <div class="chat-chip" data-question="–ü—Ä–æ–±–ª–µ–º–∞ —Å –∏–≥—Ä–æ–π">–ü—Ä–æ–±–ª–µ–º–∞ —Å –∏–≥—Ä–æ–π</div>
        <div class="chat-chip" data-question="–ü–æ–Ω—è–ª">–ü–æ–Ω—è–ª</div>
        <div class="chat-chip" data-question="resolved" style="background: rgba(34, 197, 94, 0.15); border-color: rgba(34, 197, 94, 0.3); color: #86efac;">‚úÖ –í–æ–ø—Ä–æ—Å —Ä–µ—à–µ–Ω</div>
        <div class="chat-chip" data-question="–°–≤—è–∑–∞—Ç—å—Å—è —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º" style="background: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.4); color: #fca5a5;">–°–≤—è–∑–∞—Ç—å—Å—è —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º</div>
    </div>
    <div class="chat-input-area" id="chatInputArea">
        <input type="text" class="chat-input" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
        <button class="chat-send" id="chatSend">‚ûú</button>
    </div>
</div>

<!-- Win Notification Popup -->
<div class="win-popup" id="winPopup">
    <div class="win-icon">üèÜ</div>
    <div class="win-title">–ü–û–ó–î–†–ê–í–õ–Ø–ï–ú!</div>
    <div class="win-desc" id="winDesc">–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ!</div>
    <button class="win-btn" onclick="document.getElementById('winPopup').classList.remove('active')">–ó–ê–ë–†–ê–¢–¨</button>
</div>

<script>
    // Legacy script removed. Chat logic moved to module script below.
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, collection, updateDoc, runTransaction, arrayUnion, increment, setDoc, onSnapshot, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  // INLINED shared_promo.js due to CORS on file://
  async function redeemPromoCode(db, userId, codeInput) {
      if (!userId) throw new Error('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç');
      
      const code = codeInput.trim();
      const promoRef = doc(db, 'promocodes', code);
      const userRef = doc(db, 'users', userId);

      return await runTransaction(db, async (transaction) => {
          const promoSnap = await transaction.get(promoRef);
          
          // 1. Check Firestore Promos
          if (promoSnap.exists()) {
              const promoData = promoSnap.data();
              
              if (promoData.activationsLeft <= 0) {
                  throw new Error('–ê–∫—Ç–∏–≤–∞—Ü–∏–∏ —ç—Ç–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å');
              }
              
              if (promoData.usersUsed && promoData.usersUsed.includes(userId)) {
                  throw new Error('–í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥');
              }

              // Apply Reward
              if (promoData.type === 'money') {
                  const userSnap = await transaction.get(userRef);
                  const userData = userSnap.data() || {};
                  const newBalance = (userData.balance || 0) + promoData.value;
                  
                  transaction.update(userRef, {
                      balance: newBalance
                  });
              } else if (promoData.type === 'dep' || promoData.type.startsWith('dep')) {
                  // Deposit bonus
                  transaction.update(userRef, {
                      activePromoCode: code,
                      activePromoType: promoData.type,
                      activePromoValue: promoData.value,
                      activePromoUsed: false
                  });
              }

              // Update Promo Stats
              transaction.update(promoRef, {
                  activationsLeft: increment(-1),
                  usersUsed: arrayUnion(userId)
              });
              
              return { success: true, value: promoData.value, type: promoData.type, message: `–ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω: +${promoData.value}${promoData.type === 'money' ? '‚ÇΩ' : '% –∫ –¥–µ–ø—É'}` };
          } 
          
          // 2. Check Global/Legacy Hardcoded Promos (Fallback)
          const userSnap = await transaction.get(userRef);
          const userData = userSnap.data() || {};
          
          const GLOBAL_PROMOS = {
              'PROMOCODE_DAY_670': { val: 50, type: 'money' },
              'WELCOME': { val: 100, type: 'money' },
              'DROPWIN2026': { val: 200, type: 'money' },
              'KAVEXS': { val: 1000, type: 'money' },
              'KAVEXS2026': { val: 5000, type: 'money' }
          };
          
          if (GLOBAL_PROMOS[code]) {
              const reward = GLOBAL_PROMOS[code];
              const used = userData.usedPromos || [];
              
              if (used.includes(code)) {
                  throw new Error('–í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥');
              }
              
              const newBalance = (userData.balance || 0) + reward.val;
              transaction.update(userRef, {
                  balance: newBalance,
                  usedPromos: arrayUnion(code)
              });
              
              return { success: true, value: reward.val, type: reward.type, message: `–ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω: +${reward.val}‚ÇΩ` };
          }

          // 3. Check Personal Active Promo
          if (userData.activePromoCode === code && !userData.activePromoUsed) {
               if (userData.activePromoType && userData.activePromoType.startsWith('bonus')) {
                   const val = userData.activePromoValue || 0;
                   transaction.update(userRef, {
                       balance: (userData.balance || 0) + val,
                       activePromoCode: null,
                       activePromoValue: 0,
                       activePromoUsed: true
                   });
                   return { success: true, value: val, type: 'money', message: `–ë–æ–Ω—É—Å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω: +${val}‚ÇΩ` };
               } else {
                   return { success: false, redirect: 'dep.html', message: '–≠—Ç–æ –±–æ–Ω—É—Å –∫ –¥–µ–ø–æ–∑–∏—Ç—É. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ...' };
               }
          }

          throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥');
      });
  }

  const firebaseConfig = {
    apiKey: "AIzaSyBVra2JN-C7-1b_Qa4cU8--XvJ83lymiM8",
    authDomain: "dropwin-8d94b.firebaseapp.com",
    projectId: "dropwin-8d94b",
    storageBucket: "dropwin-8d94b.firebasestorage.app",
    messagingSenderId: "988974289403",
    appId: "1:988974289403:web:886d34e6f65920a105fb5e",
    measurementId: "G-BK010MHN8N"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Hamburger Logic
  const hb = document.getElementById('hamburgerBtn');
  const overlay = document.getElementById('mobileMenuOverlay');
  const drawer = document.getElementById('mobileDrawer');
  
  function toggleDrawer() {
      document.body.classList.toggle('drawer-open');
      if(hb) hb.classList.toggle('active');
      
      const b = document.getElementById('menuBadge');
      if(b && document.body.classList.contains('drawer-open')) {
          b.classList.remove('active');
      }
  }
  
  if(hb) hb.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleDrawer();
  });
  
  if(overlay) overlay.addEventListener('click', toggleDrawer);
  
  // Close drawer when clicking links inside
  if(drawer) {
      drawer.querySelectorAll('a').forEach(link => {
          link.addEventListener('click', () => {
              if(document.body.classList.contains('drawer-open')) toggleDrawer();
          });
      });
  }

  window.toggleNotifications = function() {
      const widget = document.getElementById('notificationWidget');
      if(widget) {
          widget.classList.toggle('active');
          // Clear badge
          const b = document.getElementById('menuBadge');
          if(b) b.classList.remove('active');
      } else {
          showToast('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', '–ù–µ—Ç –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π');
      }
  };

  function showToast(title, msg) {
      const c = document.getElementById('toastContainer');
      if(!c) return;
      
      const b = document.getElementById('menuBadge');
      if(b) b.classList.add('active');

      const t = document.createElement('div');
      t.className = 'toast';
      t.innerHTML = `<div class="toast-icon">üéâ</div><div class="toast-content"><div class="toast-title">${title}</div><div class="toast-msg">${msg}</div></div>`;
      c.appendChild(t);
      setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 5000);
  }

  const RAFFLE_IDS = ['dragon_2024', 'grinch_heart', 'neo_prime_item', 'palace_milioner', 'ice_palace', 'island_maldives'];

  window.redeemPromoFromMain = async function() {
      const input = document.getElementById('mainPromoInput');
      const code = input.value.trim();
      if(!code) return showToast('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥');
      
      // Wait for currentUser to load if it's null
      let attempts = 0;
      while (!currentUser && attempts < 20) {
          await new Promise(resolve => setTimeout(resolve, 100));
          attempts++;
      }

      if(!currentUser) return showToast('–û—à–∏–±–∫–∞', '–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç');
      
      try {
          const result = await redeemPromoCode(db, currentUser.uid, code);
          if (result.success) {
              showToast('–£—Å–ø–µ—à–Ω–æ!', result.message);
              input.value = '';
              if (result.redirect) {
                  setTimeout(() => location.href = result.redirect, 1500);
              } else {
                  // Update local balance display if money
                  if (result.type === 'money') {
                      document.getElementById('balance').textContent = (currentUser.balance || 0) + result.value;
                      // Refresh user data in background
                      currentUser.balance = (currentUser.balance || 0) + result.value; 
                  }
              }
          }
      } catch (e) {
          showToast('–û—à–∏–±–∫–∞', e.message);
      }
  }

  async function checkWinners(uid) {
      const seen = JSON.parse(localStorage.getItem('seen_wins') || '[]');
      for (const id of RAFFLE_IDS) {
          try {
              const snap = await getDoc(doc(db, 'raffles', id));
              if (snap.exists()) {
                  const data = snap.data();
                  if (data.winners && data.winners.length > 0) {
                      const last = data.winners[data.winners.length - 1];
                      const winId = `${id}_${last.when}`;
                      // Check if win is recent (last 24h) and not seen
                      const isRecent = (Date.now() - last.when) < 86400000;
                      if (!last.isBot && last.userId === uid && !seen.includes(winId) && isRecent) {
                          showToast('–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!', `–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏: ${last.prizeName || '–ü—Ä–∏–∑'}!`);
                          seen.push(winId);
                          localStorage.setItem('seen_wins', JSON.stringify(seen));
                      }
                  }
              }
          } catch(e) { console.log('Check winner error', e); }
      }
  }

  function createParticles() {
    const container = document.getElementById('particles');
    for (let i = 0; i < 30; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      p.style.width = p.style.height = Math.random() * 3 + 1 + 'px';
      p.style.left = Math.random() * 100 + '%';
      p.style.animationDuration = Math.random() * 15 + 10 + 's';
      p.style.animationDelay = Math.random() * 5 + 's';
      container.appendChild(p);
    }
  }

  let currentUser = null;

  function loadCurrentUser() {
    onAuthStateChanged(auth, (user) => {
      if (user) {
        getDoc(doc(db, 'users', user.uid)).then((docSnap) => {
          if (docSnap.exists()) {
            currentUser = docSnap.data();
            currentUser.uid = user.uid; // Ensure uid is set
            document.getElementById('balance').textContent = currentUser.balance || 0;
            // Update Auth Button to show name or profile icon
            const authBtn = document.getElementById('authBtn');
            authBtn.textContent = currentUser.username || '–ü—Ä–æ—Ñ–∏–ª—å';
            authBtn.style.background = '#2a2a35'; // Darker for profile
            authBtn.onclick = () => location.href = 'profile.html';
            checkWinners(user.uid);
            setInterval(() => { if(currentUser) checkWinners(user.uid); }, 60000);
          } else {
            // No user doc
            resetAuthUI();
          }
        }).catch((error) => {
          console.error('Error loading user:', error);
          resetAuthUI();
        });
      } else {
        // Check local storage guest
        const username = localStorage.getItem('dropwin_current_username');
        if (username === '–ì–æ—Å—Ç—å') {
            const users = JSON.parse(localStorage.getItem('dropwin_users')) || [];
            currentUser = users.find(u => u.username === username);
            if (currentUser) {
                document.getElementById('balance').textContent = currentUser.balance || 0;
                const authBtn = document.getElementById('authBtn');
                authBtn.textContent = '–ì–æ—Å—Ç—å';
                authBtn.onclick = () => location.href = 'profile.html';
            } else {
                resetAuthUI();
            }
        } else {
            resetAuthUI();
        }
      }
    });
  }

  // Chat Logic
  function initChat() {
      const chatBtn = document.getElementById('adminChatBtn');
      const chatWidget = document.getElementById('chatWidget');
      const chatClose = document.getElementById('chatClose');
      const chatInput = document.getElementById('chatInput');
      const chatSend = document.getElementById('chatSend');
      const chatMessages = document.getElementById('chatMessages');
      const chatSuggestions = document.getElementById('chatSuggestions');
      const chatUserList = document.getElementById('chatUserList');
      const chatInputArea = document.getElementById('chatInputArea');
      const chatTitle = document.querySelector('.chat-title');
      
      const ADMIN_UID = 'fB5LvM4j5yVkcBE0c6eyvhV4WG02';
      let chatUnsub = null;
      let listUnsub = null;
      let activeChatUserId = null; // For admin: which user they are talking to

      if (!chatBtn || !chatWidget) return;

      // Toggle Chat
      chatBtn.addEventListener('click', () => {
          chatWidget.classList.add('active');
          chatBtn.style.display = 'none';
          // Clear badge
          const badge = chatBtn.querySelector('.badge');
          if(badge) badge.style.display = 'none';
          
          openChatInterface();
      });

      chatClose.addEventListener('click', () => {
          chatWidget.classList.remove('active');
          chatBtn.style.display = 'flex';
          cleanupListeners();
      });

      function cleanupListeners() {
          if(chatUnsub) { chatUnsub(); chatUnsub = null; }
          // Don't clean listUnsub if admin, so we can get notifications? 
          // For now clean all to save resources, but we might want background listener later.
          if(listUnsub) { listUnsub(); listUnsub = null; }
      }

      function openChatInterface() {
          cleanupListeners();
          
          if (!currentUser) {
              renderGuestView();
              return;
          }

          if (currentUser.uid === ADMIN_UID) {
              // Admin Mode
              renderAdminListView();
          } else {
              // User Mode
              renderUserChatView();
          }
      }

      // --- USER MODE ---
      function renderUserChatView() {
          chatUserList.style.display = 'none';
          chatMessages.style.display = 'flex';
          chatInputArea.style.display = 'flex';
          if(chatSuggestions) chatSuggestions.style.display = 'grid';
          chatTitle.innerHTML = '<span class="chat-status"></span>–ü–æ–¥–¥–µ—Ä–∂–∫–∞';

          loadChatMessages(currentUser.uid);
      }

      function renderGuestView() {
          chatUserList.style.display = 'none';
          chatMessages.style.display = 'flex';
          chatInputArea.style.display = 'flex';
          if(chatSuggestions) chatSuggestions.style.display = 'grid';
          chatMessages.innerHTML = '<div class="chat-msg bot"><div class="chat-msg-header">DropWin Bot</div>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã –Ω–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.</div>';
      }

      // --- ADMIN MODE ---
      function renderAdminListView() {
          chatUserList.style.display = 'block';
          chatMessages.style.display = 'none';
          chatInputArea.style.display = 'none';
          if(chatSuggestions) chatSuggestions.style.display = 'none';
          chatTitle.innerHTML = '–ß–∞—Ç—ã <span style="font-size:0.8rem; opacity:0.7; margin-left:8px;">(–ê–¥–º–∏–Ω)</span>';
          activeChatUserId = null;

          const q = query(collection(db, 'support_chats'), orderBy('lastUpdated', 'desc'));
          listUnsub = onSnapshot(q, (snapshot) => {
              chatUserList.innerHTML = '';
              if (snapshot.empty) {
                  chatUserList.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</div>';
                  return;
              }

              snapshot.forEach(doc => {
                  const data = doc.data();
                  if (data.status === 'archived') return; // Skip archived

                  const item = document.createElement('div');
                  item.className = 'chat-list-item';
                  item.style.padding = '12px';
                  item.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                  item.style.cursor = 'pointer';
                  item.style.display = 'flex';
                  item.style.justifyContent = 'space-between';
                  item.style.alignItems = 'center';
                  
                  // Check unread
                  const isUnread = data.lastSender === 'user';
                  const bg = isUnread ? 'rgba(124, 58, 237, 0.1)' : 'transparent';
                  item.style.background = bg;

                  const lastMsg = data.messages && data.messages.length > 0 ? data.messages[data.messages.length - 1].text : '';
                  const shortMsg = lastMsg.length > 30 ? lastMsg.substring(0, 30) + '...' : lastMsg;

                  item.innerHTML = `
                      <div style="flex:1;" onclick="window.openAdminChat('${doc.id}', '${data.username || 'User'}')">
                          <div style="font-weight:700; color:${isUnread ? '#a78bfa' : '#e2e8f0'}">${data.username || 'User'} ${isUnread ? '‚óè' : ''}</div>
                          <div style="font-size:0.8rem; color:#94a3b8;">${shortMsg}</div>
                      </div>
                      <button onclick="window.archiveChat('${doc.id}')" style="background:none; border:none; color:#64748b; cursor:pointer; font-size:1.2rem; padding:8px;">‚úï</button>
                  `;
                  chatUserList.appendChild(item);
              });
          });
      }

      // Exposed global functions for Admin click handlers
      window.openAdminChat = function(userId, username) {
          activeChatUserId = userId;
          chatUserList.style.display = 'none';
          chatMessages.style.display = 'flex';
          chatInputArea.style.display = 'flex';
          chatTitle.innerHTML = `<button onclick="window.backToAdminList()" style="background:none; border:none; color:white; font-size:1.2rem; margin-right:8px; cursor:pointer;">‚ùÆ</button> ${username}`;
          
          loadChatMessages(userId);
      };

      window.backToAdminList = function() {
          if(chatUnsub) chatUnsub();
          renderAdminListView();
      };

      window.archiveChat = async function(userId) {
          if(!confirm('–°–∫—Ä—ã—Ç—å —ç—Ç–æ—Ç —á–∞—Ç?')) return;
          try {
              await updateDoc(doc(db, 'support_chats', userId), {
                  status: 'archived'
              });
          } catch(e) { console.error(e); }
      };


      // --- SHARED CHAT LOGIC ---
      function playNotificationSound() {
          try {
              const AudioContext = window.AudioContext || window.webkitAudioContext;
              if (!AudioContext) return;
              const ctx = new AudioContext();
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              osc.type = 'sine';
              osc.frequency.setValueAtTime(440, ctx.currentTime);
              osc.frequency.exponentialRampToValueAtTime(880, ctx.currentTime + 0.1);
              gain.gain.setValueAtTime(0.05, ctx.currentTime);
              gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
              osc.connect(gain);
              gain.connect(ctx.destination);
              osc.start();
              osc.stop(ctx.currentTime + 0.35);
          } catch (e) { console.error(e); }
      }

      let lastMsgCount = -1;

      function loadChatMessages(userId) {
          if(chatUnsub) chatUnsub();
          
          const chatRef = doc(db, 'support_chats', userId);
          chatUnsub = onSnapshot(chatRef, (docSnap) => {
              if (docSnap.exists()) {
                  const data = docSnap.data();
                  const msgs = data.messages || [];
                  renderMessages(msgs);
                  
                  // Notification Logic (Only for User)
                  if (currentUser && currentUser.uid !== ADMIN_UID) {
                      if (lastMsgCount !== -1 && msgs.length > lastMsgCount) {
                          const lastMsg = msgs[msgs.length - 1];
                          // Notify if sender is admin or bot
                          if (lastMsg.sender === 'admin' || lastMsg.sender === 'bot') {
                              playNotificationSound();
                              if (!chatWidget.classList.contains('active')) {
                                  const badge = document.querySelector('.admin-chat-btn .badge');
                                  if(badge) badge.style.display = 'block';
                              }
                          }
                      }
                      lastMsgCount = msgs.length;
                  }

              } else {
                  renderMessages([]);
                  if (userId === currentUser.uid) {
                      sendMessageToFirestore('–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?', 'bot', userId);
                  }
              }
          });
      }

      function renderMessages(msgs) {
          chatMessages.innerHTML = '';
          msgs.forEach(msg => {
              const msgDiv = document.createElement('div');
              msgDiv.className = `chat-msg ${msg.sender}`;
              // Map sender to display name
              let name = 'User';
              if (msg.sender === 'user') name = '–í—ã';
              if (msg.sender === 'admin') name = 'Admin';
              if (msg.sender === 'bot') name = 'Bot';

              // Adjust for Admin view
              if (currentUser && currentUser.uid === ADMIN_UID) {
                  if (msg.sender === 'user') name = 'User';
                  if (msg.sender === 'admin') name = '–í—ã';
              }

              const header = document.createElement('div');
              header.className = 'chat-msg-header';
              header.textContent = name;
              
              msgDiv.appendChild(header);
              // Safe text rendering to prevent XSS
              const textNode = document.createTextNode(msg.text);
              msgDiv.appendChild(textNode);

              chatMessages.appendChild(msgDiv);
          });
          chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      async function handleSend() {
          const text = chatInput.value.trim();
          if (!text) return;
          
          if (!currentUser) {
              showToast('–û—à–∏–±–∫–∞', '–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç');
              return;
          }

          chatInput.value = ''; // Clear early

          // Determine target and sender
          let targetId = currentUser.uid;
          let senderRole = 'user';

          if (currentUser.uid === ADMIN_UID) {
              if (!activeChatUserId) return;
              targetId = activeChatUserId;
              senderRole = 'admin';
          }

          await sendMessageToFirestore(text, senderRole, targetId);

          if (senderRole === 'user') {
              checkForBotReply(text, targetId);
          }
      }

      chatSend.addEventListener('click', handleSend);
      chatInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') handleSend();
      });

      const chatSuggestionsToggle = document.getElementById('chatSuggestionsToggle');
      if (chatSuggestionsToggle) {
          chatSuggestionsToggle.addEventListener('click', () => {
              if (!chatSuggestions) return;
              const isHidden = chatSuggestions.style.display === 'none';
              chatSuggestions.style.display = isHidden ? 'grid' : 'none';
              chatSuggestionsToggle.textContent = isHidden ? '‚ñº' : '‚ñ≤';
          });
      }

      // Suggestions / Chips (Only for User)
      if (chatSuggestions) {
          chatSuggestions.querySelectorAll('.chat-chip').forEach(chip => {
              chip.addEventListener('click', () => {
                  const text = chip.getAttribute('data-question') || chip.textContent;
                  if (text === 'resolved') {
                      sendMessageToFirestore('‚úÖ –í–æ–ø—Ä–æ—Å —Ä–µ—à–µ–Ω. –°–ø–∞—Å–∏–±–æ!', 'user', currentUser.uid);
                      // Optional: archive chat or set status resolved
                  } else {
                      chatInput.value = text;
                      handleSend();
                  }
              });
          });
      }

      async function sendMessageToFirestore(text, sender, targetUid) {
          const chatRef = doc(db, 'support_chats', targetUid);
          const msg = {
              text,
              sender,
              timestamp: Date.now()
          };
          
          const updateData = {
              messages: arrayUnion(msg),
              lastUpdated: Date.now(),
              lastSender: sender,
              status: 'active' // Re-activate if archived
          };

          // If user is sending, ensure username is set
          if (sender === 'user' && currentUser) {
              updateData.userId = currentUser.uid;
              updateData.username = currentUser.username || 'User';
          }

          try {
              await setDoc(chatRef, updateData, { merge: true });
          } catch (e) {
              console.error('Chat error:', e);
              showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
          }
      }

      function checkForBotReply(userText, targetUid) {
          const lower = userText.toLowerCase();
          let reply = '';

          if (lower.includes('–±–æ–Ω—É—Å') || lower.includes('–ø—Ä–æ–º–æ–∫–æ–¥')) {
              reply = '–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –±–æ–Ω—É—Å—ã –∏ –ø—Ä–æ–º–æ–∫–æ–¥—ã –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤ –Ω–∞—à–µ–º Telegram –∫–∞–Ω–∞–ª–µ @Drop_Vins –∏–ª–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ "–ë–æ–Ω—É—Å—ã".';
          } else if (lower.includes('–≤—ã–≤–æ–¥') || lower.includes('–≤—ã–≤–µ—Å—Ç–∏')) {
              reply = '–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ –æ–±—ã—á–Ω–æ –∑–∞–Ω–∏–º–∞–µ—Ç –æ—Ç 5 –º–∏–Ω—É—Ç –¥–æ 24 —á–∞—Å–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ.';
          } else if (lower.includes('–¥–µ–ø–æ–∑–∏—Ç') || lower.includes('–ø–æ–ø–æ–ª–Ω')) {
              reply = '–ï—Å–ª–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞ –Ω–µ –ø–æ—Å—Ç—É–ø–∏–ª–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —á–µ–∫–∞ –∏ ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å—é–¥–∞.';
          } else if (lower.includes('–ø–æ–Ω—è–ª') || lower.includes('—Å–ø–∞—Å–∏–±–æ')) {
              reply = '–†–∞–¥ –ø–æ–º–æ—á—å! –ï—Å–ª–∏ –±—É–¥—É—Ç –µ—â–µ –≤–æ–ø—Ä–æ—Å—ã ‚Äî –ø–∏—à–∏—Ç–µ.';
          } else if (lower.includes('–æ–ø–µ—Ä–∞—Ç–æ—Ä') || lower.includes('–∞–¥–º–∏–Ω')) {
             // Just let it be, admin will see it in list
          }

          if (reply) {
              setTimeout(() => {
                  sendMessageToFirestore(reply, 'bot', targetUid);
              }, 1000);
          }
      }
      
      // Background Listener for Admin Notifications (Simple version)
       if (currentUser && currentUser.uid === ADMIN_UID) {
            const q = query(collection(db, 'support_chats'), orderBy('lastUpdated', 'desc'));
            onSnapshot(q, (snapshot) => {
                let unreadCount = 0;
                snapshot.forEach(doc => {
                    const d = doc.data();
                    if(d.status !== 'archived' && d.lastSender === 'user') unreadCount++;
                });
                
                const badge = document.querySelector('.admin-chat-btn .badge');
                if(badge) {
                    badge.style.display = unreadCount > 0 ? 'block' : 'none';
                }
            });
       }
  }

  function resetAuthUI() {
    document.getElementById('balance').textContent = '0';
    const authBtn = document.getElementById('authBtn');
    authBtn.textContent = '–í–æ–π—Ç–∏';
    authBtn.style.background = ''; // Reset to gradient
    authBtn.onclick = () => location.href = 'register.html';
  }

  // Notification Logic
  function initNotifications() {
      const notifyBtn = document.getElementById('notifyBtn');
      const widget = document.getElementById('notificationWidget');
      const list = document.getElementById('notifList');
      const badge = notifyBtn ? notifyBtn.querySelector('.notify-badge') : null;
      
      // 1. Toggle Widget
      if (notifyBtn && widget) {
          notifyBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              widget.classList.toggle('active');
              if (widget.classList.contains('active')) {
                  markAllAsRead();
              }
          });

          // Close when clicking outside
          document.addEventListener('click', (e) => {
              if (widget.classList.contains('active') && !widget.contains(e.target) && !notifyBtn.contains(e.target)) {
                  widget.classList.remove('active');
              }
          });
      }

      window.clearNotifications = function() {
          localStorage.setItem('notifications_cleared_ts', Date.now());
          renderNotifications([]); // Clear UI
          updateBadge(0);
      };

      // 2. Listen for System Broadcasts
      try {
          // REMOVED orderBy/limit to avoid "Missing Index" errors on client
          const sysQ = query(collection(db, 'system_notifications'));
          onSnapshot(sysQ, (snapshot) => {
              snapshot.docChanges().forEach(change => {
                  if (change.type === 'added') {
                      const data = change.doc.data();
                      // Ensure clearedTs is treated as a number
                      const clearedTs = Number(localStorage.getItem('notifications_cleared_ts') || 0);
                      
                      // Check if valid timestamp
                      if (data.timestamp && data.timestamp > clearedTs) {
                          addLocalNotification({
                              id: change.doc.id,
                              text: data.text,
                              time: data.timestamp,
                              read: false,
                              type: 'system',
                              isHighlighted: data.isHighlighted || false
                          });
                      }
                  }
              });
          });
      } catch (e) { console.log('Notif init error', e); }

      loadLocalNotifications();
  }

  function addLocalNotification(notif) {
      let existing = JSON.parse(localStorage.getItem('my_notifications') || '[]');
      
      // Dedupe
      if (existing.find(n => n.id === notif.id)) return;
      
      existing.push(notif);
      
      // Sort by time DESC
      existing.sort((a, b) => b.time - a.time);
      
      // Limit
      if (existing.length > 20) existing = existing.slice(0, 20);
      
      localStorage.setItem('my_notifications', JSON.stringify(existing));
      renderNotifications(existing);
      
      const unread = existing.filter(n => !n.read).length;
      updateBadge(unread);
      
      // Toast if new and recent (within 5 mins)
      if (!notif.read && (Date.now() - notif.time < 300000)) {
           showToast('üì¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ', notif.text);
      }
  }

  function loadLocalNotifications() {
      let existing = JSON.parse(localStorage.getItem('my_notifications') || '[]');
      // Sort on load too
      existing.sort((a, b) => b.time - a.time);
      
      const clearedTs = Number(localStorage.getItem('notifications_cleared_ts') || 0);
      const filtered = existing.filter(n => n.time > clearedTs);
      
      renderNotifications(filtered);
      const unread = filtered.filter(n => !n.read).length;
      updateBadge(unread);
  }

  function markAllAsRead() {
      const existing = JSON.parse(localStorage.getItem('my_notifications') || '[]');
      let changed = false;
      existing.forEach(n => {
          if(!n.read) {
              n.read = true;
              changed = true;
          }
      });
      if(changed) {
          localStorage.setItem('my_notifications', JSON.stringify(existing));
          renderNotifications(existing);
          updateBadge(0);
      }
  }

  function updateBadge(count) {
      const badge = document.querySelector('#notifyBtn .notify-badge');
      if (badge) {
          badge.style.display = count > 0 ? 'block' : 'none';
      }
  }

  function renderNotifications(list) {
      const container = document.getElementById('notifList');
      if (!container) return;
      
      if (list.length === 0) {
          container.innerHTML = `
            <div style="text-align:center; padding:40px 20px; color:var(--text-sec); display:flex; flex-direction:column; align-items:center; gap:12px;">
                <div style="font-size:2.5rem; opacity:0.2;">üîï</div>
                <div style="font-weight:600;">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ—Ç</div>
                <div style="font-size:0.8rem; opacity:0.6;">–ó–¥–µ—Å—å –±—É–¥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è –≤–∞–∂–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</div>
            </div>`;
          return;
      }
      
      container.innerHTML = '';
      list.forEach(n => {
          const div = document.createElement('div');
          div.className = `notif-item ${n.read ? '' : 'unread'}`;
          
          if (n.isHighlighted) {
              div.style.border = '1px solid #fbbf24';
              div.style.background = 'rgba(251, 191, 36, 0.1)';
              div.style.boxShadow = '0 0 10px rgba(251, 191, 36, 0.2)';
          }
          
          const date = new Date(n.time);
          const timeStr = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
          
          let icon = 'üîî';
          if(n.type === 'system' || n.type === 'broadcast') icon = 'üì¢';
          if(n.type === 'chat') icon = 'üí¨';

          div.innerHTML = `
              <div style="display:flex; gap:12px; align-items:flex-start;">
                  <div style="font-size:1.2rem; margin-top:2px;">${icon}</div>
                  <div style="flex:1;">
                      <div style="line-height:1.4; margin-bottom:4px;">${n.text}</div>
                      <div class="notif-time">${timeStr}</div>
                  </div>
              </div>
          `;
          container.appendChild(div);
      });
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadCurrentUser();
    createParticles();
    initSlider();
    initChat();
    initNotifications();
  });

  function initSlider() {
      const slidesContainer = document.getElementById('heroSlides');
      const slides = document.querySelectorAll('.hero-slide');
      const dotsContainer = document.getElementById('sliderDots');
      const prevBtn = document.getElementById('prevSlide');
      const nextBtn = document.getElementById('nextSlide');
      
      if (!slidesContainer || slides.length === 0) return;

      let currentSlide = 0;
      const totalSlides = slides.length;

      // Create dots
      slides.forEach((_, i) => {
          const dot = document.createElement('div');
          dot.className = `dot ${i === 0 ? 'active' : ''}`;
          dot.onclick = () => goToSlide(i);
          dotsContainer.appendChild(dot);
      });

      const dots = document.querySelectorAll('.dot');

      function updateSlider() {
          slidesContainer.style.transform = `translateX(-${currentSlide * 100}%)`;
          dots.forEach((dot, i) => {
              dot.classList.toggle('active', i === currentSlide);
          });
      }

      function goToSlide(n) {
          currentSlide = (n + totalSlides) % totalSlides;
          updateSlider();
      }

      prevBtn.addEventListener('click', () => goToSlide(currentSlide - 1));
      nextBtn.addEventListener('click', () => goToSlide(currentSlide + 1));

      // Optional: Auto-slide every 5s
      setInterval(() => goToSlide(currentSlide + 1), 5000);
  }

</script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('img').forEach((img) => {
      if (!img.hasAttribute('loading')) img.setAttribute('loading', 'lazy');
      img.setAttribute('decoding', 'async');
      const src = img.getAttribute('src');
      if (src && /\.(png|jpe?g)$/i.test(src)) {
        const webp = src.replace(/\.(png|jpe?g)$/i, '.webp');
        const tester = new Image();
        tester.onload = () => { img.src = webp; };
        tester.src = webp;
      }
    });
  });
</script>
</body>
</html>
