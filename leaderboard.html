<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>–õ–∏–¥–µ—Ä–±–æ—Ä–¥ | DropWin</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .leaderboard-tabs {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 12px;
            padding: 15px 20px;
            margin: 0 -20px;
            /* width: calc(100% + 40px); Removed to let flex container size naturally with margins */
            touch-action: pan-x;
            -webkit-overflow-scrolling: touch;
            /* scrollbar-width: none;  Removed to show scrollbar if needed */
        }
        /* .leaderboard-tabs::-webkit-scrollbar { display: none; } Removed to allow scrollbar visibility */
        
        .leaderboard-tabs::-webkit-scrollbar {
            height: 4px; /* Thin scrollbar */
        }
        .leaderboard-tabs::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.3);
            border-radius: 4px;
        }

        .leaderboard-tabs::after {
            content: '';
            min-width: 20px; 
            height: 1px;
            display: block;
            flex-shrink: 0;
        }

        .tab-btn {
            background: rgba(30, 27, 71, 0.6);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            padding: 10px 20px;
            color: #94a3b8;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
            color: white;
            border-color: #a78bfa;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .stats-summary {
            background: linear-gradient(135deg, #1e1b4b, #312e81);
            border: 1px solid #4f46e5;
            border-radius: 16px;
            padding: 16px;
            margin: 16px 0;
            text-align: center;
            display: none; /* Hidden by default, shown via JS */
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .stats-label { font-size: 0.9rem; color: #a5b4fc; margin-bottom: 4px; }
        .stats-value { font-size: 1.8rem; font-weight: 800; color: #fff; text-shadow: 0 0 15px rgba(99, 102, 241, 0.5); }

        .leaderboard-list {
            display: none;
            flex-direction: column;
            gap: 12px;
            margin-top: 10px;
        }
        .leaderboard-list.active {
            display: flex;
        }

        .leader-card {
            background: rgba(30, 27, 71, 0.7);
            border-radius: 16px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: transform 0.2s;
        }
        
        .leader-card.is-me {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid #10b981;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
        }
        
        .leader-card:hover {
            transform: translateX(4px);
            background: rgba(30, 27, 71, 0.9);
            border-color: rgba(139, 92, 246, 0.3);
        }
        
        .leader-card.is-me:hover {
            background: rgba(16, 185, 129, 0.25);
            border-color: #34d399;
        }

        .rank-badge {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .rank-1 { background: linear-gradient(135deg, #fbbf24, #d97706); color: #78350f; box-shadow: 0 0 15px rgba(251, 191, 36, 0.4); }
        .rank-2 { background: linear-gradient(135deg, #94a3b8, #64748b); color: #1e293b; box-shadow: 0 0 15px rgba(148, 163, 184, 0.4); }
        .rank-3 { background: linear-gradient(135deg, #b45309, #78350f); color: #fff; box-shadow: 0 0 15px rgba(180, 83, 9, 0.4); }
        .rank-other { background: rgba(255, 255, 255, 0.1); color: #94a3b8; }

        .leader-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            border: 2px solid rgba(139, 92, 246, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.06);
            cursor: pointer;
        }
        .leader-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .leader-avatar .placeholder {
            font-weight: 800;
            color: #a5b4fc;
        }

        .user-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
            overflow: hidden;
        }

        .user-name {
            font-weight: 700;
            color: white;
            font-size: 1.05rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .is-me .user-name {
            color: #34d399; /* Green for current user */
        }

        .user-value {
            color: #34d399;
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .category-icon {
            font-size: 1.5rem;
            opacity: 0.8;
        }
        
        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>

    <div class="header">
        <div class="logo" onclick="location.href='index.html'" style="cursor: pointer;">üíé DROPWIN</div>
        <div class="balance-container">
            <div class="balance">üí∞ <span id="balance">0</span>‚ÇΩ</div>
            <button class="auth-btn" id="authBtn">–ê–∫–∫–∞—É–Ω—Ç</button>
        </div>
    </div>

    <div class="content">
        <h2 class="section-title" style="text-align: center; margin-bottom: 20px;">üèÜ –¢–æ–ø –ò–≥—Ä–æ–∫–æ–≤</h2>

        <div class="leaderboard-tabs">
            <div class="tab-btn active" onclick="switchTab('balance', this)">üí∞ –ë–∞–ª–∞–Ω—Å</div>
            <div class="tab-btn" onclick="switchTab('crypto', this)">üìà –ö—Ä–∏–ø—Ç–∞</div>
            <div class="tab-btn" onclick="switchTab('items', this)">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
            <div class="tab-btn" onclick="switchTab('deposits', this)">üí≥ –î–µ–ø–æ–∑–∏—Ç—ã</div>
            <div class="tab-btn" onclick="switchTab('withdrawals', this)">üí∏ –í—ã–≤–æ–¥—ã</div>
        </div>

        <div id="statsSummary" class="stats-summary">
            <div class="stats-label" id="statsLabel">–û–±—â–∞—è —Å—É–º–º–∞</div>
            <div class="stats-value" id="statsValue">0 ‚ÇΩ</div>
        </div>

        <div id="loading" class="loading-spinner">
            –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö... ‚è≥
        </div>

        <div id="list-balance" class="leaderboard-list active"></div>
        <div id="list-crypto" class="leaderboard-list"></div>
        <div id="list-items" class="leaderboard-list"></div>
        <div id="list-deposits" class="leaderboard-list"></div>
        <div id="list-withdrawals" class="leaderboard-list"></div>
    </div>

    <div class="nav">
        <button class="nav-btn" onclick="location.href='index.html'"><span>üè†</span><span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span></button>
        <button class="nav-btn active" onclick="location.href='leaderboard.html'"><span>üèÜ</span><span class="nav-label">–¢–æ–ø</span></button>
        <button class="nav-btn" onclick="location.href='profile.html'"><span>üë§</span><span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span></button>
        <button class="nav-btn" onclick="location.href='register.html'"><span>üîë</span><span class="nav-label">–í—Ö–æ–¥</span></button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBVra2JN-C7-1b_Qa4cU8--XvJ83lymiM8",
            authDomain: "dropwin-8d94b.firebaseapp.com",
            projectId: "dropwin-8d94b",
            storageBucket: "dropwin-8d94b.firebasestorage.app",
            messagingSenderId: "988974289403",
            appId: "1:988974289403:web:886d34e6f65920a105fb5e",
            measurementId: "G-BK010MHN8N"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;

        // Particles
        function createParticles() {
            const container = document.getElementById('particles');
            if (!container) return;
            for (let i = 0; i < 40; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.width = p.style.height = Math.random() * 3 + 1 + 'px';
                p.style.left = Math.random() * 100 + '%';
                p.style.animationDuration = Math.random() * 15 + 10 + 's';
                p.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(p);
            }
        }

        // Tab Switching
        window.switchTab = (tabName, btnElement) => {
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            // If called from onclick, use event.target or passed element
            if (btnElement) {
                btnElement.classList.add('active');
            } else {
                const buttons = document.querySelectorAll('.tab-btn');
                for(let btn of buttons) {
                    const onclickAttr = btn.getAttribute('onclick');
                    if(onclickAttr && onclickAttr.includes(`'${tabName}'`)) {
                        btn.classList.add('active');
                        break;
                    }
                }
            }
            
            // Update lists
            document.querySelectorAll('.leaderboard-list').forEach(list => list.classList.remove('active'));
            const list = document.getElementById(`list-${tabName}`);
            if(list) list.classList.add('active');

            // Show Summary for ALL tabs
            const summaryBox = document.getElementById('statsSummary');
            if(summaryBox) summaryBox.style.display = 'block';

            let label = '–û–±—â–∞—è —Å—É–º–º–∞';
            let value = 0;

            switch(tabName) {
                case 'balance':
                    label = '–û–±—â–∏–π –±–∞–ª–∞–Ω—Å –¢–æ–ø-5';
                    value = window.totalBalance || 0;
                    break;
                case 'crypto':
                    label = '–û–±—â–∞—è –∫—Ä–∏–ø—Ç–∞ –¢–æ–ø-5';
                    value = window.totalCrypto || 0;
                    break;
                case 'items':
                    label = '–û–±—â–∏–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –¢–æ–ø-5';
                    value = window.totalItems || 0;
                    break;
                case 'deposits':
                    label = '–í—Å–µ –¥–µ–ø–æ–∑–∏—Ç—ã –¢–æ–ø-5 (–∑–∞ –≤—Å—ë –≤—Ä–µ–º—è)';
                    value = window.totalDeposits || 0;
                    break;
                case 'withdrawals':
                    label = '–í—Å–µ –≤—ã–≤–æ–¥—ã –¢–æ–ø-5 (–∑–∞ –≤—Å—ë –≤—Ä–µ–º—è)';
                    value = window.totalWithdrawals || 0;
                    break;
            }

            if(document.getElementById('statsLabel')) document.getElementById('statsLabel').textContent = label;
            if(document.getElementById('statsValue')) document.getElementById('statsValue').textContent = value.toLocaleString() + ' ‚ÇΩ';
        };

        async function fetchCryptoPrices() {
            const prices = {};
            try {
                const snap = await getDocs(collection(db, 'cryptoPrices'));
                snap.forEach(doc => {
                    prices[doc.id] = doc.data().price || 0;
                });
            } catch (e) {
                console.error("Error fetching crypto prices:", e);
            }
            return prices;
        }

        async function loadLeaderboard() {
            try {
                // Ensure current user is loaded first
                if (!currentUser && auth.currentUser) {
                     const userSnap = await getDoc(doc(db, 'users', auth.currentUser.uid));
                     if (userSnap.exists()) currentUser = userSnap.data();
                }

                const [usersSnap, cryptoPrices] = await Promise.all([
                    getDocs(collection(db, 'users')),
                    fetchCryptoPrices()
                ]);

                const users = [];
                usersSnap.forEach(docSnap => { // Changed param name to avoid conflict with function arg 'doc'
                    const data = docSnap.data();
                    // Basic user object
                    const user = {
                        id: docSnap.id, // Correct ID
                        username: data.username || '–ê–Ω–æ–Ω–∏–º',
                        balance: data.balance || 0,
                        inventoryValue: 0,
                        cryptoValue: 0,
                        depositValue: 0,
                        withdrawalValue: 0,
                        avatarUrl: data.avatarUrl || null,
                        avatarUpdatedAt: data.avatarUpdatedAt || null
                    };

                    // Calculate Inventory
                    if (data.inventory && Array.isArray(data.inventory)) {
                        user.inventoryValue = data.inventory.reduce((sum, item) => sum + (Number(item.value) || 0), 0);
                    }

                    // Calculate Crypto
                    if (data.cryptoPortfolio) {
                        for (const [coinId, info] of Object.entries(data.cryptoPortfolio)) {
                            const price = cryptoPrices[coinId] || 0;
                            user.cryptoValue += (info.amount || 0) * price;
                        }
                    }

                    // Calculate Deposits & Withdrawals from transactions (TOTAL ALL TIME)
                    if (data.cryptoTransactions && Array.isArray(data.cryptoTransactions)) {
                        user.depositValue = data.cryptoTransactions
                            .filter(t => t.type === 'deposit')
                            .reduce((sum, t) => sum + (Number(t.amount) || 0), 0);
                            
                        user.withdrawalValue = data.cryptoTransactions
                            .filter(t => t.type === 'withdraw' || t.kind === 'withdraw') // Check both types just in case
                            .reduce((sum, t) => sum + (Number(t.amount) || 0), 0);
                    }

                    users.push(user);
                });

                // Render Top 5 for each category and save totals
                window.totalBalance = renderTop5(users, 'balance', 'balance', '‚ÇΩ');
                window.totalCrypto = renderTop5(users, 'crypto', 'cryptoValue', '‚ÇΩ');
                window.totalItems = renderTop5(users, 'items', 'inventoryValue', '‚ÇΩ');
                window.totalDeposits = renderTop5(users, 'deposits', 'depositValue', '‚ÇΩ');
                window.totalWithdrawals = renderTop5(users, 'withdrawals', 'withdrawalValue', '‚ÇΩ');

                // Initialize default summary (Balance)
                switchTab('balance');

                document.getElementById('loading').style.display = 'none';

            } catch (error) {
                console.error("Error loading leaderboard:", error);
                document.getElementById('loading').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö üòï';
            }
        }

        function renderTop5(users, listId, sortField, suffix) {
            const container = document.getElementById(`list-${listId}`);
            if (!container) return 0; // Guard clause
            
            container.innerHTML = '';

            const top5 = users
                .sort((a, b) => b[sortField] - a[sortField])
                .slice(0, 5);

            if (top5.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#94a3b8;">–ü—É—Å—Ç–æ...</div>';
                return 0;
            }

            let totalSum = 0;

            top5.forEach((user, index) => {
                const rank = index + 1;
                const card = document.createElement('div');
                
                // Strict check for "Me"
                const currentUid = auth.currentUser ? auth.currentUser.uid : null;
                const isMe = currentUid && (user.id === currentUid);
                
                card.className = `leader-card ${isMe ? 'is-me' : ''}`;
                
                let rankClass = 'rank-other';
                if (rank === 1) rankClass = 'rank-1';
                else if (rank === 2) rankClass = 'rank-2';
                else if (rank === 3) rankClass = 'rank-3';

                const displayName = isMe ? `<span style="color:#34d399">–í–´ (${escapeHtml(user.username)})</span>` : escapeHtml(user.username);
                const profileLink = `profile.html?uid=${encodeURIComponent(user.id)}`;
                const avatarHtml = user.avatarUrl
                  ? `<img loading="lazy" src="${escapeAttr(getCachedAvatarSrc(user))}" alt="${escapeAttr(user.username)}">`
                  : `<div class="placeholder">${escapeHtml((user.username || 'A').charAt(0).toUpperCase())}</div>`;

                card.innerHTML = `
                    <div class="rank-badge ${rankClass}">${rank}</div>
                    <a class="leader-avatar" href="${profileLink}" title="–ü—Ä–æ—Ñ–∏–ª—å">${avatarHtml}</a>
                    <div class="user-info">
                        <div class="user-name">${displayName}</div>
                        <div class="user-value">${Math.floor(user[sortField]).toLocaleString()} ${suffix}</div>
                    </div>
                `;
                container.appendChild(card);
                totalSum += user[sortField];
            });
            
            return totalSum;
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        function escapeAttr(text) {
            if (!text) return '';
            return String(text).replace(/"/g, '&quot;');
        }
        function getCachedAvatarSrc(user) {
            try {
                const key = `avatar_cache_${user.id}`;
                const cached = localStorage.getItem(key);
                if (cached) {
                    const entry = JSON.parse(cached);
                    if (entry && entry.ts && user.avatarUpdatedAt && entry.ts === user.avatarUpdatedAt && entry.dataUrl) {
                        return entry.dataUrl;
                    }
                }
                setTimeout(() => {
                    if (user.avatarUrl) {
                        fetch(user.avatarUrl, { cache: 'force-cache' }).then(r => r.blob()).then(b => {
                            const fr = new FileReader();
                            fr.onload = () => {
                                const dataUrl = fr.result;
                                const entry = { dataUrl, ts: user.avatarUpdatedAt || Date.now() };
                                localStorage.setItem(key, JSON.stringify(entry));
                            };
                            fr.readAsDataURL(b);
                        }).catch(()=>{});
                    }
                }, 0);
                return user.avatarUrl;
            } catch (e) {
                return user.avatarUrl;
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, 'users', user.uid));
                if (snap.exists()) {
                    currentUser = snap.data();
                    document.getElementById('balance').textContent = Math.floor(currentUser.balance || 0);
                    document.getElementById('authBtn').textContent = currentUser.username || '–ê–∫–∫–∞—É–Ω—Ç';
                    document.getElementById('authBtn').onclick = () => location.href = 'profile.html';
                }
            } else {
                currentUser = null;
                document.getElementById('authBtn').textContent = '–í–æ–π—Ç–∏';
                document.getElementById('authBtn').onclick = () => location.href = 'register.html';
            }
            // Reload leaderboard to update "Me" highlighting
            loadLeaderboard();
        });

        // Init
        createParticles();
        // loadLeaderboard(); // Removed initial call, onAuthStateChanged will handle it

        // Enable mouse wheel scrolling for tabs
        const tabsContainer = document.querySelector('.leaderboard-tabs');
        if (tabsContainer) {
            tabsContainer.addEventListener('wheel', (e) => {
                if (e.deltaY !== 0) {
                    e.preventDefault();
                    tabsContainer.scrollLeft += e.deltaY;
                }
            }, { passive: false });
        }
    </script>
</body>
</html>
