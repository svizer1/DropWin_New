<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>–ü—Ä–æ—Ñ–∏–ª—å | DropWin</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Profile specific styles */
    .profile-header {
        display: flex;
        align-items: center;
        gap: 20px;
        background: var(--bg-card);
        padding: 24px;
        border-radius: var(--radius);
        border: 1px solid var(--border);
        margin-bottom: 20px;
    }
    .profile-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: var(--bg-hover);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        border: 2px solid var(--primary);
    }
    .profile-info {
        flex: 1;
    }
    .profile-name {
        font-size: 1.5rem;
        font-weight: 800;
        margin-bottom: 5px;
    }
    .profile-id {
        color: var(--text-sec);
        font-size: 0.9rem;
    }
    
    .balance-section {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
        border: 1px solid rgba(16, 185, 129, 0.3);
        border-radius: var(--radius);
        padding: 24px;
        text-align: center;
        margin-bottom: 20px;
    }
    .balance-amount {
        font-size: 2.5rem;
        font-weight: 900;
        color: #34d399;
        margin: 10px 0;
        text-shadow: 0 0 20px rgba(52, 211, 153, 0.3);
    }
    .action-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 20px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 24px;
    }
    .stat-card {
        background: var(--bg-card);
        padding: 16px;
        border-radius: 12px;
        text-align: center;
        border: 1px solid var(--border);
    }
    .stat-value {
        font-size: 1.4rem;
        font-weight: 800;
        color: var(--text-main);
    }
    .stat-label {
        font-size: 0.8rem;
        color: var(--text-sec);
        margin-top: 4px;
    }

    .menu-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 30px;
    }
    .menu-item {
        background: var(--bg-card);
        padding: 16px;
        border-radius: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: 0.2s;
        border: 1px solid var(--border);
    }
    .menu-item:hover {
        border-color: var(--primary);
        background: var(--bg-hover);
    }

    .referral-box {
        background: radial-gradient(circle at 80% 0%, rgba(124,58,237,0.18), rgba(124,58,237,0.08));
        border: 1px solid rgba(124, 58, 237, 0.35);
        padding: 24px;
        border-radius: var(--radius);
        margin-bottom: 24px;
        text-align: center;
        box-shadow: 0 0 24px rgba(124,58,237,0.22);
    }
    .referral-code {
        font-size: 2rem;
        font-weight: 900;
        color: var(--accent);
        letter-spacing: 2px;
        margin: 10px 0;
    }
    .ref-row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 8px;
        align-items: center;
        margin-top: 8px;
    }
    .ref-actions {
        margin-top: 14px;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <div class="logo" onclick="location.href='index.html'" style="cursor: pointer;">üíé DROP<span>WIN</span></div>
    </div>
    <div class="header-right">
      <button class="back-btn" onclick="location.href='index.html'" style="font-size: 1.2rem;">‚úñ</button>
    </div>
  </header>

  <div class="content" style="max-width: 600px; margin: 0 auto;">
    
    <!-- Profile Header -->
    <div class="profile-header">
      <div class="profile-avatar" onclick="changeAvatar()" style="cursor: pointer; position: relative; overflow: hidden;">
        <img id="avatarImg" src="" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover; display: none;">
        <span id="avatarPlaceholder">üë§</span>
        <div style="position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.6); color: white; font-size: 0.6rem; text-align: center; padding: 2px;">–ò–ó–ú–ï–ù–ò–¢–¨</div>
      </div>
      <div class="profile-info">
        <div class="profile-name" id="usernameDisplay">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="profile-id">ID: <span id="userIdDisplay">...</span></div>
      </div>
      <button onclick="logout()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">üö™</button>
    </div>

    <!-- Balance -->
    <div class="balance-section">
      <div style="color: var(--text-sec);">–í–∞—à –±–∞–ª–∞–Ω—Å</div>
      <div class="balance-amount"><span id="balanceBig">0</span> ‚ÇΩ</div>
      <div class="action-buttons">
        <button class="btn" style="background: #10b981;" onclick="location.href='dep.html'">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
        <button class="btn" style="background: #374151;" onclick="location.href='–≤—ã–≤–æ–¥.html'">–í—ã–≤–µ—Å—Ç–∏</button>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="gamesPlayed">0</div>
        <div class="stat-label">–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="winRate">0%</div>
        <div class="stat-label">–í–∏–Ω—Ä–µ–π—Ç</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalWin">0</div>
        <div class="stat-label">–í—ã–∏–≥—Ä—ã—à</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="maxWinStreak">0</div>
        <div class="stat-label">–°—Ç—Ä–∏–∫ –ø–æ–±–µ–¥</div>
      </div>
    </div>

    <!-- Referral -->
    <div class="referral-box">
      <div class="stat-label">–í–∞—à —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥</div>
      <div class="referral-code" id="myReferralCode">LOADING</div>
      <div class="ref-actions">
        <button class="btn" style="background:#7c3aed; width:100%;" onclick="copyReferralCode()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
      </div>
      <div style="margin-top: 10px; font-size: 0.9rem;">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ: <span id="refCount" style="color:white; font-weight:bold;">0</span></div>
    </div>

    <!-- Menu -->
    <div class="menu-list">
      <div class="menu-item" onclick="openDailyCaseFromProfile()">
        <span>üì¶ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –∫–µ–π—Å</span>
        <span>‚ûú</span>
      </div>
      <div class="menu-item" onclick="location.href='inventory.html'">
        <span>üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</span>
        <span>‚ûú</span>
      </div>
      <div class="menu-item" onclick="activatePromoPrompt()">
        <span>üéÅ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</span>
        <span>‚ûú</span>
      </div>
      <div class="menu-item" onclick="toggleHistory()">
        <span>üìú –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</span>
        <span id="historyArrow">‚ñº</span>
      </div>
      <div id="historySection" style="display: none; padding-top: 10px;">
          <div class="stat-label" style="margin-bottom: 8px;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–≥—Ä—ã</div>
          <div id="historyList"></div>
          <div class="stat-label" style="margin: 16px 0 8px;">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</div>
          <div id="transactionList"></div>
      </div>
      <div class="menu-item" onclick="location.href='https://t.me/DropWinHelp_bot'">
        <span>üí¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞</span>
        <span>‚ûú</span>
      </div>
    </div>

  </div>

  <!-- Bottom Nav -->
  <nav class="nav">
    <button class="nav-btn" onclick="location.href='index.html'"><span>üè†</span><span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span></button>
    <button class="nav-btn" onclick="location.href='leaderboard.html'"><span>üèÜ</span><span class="nav-label">–¢–æ–ø</span></button>
    <button class="nav-btn" onclick="location.href='inventory.html'"><span>üéí</span><span class="nav-label">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</span></button>
    <button class="nav-btn active"><span>üë§</span><span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span></button>
  </nav>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBVra2JN-C7-1b_Qa4cU8--XvJ83lymiM8",
    authDomain: "dropwin-8d94b.firebaseapp.com",
    projectId: "dropwin-8d94b",
    storageBucket: "dropwin-8d94b.firebasestorage.app",
    messagingSenderId: "988974289403",
    appId: "1:988974289403:web:886d34e6f65920a105fb5e",
    measurementId: "G-BK010MHN8N"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let userId = null;

  window.changeAvatar = async function() {
      if (!currentUser) return;
      const url = prompt("–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É –∞–≤–∞—Ç–∞—Ä–∞:", currentUser.avatarUrl || "");
      if (url !== null) {
          await updateDoc(doc(db, 'users', userId), { avatarUrl: url });
          currentUser.avatarUrl = url;
          updateAvatarDisplay();
      }
  }

  function updateAvatarDisplay() {
      const img = document.getElementById('avatarImg');
      const placeholder = document.getElementById('avatarPlaceholder');
      if (currentUser && currentUser.avatarUrl) {
          img.src = currentUser.avatarUrl;
          img.style.display = 'block';
          placeholder.style.display = 'none';
      } else {
          img.style.display = 'none';
          placeholder.style.display = 'block';
      }
  }

  window.logout = function() {
    signOut(auth).then(() => location.href = 'index.html');
  }

  window.copyReferralCode = function() {
    const code = document.getElementById('myReferralCode').textContent;
    navigator.clipboard.writeText(code).then(() => alert('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!'));
  }

  window.openDailyCaseFromProfile = function() {
    if (!currentUser) return;
    const today = new Date().toDateString();
    if (currentUser.lastDailyCase === today) {
        alert('–°–µ–≥–æ–¥–Ω—è –≤—ã —É–∂–µ –æ—Ç–∫—Ä—ã–≤–∞–ª–∏ –∫–µ–π—Å');
    } else {
        location.href = 'freebet.html';
    }
  }

  window.toggleHistory = function() {
      const sec = document.getElementById('historySection');
      const arrow = document.getElementById('historyArrow');
      if (sec.style.display === 'none') {
          sec.style.display = 'block';
          arrow.textContent = '‚ñ≤';
      } else {
          sec.style.display = 'none';
          arrow.textContent = '‚ñº';
      }
  }

  window.activatePromoPrompt = async function() {
    const code = prompt("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥:");
    if (!code) return;
    
    if (!currentUser) return;
    
    // Simple promo logic reuse
    const upperCode = code.toUpperCase().trim();
    if (upperCode === 'KAVEXS' || upperCode === 'KAVEXS2026') {
        const today = new Date().toDateString();
        if (currentUser.lastPromoDate === today) return alert('–£–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω —Å–µ–≥–æ–¥–Ω—è');
        
        const bonus = 100;
        await updateDoc(doc(db, 'users', userId), {
            balance: (currentUser.balance || 0) + bonus,
            lastPromoDate: today
        });
        alert(`–ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! +${bonus}‚ÇΩ`);
        location.reload();
    } else {
        alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥');
    }
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      location.href = 'register.html';
      return;
    }
    userId = user.uid;
    try {
      const ref = doc(db, 'users', userId);
      let snap = await getDoc(ref);
      if (!snap.exists()) {
        const def = {
          username: user.displayName || 'User',
          balance: 0,
          gamesPlayed: 0,
          wins: 0,
          totalWin: 0,
          history: [],
          referralCode: 'DROPWIN-' + Math.random().toString(36).substring(2,7).toUpperCase(),
          referralCount: 0
        };
        await setDoc(ref, def);
        snap = await getDoc(ref);
      }
      currentUser = snap.data();
      if ((!currentUser.username || currentUser.username === 'User') && user.displayName) {
        await updateDoc(doc(db, 'users', userId), { username: user.displayName });
        currentUser.username = user.displayName;
      }
      document.getElementById('usernameDisplay').textContent = currentUser.username || 'User';
      document.getElementById('userIdDisplay').textContent = userId.substring(0,6);
      updateAvatarDisplay();
      document.getElementById('balanceBig').textContent = currentUser.balance || 0;
      document.getElementById('gamesPlayed').textContent = currentUser.gamesPlayed || 0;
      const wins = currentUser.wins || 0;
      const games = currentUser.gamesPlayed || 0;
      document.getElementById('winRate').textContent = games ? Math.round((wins/games)*100) + '%' : '0%';
      document.getElementById('totalWin').textContent = currentUser.totalWin || 0;
      let maxWin = 0;
      let currentWin = 0;
      if (currentUser.history) {
        currentUser.history.forEach(h => {
          if (h.result === 'win') {
            currentWin++;
            if (currentWin > maxWin) maxWin = currentWin;
          } else {
            currentWin = 0;
          }
        });
      }
      document.getElementById('maxWinStreak').textContent = maxWin;
      let refCode = currentUser.referralCode;
      if (!refCode) {
        refCode = 'DROPWIN-' + Math.random().toString(36).substring(2,7).toUpperCase();
        await updateDoc(ref, { referralCode: refCode });
      }
      document.getElementById('myReferralCode').textContent = refCode;
      document.getElementById('refCount').textContent = currentUser.referralCount || 0;
      const histList = document.getElementById('historyList');
      histList.innerHTML = '';
      if (currentUser.history && currentUser.history.length > 0) {
        currentUser.history.slice(-5).reverse().forEach(h => {
          const div = document.createElement('div');
          div.style.cssText = 'display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid var(--border); font-size:0.9rem;';
          div.innerHTML = `<span>${h.game}</span><span style="color:${h.result==='win'?'#34d399':'#ef4444'}">${h.result==='win'?'+':''}${h.win}‚ÇΩ</span>`;
          histList.appendChild(div);
        });
      } else {
        histList.innerHTML = '<div style="color:var(--text-sec); font-size:0.8rem;">–ù–µ—Ç –∏–≥—Ä</div>';
      }
      const transList = document.getElementById('transactionList');
      transList.innerHTML = '';
      if (currentUser.cryptoTransactions && currentUser.cryptoTransactions.length > 0) {
        currentUser.cryptoTransactions.slice(-5).reverse().forEach(t => {
          const div = document.createElement('div');
          div.style.cssText = 'display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid var(--border); font-size:0.9rem;';
          div.innerHTML = `<span>${t.type}</span><span style="color:#fbbf24">${t.amount}‚ÇΩ</span>`;
          transList.appendChild(div);
        });
      } else {
        transList.innerHTML = '<div style="color:var(--text-sec); font-size:0.8rem;">–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div>';
      }
    } catch (e) {}
  });
</script>
</body>
</html>
