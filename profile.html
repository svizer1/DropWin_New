<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>–ü—Ä–æ—Ñ–∏–ª—å | DropWin</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .streak-bar {
      display: flex;
      gap: 5px;
      height: 38px;
      padding: 6px;
      background: rgba(30, 30, 50, 0.5);
      border-radius: 12px;
      overflow: hidden;
      margin: 16px 0;
    }
    .streak-item {
      flex: 1;
      border-radius: 8px;
      position: relative;
      transition: transform 0.15s;
    }
    .streak-item:hover {
      transform: scale(1.08);
      z-index: 2;
    }
    .streak-item.win {
      background: linear-gradient(135deg, #34d399, #10b981);
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
    }
    .streak-item.loss {
      background: linear-gradient(135deg, #f87171, #ef4444);
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
    }
    .streak-tooltip {
      position: absolute;
      bottom: 110%;
      left: 50%;
      transform: translateX(-50%);
      background: #111827;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.78rem;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: all 0.18s ease;
      z-index: 10;
      box-shadow: 0 6px 16px rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .streak-item:hover .streak-tooltip {
      opacity: 1;
      bottom: 120%;
    }
    .streak-empty {
      color: #6b7280;
      font-size: 0.9rem;
      text-align: center;
      padding: 10px;
      opacity: 0.7;
    }
    .max-streak {
      background: rgba(30, 30, 50, 0.4);
      border-radius: 10px;
      padding: 12px 16px;
      margin: 16px 0;
      display: flex;
      justify-content: space-around;
      text-align: center;
    }
    .max-streak-item {
      flex: 1;
    }
    .max-streak-value {
      font-size: 1.6rem;
      font-weight: 800;
      margin: 4px 0;
    }
    .max-streak-win  { color: #34d399; }
    .max-streak-loss { color: #f87171; }
    .time-direction {
      text-align: center;
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 6px;
      opacity: 0.8;
    }
    .crypto-transactions {
      margin-top: 24px;
    }
    .transaction-item {
      background: rgba(255,255,255,0.03);
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.95rem;
    }
    .transaction-buy  { border-left: 4px solid #10b981; }
    .transaction-sell { border-left: 4px solid #ef4444; }
    .transaction-fee { border-left: 4px solid #fbbf24; }
    .profile-balance-block {
      text-align: center;
      margin: 24px 0 32px;
      padding: 20px;
      background: rgba(16, 185, 129, 0.08);
      border-radius: 16px;
      border: 1px solid rgba(52, 211, 153, 0.25);
    }
    .profile-balance-big {
      font-size: 2.8rem;
      font-weight: 800;
      color: #34d399;
      margin: 8px 0;
    }

    .referral-card {
      background: rgba(30,30,50,0.48);
      border: 1px solid rgba(139,92,246,0.22);
      border-radius: 18px;
      padding: 28px 18px;
      margin: 32px 0;
      backdrop-filter: blur(8px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.32);
    }
    .referral-title {
      font-size: 1.15rem;
      color: #c4b5fd;
      margin-bottom: 12px;
      font-weight: 500;
      letter-spacing: 0.6px;
    }
    .referral-code-display {
      font-size: 2.6rem;
      font-weight: 900;
      color: #fcd34d;
      letter-spacing: 3px;
      margin: 14px 0;
      word-break: break-all;
      text-shadow: 0 3px 14px rgba(251,191,36,0.4);
    }
    .referral-buttons {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
      margin: 24px 0;
    }
    .btn-copy-referral {
      padding: 14px 36px;
      font-size: 1.05rem;
      font-weight: 600;
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: #111827;
      border: none;
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(251,191,36,0.55);
      transition: all 0.22s ease;
      min-width: 150px;
      cursor: pointer;
    }
    .btn-refresh-referral {
      width: 56px;
      height: 56px;
      padding: 0;
      font-size: 1.7rem;
      background: linear-gradient(145deg, #a78bfa, #7c3aed);
      color: white;
      border: none;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 18px rgba(139,92,246,0.5);
      transition: all 0.22s ease;
      cursor: pointer;
    }
    .btn-copy-referral:hover,
    .btn-refresh-referral:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 24px rgba(0,0,0,0.4) !important;
    }
  </style>
</head>
<body>
  <div class="particles" id="particles"></div>

  <div class="header">
    <div class="logo">üíé DROPWIN</div>
    <div class="balance-container" id="gotoDeposit" style="cursor: pointer; transition: all 0.2s;">
      <div class="balance">üí∞ <span id="balance">‚Äî</span>‚ÇΩ</div>
      <div style="font-size:0.78rem; color:#34d399; margin-top:3px; text-align:center; opacity:0.9;">
        –ü–æ–ø–æ–ª–Ω–∏—Ç—å ‚Üí
      </div>
    </div>
  </div>

  <div class="content">
    <button class="back-btn" onclick="location.href='index.html'">‚Üê –ù–∞–∑–∞–¥</button>

    <div class="game-card">
      <div class="game-title">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
      <div id="usernameDisplay" style="font-size:1.6rem; font-weight:800; margin:20px 0; text-align:center;">‚Äî</div>

      <div class="profile-balance-block">
        <div style="font-size:1.1rem; color:#9ca3af; margin-bottom:4px;">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</div>
        <div class="profile-balance-big"><span id="balanceBig">‚Äî</span> ‚ÇΩ</div>
        <button class="btn" onclick="location.href='dep.html'"
                style="margin-top:16px; background: linear-gradient(135deg, #10b981, #059669); font-size:1.15rem; padding:14px 40px;">
          –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å
        </button>
      </div>

      <div class="referral-card">
        <div class="referral-title">–í–∞—à —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥</div>
        <div class="referral-code-display" id="myReferralCode">‚Äî‚Äî</div>
        <div class="referral-buttons">
          <button class="btn-copy-referral" onclick="copyReferralCode()">
            –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
          </button>
          <button class="btn-refresh-referral" id="refreshReferralCodeBtn">
            üîÑ
          </button>
        </div>
        <div id="referralChangeInfo"
             style="margin-top:16px; font-size:0.88rem; color:#fca5a5; font-weight:500; display:none;
                    background:rgba(239,68,68,0.15); padding:10px 16px; border-radius:12px;
                    border:1px solid rgba(239,68,68,0.3);">
          –ù–æ–≤—ã–π –∫–æ–¥ –º–æ–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏
        </div>
        <div style="margin-top:20px; font-size:0.96rem; color:#9ca3af; line-height:1.5;">
          –ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ <span style="color:#fcd34d; font-weight:700;">+10 ‚ÇΩ</span> –∑–∞ –∫–∞–∂–¥–æ–≥–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ
        </div>
      </div>

      <div style="margin: 28px 0; text-align: center; background: rgba(30,30,50,0.4); padding: 20px; border-radius: 12px;">
        <div style="font-size: 1.1rem; color: #9ca3af; margin-bottom: 12px;">–í–∞—à–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—ã</div>
        <div style="display: flex; justify-content: space-around; margin: 16px 0;">
          <div>
            <div style="font-size: 2.2rem; font-weight: 800; color: #60a5fa;" id="refCount">0</div>
            <div style="color: #9ca3af;">–ø—Ä–∏–≥–ª–∞—à–µ–Ω–æ</div>
          </div>
          <div>
            <div style="font-size: 2.2rem; font-weight: 800; color: #34d399;" id="refEarnings">0 ‚ÇΩ</div>
            <div style="color: #9ca3af;">–∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
          </div>
        </div>
      </div>

      <div class="input-group" style="margin: 32px 0 16px;">
        <label class="input-label">–ü—Ä–æ–º–æ–∫–æ–¥</label>
        <input type="text" id="promoCode" placeholder="Kavexs / Kavexs2026">
        <button class="btn" id="promoBtn"
          style="margin: 16px auto; display: block; width: 90%; max-width: 360px;
                 background: linear-gradient(135deg, #facc15, #ca8a04);
                 font-size: 1.25rem; padding: 16px; font-weight: 700;
                 box-shadow: 0 4px 15px rgba(250, 204, 21, 0.4);">
          üéÅ –ê–ö–¢–ò–í–ò–†–û–í–ê–¢–¨
        </button>
      </div>

      <button class="btn" onclick="openDailyCaseFromProfile()"
        style="margin: 16px auto; display:block; width:90%; max-width:400px; background:linear-gradient(135deg,#eab308,#ca8a04);">
        üì¶ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –∫–µ–π—Å
      </button>

      <div class="stats-grid">
        <div class="stat-card"><div class="stat-value" id="gamesPlayed">0</div><div class="stat-label">–ò–≥—Ä</div></div>
        <div class="stat-card"><div class="stat-value" id="winRate">0%</div><div class="stat-label">% –ø–æ–±–µ–¥</div></div>
        <div class="stat-card"><div class="stat-value" id="totalBet">0‚ÇΩ</div><div class="stat-label">–°—Ç–∞–≤–∫–∏</div></div>
        <div class="stat-card"><div class="stat-value" id="totalWin">0‚ÇΩ</div><div class="stat-label">–í—ã–∏–≥—Ä—ã—à</div></div>
      </div>

      <div class="max-streak">
        <div class="max-streak-item">
          <div>–ú–∞–∫—Å. –≤—ã–∏–≥—Ä—ã—à–µ–π –ø–æ–¥—Ä—è–¥</div>
          <div class="max-streak-value max-streak-win" id="maxWinStreak">0</div>
        </div>
        <div class="max-streak-item">
          <div>–ú–∞–∫—Å. –ø—Ä–æ–∏–≥—Ä—ã—à–µ–π –ø–æ–¥—Ä—è–¥</div>
          <div class="max-streak-value max-streak-loss" id="maxLossStreak">0</div>
        </div>
      </div>

      <div class="recent-streak">
        <div class="game-title" style="margin: 20px 0 8px;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–≥—Ä—ã</div>
        <div id="streakBar" class="streak-bar"></div>
        <div class="time-direction">‚Üê —Å—Ç–∞—Ä—ã–µ ¬†¬†‚Ä¢¬†¬† –Ω–æ–≤—ã–µ ‚Üí</div>
      </div>

      <div class="history-list">
        <div class="game-title" style="margin-top:28px; margin-bottom:12px;">–ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä</div>
        <div id="historyList"></div>
      </div>

      <div class="crypto-transactions">
        <div class="game-title" style="margin-top:28px; margin-bottom:12px;">–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div>
        <div id="cryptoTransactionList"></div>
      </div>

    </div>

    <button class="btn logout-btn" id="logoutBtn" style="margin: 40px auto 80px; display:block; width:90%; max-width:400px;">
      –í—ã–π—Ç–∏
    </button>
  </div>

  <div class="nav">
    <button class="nav-btn" onclick="location.href='index.html'"><span>üè†</span><span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span></button>
    <button class="nav-btn" onclick="location.href='profile.html'"><span>üë§</span><span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span></button>
    <button class="nav-btn" onclick="location.href='register.html'"><span>üîë</span><span class="nav-label">–í—Ö–æ–¥</span></button>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBVra2JN-C7-1b_Qa4cU8--XvJ83lymiM8",
    authDomain: "dropwin-8d94b.firebaseapp.com",
    projectId: "dropwin-8d94b",
    storageBucket: "dropwin-8d94b.firebasestorage.app",
    messagingSenderId: "988974289403",
    appId: "1:988974289403:web:886d34e6f65920a105fb5e",
    measurementId: "G-BK010MHN8N"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let userId = null;

  // ‚îÄ‚îÄ‚îÄ –í–°–ï –§–£–ù–ö–¶–ò–ò –í–´–®–ï addEventListener ‚îÄ‚îÄ‚îÄ

  function logout() {
    signOut(auth).then(() => {
      location.href = 'index.html';
    }).catch((error) => {
      alert('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ' + error.message);
    });
  }

  function createParticles() {
    const container = document.getElementById('particles');
    for (let i = 0; i < 40; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      p.style.width = p.style.height = Math.random() * 3 + 1 + 'px';
      p.style.left = Math.random() * 100 + '%';
      p.style.animationDuration = Math.random() * 15 + 10 + 's';
      p.style.animationDelay = Math.random() * 5 + 's';
      container.appendChild(p);
    }
  }

  window.openDailyCaseFromProfile = async function() {
    if (!currentUser) return alert('–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç');
    const today = new Date().toDateString();
    if (currentUser.lastDailyCase === today) {
      return alert('–°–µ–≥–æ–¥–Ω—è –≤—ã —É–∂–µ –æ—Ç–∫—Ä—ã–≤–∞–ª–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –∫–µ–π—Å');
    }
    location.href = 'freebet.html';
  };

  window.copyReferralCode = function() {
    const code = document.getElementById('myReferralCode').textContent.trim();
    if (!code || code === '‚Äî' || !code.includes('DropWin-')) {
      alert('–ù–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞');
      return;
    }
    navigator.clipboard.writeText(code)
      .then(() => alert(`–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!\n${code}`))
      .catch(() => alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'));
  };

  function generateNewReferralCode() {
    if (!currentUser || !userId) {
      alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç');
      return;
    }

    const today = new Date().toDateString();

    if (currentUser.lastReferralChange === today) {
      const info = document.getElementById('referralChangeInfo');
      info.style.display = 'block';
      setTimeout(() => info.style.display = 'none', 7000);
      return;
    }

    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let codePart = '';
    for (let i = 0; i < 5; i++) {
      codePart += chars[Math.floor(Math.random() * chars.length)];
    }

    const newCode = `DropWin-${codePart}`;

    currentUser.referralCode = newCode;
    currentUser.lastReferralChange = today;

    updateDoc(doc(db, 'users', userId), {
      referralCode: newCode,
      lastReferralChange: today
    }).then(() => {
      document.getElementById('myReferralCode').textContent = newCode;
      alert(`–ù–æ–≤—ã–π –∫–æ–¥ —Å–æ–∑–¥–∞–Ω!\n\n${newCode}\n\n–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ–≥–æ —Å–µ–π—á–∞—Å`);
    }).catch(err => {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞:', err);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
    });
  }

  async function activatePromo() {
    if (!currentUser) return alert('–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç');
    const code = document.getElementById('promoCode').value.trim().toUpperCase();
    if (!code) return alert('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥');

    const today = new Date().toDateString();
    if (currentUser.lastPromoDate === today && code.startsWith('FB-')) {
      return alert('–°–µ–≥–æ–¥–Ω—è –≤—ã —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥');
    }

    let sum = 0;
    let isBonusPromo = false;

    if (code === 'KAVEXS' || code === 'KAVEXS2026') {
      sum = 100;
    }
    else if (currentUser.activePromoCode === code && currentUser.activePromoValue != null) {
      sum = currentUser.activePromoValue;
      isBonusPromo = true;

      // –£–¥–∞–ª—è–µ–º –ø—Ä–æ–º–æ–∫–æ–¥ —Å—Ä–∞–∑—É
      currentUser.activePromoCode = null;
      currentUser.activePromoType = null;
      currentUser.activePromoValue = null;
    }
    else {
      return alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥');
    }

    if (sum <= 0) return;

    currentUser.balance = (currentUser.balance || 0) + sum;
    currentUser.lastPromoDate = today;

    const updateData = {
      balance: currentUser.balance,
      lastPromoDate: today,
      activePromoCode: null,
      activePromoType: null,
      activePromoValue: null
    };

    await updateDoc(doc(db, 'users', userId), updateData);

    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
    if (!currentUser.cryptoTransactions) currentUser.cryptoTransactions = [];
    currentUser.cryptoTransactions.push({
      type: 'promo',
      amount: sum,
      code: code,
      timestamp: Date.now()
    });

    await updateDoc(doc(db, 'users', userId), {
      cryptoTransactions: currentUser.cryptoTransactions
    });

    document.getElementById('balance').textContent = currentUser.balance;
    document.getElementById('balanceBig').textContent = currentUser.balance;
    alert(`+${sum}‚ÇΩ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!`);
    document.getElementById('promoCode').value = '';
  }

  function calculateMaxStreaks(history) {
    if (!history || history.length === 0) return { maxWin: 0, maxLoss: 0 };
    let currentWin = 0, currentLoss = 0;
    let maxWin = 0, maxLoss = 0;
    for (const item of history) {
      if (item.result === 'win') {
        currentWin++;
        currentLoss = 0;
        maxWin = Math.max(maxWin, currentWin);
      } else {
        currentLoss++;
        currentWin = 0;
        maxLoss = Math.max(maxLoss, currentLoss);
      }
    }
    return { maxWin, maxLoss };
  }

  function loadCurrentUser() {
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        location.href = 'register.html';
        return;
      }

      userId = user.uid;
      document.getElementById('usernameDisplay').textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";

      getDoc(doc(db, 'users', user.uid))
        .then((docSnap) => {
          if (docSnap.exists()) {
            currentUser = docSnap.data();

            // –ó–∞—â–∏—Ç–∞ –æ—Ç –±–∏—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            if (!currentUser.activePromoCode) {
              currentUser.activePromoCode = null;
              currentUser.activePromoType = null;
              currentUser.activePromoValue = null;
            }

            document.getElementById('usernameDisplay').textContent = currentUser.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            const bal = currentUser.balance || 0;
            document.getElementById('balance').textContent = bal;
            document.getElementById('balanceBig').textContent = bal;

            document.getElementById('myReferralCode').textContent = currentUser.referralCode || '‚Äî';

            document.getElementById('gamesPlayed').textContent = currentUser.gamesPlayed || 0;
            document.getElementById('totalBet').textContent = (currentUser.totalBet || 0) + '‚ÇΩ';
            document.getElementById('totalWin').textContent = (currentUser.totalWin || 0) + '‚ÇΩ';

            const wins = currentUser.wins || 0;
            const games = currentUser.gamesPlayed || 0;
            const winRate = games > 0 ? Math.round((wins / games) * 100) : 0;
            document.getElementById('winRate').textContent = winRate + '%';

            const { maxWin, maxLoss } = calculateMaxStreaks(currentUser.history || []);
            document.getElementById('maxWinStreak').textContent = maxWin;
            document.getElementById('maxLossStreak').textContent = maxLoss;

            document.getElementById('refCount').textContent = currentUser.referralCount || 0;
            document.getElementById('refEarnings').textContent = (currentUser.referralEarnings || 0) + ' ‚ÇΩ';

            // –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            if (!currentUser.history || currentUser.history.length === 0) {
              historyList.innerHTML = '<div class="empty-state">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
            } else {
              currentUser.history.forEach(item => {
                const div = document.createElement('div');
                div.className = `history-item ${item.result || 'loss'}`;
                div.innerHTML = `
                  <div>
                    <div class="history-game">${item.game || '–ò–≥—Ä–∞'}</div>
                    <div class="history-time">${item.time || ''}</div>
                  </div>
                  <div class="history-amount ${item.result}">
                    ${item.win > 0 ? '+' : ''}${item.win || 0}‚ÇΩ
                  </div>
                `;
                historyList.appendChild(div);
              });
            }

            // –°—Ç—Ä–∏–∫
            const streakBar = document.getElementById('streakBar');
            streakBar.innerHTML = '';
            if (!currentUser.history || currentUser.history.length === 0) {
              streakBar.innerHTML = '<div class="streak-empty">–ù–µ—Ç —Å—ã–≥—Ä–∞–Ω–Ω—ã—Ö –∏–≥—Ä</div>';
            } else {
              const recent = currentUser.history.slice(-12);
              recent.forEach(item => {
                const el = document.createElement('div');
                el.className = `streak-item ${item.result || 'loss'}`;
                el.innerHTML = `<div class="streak-tooltip">${item.game || '–ò–≥—Ä–∞'} ‚Ä¢ ${item.result === 'win' ? '–í—ã–∏–≥—Ä—ã—à' : '–ü—Ä–æ–∏–≥—Ä—ã—à'}</div>`;
                streakBar.appendChild(el);
              });
            }

            // –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (–±–µ–∑–æ–ø–∞—Å–Ω–∞—è –≤–µ—Ä—Å–∏—è)
            const transactionList = document.getElementById('cryptoTransactionList');
            transactionList.innerHTML = '';
            const transactions = currentUser.cryptoTransactions || [];

            if (transactions.length === 0) {
              transactionList.innerHTML = '<div class="empty-state">–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div>';
            } else {
              transactions.slice(-12).reverse().forEach(tr => {
                const div = document.createElement('div');
                let title = '';
                let extra = '';
                let amountText = `+${Math.round(tr.amount || 0)} ‚ÇΩ`;
                let classType = 'transaction-fee';

                if (tr.type === 'deposit') {
                  title = '–ü–û–ü–û–õ–ù–ï–ù–ò–ï';
                  classType = 'transaction-buy';
                  if (tr.bonus) extra += ` +${tr.bonus}‚ÇΩ –±–æ–Ω—É—Å`;
                  if (tr.promoCode) extra += ` [${tr.promoCode}]`;
                } else if (tr.type === 'promo') {
                  title = '–ü–†–û–ú–û–ö–û–î';
                  extra = tr.code || '';
                } else {
                  title = `${(tr.coin || 'RUB').toUpperCase()} - ${tr.type.toUpperCase()}`;
                  classType = `transaction-${tr.type}`;
                  if (tr.type === 'fee_in') title += ` –æ—Ç ${tr.from || ''}`;
                }

                div.className = `transaction-item ${classType}`;
                div.innerHTML = `
                  <div>
                    <div>${title}${extra ? ' ' + extra : ''}</div>
                    <div class="history-time">${new Date(tr.timestamp).toLocaleString('ru-RU')}</div>
                  </div>
                  <div class="history-amount profit">${amountText}</div>
                `;
                transactionList.appendChild(div);
              });
            }
          } else {
            console.warn("–ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Firestore");
            alert("–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–π—Ç–∏ –∏ –≤–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ.");
          }
        })
        .catch(err => {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:", err);
          document.getElementById('usernameDisplay').textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è";
        });
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    createParticles();
    loadCurrentUser();

    document.getElementById('promoBtn')?.addEventListener('click', activatePromo);
    document.getElementById('logoutBtn')?.addEventListener('click', logout);
    document.getElementById('refreshReferralCodeBtn')?.addEventListener('click', generateNewReferralCode);
    document.getElementById('gotoDeposit')?.addEventListener('click', () => {
      location.href = 'dep.html';
    });
  });
</script>
</body>
</html>