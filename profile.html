<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>–ü—Ä–æ—Ñ–∏–ª—å | DropWin</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Dark Minimalism Theme */
    :root {
        --bg-main: #09090b;
        --bg-card: #18181b;
        --bg-hover: #27272a;
        --border: #27272a;
        --text-main: #e4e4e7;
        --text-sec: #a1a1aa;
        --primary: #8b5cf6;
        --success: #10b981;
        --danger: #ef4444;
        --radius: 12px;
    }

    body {
        background-color: var(--bg-main);
        color: var(--text-main);
        font-family: 'Inter', sans-serif;
    }

    .profile-header {
        display: flex;
        align-items: center;
        gap: 20px;
        background: var(--bg-card);
        padding: 24px;
        border-radius: var(--radius);
        border: 1px solid var(--border);
        margin-bottom: 20px;
    }
    .profile-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: var(--bg-hover);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        border: 2px solid var(--border);
        position: relative;
        transition: border-color 0.2s;
    }
    .profile-avatar:hover {
        border-color: var(--primary);
    }
    .profile-info {
        flex: 1;
    }
    .profile-name {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 4px;
        color: var(--text-main);
    }
    .profile-id {
        color: var(--text-sec);
        font-size: 0.85rem;
        font-family: monospace;
    }
    
    .balance-section {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 24px;
        text-align: center;
        margin-bottom: 20px;
    }
    .balance-amount {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--text-main);
        margin: 10px 0;
        letter-spacing: -1px;
    }
    .action-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 20px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 24px;
    }
    .stat-card {
        background: var(--bg-card);
        padding: 16px;
        border-radius: var(--radius);
        text-align: center;
        border: 1px solid var(--border);
    }
    .stat-value {
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--text-main);
    }
    .stat-label {
        font-size: 0.8rem;
        color: var(--text-sec);
        margin-top: 4px;
    }

    .menu-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 30px;
    }
    .menu-item {
        background: var(--bg-card);
        padding: 16px;
        border-radius: var(--radius);
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: 0.2s;
        border: 1px solid var(--border);
        color: var(--text-main);
    }
    .menu-item:hover {
        border-color: var(--primary);
        background: var(--bg-hover);
    }

    .referral-box {
        background: var(--bg-card);
        border: 1px solid var(--primary);
        padding: 24px;
        border-radius: var(--radius);
        margin-bottom: 24px;
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    .referral-box::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: radial-gradient(circle at 50% 50%, rgba(139, 92, 246, 0.1), transparent 70%);
        pointer-events: none;
    }
    .referral-code {
        font-size: 1.8rem;
        font-weight: 800;
        color: var(--primary);
        letter-spacing: 1px;
        margin: 12px 0;
        font-family: monospace;
    }

    /* Admin Panel */
    #adminPanel {
        background: var(--bg-card); 
        padding: 24px; 
        border-radius: var(--radius); 
        margin-bottom: 24px; 
        border: 1px solid #7c3aed; 
        box-shadow: 0 0 20px rgba(124, 58, 237, 0.1);
    }
    .admin-input {
        padding: 12px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--bg-main);
        color: var(--text-main);
        width: 100%;
        box-sizing: border-box;
    }
    .admin-input:focus {
        border-color: var(--primary);
        outline: none;
    }

  </style>
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <div class="logo" onclick="location.href='index.html'" style="cursor: pointer;">üíé DROP<span>WIN</span></div>
    </div>
    <div class="header-right">
      <button class="back-btn" onclick="location.href='index.html'" style="font-size: 1.2rem; color: var(--text-sec);">‚úñ</button>
    </div>
  </header>

  <div class="content" style="max-width: 600px; margin: 0 auto;">
    
    <!-- Profile Header -->
    <div class="profile-header">
      <div class="profile-avatar" id="profileAvatar" style="cursor: pointer; overflow: hidden;">
        <img id="avatarImg" src="" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover; display: none;">
        <span id="avatarPlaceholder" style="color: var(--text-sec);">üë§</span>
      </div>
      <div class="profile-info">
        <div class="profile-name" id="usernameDisplay">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="profile-id">ID: <span id="userIdDisplay">...</span></div>
      </div>
      <button onclick="logout()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color: var(--text-sec);">üö™</button>
    </div>

    <!-- Balance -->
    <div class="balance-section">
      <div style="color: var(--text-sec); font-size: 0.9rem;">–í–∞—à –±–∞–ª–∞–Ω—Å</div>
      <div class="balance-amount"><span id="balanceBig">0</span> ‚ÇΩ</div>
      <div class="action-buttons">
        <button class="btn" style="background: var(--success); color: #000; font-weight: 700;" onclick="location.href='dep.html'">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
        <button class="btn" style="background: var(--bg-hover); color: var(--text-main); border: 1px solid var(--border);" onclick="location.href='–≤—ã–≤–æ–¥.html'">–í—ã–≤–µ—Å—Ç–∏</button>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="gamesPlayed">0</div>
        <div class="stat-label">–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="winRate">0%</div>
        <div class="stat-label">–í–∏–Ω—Ä–µ–π—Ç</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalWin">0</div>
        <div class="stat-label">–í—ã–∏–≥—Ä—ã—à</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="maxWinStreak">0</div>
        <div class="stat-label">–°—Ç—Ä–∏–∫ –ø–æ–±–µ–¥</div>
      </div>
    </div>

    <!-- Referral -->
    <div class="referral-box">
      <div class="stat-label">–í–∞—à —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥</div>
      <div class="referral-code" id="myReferralCode">LOADING</div>
      <div class="ref-actions">
        <button class="btn" style="background: var(--primary); width:100%; font-weight: 600;" onclick="copyReferralCode()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
      </div>
      <div style="margin-top: 12px; font-size: 0.85rem; color: var(--text-sec);">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ: <span id="refCount" style="color:var(--text-main); font-weight:bold;">0</span></div>
    </div>

    <!-- Menu -->
    <div class="menu-list">
      <div class="menu-item" onclick="openDailyCaseFromProfile()">
        <span>üì¶ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –∫–µ–π—Å</span>
        <span style="color: var(--text-sec);">‚ûú</span>
      </div>
      <div class="menu-item" onclick="location.href='inventory.html'">
        <span>üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</span>
        <span style="color: var(--text-sec);">‚ûú</span>
      </div>
      <div class="menu-item" onclick="activatePromoPrompt()">
        <span>üéÅ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</span>
        <span style="color: var(--text-sec);">‚ûú</span>
      </div>
      <div class="menu-item" onclick="toggleHistory()">
        <span>üìú –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</span>
        <span id="historyArrow" style="color: var(--text-sec);">‚ñº</span>
      </div>
      <div id="historySection" style="display: none; padding-top: 10px;">
          <div class="stat-label" style="margin-bottom: 8px;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–≥—Ä—ã</div>
          <div id="historyList"></div>
          <div class="stat-label" style="margin: 16px 0 8px;">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</div>
          <div id="transactionList"></div>
      </div>
      <div class="menu-item" onclick="location.href='https://t.me/DropWinHelp_bot'">
        <span>üí¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞</span>
        <span style="color: var(--text-sec);">‚ûú</span>
      </div>
    </div>

    <!-- Admin Panel (Hidden) -->
    <div id="adminPanel" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h3 style="color: var(--text-main); font-size: 1.2rem; margin: 0;">üëë –ü–∞–Ω–µ–ª—å –°–æ–∑–¥–∞—Ç–µ–ª—è</h3>
            <span style="background: var(--primary); color: white; padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700;">ADMIN</span>
        </div>
        <div style="display: grid; gap: 12px;">
            <input type="text" id="adminPromoCode" placeholder="–ö–æ–¥ (–Ω–∞–ø—Ä. WIN100)" class="admin-input">
            <input type="number" id="adminPromoActivations" placeholder="–ö–æ–ª-–≤–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–π (–Ω–∞–ø—Ä. 3)" class="admin-input">
            <input type="number" id="adminPromoValue" placeholder="–°—É–º–º–∞ (–Ω–∞–ø—Ä. 100)" class="admin-input">
            <select id="adminPromoType" class="admin-input">
                <option value="money">–î–µ–Ω—å–≥–∏ –Ω–∞ –±–∞–ª–∞–Ω—Å</option>
                <option value="dep">–ë–æ–Ω—É—Å –∫ –¥–µ–ø–æ–∑–∏—Ç—É (%)</option>
            </select>
            <button onclick="createAdminPromo()" class="btn" style="background: var(--danger); font-weight: 600;">–°–æ–∑–¥–∞—Ç—å –ü—Ä–æ–º–æ–∫–æ–¥</button>
        </div>
        
        <div style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 16px;">
            <div style="color: var(--text-sec); font-size: 0.9rem; margin-bottom: 12px;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã:</div>
            <div id="adminPromoList" style="display:flex; flex-direction:column; gap:8px; max-height: 200px; overflow-y:auto;">
                <div style="text-align:center; color:rgba(255,255,255,0.4); font-size:0.9rem;">–ù–∞–∂–º–∏—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å...</div>
            </div>
            <button onclick="loadRecentPromos()" class="btn" style="margin-top: 12px; background: var(--bg-hover); border: 1px solid var(--border); padding: 8px; font-size: 0.9rem;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
        </div>
    </div>

  </div>

  <!-- Bottom Nav -->
  <nav class="nav">
    <button class="nav-btn" onclick="location.href='index.html'"><span>üè†</span><span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span></button>
    <button class="nav-btn" onclick="location.href='leaderboard.html'"><span>üèÜ</span><span class="nav-label">–¢–æ–ø</span></button>
    <button class="nav-btn" onclick="location.href='inventory.html'"><span>üéí</span><span class="nav-label">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</span></button>
    <button class="nav-btn active"><span>üë§</span><span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span></button>
  </nav>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, updateDoc, setDoc, deleteDoc, runTransaction, arrayUnion, increment, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  // INLINED shared_promo.js due to CORS on file://

  async function createPromoCode(db, code, activations, value, type = 'money') {
      const promoRef = doc(db, 'promocodes', code);
      await setDoc(promoRef, {
          code: code,
          activationsLeft: Number(activations),
          value: Number(value),
          type: type, // 'money' or 'dep'
          usersUsed: [],
          createdAt: Date.now()
      });
      return true;
  }

  async function deletePromoCode(db, code) {
      await deleteDoc(doc(db, 'promocodes', code));
      return true;
  }

  async function getRecentPromos(db) {
      const q = query(collection(db, 'promocodes'), orderBy('createdAt', 'desc'), limit(20));
      const snap = await getDocs(q);
      return snap.docs.map(d => d.data());
  }

  async function redeemPromoCode(db, userId, codeInput) {
      if (!userId) throw new Error('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç');
      
      const code = codeInput.trim();
      const promoRef = doc(db, 'promocodes', code);
      const userRef = doc(db, 'users', userId);

      return await runTransaction(db, async (transaction) => {
          const promoSnap = await transaction.get(promoRef);
          
          // 1. Check Firestore Promos
          if (promoSnap.exists()) {
              const promoData = promoSnap.data();
              
              if (promoData.activationsLeft <= 0) {
                  throw new Error('–ê–∫—Ç–∏–≤–∞—Ü–∏–∏ —ç—Ç–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å');
              }
              
              if (promoData.usersUsed && promoData.usersUsed.includes(userId)) {
                  throw new Error('–í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥');
              }

              // Apply Reward
              if (promoData.type === 'money') {
                  const userSnap = await transaction.get(userRef);
                  const userData = userSnap.data() || {};
                  const newBalance = (userData.balance || 0) + promoData.value;
                  
                  transaction.update(userRef, {
                      balance: newBalance
                  });
              } else if (promoData.type === 'dep' || promoData.type.startsWith('dep')) {
                  // Deposit bonus
                  transaction.update(userRef, {
                      activePromoCode: code,
                      activePromoType: promoData.type,
                      activePromoValue: promoData.value,
                      activePromoUsed: false
                  });
              }

              // Update Promo Stats
              transaction.update(promoRef, {
                  activationsLeft: increment(-1),
                  usersUsed: arrayUnion(userId)
              });
              
              return { success: true, value: promoData.value, type: promoData.type, message: `–ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω: +${promoData.value}${promoData.type === 'money' ? '‚ÇΩ' : '% –∫ –¥–µ–ø—É'}` };
          } 
          
          // 2. Check Global/Legacy Hardcoded Promos (Fallback)
          const userSnap = await transaction.get(userRef);
          const userData = userSnap.data() || {};
          
          const GLOBAL_PROMOS = {
              'PROMOCODE_DAY_670': { val: 50, type: 'money' },
              'WELCOME': { val: 100, type: 'money' },
              'DROPWIN2026': { val: 200, type: 'money' },
              'KAVEXS': { val: 1000, type: 'money' },
              'KAVEXS2026': { val: 5000, type: 'money' }
          };
          
          if (GLOBAL_PROMOS[code]) {
              const reward = GLOBAL_PROMOS[code];
              const used = userData.usedPromos || [];
              
              if (used.includes(code)) {
                  throw new Error('–í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥');
              }
              
              const newBalance = (userData.balance || 0) + reward.val;
              transaction.update(userRef, {
                  balance: newBalance,
                  usedPromos: arrayUnion(code)
              });
              
              return { success: true, value: reward.val, type: reward.type, message: `–ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω: +${reward.val}‚ÇΩ` };
          }

          // 3. Check Personal Active Promo
          if (userData.activePromoCode === code && !userData.activePromoUsed) {
               if (userData.activePromoType && userData.activePromoType.startsWith('bonus')) {
                   const val = userData.activePromoValue || 0;
                   transaction.update(userRef, {
                       balance: (userData.balance || 0) + val,
                       activePromoCode: null,
                       activePromoValue: 0,
                       activePromoUsed: true
                   });
                   return { success: true, value: val, type: 'money', message: `–ë–æ–Ω—É—Å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω: +${val}‚ÇΩ` };
               } else {
                   return { success: false, redirect: 'dep.html', message: '–≠—Ç–æ –±–æ–Ω—É—Å –∫ –¥–µ–ø–æ–∑–∏—Ç—É. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ...' };
               }
          }

          throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥');
      });
  }

  const firebaseConfig = {
    apiKey: "AIzaSyBVra2JN-C7-1b_Qa4cU8--XvJ83lymiM8",
    authDomain: "dropwin-8d94b.firebaseapp.com",
    projectId: "dropwin-8d94b",
    storageBucket: "dropwin-8d94b.appspot.com",
    messagingSenderId: "988974289403",
    appId: "1:988974289403:web:886d34e6f65920a105fb5e",
    measurementId: "G-BK010MHN8N"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let userId = null;
  let viewUid = null;
  let canEdit = false;

  function promptSetAvatarUrl() {
      if (!canEdit) return;
      const url = prompt('–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (http/https):', currentUser && currentUser.avatarUrl ? currentUser.avatarUrl : '');
      if (!url) return;
      const trimmed = url.trim();
      if (!/^https?:\/\//i.test(trimmed)) {
        alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Å—ã–ª–∫–∞. –î–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http(s)://');
        return;
      }
      (async () => {
        try {
          const ts = Date.now();
          await updateDoc(doc(db, 'users', userId), { avatarUrl: trimmed, avatarUpdatedAt: ts });
          if (!currentUser) currentUser = {};
          currentUser.avatarUrl = trimmed;
          currentUser.avatarUpdatedAt = ts;
          updateAvatarDisplay();
        } catch (e) {
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Å—ã–ª–∫—É –∞–≤–∞—Ç–∞—Ä–∞');
        }
      })();
  }

  function updateAvatarDisplay() {
      const img = document.getElementById('avatarImg');
      const placeholder = document.getElementById('avatarPlaceholder');
      if (currentUser && currentUser.avatarUrl) {
          const src = getCachedAvatarSrc(userId, currentUser.avatarUrl, currentUser.avatarUpdatedAt);
          img.src = src;
          img.style.display = 'block';
          placeholder.style.display = 'none';
      } else {
          img.style.display = 'none';
          placeholder.style.display = 'block';
      }
  }

  window.logout = function() {
    signOut(auth).then(() => location.href = 'index.html');
  }

  window.copyReferralCode = function() {
    const code = document.getElementById('myReferralCode').textContent;
    navigator.clipboard.writeText(code).then(() => alert('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!'));
  }

  window.openDailyCaseFromProfile = function() {
    if (!currentUser) return;
    const today = new Date().toDateString();
    if (currentUser.lastDailyCase === today) {
        alert('–°–µ–≥–æ–¥–Ω—è –≤—ã —É–∂–µ –æ—Ç–∫—Ä—ã–≤–∞–ª–∏ –∫–µ–π—Å');
    } else {
        location.href = 'freebet.html';
    }
  }

  window.toggleHistory = function() {
      const sec = document.getElementById('historySection');
      const arrow = document.getElementById('historyArrow');
      if (sec.style.display === 'none') {
          sec.style.display = 'block';
          arrow.textContent = '‚ñ≤';
      } else {
          sec.style.display = 'none';
          arrow.textContent = '‚ñº';
      }
  }

  window.activatePromoPrompt = async function() {
    const code = prompt("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥:");
    if (!code) return;
    if (!currentUser) return;
    
    try {
        const result = await redeemPromoCode(db, userId, code);
        if (result.success) {
            alert(result.message);
            if (result.redirect) location.href = result.redirect;
            else location.reload();
        }
    } catch (e) {
        alert(e.message);
    }
  }

  window.createAdminPromo = async function() {
      const code = document.getElementById('adminPromoCode').value.trim();
      const activations = document.getElementById('adminPromoActivations').value;
      const value = document.getElementById('adminPromoValue').value;
      const type = document.getElementById('adminPromoType').value;

      if (!code || !activations || !value) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');

      try {
          await createPromoCode(db, code, activations, value, type);
          alert('–ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ–∑–¥–∞–Ω!');
          document.getElementById('adminPromoCode').value = '';
          loadRecentPromos(); // Refresh list
      } catch (e) {
          console.error(e);
          alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ' + e.message);
      }
  }

  window.loadRecentPromos = async function() {
      const list = document.getElementById('adminPromoList');
      if (!list) {
          console.error('adminPromoList element not found');
          return;
      }
      list.innerHTML = '<div style="text-align:center; font-size:0.9rem; color:var(--text-sec);">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
      try {
          const promos = await getRecentPromos(db);
          list.innerHTML = '';
          if(promos.length === 0) {
              list.innerHTML = '<div style="text-align:center; color:var(--text-sec);">–ù–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</div>';
              return;
          }
          promos.forEach(p => {
              const div = document.createElement('div');
              div.style.cssText = 'background:var(--bg-main); padding:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; border:1px solid var(--border);';
              
              const info = document.createElement('div');
              info.innerHTML = `
                  <div style="font-weight:bold; color:var(--primary); font-family:monospace;">${p.code}</div>
                  <div style="font-size:0.8rem; color:var(--text-sec);">
                    –û—Å—Ç: ${p.activationsLeft} | 
                    ${p.type==='money' ? p.value+'‚ÇΩ' : '+'+p.value+'% Dep'}
                  </div>
              `;
              
              const delBtn = document.createElement('button');
              delBtn.innerHTML = 'üóëÔ∏è';
              delBtn.title = '–£–¥–∞–ª–∏—Ç—å';
              delBtn.style.cssText = 'background:rgba(239, 68, 68, 0.1); border:1px solid var(--danger); color:var(--danger); padding:6px 10px; border-radius:6px; cursor:pointer; transition:0.2s;';
              delBtn.onmouseover = () => delBtn.style.background = 'rgba(239, 68, 68, 0.2)';
              delBtn.onmouseout = () => delBtn.style.background = 'rgba(239, 68, 68, 0.1)';
              delBtn.onclick = async () => {
                  if(confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ ${p.code}?`)) {
                      await deletePromoCode(db, p.code);
                      loadRecentPromos();
                  }
              };
              
              div.appendChild(info);
              div.appendChild(delBtn);
              list.appendChild(div);
          });
      } catch(e) {
          console.error(e);
          list.innerHTML = '<div style="color:var(--danger); text-align:center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
      }
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      location.href = 'register.html';
      return;
    }
    
    // Admin Check
    if (user.uid === 'fB5LvM4j5yVkcBE0c6eyvhV4WG02') {
        const adminPanel = document.getElementById('adminPanel');
        if (adminPanel) adminPanel.style.display = 'block';
        loadRecentPromos();
    }

    const params = new URLSearchParams(location.search);
    viewUid = params.get('uid');
    userId = viewUid && viewUid !== user.uid ? viewUid : user.uid;
    canEdit = user.uid === userId;
    try {
      const ref = doc(db, 'users', userId);
      let snap = await getDoc(ref);
      if (!snap.exists() && canEdit) {
        const def = {
          username: user.displayName || 'User',
          balance: 0,
          gamesPlayed: 0,
          wins: 0,
          totalWin: 0,
          history: [],
          referralCode: 'DROPWIN-' + Math.random().toString(36).substring(2,7).toUpperCase(),
          referralCount: 0
        };
        await setDoc(ref, def);
        snap = await getDoc(ref);
      }
      currentUser = snap.data();
      if (currentUser && canEdit && (!currentUser.username || currentUser.username === 'User') && user.displayName) {
        await updateDoc(doc(db, 'users', userId), { username: user.displayName });
        currentUser.username = user.displayName;
      }
      document.getElementById('usernameDisplay').textContent = currentUser.username || 'User';
      document.getElementById('userIdDisplay').textContent = userId.substring(0,6);
      updateAvatarDisplay();
      document.getElementById('balanceBig').textContent = currentUser.balance || 0;
      document.getElementById('gamesPlayed').textContent = currentUser.gamesPlayed || 0;
      const wins = currentUser.wins || 0;
      const games = currentUser.gamesPlayed || 0;
      document.getElementById('winRate').textContent = games ? Math.round((wins/games)*100) + '%' : '0%';
      document.getElementById('totalWin').textContent = currentUser.totalWin || 0;
      let maxWin = 0;
      let currentWin = 0;
      if (currentUser.history) {
        currentUser.history.forEach(h => {
          if (h.result === 'win') {
            currentWin++;
            if (currentWin > maxWin) maxWin = currentWin;
          } else {
            currentWin = 0;
          }
        });
      }
      document.getElementById('maxWinStreak').textContent = maxWin;
      let refCode = currentUser.referralCode;
      if (!refCode) {
        refCode = 'DROPWIN-' + Math.random().toString(36).substring(2,7).toUpperCase();
        await updateDoc(ref, { referralCode: refCode });
      }
      document.getElementById('myReferralCode').textContent = refCode;
      document.getElementById('refCount').textContent = currentUser.referralCount || 0;
      const histList = document.getElementById('historyList');
      histList.innerHTML = '';
      if (currentUser.history && currentUser.history.length > 0) {
        currentUser.history.slice(-5).reverse().forEach(h => {
          const div = document.createElement('div');
          div.style.cssText = 'display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid var(--border); font-size:0.9rem;';
          div.innerHTML = `<span>${h.game}</span><span style="color:${h.result==='win'?'var(--success)':'var(--danger)'}">${h.result==='win'?'+':''}${h.win}‚ÇΩ</span>`;
          histList.appendChild(div);
        });
      } else {
        histList.innerHTML = '<div style="color:var(--text-sec); font-size:0.8rem;">–ù–µ—Ç –∏–≥—Ä</div>';
      }
      const transList = document.getElementById('transactionList');
      transList.innerHTML = '';
      if (currentUser.cryptoTransactions && currentUser.cryptoTransactions.length > 0) {
        currentUser.cryptoTransactions.slice(-5).reverse().forEach(t => {
          const div = document.createElement('div');
          div.style.cssText = 'display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid var(--border); font-size:0.9rem;';
          div.innerHTML = `<span>${t.type}</span><span style="color:#fbbf24">${t.amount}‚ÇΩ</span>`;
          transList.appendChild(div);
        });
      } else {
        transList.innerHTML = '<div style="color:var(--text-sec); font-size:0.8rem;">–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div>';
      }
      const avatarContainer = document.getElementById('profileAvatar');
      if (avatarContainer) {
        if (canEdit) {
          avatarContainer.style.cursor = 'pointer';
          avatarContainer.onclick = promptSetAvatarUrl;
        } else {
          avatarContainer.style.cursor = 'default';
          avatarContainer.onclick = null;
        }
      }
    } catch (e) {}
  });


  function cacheAvatarLocal(uid, url, ts) {
    try {
      fetch(url, { cache: 'force-cache' }).then(r => r.blob()).then(b => {
        const fr = new FileReader();
        fr.onload = () => {
          const dataUrl = fr.result;
          const entry = { dataUrl, ts };
          localStorage.setItem(`avatar_cache_${uid}`, JSON.stringify(entry));
        };
        fr.readAsDataURL(b);
      });
    } catch {}
  }
  function getCachedAvatarSrc(uid, url, ts) {
    try {
      const key = `avatar_cache_${uid}`;
      const cached = localStorage.getItem(key);
      if (cached) {
        const entry = JSON.parse(cached);
        if (entry && entry.ts && ts && entry.ts === ts && entry.dataUrl) {
          return entry.dataUrl;
        }
      }
      return url;
    } catch {
      return url;
    }
  }
</script>
</body>
</html>
