<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>–ü—Ä–æ—Ñ–∏–ª—å | DropWin</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .streak-bar {
      display: flex;
      gap: 5px;
      height: 38px;
      padding: 6px;
      background: rgba(30, 30, 50, 0.5);
      border-radius: 12px;
      overflow: hidden;
      margin: 16px 0;
    }

    .streak-item {
      flex: 1;
      border-radius: 8px;
      position: relative;
      transition: transform 0.15s;
    }

    .streak-item:hover {
      transform: scale(1.08);
      z-index: 2;
    }

    .streak-item.win {
      background: linear-gradient(135deg, #34d399, #10b981);
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
    }

    .streak-item.loss {
      background: linear-gradient(135deg, #f87171, #ef4444);
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
    }

    .streak-tooltip {
      position: absolute;
      bottom: 110%;
      left: 50%;
      transform: translateX(-50%);
      background: #111827;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.78rem;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: all 0.18s ease;
      z-index: 10;
      box-shadow: 0 6px 16px rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.08);
    }

    .streak-item:hover .streak-tooltip {
      opacity: 1;
      bottom: 120%;
    }

    .streak-empty {
      color: #6b7280;
      font-size: 0.9rem;
      text-align: center;
      padding: 10px;
      opacity: 0.7;
    }

    .max-streak {
      background: rgba(30, 30, 50, 0.4);
      border-radius: 10px;
      padding: 12px 16px;
      margin: 16px 0;
      display: flex;
      justify-content: space-around;
      text-align: center;
    }

    .max-streak-item {
      flex: 1;
    }

    .max-streak-value {
      font-size: 1.6rem;
      font-weight: 800;
      margin: 4px 0;
    }

    .max-streak-win  { color: #34d399; }
    .max-streak-loss { color: #f87171; }

    .time-direction {
      text-align: center;
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 6px;
      opacity: 0.8;
    }
    /* –ù–æ–≤—ã–π —Å—Ç–∏–ª—å –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π */
    .crypto-transactions {
      margin-top: 24px;
    }
    .transaction-item {
      background: rgba(255,255,255,0.03);
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.95rem;
    }
    .transaction-buy  { border-left: 4px solid #10b981; }
    .transaction-sell { border-left: 4px solid #ef4444; }
  </style>
</head>
<body>
  <div class="particles" id="particles"></div>

  <div class="header">
    <div class="logo">üíé DROPWIN</div>
    <div class="balance-container">
      <div class="balance">üí∞ <span id="balance">‚Äî</span>‚ÇΩ</div>
    </div>
  </div>

  <div class="content">
    <button class="back-btn" onclick="location.href='index.html'">‚Üê –ù–∞–∑–∞–¥</button>

    <div class="game-card">
      <div class="game-title">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
      <div id="usernameDisplay" style="font-size:1.6rem; font-weight:800; margin:20px 0; text-align:center;">‚Äî</div>

      <div class="input-group">
        <label class="input-label">–ü—Ä–æ–º–æ–∫–æ–¥</label>
        <input type="text" id="promoCode" placeholder="Kavexs / Kavexs2026">
        <button class="btn" id="promoBtn" style="margin-top:12px;">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>

      <div class="stats-grid">
        <div class="stat-card"><div class="stat-value" id="gamesPlayed">0</div><div class="stat-label">–ò–≥—Ä</div></div>
        <div class="stat-card"><div class="stat-value" id="winRate">0%</div><div class="stat-label">% –ø–æ–±–µ–¥</div></div>
        <div class="stat-card"><div class="stat-value" id="totalBet">0‚ÇΩ</div><div class="stat-label">–°—Ç–∞–≤–∫–∏</div></div>
        <div class="stat-card"><div class="stat-value" id="totalWin">0‚ÇΩ</div><div class="stat-label">–í—ã–∏–≥—Ä—ã—à</div></div>
      </div>

      <div class="max-streak">
        <div class="max-streak-item">
          <div>–ú–∞–∫—Å. –≤—ã–∏–≥—Ä—ã—à–µ–π –ø–æ–¥—Ä—è–¥</div>
          <div class="max-streak-value max-streak-win" id="maxWinStreak">0</div>
        </div>
        <div class="max-streak-item">
          <div>–ú–∞–∫—Å. –ø—Ä–æ–∏–≥—Ä—ã—à–µ–π –ø–æ–¥—Ä—è–¥</div>
          <div class="max-streak-value max-streak-loss" id="maxLossStreak">0</div>
        </div>
      </div>

      <div class="recent-streak">
        <div class="game-title" style="margin: 20px 0 8px;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–≥—Ä—ã</div>
        <div id="streakBar" class="streak-bar"></div>
        <div class="time-direction">‚Üê —Å—Ç–∞—Ä—ã–µ &nbsp;&nbsp; ‚Ä¢ &nbsp;&nbsp; –Ω–æ–≤—ã–µ ‚Üí</div>
      </div>

      <div class="history-list">
        <div class="game-title" style="margin-top:28px; margin-bottom:12px;">–ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä</div>
        <div id="historyList"></div>
      </div>

      <!-- –ù–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª: –ò—Å—Ç–æ—Ä–∏—è –∫—Ä–∏–ø—Ç–æ-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π -->
      <div class="crypto-transactions">
        <div class="game-title" style="margin-top:28px; margin-bottom:12px;">–ò—Å—Ç–æ—Ä–∏—è –∫—Ä–∏–ø—Ç–æ-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div>
        <div id="cryptoTransactionList"></div>
      </div>

    </div>

    <button class="btn logout-btn" id="logoutBtn" style="margin: 32px auto; display:block; width:90%; max-width:400px;">
      –í—ã–π—Ç–∏
    </button>
  </div>

  <div class="nav">
    <button class="nav-btn" onclick="location.href='index.html'"><span>üè†</span><span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span></button>
    <button class="nav-btn active"><span>üë§</span><span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span></button>
    <button class="nav-btn" onclick="location.href='register.html'"><span>üîë</span><span class="nav-label">–í—Ö–æ–¥</span></button>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBVra2JN-C7-1b_Qa4cU8--XvJ83lymiM8",
    authDomain: "dropwin-8d94b.firebaseapp.com",
    projectId: "dropwin-8d94b",
    storageBucket: "dropwin-8d94b.firebasestorage.app",
    messagingSenderId: "988974289403",
    appId: "1:988974289403:web:886d34e6f65920a105fb5e",
    measurementId: "G-BK010MHN8N"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  function createParticles() {
    const container = document.getElementById('particles');
    for (let i = 0; i < 40; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      p.style.width = p.style.height = Math.random() * 3 + 1 + 'px';
      p.style.left = Math.random() * 100 + '%';
      p.style.animationDuration = Math.random() * 15 + 10 + 's';
      p.style.animationDelay = Math.random() * 5 + 's';
      container.appendChild(p);
    }
  }

  let currentUser = null;
  let userId = null;

  function calculateMaxStreaks(history) {
    if (!history || history.length === 0) return { maxWin: 0, maxLoss: 0 };

    let currentWin = 0, currentLoss = 0;
    let maxWin = 0, maxLoss = 0;

    for (const item of history) {
      if (item.result === 'win') {
        currentWin++;
        currentLoss = 0;
        maxWin = Math.max(maxWin, currentWin);
      } else {
        currentLoss++;
        currentWin = 0;
        maxLoss = Math.max(maxLoss, currentLoss);
      }
    }

    return { maxWin, maxLoss };
  }

  function loadCurrentUser() {
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userId = user.uid;
        getDoc(doc(db, 'users', user.uid)).then((docSnap) => {
          if (docSnap.exists()) {
            currentUser = docSnap.data();
            let displayName = currentUser.isGuest ? '–ì–æ—Å—Ç—å' : currentUser.username;
            document.getElementById('usernameDisplay').textContent = displayName;
            document.getElementById('balance').textContent = currentUser.balance || 0;

            document.getElementById('gamesPlayed').textContent = currentUser.gamesPlayed || 0;
            document.getElementById('totalBet').textContent = (currentUser.totalBet || 0) + '‚ÇΩ';
            document.getElementById('totalWin').textContent = (currentUser.totalWin || 0) + '‚ÇΩ';

            const wins = currentUser.wins || 0;
            const games = currentUser.gamesPlayed || 0;
            const winRate = games > 0 ? Math.round((wins / games) * 100) : 0;
            document.getElementById('winRate').textContent = winRate + '%';

            const { maxWin, maxLoss } = calculateMaxStreaks(currentUser.history || []);
            document.getElementById('maxWinStreak').textContent = maxWin;
            document.getElementById('maxLossStreak').textContent = maxLoss;

            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            if (!currentUser.history || currentUser.history.length === 0) {
              historyList.innerHTML = '<div class="empty-state">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
            } else {
              currentUser.history.forEach(item => {
                const div = document.createElement('div');
                div.className = `history-item ${item.result || 'loss'}`;
                div.innerHTML = `
                  <div>
                    <div class="history-game">${item.game || '–ò–≥—Ä–∞'}</div>
                    <div class="history-time">${item.time || ''}</div>
                  </div>
                  <div class="history-amount ${item.result}">
                    ${item.win > 0 ? '+' : ''}${item.win || 0}‚ÇΩ
                  </div>
                `;
                historyList.appendChild(div);
              });
            }

            const streakBar = document.getElementById('streakBar');
            streakBar.innerHTML = '';
            if (!currentUser.history || currentUser.history.length === 0) {
              streakBar.innerHTML = '<div class="streak-empty">–ù–µ—Ç —Å—ã–≥—Ä–∞–Ω–Ω—ã—Ö –∏–≥—Ä</div>';
            } else {
              const recent = currentUser.history.slice(-12);
              recent.forEach(item => {
                const el = document.createElement('div');
                el.className = `streak-item ${item.result || 'loss'}`;
                const resultText = item.result === 'win' ? '–í—ã–∏–≥—Ä—ã—à' : '–ü—Ä–æ–∏–≥—Ä—ã—à';
                const amount = item.win > 0 ? `+${item.win}‚ÇΩ` : `${item.win}‚ÇΩ`;
                el.innerHTML = `
                  <div class="streak-tooltip">
                    ${item.game || '–ò–≥—Ä–∞'}<br>
                    ${resultText} ‚Ä¢ ${amount}<br>
                    <small>${item.time || ''}</small>
                  </div>
                `;
                streakBar.appendChild(el);
              });
            }

            // –ù–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª: –ò—Å—Ç–æ—Ä–∏—è –∫—Ä–∏–ø—Ç–æ-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
            const transactionList = document.getElementById('cryptoTransactionList');
            transactionList.innerHTML = '';
            const transactions = currentUser.cryptoTransactions || [];
            if (transactions.length === 0) {
              transactionList.innerHTML = '<div class="empty-state">–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div>';
            } else {
              transactions.slice(-10).reverse().forEach(tr => { // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10, –≤ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –ø–æ—Ä—è–¥–∫–µ
                const div = document.createElement('div');
                div.className = `transaction-item transaction-${tr.type}`;
                div.innerHTML = `
                  <div>
                    <div>${tr.coin.toUpperCase()} - ${tr.type.toUpperCase()}</div>
                    <div class="history-time">${new Date(tr.timestamp).toLocaleString('ru-RU')}</div>
                  </div>
                  <div class="history-amount ${tr.type === 'buy' ? 'loss' : 'profit'}">
                    ${tr.type === 'buy' ? '-' : '+'}${Math.round(tr.type === 'buy' ? tr.cost : tr.revenue)}‚ÇΩ<br>
                    <small>${tr.amount.toFixed(4)} —à—Ç @ ${Math.round(tr.price)}‚ÇΩ</small>
                  </div>
                `;
                transactionList.appendChild(div);
              });
            }
          } else {
            showGuestMode();
          }
        });
      } else {
        showGuestMode();
      }
    });
  }

  function showGuestMode() {
    // –¢–≤–æ–π —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –¥–ª—è –≥–æ—Å—Ç—è
    const username = localStorage.getItem('dropwin_current_username');
    if (username !== '–ì–æ—Å—Ç—å') {
      location.href = 'register.html';
      return;
    }
    const users = JSON.parse(localStorage.getItem('dropwin_users')) || [];
    currentUser = users.find(u => u.username === username);
    if (!currentUser) {
      location.href = 'register.html';
      return;
    }

    document.getElementById('usernameDisplay').textContent = '–ì–æ—Å—Ç—å';
    document.getElementById('balance').textContent = currentUser.balance;
    document.getElementById('gamesPlayed').textContent = currentUser.gamesPlayed || 0;
    document.getElementById('totalBet').textContent = (currentUser.totalBet || 0) + '‚ÇΩ';
    document.getElementById('totalWin').textContent = (currentUser.totalWin || 0) + '‚ÇΩ';
    const wins = currentUser.wins || 0;
    const games = currentUser.gamesPlayed || 0;
    const winRate = games > 0 ? Math.round((wins / games) * 100) : 0;
    document.getElementById('winRate').textContent = winRate + '%';

    const { maxWin, maxLoss } = calculateMaxStreaks(currentUser.history || []);
    document.getElementById('maxWinStreak').textContent = maxWin;
    document.getElementById('maxLossStreak').textContent = maxLoss;

    const historyList = document.getElementById('historyList');
    historyList.innerHTML = '<div class="empty-state">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
    if (currentUser.history && currentUser.history.length > 0) {
      historyList.innerHTML = '';
      currentUser.history.forEach(item => {
        const div = document.createElement('div');
        div.className = `history-item ${item.result || 'loss'}`;
        div.innerHTML = `
          <div>
            <div class="history-game">${item.game || '–ò–≥—Ä–∞'}</div>
            <div class="history-time">${item.time || ''}</div>
          </div>
          <div class="history-amount ${item.result}">
            ${item.win > 0 ? '+' : ''}${item.win || 0}‚ÇΩ
          </div>
        `;
        historyList.appendChild(div);
      });
    }

    const streakBar = document.getElementById('streakBar');
    streakBar.innerHTML = '<div class="streak-empty">–ù–µ—Ç —Å—ã–≥—Ä–∞–Ω–Ω—ã—Ö –∏–≥—Ä</div>';
    if (currentUser.history && currentUser.history.length > 0) {
      streakBar.innerHTML = '';
      const recent = currentUser.history.slice(-12);
      recent.forEach(item => {
        const el = document.createElement('div');
        el.className = `streak-item ${item.result || 'loss'}`;
        const resultText = item.result === 'win' ? '–í—ã–∏–≥—Ä—ã—à' : '–ü—Ä–æ–∏–≥—Ä—ã—à';
        const amount = item.win > 0 ? `+${item.win}‚ÇΩ` : `${item.win}‚ÇΩ`;
        el.innerHTML = `
          <div class="streak-tooltip">
            ${item.game || '–ò–≥—Ä–∞'}<br>
            ${resultText} ‚Ä¢ ${amount}<br>
            <small>${item.time || ''}</small>
          </div>
        `;
        streakBar.appendChild(el);
      });
    }

    // –î–ª—è –≥–æ—Å—Ç—è –∫—Ä–∏–ø—Ç–æ-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è
    document.getElementById('cryptoTransactionList').innerHTML = '<div class="empty-state">–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (–¥–ª—è –≥–æ—Å—Ç–µ–π –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ)</div>';
  }

  async function saveUser() {
    if (currentUser && userId) {
      await updateDoc(doc(db, 'users', userId), currentUser);
    } else if (currentUser && currentUser.isGuest) {
      let users = JSON.parse(localStorage.getItem('dropwin_users')) || [];
      const idx = users.findIndex(u => u.username === currentUser.username);
      if (idx !== -1) users[idx] = currentUser;
      localStorage.setItem('dropwin_users', JSON.stringify(users));
    }
  }

  async function activatePromo() {
    if (!currentUser) return alert('–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç');
    const code = document.getElementById('promoCode').value.trim().toUpperCase();
    if (!code) return alert('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥');

    const today = new Date().toDateString();
    if (currentUser.lastPromoDate === today) {
      return alert('–°–µ–≥–æ–¥–Ω—è –≤—ã —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥');
    }

    let sum = 0;
    if (code === 'KAVEXS' || code === 'KAVEXS2026') {
      sum = 100;
    } else {
      return alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥');
    }

    currentUser.balance = (currentUser.balance || 0) + sum;
    currentUser.lastPromoDate = today;
    await saveUser();

    document.getElementById('balance').textContent = currentUser.balance;
    alert(`+${sum}‚ÇΩ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –Ω–∞ –±–∞–ª–∞–Ω—Å!`);
    document.getElementById('promoCode').value = '';
  }

  function logout() {
    if (currentUser.isGuest) {
      localStorage.removeItem('dropwin_current_username');
      location.href = 'index.html';
    } else {
      signOut(auth).then(() => {
        location.href = 'index.html';
      }).catch((error) => {
        alert('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ' + error.message);
      });
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    createParticles();
    loadCurrentUser();
  });
  document.getElementById('promoBtn').addEventListener('click', activatePromo);
  document.getElementById('logoutBtn').addEventListener('click', logout);
</script>
</body>
</html>