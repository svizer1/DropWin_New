<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Upgrader | DropWin</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .upgrade-card {
      max-width: 820px;
      margin: 0 auto;
    }
    .upgrade-container {
      display: grid;
      grid-template-columns: 1fr 220px 1fr;
      gap: 14px;
      align-items: center;
      margin-top: 14px;
    }
    .item-slot {
      background: rgba(30, 30, 50, 0.75);
      border: 2px solid rgba(139, 92, 246, 0.35);
      border-radius: 16px;
      padding: 12px;
      min-height: 200px;
      transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease;
    }
    .item-slot:hover {
      border-color: rgba(139, 92, 246, 0.6);
      box-shadow: 0 10px 24px rgba(99,102,241,0.18);
      transform: translateY(-2px);
    }
    .slot-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #c4b5fd;
      font-weight: 700;
      margin-bottom: 10px;
    }
    .slot-body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .slot-emoji {
      font-size: 3.2rem;
      filter: drop-shadow(0 4px 10px rgba(0,0,0,0.6));
      transition: transform 0.18s ease;
    }
    .slot-name {
      color: #e0e0ff;
      font-weight: 700;
    }
    .slot-value {
      color: #fde047;
      font-weight: 900;
      font-size: 1.05rem;
    }
    .select-btn {
      padding: 7px 12px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.16s ease, box-shadow 0.2s ease, filter 0.2s ease;
      min-height: 44px;
      min-width: 44px;
    }
    .select-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(139,92,246,0.35);
      filter: brightness(1.05);
    }
    .select-btn:active {
      transform: translateY(0);
      filter: brightness(0.95);
    }
    .chance-circle {
      background: rgba(20, 20, 40, 0.9);
      border: 2px solid rgba(99, 102, 241, 0.4);
      border-radius: 20px;
      padding: 16px;
      text-align: center;
    }
    .ring-wrap {
      position: relative;
      width: 160px;
      height: 160px;
      margin: 0 auto 8px auto;
    }
    .ring-svg {
      transform: rotate(-90deg);
    }
    .ring-bg {
      stroke: rgba(99, 102, 241, 0.25);
      stroke-width: 12;
      fill: none;
    }
    .ring-progress {
      stroke: #fbbf24;
      stroke-linecap: round;
      stroke-width: 12;
      fill: none;
      transition: stroke-dashoffset 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    .ring-pointer {
      position: absolute;
      inset: 0;
      transform: rotate(0deg);
      transform-origin: 50% 50%;
      will-change: transform;
      backface-visibility: hidden;
    }
    .ring-pointer-dot {
      position: absolute;
      top: 6px;
      left: 50%;
      transform: translateX(-50%);
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #ffffff;
      box-shadow: 0 0 10px rgba(255,255,255,0.9);
    }
    .ring-pointer-arrow {
      position: absolute;
      top: 2px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 7px solid transparent;
      border-right: 7px solid transparent;
      border-bottom: 14px solid #ffffff;
      filter: drop-shadow(0 0 8px rgba(255,255,255,0.9));
    }
    .ring-pointer-arrow::after {
      content: '';
      position: absolute;
      top: 2px;
      left: -5px;
      width: 0;
      height: 0;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-bottom: 10px solid rgba(15,23,42,0.9);
    }
    .fast-toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
      margin-top: 8px;
      color: #c4b5fd;
      font-weight: 700;
    }
    .fast-toggle input {
      width: 44px;
      height: 24px;
      appearance: none;
      background: #4b5563;
      border-radius: 12px;
      position: relative;
      outline: none;
      cursor: pointer;
    }
    .fast-toggle input:checked {
      background: #22c55e;
    }
    .fast-toggle input::after {
      content: '';
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      position: absolute;
      top: 3px;
      left: 4px;
      transition: left 0.2s ease;
    }
    .fast-toggle input:checked::after {
      left: 22px;
    }
    .mult-row {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
      margin-top: 10px;
    }
    .mult-btn {
      padding: 8px 0;
      border-radius: 10px;
      border: none;
      background: rgba(99,102,241,0.25);
      color: #e5e7eb;
      font-weight: 800;
      cursor: pointer;
      transition: transform 0.14s ease, background 0.2s ease, box-shadow 0.2s ease;
      min-height: 44px;
    }
    .mult-btn:hover {
      transform: translateY(-1px);
      background: rgba(99,102,241,0.35);
      box-shadow: 0 8px 16px rgba(99,102,241,0.25);
    }
    .mult-btn.active {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
    }
    .balance-use {
      margin-top: 10px;
      color: #c4b5fd;
      font-weight: 700;
    }
    .balance-use input[type="range"] {
      width: 100%;
    }
    @media (max-width: 860px) {
      .upgrade-container {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .ring-wrap {
        width: 150px;
        height: 150px;
      }
      .chance-percent {
        font-size: 1.8rem;
      }
    }
    @media (max-width: 520px) {
      .upgrade-container {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .item-slot {
        min-height: 180px;
      }
      .slot-emoji {
        font-size: 3.2rem;
      }
      .ring-wrap {
        width: 140px;
        height: 140px;
      }
      .chance-percent {
        font-size: 1.6rem;
      }
      .mult-row {
        grid-template-columns: repeat(3, 1fr);
      }
      .select-btn {
        padding: 12px 16px;
        font-size: 1rem;
        min-height: 48px;
      }
      .fast-toggle input {
        width: 56px;
        height: 30px;
      }
      .inventory-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .selected-list {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (max-width: 380px) {
      .ring-wrap { width: 128px; height: 128px; }
      .chance-percent { font-size: 1.5rem; }
      .slot-emoji { font-size: 2.8rem; }
      .select-btn { font-size: 0.95rem; padding: 12px 14px; }
      .mult-row { grid-template-columns: repeat(2, 1fr); }
    }
    button, .select-btn, .mult-btn, .upgrade-btn, .result-btn, .modal-actions .btn {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .chance-percent {
      font-size: 1.6rem;
      font-weight: 900;
      color: #34d399;
    }
    .chance-label {
      color: #c4b5fd;
      margin-top: 6px;
      font-weight: 700;
    }
    .upgrade-btn {
      margin-top: 12px;
      width: 100%;
      padding: 10px 16px;
      border: none;
      border-radius: 14px;
      background: linear-gradient(135deg, #fbbf24, #d97706);
      color: white;
      font-weight: 900;
      cursor: pointer;
      transition: transform 0.16s ease, box-shadow 0.2s ease, filter 0.2s ease;
      min-height: 44px;
    }
    .upgrade-btn:hover { transform: translateY(-1px); box-shadow: 0 12px 24px rgba(217,119,6,0.25); filter: brightness(1.05); }
    .upgrade-btn:active { transform: translateY(0); filter: brightness(0.95); }
    .upgrade-btn:disabled { opacity: 0.65; cursor: not-allowed; filter: grayscale(0.2); }
    .inventory-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
      gap: 10px;
      margin-top: 18px;
    }
    .section-title {
      margin-top: 18px;
      margin-bottom: 8px;
      color: #c4b5fd;
      font-weight: 800;
    }
    .inventory-item {
      background: rgba(28, 26, 60, 0.8);
      border: 2px solid rgba(139, 92, 246, 0.25);
      border-radius: 12px;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.16s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    }
    .inventory-item.active {
      border-color: #d946ef;
      box-shadow: 0 0 16px rgba(217, 70, 239, 0.6);
    }
    .inventory-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 18px rgba(139,92,246,0.25);
      border-color: rgba(139,92,246,0.5);
    }
    .inv-emoji { font-size: 2.2rem; }
    .inv-name { color: #e0e0ff; font-weight: 700; font-size: 0.95rem; }
    .inv-value { color: #fde047; font-weight: 800; }
    .selected-list {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      width: 100%;
    }
    .selected-item {
      background: rgba(28, 26, 60, 0.8);
      border: 1px solid rgba(139, 92, 246, 0.35);
      border-radius: 10px;
      padding: 6px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .selected-emoji { font-size: 1.6rem; }
    .selected-value { color: #fde047; font-weight: 800; font-size: 0.9rem; }
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.85);
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.12s ease;
    }
    .modal[style*="display: flex"] { opacity: 1; }
    .modal-body {
      background: #15142a;
      border: 2px solid rgba(139,92,246,0.35);
      border-radius: 16px;
      padding: 16px;
      max-width: 920px;
      width: 92%;
      max-height: 80vh;
      overflow: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
      animation: modalPop 0.12s ease;
    }
    .result-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.7);
      z-index: 10000;
    }
    .result-card {
      background: #0f172a;
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 16px;
      padding: 18px;
      min-width: 280px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.6);
      animation: modalPop 0.12s ease;
    }
    .result-card.success { border-color: rgba(34,197,94,0.55); }
    .result-card.fail { border-color: rgba(248,113,113,0.55); }
    .result-title { font-weight: 900; margin-bottom: 6px; }
    .result-title.success { color: #22c55e; }
    .result-title.fail { color: #ef4444; }
    .result-text { color: #e5e7eb; }
    .result-btn {
      margin-top: 12px;
      padding: 8px 12px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #64748b, #475569);
      color: white;
      font-weight: 700;
      cursor: pointer;
      min-height: 44px;
      min-width: 44px;
    }
    .modal-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .modal-actions .btn {
      padding: 8px 12px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #64748b, #475569);
      color: white;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.14s ease, box-shadow 0.2s ease, filter 0.2s ease;
      min-height: 44px;
      min-width: 44px;
    }
    .modal-actions .btn:hover { transform: translateY(-1px); box-shadow: 0 8px 16px rgba(100,116,139,0.35); filter: brightness(1.05); }
    .modal-actions .btn:active { transform: translateY(0); filter: brightness(0.95); }
    .modal-actions input {
      flex: 1;
      margin-left: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.06);
      color: #e5e7eb;
    }
    
    @keyframes modalPop { from { transform: translateY(6px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
  </head>
<body>
  <div class="particles" id="particles"></div>

  <div class="header">
    <div class="logo">üíé DROPWIN</div>
    <div class="balance-container">
      <div class="balance">üí∞ <span id="balance">0</span>‚ÇΩ</div>
      <button class="auth-btn" id="authBtn">–ê–∫–∫–∞—É–Ω—Ç</button>
      <button class="auth-btn" onclick="window.open('https://t.me/DropWinHelp_bot','_blank')">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</button>
    </div>
  </div>

  <div class="content">
    <button class="back-btn" onclick="location.href='index.html'">‚Üê –ù–∞–∑–∞–¥</button>

    <div class="game-card upgrade-card">
      <div class="game-title">‚öôÔ∏è Upgrader</div>

      <div class="upgrade-container">
        <div class="item-slot" id="leftSlot">
          <div class="slot-header">
            <span>–ë–∞–∑–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç</span>
            <button class="select-btn" id="selectLeft">–í—ã–±—Ä–∞—Ç—å</button>
          </div>
          <div class="slot-body">
            <div class="slot-emoji" id="leftEmoji">‚ùì</div>
            <div class="slot-name" id="leftName">–ù–µ –≤—ã–±—Ä–∞–Ω</div>
            <div class="slot-value" id="leftValue">0‚ÇΩ</div>
            <div class="selected-list" id="leftSelectedList"></div>
          </div>
        </div>
        <div class="chance-circle">
          <div class="ring-wrap">
            <svg class="ring-svg" width="160" height="160">
              <circle class="ring-bg" cx="80" cy="80" r="64"></circle>
              <circle class="ring-progress" id="ringProgress" cx="80" cy="80" r="64" stroke-dasharray="402" stroke-dashoffset="402"></circle>
            </svg>
            <div class="ring-pointer" id="ringPointer">
              <div class="ring-pointer-dot"></div>
            </div>
            <div class="chance-percent" id="chancePercent" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);">0%</div>
          </div>
          <div class="chance-label">–®–∞–Ω—Å —É–ª—É—á—à–µ–Ω–∏—è</div>
          <button class="upgrade-btn" id="upgradeBtn">–£–ª—É—á—à–∏—Ç—å</button>
          <div class="fast-toggle">
            <span>–ë—ã—Å—Ç—Ä–æ</span>
            <input type="checkbox" id="fastMode">
          </div>
          <div class="mult-row">
            <button class="mult-btn" data-mult="1.5">x1.5</button>
            <button class="mult-btn" data-mult="2">x2</button>
            <button class="mult-btn" data-mult="3">x3</button>
            <button class="mult-btn" data-mult="5">x5</button>
            <button class="mult-btn" data-mult="10">x10</button>
          </div>
          <div class="balance-use">
            <div>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–∞–ª–∞–Ω—Å –Ω–∞: <span id="balanceUseText">0</span>‚ÇΩ</div>
            <input type="range" id="balanceUseRange" min="0" max="0" step="1" value="0">
          </div>
        </div>
        <div class="item-slot" id="rightSlot">
          <div class="slot-header">
            <span>–¶–µ–ª–µ–≤–æ–π –ø—Ä–µ–¥–º–µ—Ç</span>
            <button class="select-btn" id="selectRight">–í—ã–±—Ä–∞—Ç—å</button>
          </div>
          <div class="slot-body">
            <div class="slot-emoji" id="rightEmoji">‚ùì</div>
            <div class="slot-name" id="rightName">–ù–µ –≤—ã–±—Ä–∞–Ω</div>
            <div class="slot-value" id="rightValue">0‚ÇΩ</div>
          </div>
        </div>
      </div>

      <div id="inventoryContainer"></div>
      <div id="upgradeResult" style="text-align:center; margin-top:14px; min-height:28px;"></div>
      <div class="result-modal" id="upgradeResultModal">
        <div class="result-card" id="upgradeResultCard">
          <div class="result-title" id="upgradeResultTitle">‚Äî</div>
          <div class="result-text" id="upgradeResultText">‚Äî</div>
          <button class="result-btn" onclick="closeUpgradeResult()">–û–∫</button>
        </div>
      </div>
    </div>

    <div class="modal" id="selectModal">
      <div class="modal-body">
        <div class="modal-actions">
          <div class="section-title" id="modalTitle">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</div>
          <div style="display:flex; gap:8px; align-items:center; width: 60%;">
            <button class="btn" id="sortPriceBtn">–¶–µ–Ω–∞ ‚Üë</button>
            <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é">
            <button class="btn" id="closeModalBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        </div>
        <div class="inventory-grid" id="modalItemsGrid"></div>
      </div>
    </div>
  </div>

  <div class="nav">
    <button class="nav-btn" onclick="location.href='index.html'"><span>üè†</span><span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span></button>
    <button class="nav-btn" onclick="location.href='inventory.html'"><span>üéí</span><span class="nav-label">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</span></button>
    <button class="nav-btn" onclick="location.href='profile.html'"><span>üë§</span><span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span></button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBVra2JN-C7-1b_Qa4cU8--XvJ83lymiM8",
      authDomain: "dropwin-8d94b.firebaseapp.com",
      projectId: "dropwin-8d94b",
      storageBucket: "dropwin-8d94b.firebasestorage.app",
      messagingSenderId: "988974289403",
      appId: "1:988974289403:web:886d34e6f65920a105fb5e",
      measurementId: "G-BK010MHN8N"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let userId = null;
    let isGuest = false;
    let leftIndex = null;
    let rightIndex = null;
    let modalMode = null;
    let modalSortAsc = true;
    let modalItems = [];
    let fastMode = false;
    let currentMult = null;
    let balanceUse = 0;
    let battleCatalog = [];
    let rightSelected = null;
    let selectedLeftIndices = [];

    function createParticles() {
      const container = document.getElementById('particles');
      if (!container) return;
      const isMobile = (window.matchMedia && window.matchMedia('(pointer:coarse)').matches) || window.innerWidth < 768;
      const count = isMobile ? 18 : 40;
      for (let i = 0; i < count; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.width = p.style.height = Math.random() * 3 + 1 + 'px';
        p.style.left = Math.random() * 100 + '%';
        p.style.animationDuration = Math.random() * 12 + 8 + 's';
        p.style.animationDelay = Math.random() * 5 + 's';
        container.appendChild(p);
      }
    }

    function updateBalance() {
      document.getElementById('balance').textContent = currentUser ? (currentUser.balance || 0) : 0;
      const btn = document.getElementById('authBtn');
      btn.textContent = isGuest ? '–ì–æ—Å—Ç—å' : (currentUser ? currentUser.username : '–í–æ–π—Ç–∏');
      btn.onclick = () => location.href = 'profile.html';
    }

    async function saveUser() {
      if (isGuest) {
        let users = JSON.parse(localStorage.getItem('dropwin_users')) || [];
        const idx = users.findIndex(u => u.username === '–ì–æ—Å—Ç—å');
        if (idx !== -1) users[idx] = currentUser;
        localStorage.setItem('dropwin_users', JSON.stringify(users));
      } else if (userId) {
        await updateDoc(doc(db, 'users', userId), {
          balance: currentUser.balance || 0,
          inventory: currentUser.inventory || []
        });
      }
    }

    function isBattleItem(item) {
      return (item && typeof item.source === 'string') && item.source.includes('–ë–∞—Ç—Ç–ª');
    }

    const cases = {
      bomj: { price: 5, items: [
        {emoji:'üß¶',name:'–î—ã—Ä—è–≤—ã–π –Ω–æ—Å–æ–∫',value:1},
        {emoji:'üçû',name:'–ß—ë—Ä—Å—Ç–≤—ã–π —Ö–ª–µ–±',value:3},
        {emoji:'üóëÔ∏è',name:'–ú—É—Å–æ—Ä–Ω—ã–π –ø–∞–∫–µ—Ç',value:7},
        {emoji:'üç∫',name:'–¢—ë–ø–ª–æ–µ –ø–∏–≤–æ 0.5',value:12},
        {emoji:'ü™ô',name:'–ì–æ—Ä—Å—Ç–∫–∞ –º–µ–ª–æ—á–∏',value:25},
        {emoji:'üß•',name:'–°—Ç–∞—Ä–∞—è –∫—É—Ä—Ç–∫–∞',value:50},
        {emoji:'üì±',name:'–°–ª–æ–º–∞–Ω–Ω—ã–π Nokia',value:100},
        {emoji:'üí∏',name:'–ó–∞–Ω–∞—á–∫–∞ –ø–æ–¥ –º–∞—Ç—Ä–∞—Å–æ–º',value:180},
      ]},
      vibe: { price: 45, items: [
        {emoji:'üíñ',name:'–°–µ—Ä–¥—Ü–µ',value:15},
        {emoji:'üåπ',name:'–†–æ–∑–∞',value:25},
        {emoji:'üöÄ',name:'–†–∞–∫–µ—Ç–∞',value:50},
        {emoji:'üíê',name:'–¶–≤–µ—Ç—ã',value:50},
        {emoji:'üíç',name:'–ö–æ–ª—å—Ü–æ',value:100},
        {emoji:'üíé',name:'–ê–ª–º–∞–∑',value:100},
        {emoji:'üç≠',name:'–õ–æ–ª-–ø–æ–ø',value:325},
        {emoji:'üê∂',name:'–°—É–ø –î–æ–≥',value:425},
        {emoji:'ü§°',name:'–®–∞–ø–∫–∞ —à—É—Ç–∞',value:500},
        {emoji:'‚≠ê',name:'–ó–≤–µ–∑–¥–∞',value:200},
      ]},
      dvornik:{ price:25, items:[
        {emoji:'üßπ',name:'–ú–µ—Ç–ª–∞',value:5},
        {emoji:'ü™£',name:'–í–µ–¥—Ä–æ',value:10},
        {emoji:'üßº',name:'–ú—ã–ª–æ',value:15},
        {emoji:'ü™ì',name:'–¢–æ–ø–æ—Ä —Å—Ç–∞—Ä—ã–π',value:35},
        {emoji:'üß§',name:'–ü–µ—Ä—á–∞—Ç–∫–∏ —Ä–∞–±–æ—á–∏–µ',value:50},
        {emoji:'‚õèÔ∏è',name:'–õ–æ–ø–∞—Ç–∞',value:80},
        {emoji:'üõ†Ô∏è',name:'–ù–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤',value:150},
        {emoji:'üö≤',name:'–í–µ–ª–æ—Å–∏–ø–µ–¥ –±/—É',value:400},
      ]},
      schoolboy:{ price:250, items:[
        {emoji:'üìö',name:'–£—á–µ–±–Ω–∏–∫',value:80},
        {emoji:'üéí',name:'–†—é–∫–∑–∞–∫',value:150},
        {emoji:'üì±',name:'–°–º–∞—Ä—Ç—Ñ–æ–Ω',value:400},
        {emoji:'üíª',name:'–ù–æ—É—Ç–±—É–∫',value:700},
        {emoji:'üéÆ',name:'PlayStation',value:1000},
        {emoji:'üöó',name:'–ú–∞—à–∏–Ω–∫–∞',value:1300},
        {emoji:'üè†',name:'–ö–≤–∞—Ä—Ç–∏—Ä–∞',value:4000},
      ]},
      event:{ price:500, items:[
        {emoji:'üéâ',name:'–ö–æ–Ω—Ñ–µ—Ç—Ç–∏',value:150},
        {emoji:'üéÅ',name:'–ü–æ–¥–∞—Ä–æ–∫',value:300},
        {emoji:'üéà',name:'–í–æ–∑–¥—É—à–Ω—ã–π —à–∞—Ä',value:400},
        {emoji:'üçæ',name:'–®–∞–º–ø–∞–Ω—Å–∫–æ–µ',value:600},
        {emoji:'üé§',name:'–ú–∏–∫—Ä–æ—Ñ–æ–Ω',value:900},
        {emoji:'üé¨',name:'–ö–∏–Ω–æ',value:1500},
        {emoji:'‚úàÔ∏è',name:'–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ',value:3000},
      ]},
      milioner:{ price:1000, items:[
        {emoji:'üíµ',name:'–î–µ–Ω—å–≥–∏',value:500},
        {emoji:'üè¶',name:'–ë–∞–Ω–∫',value:1000},
        {emoji:'üí∞',name:'–ú–µ—à–æ–∫ –¥–µ–Ω–µ–≥',value:2000},
        {emoji:'üìà',name:'–ì—Ä–∞—Ñ–∏–∫ —Ä–æ—Å—Ç–∞',value:3000},
        {emoji:'ü§ë',name:'–ú–∏–ª–ª–∏–æ–Ω–µ—Ä',value:5000},
        {emoji:'üöÄ',name:'–†–∞–∫–µ—Ç–∞',value:10000},
        {emoji:'üè∞',name:'–î–≤–æ—Ä–µ—Ü',value:50000},
      ]},
    };

    function buildBattleCatalog() {
      const res = [];
      Object.keys(cases).forEach(key => {
        cases[key].items.forEach(it => {
          res.push({ emoji: it.emoji, name: it.name, value: it.value, source: '–ë–∞—Ç—Ç–ª:'+key });
        });
      });
      res.sort((a,b) => a.value - b.value);
      battleCatalog = res;
    }

    function renderInventory() {
      const container = document.getElementById('inventoryContainer');
      const allInv = currentUser?.inventory || [];
      const inventory = allInv;
      if (inventory.length === 0) {
        container.innerHTML = `
          <div class="empty-inventory">
            <div class="empty-icon">üì¶</div>
            <h3>–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∏–∑ –±–∞—Ç—Ç–ª–æ–≤</h3>
            <p style="margin-top: 12px;">–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –ø—Ä–µ–¥–º–µ—Ç—ã –∏–∑ –±–∞—Ç—Ç–ª–æ–≤.</p>
          </div>
        `;
        return;
      }
      const wrapper = document.createElement('div');
      const title = document.createElement('div');
      title.className = 'section-title';
      title.textContent = '–ú–æ–∏ –ø—Ä–µ–¥–º–µ—Ç—ã';
      const grid = document.createElement('div');
      grid.className = 'inventory-grid';
      inventory.forEach((item, idx) => {
        const actualIndex = allInv.indexOf(item);
        const d = document.createElement('div');
        const isActive = selectedLeftIndices.includes(actualIndex);
        d.className = `inventory-item ${isActive ? 'active' : ''}`;
        d.innerHTML = `
          <div class="inv-emoji">${item.emoji || '‚ùì'}</div>
          <div class="inv-name">${item.name || ''}</div>
          <div class="inv-value">${item.value || 0}‚ÇΩ</div>
        `;
        d.onclick = () => {
          if (selectedLeftIndices.includes(actualIndex)) {
            selectedLeftIndices = selectedLeftIndices.filter(i => i !== actualIndex);
          } else {
            if (selectedLeftIndices.length >= 4) {
              alert('–ú–∞–∫—Å–∏–º—É–º 4 –ø—Ä–µ–¥–º–µ—Ç–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è');
              return;
            }
            selectedLeftIndices = [...selectedLeftIndices, actualIndex];
          }
          applySelection();
        };
        grid.appendChild(d);
      });
      wrapper.appendChild(title);
      wrapper.appendChild(grid);
      container.innerHTML = '';
      container.appendChild(wrapper);
    }

    function applySelection() {
      const inv = currentUser?.inventory || [];
      const selected = selectedLeftIndices.map(i => inv[i]).filter(Boolean);
      const right = rightSelected;
      const total = selected.reduce((sum, it) => sum + (it.value || 0), 0);
      const first = selected[0] || null;
      document.getElementById('leftEmoji').textContent = first ? (first.emoji || '‚ùì') : '‚ùì';
      document.getElementById('leftName').textContent = selected.length > 0 ? `–í—ã–±—Ä–∞–Ω–æ ${selected.length}` : '–ù–µ –≤—ã–±—Ä–∞–Ω';
      document.getElementById('leftValue').textContent = `${total}‚ÇΩ`;
      const list = document.getElementById('leftSelectedList');
      if (list) {
        list.innerHTML = '';
        selected.forEach(it => {
          const d = document.createElement('div');
          d.className = 'selected-item';
          d.innerHTML = `
            <div class="selected-emoji">${it.emoji || '‚ùì'}</div>
            <div class="selected-value">${it.value || 0}‚ÇΩ</div>
          `;
          list.appendChild(d);
        });
      }
      document.getElementById('rightEmoji').textContent = right ? (right.emoji || '‚ùì') : '‚ùì';
      document.getElementById('rightName').textContent = right ? (right.name || '–ü—Ä–µ–¥–º–µ—Ç') : '–ù–µ –≤—ã–±—Ä–∞–Ω';
      document.getElementById('rightValue').textContent = (right && right.value) ? `${right.value}‚ÇΩ` : '0‚ÇΩ';
      const effectiveBase = total + balanceUse;
      const valid = selected.length >= 1 && selected.length <= 4 && right && right.value > effectiveBase;
      const chance = valid ? Math.max(1, Math.min(95, (effectiveBase / right.value) * 100)) : 0;
      document.getElementById('chancePercent').textContent = `${chance.toFixed(2)}%`;
      const circumference = 2 * Math.PI * 64;
      const offset = circumference * (1 - Math.min(0.95, chance / 100));
      document.getElementById('ringProgress').setAttribute('stroke-dasharray', `${circumference}`);
      document.getElementById('ringProgress').setAttribute('stroke-dashoffset', `${offset}`);
      const ringPtr = document.getElementById('ringPointer');
      if (ringPtr) {
        if (!window.__ringAnimating) {
          ringPtr.style.transition = 'none';
          ringPtr.style.transform = 'rotate(0deg)';
        }
      }
      updateUpgradeButtonState(valid);
      renderInventory();
      updateBalanceUseRange();
    }

    function updateUpgradeButtonState(valid) {
      const btn = document.getElementById('upgradeBtn');
      if (!btn) return;
      btn.disabled = !valid;
      btn.style.opacity = valid ? '1' : '0.6';
      btn.textContent = valid ? '–£–ª—É—á—à–∏—Ç—å' : '–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã';
    }

    function showSelectModal(mode) {
      modalMode = mode;
      const inv = currentUser?.inventory || [];
      const battleInv = inv.filter(isBattleItem);
      let list = mode === 'right' ? battleCatalog.slice() : inv;
      if (mode === 'right' && leftIndex != null) {
        const base = inv[leftIndex];
        const minVal = base.value + balanceUse;
        list = list.filter(it => it.value > minVal);
      }
      modalItems = list.map(it => ({ ...it }));
      renderModalItems();
      document.getElementById('modalTitle').textContent = mode === 'left' ? '–í—ã–±–µ—Ä–∏—Ç–µ –±–∞–∑–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç' : '–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª–µ–≤–æ–π –ø—Ä–µ–¥–º–µ—Ç (–≤—Å–µ —Å–∫–∏–Ω—ã –±–∞—Ç—Ç–ª–æ–≤)';
      document.getElementById('selectModal').style.display = 'flex';
    }

    function renderModalItems() {
      const grid = document.getElementById('modalItemsGrid');
      const search = (document.getElementById('searchInput')?.value || '').trim().toLowerCase();
      let items = modalItems.slice();
      if (search) {
        items = items.filter(it => (it.name || '').toLowerCase().includes(search));
      }
      items.sort((a,b) => modalSortAsc ? a.value - b.value : b.value - a.value);
      grid.innerHTML = '';
      items.forEach(it => {
        const d = document.createElement('div');
        let active = false;
        if (modalMode === 'left') {
          const idx = (currentUser?.inventory || []).findIndex(x => x.emoji === it.emoji && x.name === it.name && x.value === it.value && isBattleItem(x));
          active = selectedLeftIndices.includes(idx);
        }
        d.className = `inventory-item ${active ? 'active' : ''}`;
        d.innerHTML = `
          <div class="inv-emoji">${it.emoji || '‚ùì'}</div>
          <div class="inv-name">${it.name || ''}</div>
          <div class="inv-value">${it.value || 0}‚ÇΩ</div>
        `;
        d.onclick = () => {
          if (modalMode === 'left') {
            const idx = (currentUser?.inventory || []).findIndex(x => x.emoji === it.emoji && x.name === it.name && x.value === it.value && isBattleItem(x));
            if (idx >= 0) {
              if (selectedLeftIndices.includes(idx)) {
                selectedLeftIndices = selectedLeftIndices.filter(i => i !== idx);
              } else {
                if (selectedLeftIndices.length >= 4) {
                  alert('–ú–∞–∫—Å–∏–º—É–º 4 –ø—Ä–µ–¥–º–µ—Ç–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è');
                  return;
                }
                selectedLeftIndices = [...selectedLeftIndices, idx];
              }
            }
            renderModalItems();
            applySelection();
          } else {
            rightSelected = { emoji: it.emoji, name: it.name, value: it.value };
            applySelection();
            document.getElementById('selectModal').style.display = 'none';
          }
        };
        grid.appendChild(d);
      });
    }

    function updateBalanceUseRange() {
      const range = document.getElementById('balanceUseRange');
      const max = Math.floor(currentUser?.balance || 0);
      range.max = String(max);
      if (balanceUse > max) balanceUse = max;
      range.value = String(balanceUse);
      document.getElementById('balanceUseText').textContent = balanceUse;
    }


    function autoSelectTargetByMult() {
      const inv = currentUser?.inventory || [];
      const selected = selectedLeftIndices.map(i => inv[i]).filter(Boolean);
      if (selected.length === 0 || !currentMult) return;
      const total = selected.reduce((sum, it) => sum + (it.value || 0), 0);
      const targetVal = (total + balanceUse) * currentMult;
      let candidate = null;
      for (let i = 0; i < battleCatalog.length; i++) {
        if (battleCatalog[i].value >= targetVal) { candidate = battleCatalog[i]; break; }
      }
      if (!candidate) candidate = battleCatalog[battleCatalog.length - 1];
      rightSelected = { emoji: candidate.emoji, name: candidate.name, value: candidate.value };
      applySelection();
    }

    async function tryUpgrade() {
      const inv = currentUser?.inventory || [];
      if (selectedLeftIndices.length === 0 || !rightSelected) {
        document.getElementById('upgradeResult').innerHTML = '<span style="color:#f87171">–í—ã–±–µ—Ä–∏—Ç–µ 1‚Äì4 –ø—Ä–µ–¥–º–µ—Ç–∞ –∏ —Ü–µ–ª—å</span>';
        return;
      }
      const selected = selectedLeftIndices.map(i => inv[i]).filter(Boolean);
      const target = rightSelected;
      const total = selected.reduce((sum, it) => sum + (it.value || 0), 0);
      const effectiveBase = total + balanceUse;
      if (!(target.value > effectiveBase)) {
        document.getElementById('upgradeResult').innerHTML = '<span style="color:#f87171">–¶–µ–ª–µ–≤–æ–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Ä–æ–∂–µ –±–∞–∑–æ–≤–æ–≥–æ</span>';
        return;
      }
      const chance = Math.max(1, Math.min(95, (effectiveBase / target.value) * 100));
      const proceed = true;
      let success = false;
      const arc = Math.max(1, Math.min(95, chance)) * 3.6;
      const rollByAngle = (angleIn360) => angleIn360 <= arc;
      const runAnimation = () => new Promise(resolve => {
        if (fastMode) {
          const ringPtr = document.getElementById('ringPointer');
          if (ringPtr) {
            const angleIn360 = Math.random() * 360;
            window.__ringAnimating = true;
            ringPtr.style.transition = 'transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1)';
            ringPtr.style.transform = `rotate(${angleIn360}deg)`;
            setTimeout(() => {
              window.__ringAnimating = false;
              resolve(rollByAngle(angleIn360));
            }, 800);
            return;
          }
          resolve(rollByAngle(Math.random() * 360));
          return;
        }
        const ringPtr = document.getElementById('ringPointer');
        const baseSpins = 5 * 360;
        const angleIn360 = Math.random() * 360;
        const totalAngle = baseSpins + angleIn360;
        if (ringPtr) {
          window.__ringAnimating = true;
          ringPtr.style.transition = 'transform 2.8s cubic-bezier(0.11, 0.89, 0.32, 1.00)';
          ringPtr.style.transform = `rotate(${totalAngle}deg)`;
        }
        setTimeout(() => {
          window.__ringAnimating = false;
          resolve(rollByAngle(angleIn360));
        }, 2800);
      });
      success = await runAnimation();
      {
        const modal = document.getElementById('upgradeResultModal');
        const card = document.getElementById('upgradeResultCard');
        const title = document.getElementById('upgradeResultTitle');
        const text = document.getElementById('upgradeResultText');
        if (modal && card && title && text) {
          card.className = `result-card ${success ? 'success' : 'fail'}`;
          title.className = `result-title ${success ? 'success' : 'fail'}`;
          title.textContent = success ? '–ü–æ–±–µ–¥–∞!' : '–ü—Ä–æ–∏–≥—Ä—ã—à';
          text.textContent = success ? `–ü–æ–ª—É—á–µ–Ω–æ: ${target.value}‚ÇΩ` : '–ü—Ä–µ–¥–º–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω';
          modal.style.display = 'flex';
        }
      }
      await runTransaction(db, async (tx) => {
        const userRef = doc(db, 'users', userId);
        const snap = await tx.get(userRef);
        if (!snap.exists()) throw new Error('user not found');
        const data = snap.data();
        const curInv = Array.isArray(data.inventory) ? data.inventory.slice() : [];
        const toRemove = selected.map(s => ({ emoji: s.emoji, name: s.name, value: s.value }));
        toRemove.forEach(s => {
          const idx = curInv.findIndex(it => it && it.emoji === s.emoji && it.name === s.name && it.value === s.value);
          if (idx !== -1) curInv.splice(idx, 1);
        });
        if (success) {
          curInv.push({
            id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString() + Math.random().toString(16).slice(2)),
            emoji: target.emoji,
            name: target.name,
            value: target.value,
            source: '–ê–ø–≥—Ä–µ–π–¥',
            timestamp: Date.now()
          });
        }
        const newBalance = Math.max(0, ((data.balance || 0) - balanceUse));
        tx.update(userRef, { inventory: curInv, balance: newBalance });
        currentUser.inventory = curInv;
        currentUser.balance = newBalance;
      });
      updateBalance();
      selectedLeftIndices = [];
      balanceUse = 0;
      applySelection();
      updateBalance();
      document.getElementById('upgradeResult').innerHTML = success
        ? `<span style="color:#34d399">–£—Å–ø–µ—Ö! –ü–æ–ª—É—á–µ–Ω–æ: ${target.value}‚ÇΩ</span>`
        : `<span style="color:#f87171">–ù–µ—É–¥–∞—á–∞. –ü—Ä–µ–¥–º–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω.</span>`;
    }

    function bindSelectors() {
      document.getElementById('selectLeft')?.addEventListener('click', () => showSelectModal('left'));
      document.getElementById('selectRight')?.addEventListener('click', () => showSelectModal('right'));
      document.getElementById('upgradeBtn')?.addEventListener('click', tryUpgrade);
      document.getElementById('sortPriceBtn')?.addEventListener('click', () => {
        modalSortAsc = !modalSortAsc;
        document.getElementById('sortPriceBtn').textContent = modalSortAsc ? '–¶–µ–Ω–∞ ‚Üë' : '–¶–µ–Ω–∞ ‚Üì';
        renderModalItems();
      });
      document.getElementById('searchInput')?.addEventListener('input', renderModalItems);
      document.getElementById('closeModalBtn')?.addEventListener('click', () => {
        document.getElementById('selectModal').style.display = 'none';
      });
      document.getElementById('fastMode')?.addEventListener('change', e => {
        fastMode = !!e.target.checked;
      });
      document.querySelectorAll('.mult-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.mult-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentMult = parseFloat(btn.dataset.mult);
          autoSelectTargetByMult();
        });
      });
      document.getElementById('balanceUseRange')?.addEventListener('input', e => {
        balanceUse = Math.floor(parseFloat(e.target.value || '0'));
        document.getElementById('balanceUseText').textContent = balanceUse;
        applySelection();
      });
    }
    window.closeUpgradeResult = function() {
      const modal = document.getElementById('upgradeResultModal');
      if (modal) modal.style.display = 'none';
    };

    function loadCurrentUser() {
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          userId = user.uid;
          const snap = await getDoc(doc(db, 'users', user.uid));
          if (snap.exists()) {
            currentUser = snap.data();
            if (!Array.isArray(currentUser.inventory)) currentUser.inventory = [];
            isGuest = false;
            updateBalance();
            buildBattleCatalog();
            renderInventory();
            applySelection();
          }
        } else {
          const username = localStorage.getItem('dropwin_current_username');
          if (username === '–ì–æ—Å—Ç—å') {
            const users = JSON.parse(localStorage.getItem('dropwin_users')) || [];
            currentUser = users.find(u => u.username === '–ì–æ—Å—Ç—å') || { username: '–ì–æ—Å—Ç—å', balance: 0, inventory: [] };
            isGuest = true;
            updateBalance();
            buildBattleCatalog();
            renderInventory();
            applySelection();
          } else {
            location.href = 'register.html';
          }
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      createParticles();
      loadCurrentUser();
      bindSelectors();
    });
  </script>
</body>
</html>
