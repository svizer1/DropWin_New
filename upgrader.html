<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Upgrader | DropWin</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .upgrade-card {
      max-width: 820px;
      margin: 0 auto;
    }
    .upgrade-container {
      display: grid;
      grid-template-columns: 1fr 220px 1fr;
      gap: 14px;
      align-items: center;
      margin-top: 14px;
    }
    .item-slot {
      background: rgba(30, 30, 50, 0.75);
      border: 2px solid rgba(139, 92, 246, 0.35);
      border-radius: 16px;
      padding: 12px;
      min-height: 200px;
      transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease;
    }
    .item-slot:hover {
      border-color: rgba(139, 92, 246, 0.6);
      box-shadow: 0 10px 24px rgba(99,102,241,0.18);
      transform: translateY(-2px);
    }
    .slot-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #c4b5fd;
      font-weight: 700;
      margin-bottom: 10px;
    }
    .slot-body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .slot-emoji {
      font-size: 3.2rem;
      filter: drop-shadow(0 4px 10px rgba(0,0,0,0.6));
      transition: transform 0.18s ease;
    }
    .slot-name {
      color: #e0e0ff;
      font-weight: 700;
    }
    .slot-value {
      color: #fde047;
      font-weight: 900;
      font-size: 1.05rem;
    }
    .slot-breakdown {
      font-size: 0.72rem;
      color: #94a3b8;
      margin-top: 4px;
      font-weight: 600;
    }
    .slot-breakdown span {
      color: #fbbf24;
    }
    .slot-breakdown .balance-part {
      color: #34d399;
    }
    .select-btn {
      padding: 6px 10px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.16s ease, box-shadow 0.2s ease, filter 0.2s ease;
      min-height: 38px;
      min-width: 38px;
      font-size: 0.95rem;
    }
    .select-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(139,92,246,0.35);
      filter: brightness(1.05);
    }
    .select-btn:active {
      transform: translateY(0);
      filter: brightness(0.95);
    }
    .chance-circle {
      background: rgba(20, 20, 40, 0.9);
      border: 2px solid rgba(99, 102, 241, 0.4);
      border-radius: 20px;
      padding: 16px;
      text-align: center;
    }
    .ring-wrap {
      position: relative;
      width: 160px;
      height: 160px;
      margin: 0 auto 8px auto;
    }
    .ring-svg {
      transform: rotate(-90deg);
    }
    .ring-bg {
      stroke: rgba(99, 102, 241, 0.25);
      stroke-width: 12;
      fill: none;
    }
    .ring-progress {
      stroke: #fbbf24;
      stroke-linecap: round;
      stroke-width: 12;
      fill: none;
      transition: stroke-dashoffset 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    .ring-pointer {
      position: absolute;
      inset: 0;
      transform: rotate(0deg);
      transform-origin: 50% 50%;
      will-change: transform;
      backface-visibility: hidden;
    }
    .ring-pointer-arrow {
      position: absolute;
      top: -2px;
      left: 50%;
      transform: translateX(-50%) rotate(-45deg);
      width: 18px;
      height: 18px;
      background: #ffffff;
      border-radius: 50% 50% 50% 0;
      filter: drop-shadow(0 0 14px rgba(255,255,255,0.95))
              drop-shadow(0 0 8px rgba(255,255,255,0.8))
              drop-shadow(0 2px 6px rgba(0,0,0,0.6));
      z-index: 10;
      animation: arrowPulse 2s ease-in-out infinite;
    }
    .ring-pointer-arrow::before {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 12px;
      height: 12px;
      background: rgba(251,191,36,0.3);
      border-radius: 50% 50% 50% 0;
    }
    @media (max-width: 520px) {
      .ring-pointer-arrow {
        width: 16px;
        height: 16px;
      }
      .ring-pointer-arrow::before {
        width: 10px;
        height: 10px;
      }
    }
    @media (max-width: 380px) {
      .ring-pointer-arrow {
        width: 14px;
        height: 14px;
      }
      .ring-pointer-arrow::before {
        width: 9px;
        height: 9px;
        top: 2px;
        left: 2px;
      }
    }
    @keyframes arrowPulse {
      0%, 100% {
        filter: drop-shadow(0 0 14px rgba(255,255,255,0.95))
                drop-shadow(0 0 8px rgba(255,255,255,0.8))
                drop-shadow(0 2px 6px rgba(0,0,0,0.6));
      }
      50% {
        filter: drop-shadow(0 0 22px rgba(255,255,255,1))
                drop-shadow(0 0 14px rgba(255,255,255,0.95))
                drop-shadow(0 2px 6px rgba(0,0,0,0.6));
      }
    }
    .fast-toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
      margin-top: 8px;
      color: #c4b5fd;
      font-weight: 700;
    }
    .fast-toggle input {
      width: 44px;
      height: 24px;
      appearance: none;
      background: #4b5563;
      border-radius: 12px;
      position: relative;
      outline: none;
      cursor: pointer;
    }
    .fast-toggle input:checked {
      background: #22c55e;
    }
    .fast-toggle input::after {
      content: '';
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      position: absolute;
      top: 3px;
      left: 4px;
      transition: left 0.2s ease;
    }
    .fast-toggle input:checked::after {
      left: 22px;
    }
    .mult-row {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
      margin-top: 10px;
    }
    .mult-btn {
      padding: 6px 0;
      border-radius: 10px;
      border: none;
      background: rgba(99,102,241,0.25);
      color: #e5e7eb;
      font-weight: 800;
      cursor: pointer;
      transition: transform 0.14s ease, background 0.2s ease, box-shadow 0.2s ease;
      min-height: 36px;
      font-size: 0.9rem;
    }
    .mult-btn:hover {
      transform: translateY(-1px);
      background: rgba(99,102,241,0.35);
      box-shadow: 0 8px 16px rgba(99,102,241,0.25);
    }
    .mult-btn.active {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
    }
    .balance-use {
      margin-top: 10px;
      color: #c4b5fd;
      font-weight: 700;
    }
    .balance-use input[type="range"] {
      width: 100%;
    }
    .spin-type-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 4px;
      margin-top: 10px;
    }
    .spin-type-btn {
      padding: 4px 0;
      border-radius: 8px;
      border: none;
      background: rgba(99,102,241,0.25);
      color: #e5e7eb;
      font-weight: 800;
      cursor: pointer;
      transition: transform 0.14s ease, background 0.2s ease, box-shadow 0.2s ease;
      min-height: 28px;
      font-size: 0.8rem;
      font-size: 0.9rem;
    }
    .spin-type-btn:hover {
      transform: translateY(-1px);
      background: rgba(99,102,241,0.35);
      box-shadow: 0 8px 16px rgba(99,102,241,0.25);
    }
    .spin-type-btn.active {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
    }
    @media (max-width: 860px) {
      .upgrade-container {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .ring-wrap {
        width: 140px;
        height: 140px;
      }
      .ring-svg {
        width: 140px;
        height: 140px;
      }
      .ring-bg, .ring-progress {
        cx: 70;
        cy: 70;
        r: 56;
      }
      .ring-progress {
        stroke-width: 10;
      }
      .ring-bg {
        stroke-width: 10;
      }
      .chance-percent {
        font-size: 1.6rem;
      }
      .mult-row {
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
      }
      .mult-btn {
        font-size: 0.95rem;
        padding: 10px 0;
      }
      .chance-circle {
        padding: 12px;
      }
    }
    @media (max-width: 520px) {
      .upgrade-container {
        grid-template-columns: 1fr;
        gap: 16px; /* Increased gap */
      }
      .item-slot {
        min-height: 160px;
        padding: 16px; /* Increased padding */
        border-width: 2px;
      }
      .slot-emoji {
        font-size: 3.5rem; /* Larger emoji */
        margin-bottom: 8px;
      }
      .slot-header {
        font-size: 1rem;
        flex-direction: row; /* Keep row for better space usage */
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }
      .select-btn {
        padding: 10px 18px; /* Larger button */
        font-size: 1rem;
        min-height: 48px;
        width: auto;
      }
      .ring-wrap {
        width: 150px; /* Larger ring */
        height: 150px;
        margin-bottom: 12px;
      }
      .ring-svg {
        width: 150px;
        height: 150px;
      }
      .ring-bg, .ring-progress {
        cx: 75;
        cy: 75;
        r: 60;
      }
      .chance-percent {
        font-size: 1.8rem;
      }
      .mult-row {
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        overflow-x: auto; /* Scroll if too tight */
        padding-bottom: 4px;
      }
      .mult-btn {
        font-size: 1rem;
        padding: 12px 0;
        min-height: 52px;
      }
      .spin-type-btn {
        min-height: 36px;
        font-size: 1rem;
      }
      .upgrade-btn {
        font-size: 1.2rem;
        padding: 16px;
        min-height: 60px; /* Big action button */
        margin-top: 16px;
      }
      /* Hide inventory initially or make it collapsible if too long? No, just grid */
      .inventory-grid {
        grid-template-columns: repeat(3, 1fr); /* 3 cols on mobile */
        gap: 8px;
      }
      .selected-list {
        grid-template-columns: repeat(3, 1fr);
      }
      .modal-actions {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      .modal-controls {
        width: 100%;
      }
    }
    @media (max-width: 380px) {
        .inventory-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 380px) {
      .selected-list { grid-template-columns: repeat(2, 1fr); }
      .ring-wrap {
        width: 120px;
        height: 120px;
      }
      .ring-svg {
        width: 120px;
        height: 120px;
      }
      .ring-bg, .ring-progress {
        cx: 60;
        cy: 60;
        r: 48;
      }
      .ring-progress {
        stroke-width: 8;
      }
      .ring-bg {
        stroke-width: 8;
      }
      .chance-percent {
        font-size: 1.3rem;
      }
      .slot-emoji {
        font-size: 2.5rem;
      }
      .select-btn {
        font-size: 0.9rem;
        padding: 10px 12px;
      }
      .mult-row {
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
      }
      .mult-btn {
        font-size: 0.85rem;
        min-height: 46px;
      }
      .upgrade-btn {
        font-size: 1rem;
        min-height: 48px;
      }
      .inv-emoji {
        font-size: 2rem;
      }
      .inv-name {
        font-size: 0.85rem;
      }
    }
    button, .select-btn, .mult-btn, .upgrade-btn, .result-btn, .modal-actions .btn {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .chance-percent {
      font-size: 1.6rem;
      font-weight: 900;
      color: #34d399;
    }
    .chance-label {
      color: #c4b5fd;
      margin-top: 6px;
      font-weight: 700;
    }
    .upgrade-btn {
      margin-top: 12px;
      width: 100%;
      padding: 8px 14px;
      border: none;
      border-radius: 14px;
      background: linear-gradient(135deg, #fbbf24, #d97706);
      color: white;
      font-weight: 900;
      cursor: pointer;
      transition: transform 0.16s ease, box-shadow 0.2s ease, filter 0.2s ease;
      min-height: 40px;
      font-size: 0.95rem;
    }
    .upgrade-btn:hover { transform: translateY(-1px); box-shadow: 0 12px 24px rgba(217,119,6,0.25); filter: brightness(1.05); }
    .upgrade-btn:active { transform: translateY(0); filter: brightness(0.95); }
    .upgrade-btn:disabled { opacity: 0.65; cursor: not-allowed; filter: grayscale(0.2); }
    .inventory-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
      gap: 10px;
      margin-top: 18px;
    }
    .section-title {
      margin-top: 18px;
      margin-bottom: 8px;
      color: #c4b5fd;
      font-weight: 800;
    }
    .inventory-item {
      background: rgba(28, 26, 60, 0.8);
      border: 2px solid rgba(139, 92, 246, 0.25);
      border-radius: 12px;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.16s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    }
    .inventory-item.active {
      border-color: #d946ef;
      box-shadow: 0 0 16px rgba(217, 70, 239, 0.6);
    }
    .inventory-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 18px rgba(139,92,246,0.25);
      border-color: rgba(139,92,246,0.5);
    }
    .inv-emoji { font-size: 2.2rem; }
    .inv-name { color: #e0e0ff; font-weight: 700; font-size: 0.95rem; }
    .inv-value { color: #fde047; font-weight: 800; }
    .item-visual { height: 60px; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; }
    .item-visual img { width: 80%; height: 100%; object-fit: contain; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.4)); }
    .selected-list {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      width: 100%;
    }
    .selected-item {
      background: rgba(28, 26, 60, 0.8);
      border: 1px solid rgba(139, 92, 246, 0.35);
      border-radius: 10px;
      padding: 6px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .selected-emoji { font-size: 1.6rem; }
    .selected-value { color: #fde047; font-weight: 800; font-size: 0.9rem; }
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.85);
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.12s ease;
    }
    .modal[style*="display: flex"] { opacity: 1; }
    .modal-body {
      background: #15142a;
      border: 2px solid rgba(139,92,246,0.35);
      border-radius: 16px;
      padding: 16px;
      max-width: 920px;
      width: 92%;
      max-height: 80vh;
      overflow: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
      animation: modalPop 0.12s ease;
    }
    .result-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.7);
      z-index: 10000;
    }
    .result-card {
      background: #0f172a;
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 16px;
      padding: 18px;
      min-width: 280px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.6);
      animation: modalPop 0.12s ease;
    }
    .result-card.success { border-color: rgba(34,197,94,0.55); }
    .result-card.fail { border-color: rgba(248,113,113,0.55); }
    .result-title { font-weight: 900; margin-bottom: 6px; }
    .result-title.success { color: #22c55e; }
    .result-title.fail { color: #ef4444; }
    .result-text { color: #e5e7eb; }
    .result-btn {
      margin-top: 12px;
      padding: 8px 12px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #64748b, #475569);
      color: white;
      font-weight: 700;
      cursor: pointer;
      min-height: 44px;
      min-width: 44px;
    }
    .modal-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .modal-controls {
      display: flex;
      gap: 8px;
      align-items: center;
      width: 60%;
    }
    .modal-actions .btn {
      padding: 8px 12px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #64748b, #475569);
      color: white;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.14s ease, box-shadow 0.2s ease, filter 0.2s ease;
      min-height: 44px;
      min-width: 44px;
    }
    .modal-actions .btn:hover { transform: translateY(-1px); box-shadow: 0 8px 16px rgba(100,116,139,0.35); filter: brightness(1.05); }
    .modal-actions .btn:active { transform: translateY(0); filter: brightness(0.95); }
    .price-btn {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      border: 2px solid rgba(139,92,246,0.6);
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(139,92,246,0.35);
      letter-spacing: 0.2px;
    }
    .price-btn:hover { box-shadow: 0 12px 24px rgba(139,92,246,0.45); filter: brightness(1.06); }
    .price-btn:active { transform: translateY(0); filter: brightness(0.95); }
    .modal-actions input {
      flex: 1;
      margin-left: 8px;
      padding: 10px 14px;
      border-radius: 10px;
      border: 2px solid rgba(139, 92, 246, 0.3);
      background: rgba(15,23,42,0.9);
      color: #ffffff;
      font-size: 0.95rem;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .modal-actions input::placeholder {
      color: rgba(255,255,255,0.4);
    }
    .modal-actions input:focus {
      outline: none;
      border-color: #8b5cf6;
      background: rgba(15,23,42,1);
      box-shadow: 0 0 0 4px rgba(139,92,246,0.2), 0 0 20px rgba(139,92,246,0.3);
      transform: translateY(-1px);
    }
    .search-indicator {
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: #8b5cf6;
      font-weight: 700;
      font-size: 0.85rem;
      opacity: 0;
      transition: opacity 0.2s ease;
      pointer-events: none;
    }
    .search-indicator.active {
      opacity: 1;
    }
    .modal-search-wrapper {
      position: relative;
      flex: 1;
      margin-left: 8px;
    }

    @keyframes modalPop { from { transform: translateY(6px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
  </head>
<body>
  <div class="particles" id="particles"></div>

  <div class="header">
    <div class="logo" onclick="location.href='index.html'" style="cursor: pointer;">üíé DROPWIN</div>
    <button class="hamburger" id="hamburgerBtn"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>
    <div class="balance-container">
      <div class="balance">üí∞ <span id="balance">0</span>‚ÇΩ</div>
      <button class="auth-btn" id="authBtn">–ê–∫–∫–∞—É–Ω—Ç</button>
      <button class="auth-btn" onclick="window.open('https://t.me/DropWinHelp_bot','_blank')">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</button>
    </div>
  </div>

  <div class="content">
    <button class="back-btn" onclick="location.href='index.html'">‚Üê –ù–∞–∑–∞–¥</button>

    <div class="game-card upgrade-card">
      <div class="game-title">‚öôÔ∏è Upgrader</div>

      <div class="upgrade-container">
        <div class="item-slot" id="leftSlot">
          <div class="slot-header">
            <span>–ë–∞–∑–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç</span>
            <button class="select-btn" id="selectLeft">–í—ã–±—Ä–∞—Ç—å</button>
          </div>
          <div class="slot-body">
            <div class="slot-emoji" id="leftEmoji">‚ùì</div>
            <div class="slot-name" id="leftName">–ù–µ –≤—ã–±—Ä–∞–Ω</div>
            <div class="slot-value" id="leftValue">0‚ÇΩ</div>
            <div class="slot-breakdown" id="leftBreakdown"></div>
            <div class="selected-list" id="leftSelectedList"></div>
          </div>
        </div>
        <div class="chance-circle">
          <div class="ring-wrap">
            <svg class="ring-svg" width="160" height="160">
              <circle class="ring-bg" cx="80" cy="80" r="64"></circle>
              <circle class="ring-progress" id="ringProgress" cx="80" cy="80" r="64" stroke-dasharray="402" stroke-dashoffset="402"></circle>
            </svg>
            <div class="ring-pointer" id="ringPointer">
              <div class="ring-pointer-arrow"></div>
            </div>
            <div class="chance-percent" id="chancePercent" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);">0%</div>
          </div>
          <div class="chance-label">–®–∞–Ω—Å —É–ª—É—á—à–µ–Ω–∏—è</div>
          <button class="upgrade-btn" id="upgradeBtn">–£–ª—É—á—à–∏—Ç—å</button>
          <div class="fast-toggle">
            <span>–ë—ã—Å—Ç—Ä–æ</span>
            <input type="checkbox" id="fastMode">
          </div>
          <div class="spin-type-row">
            <button class="spin-type-btn active" data-type="normal">–û–±—ã—á</button>
            <button class="spin-type-btn" data-type="degen">–õ—É–¥</button>
            <button class="spin-type-btn" data-type="bait">–ê–∑–∞—Ä—Ç</button>
          </div>
          <div class="mult-row">
            <button class="mult-btn" data-mult="1.5">x1.5</button>
            <button class="mult-btn" data-mult="2">x2</button>
            <button class="mult-btn" data-mult="3">x3</button>
            <button class="mult-btn" data-mult="5">x5</button>
            <button class="mult-btn" data-mult="10">x10</button>
          </div>
          <div class="balance-use">
            <div>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–∞–ª–∞–Ω—Å –Ω–∞: <span id="balanceUseText">0</span>‚ÇΩ</div>
            <input type="range" id="balanceUseRange" min="0" max="0" step="1" value="0">
          </div>
        </div>
        <div class="item-slot" id="rightSlot">
          <div class="slot-header">
            <span>–¶–µ–ª–µ–≤–æ–π –ø—Ä–µ–¥–º–µ—Ç</span>
            <button class="select-btn" id="selectRight">–í—ã–±—Ä–∞—Ç—å</button>
          </div>
          <div class="slot-body">
            <div class="slot-emoji" id="rightEmoji">‚ùì</div>
            <div class="slot-name" id="rightName">–ù–µ –≤—ã–±—Ä–∞–Ω</div>
            <div class="slot-value" id="rightValue">0‚ÇΩ</div>
            <div class="slot-breakdown" id="rightBreakdown"></div>
          </div>
        </div>
      </div>

      <div id="inventoryContainer"></div>
      <div id="upgradeResult" style="text-align:center; margin-top:14px; min-height:28px;"></div>
      <div class="result-modal" id="upgradeResultModal">
        <div class="result-card" id="upgradeResultCard">
          <div class="result-title" id="upgradeResultTitle">‚Äî</div>
          <div class="result-text" id="upgradeResultText">‚Äî</div>
          <button class="result-btn" onclick="closeUpgradeResult()">–û–∫</button>
        </div>
      </div>
    </div>

    <div class="modal" id="selectModal">
      <div class="modal-body">
        <div class="modal-actions">
          <div class="section-title" id="modalTitle">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</div>
          <div class="modal-controls">
            <button class="btn price-btn" id="sortPriceBtn">–¶–µ–Ω–∞ ‚ÇΩ ‚Üë</button>
            <div class="modal-search-wrapper">
              <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ —Ü–µ–Ω–µ">
              <span class="search-indicator" id="searchIndicator">üîç</span>
            </div>
            <button class="btn" id="closeModalBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        </div>
        <div class="inventory-grid" id="modalItemsGrid"></div>
      </div>
    </div>
  </div>

  <div class="nav">
    <button class="nav-btn" onclick="location.href='index.html'"><span>üè†</span><span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span></button>
    <button class="nav-btn" onclick="location.href='inventory.html'"><span>üéí</span><span class="nav-label">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</span></button>
    <button class="nav-btn" onclick="location.href='profile.html'"><span>üë§</span><span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span></button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBVra2JN-C7-1b_Qa4cU8--XvJ83lymiM8",
      authDomain: "dropwin-8d94b.firebaseapp.com",
      projectId: "dropwin-8d94b",
      storageBucket: "dropwin-8d94b.firebasestorage.app",
      messagingSenderId: "988974289403",
      appId: "1:988974289403:web:886d34e6f65920a105fb5e",
      measurementId: "G-BK010MHN8N"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const hb = document.getElementById('hamburgerBtn');
    const overlay = document.getElementById('mobileMenuOverlay');
    function toggleDrawer() {
        document.body.classList.toggle('drawer-open');
        hb && hb.classList.toggle('active');
    }
    if(hb) hb.addEventListener('click', toggleDrawer);
    if(overlay) overlay.addEventListener('click', toggleDrawer);

    let currentUser = null;
    let userId = null;
    let isGuest = false;
    let leftIndex = null;
    let rightIndex = null;
    let modalMode = null;
    let modalSortAsc = true;
    let invSortAsc = true;
    let modalItems = [];
    let fastMode = false;
    let currentMult = null;
    let balanceUse = 0;
    let battleCatalog = [];
    let rightSelected = null;
    let selectedLeftIndices = [];
    let spinType = 'normal';
    let isUpgrading = false;
    const audioCtx = typeof window !== 'undefined' && (window.AudioContext || window.webkitAudioContext) ? new (window.AudioContext || window.webkitAudioContext)() : null;
    function playTick(freq=1200, vol=0.06, dur=0.09) {
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'square';
      osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
      gain.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(vol, audioCtx.currentTime + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + Math.max(0.08, dur));
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + Math.max(0.09, dur));
    }
    function playSpinStart() {
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(220, audioCtx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(440, audioCtx.currentTime + 0.25);
      gain.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.08, audioCtx.currentTime + 0.05);
      gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.4);
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.42);
    }
    function playNearHit() {
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(800, audioCtx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.18);
      gain.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.07, audioCtx.currentTime + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.22);
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.24);
    }
    function playWinSound() {
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(500, audioCtx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.35);
      gain.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.08, audioCtx.currentTime + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.5);
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.52);
    }
    function playLoseSound() {
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(300, audioCtx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(180, audioCtx.currentTime + 0.25);
      gain.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.06, audioCtx.currentTime + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.4);
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.42);
    }
    function startTickLoop(ms, mode='normal') {
      const start = performance.now();
      let interval = 110;
      let pitch = 900;
      if (mode === 'degen') interval = 90;
      if (mode === 'bait') interval = 120;
      const id = setInterval(() => {
        const elapsed = performance.now() - start;
        if (elapsed >= ms) { clearInterval(id); return; }
        pitch = Math.min(1500, pitch + 20);
        playTick(pitch, 0.05);
      }, interval);
      return id;
    }

    function createParticles() {
      const container = document.getElementById('particles');
      if (!container) return;
      const isMobile = (window.matchMedia && window.matchMedia('(pointer:coarse)').matches) || window.innerWidth < 768;
      const count = isMobile ? 18 : 40;
      for (let i = 0; i < count; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.width = p.style.height = Math.random() * 3 + 1 + 'px';
        p.style.left = Math.random() * 100 + '%';
        p.style.animationDuration = Math.random() * 12 + 8 + 's';
        p.style.animationDelay = Math.random() * 5 + 's';
        container.appendChild(p);
      }
    }

    function updateBalance() {
      document.getElementById('balance').textContent = currentUser ? (currentUser.balance || 0) : 0;
      const btn = document.getElementById('authBtn');
      btn.textContent = isGuest ? '–ì–æ—Å—Ç—å' : (currentUser ? currentUser.username : '–í–æ–π—Ç–∏');
      btn.onclick = () => location.href = 'profile.html';
    }

    async function saveUser() {
      if (isGuest) {
        let users = JSON.parse(localStorage.getItem('dropwin_users')) || [];
        const idx = users.findIndex(u => u.username === '–ì–æ—Å—Ç—å');
        if (idx !== -1) users[idx] = currentUser;
        localStorage.setItem('dropwin_users', JSON.stringify(users));
      } else if (userId) {
        await updateDoc(doc(db, 'users', userId), {
          balance: currentUser.balance || 0,
          inventory: currentUser.inventory || []
        });
      }
    }

    function isBattleItem(item) {
      return (item && typeof item.source === 'string') && item.source.includes('–ë–∞—Ç—Ç–ª');
    }
    function resolveItemImage(item) {
      let imgSrc = (item && (item.img || item.image)) || '';
      const name = (item && item.name) || '';
      if (!imgSrc) {
        if (name.includes('–°–∞–Ω—Ç–∞')) imgSrc = 'images/Santa.png';
        else if (name.includes('–ë–æ–º–∂')) imgSrc = 'images/bomj.png';
        else if (name.includes('–®–∫–æ–ª—å–Ω–∏–∫')) imgSrc = 'images/schoolboy.png';
        else if (name.includes('–î–≤–æ—Ä–Ω–∏–∫')) imgSrc = 'images/dvornik.png';
        else if (name.includes('–ú–∏–ª–ª–∏–æ–Ω–µ—Ä')) imgSrc = 'images/milioner.png';
        else imgSrc = 'images/games/shoot.png';
      }
      return imgSrc;
    }

    const cases = {
      agent: {
        price: 69,
        items: [
            {emoji: 'üßî', name: '–ë–æ–º–∂', value: 10},
            {emoji: 'üë¶', name: '–ü–∞—Ü–∞–Ω', value: 60},
            {emoji: 'üßë', name: '–ß–µ–ª–æ–≤–µ–∫', value: 150},
            {emoji: 'üßô‚Äç‚ôÇÔ∏è', name: '–ì–Ω–æ–º', value: 300}
        ]
      },
      background: {
        price: 49,
        items: [
            {emoji: 'üèôÔ∏è', name: '–ì–æ—Ä–æ–¥', value: 25},
            {emoji: 'üå®Ô∏è', name: '–°–Ω–µ–≥', value: 50},
            {emoji: 'üèúÔ∏è', name: '–ü—É—Å—Ç—ã–Ω—è', value: 100},
            {emoji: 'üå≤', name: '–õ–µ—Å', value: 250}
        ]
      },
      keychain: {
        price: 29,
        items: [
            {emoji: 'üîë', name: '–ë—Ä–µ–ª–æ–∫-–∫–ª—é—á', value: 10},
            {emoji: 'üêæ', name: '–ë—Ä–µ–ª–æ–∫ –ª–∞–ø–∫–∞', value: 20},
            {emoji: 'üéñÔ∏è', name: '–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–π –±—Ä–µ–ª–æ–∫', value: 50},
            {emoji: 'üíé', name: '–†–µ–¥–∫–∏–π –±—Ä–µ–ª–æ–∫', value: 120},
            {emoji: 'üåü', name: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –±—Ä–µ–ª–æ–∫', value: 400}
        ]
      },
      skin: {
        price: 99,
        items: [
            {emoji: 'üî´', name: '–°—Ç–∞–Ω–¥–∞—Ä—Ç', value: 30},
            {emoji: 'üé®', name: '–ì—Ä–∞—Ñ—Ñ–∏—Ç–∏', value: 100},
            {emoji: '‚ú®', name: '–°–Ω–µ–∂–Ω—ã–π', value: 180},
            {emoji: 'üåü', name: '–ó–æ–ª–æ—Ç–æ–π', value: 500}
        ]
      },
      bomj: { price: 5, items: [
        {emoji:'üß¶',name:'–î—ã—Ä—è–≤—ã–π –Ω–æ—Å–æ–∫',value:1},
        {emoji:'üçû',name:'–ß—ë—Ä—Å—Ç–≤—ã–π —Ö–ª–µ–±',value:2},
        {emoji:'üóëÔ∏è',name:'–ú—É—Å–æ—Ä–Ω—ã–π –ø–∞–∫–µ—Ç',value:3},
        {emoji:'üç∫',name:'–¢—ë–ø–ª–æ–µ –ø–∏–≤–æ 0.5',value:5},
        {emoji:'ü™ô',name:'–ì–æ—Ä—Å—Ç–∫–∞ –º–µ–ª–æ—á–∏',value:10},
        {emoji:'üß•',name:'–°—Ç–∞—Ä–∞—è –∫—É—Ä—Ç–∫–∞',value:20},
        {emoji:'üì±',name:'–°–ª–æ–º–∞–Ω–Ω—ã–π Nokia',value:40},
        {emoji:'üí∏',name:'–ó–∞–Ω–∞—á–∫–∞ –ø–æ–¥ –º–∞—Ç—Ä–∞—Å–æ–º',value:80},
      ]},
      vibe: { price: 45, items: [
        {emoji:'üíñ',name:'–°–µ—Ä–¥—Ü–µ',value:6},
        {emoji:'üåπ',name:'–†–æ–∑–∞',value:10},
        {emoji:'üöÄ',name:'–†–∞–∫–µ—Ç–∞',value:20},
        {emoji:'üíê',name:'–¶–≤–µ—Ç—ã',value:20},
        {emoji:'üíç',name:'–ö–æ–ª—å—Ü–æ',value:40},
        {emoji:'üíé',name:'–ê–ª–º–∞–∑',value:40},
        {emoji:'üç≠',name:'–õ–æ–ª-–ø–æ–ø',value:120},
        {emoji:'üê∂',name:'–°—É–ø –î–æ–≥',value:180},
        {emoji:'ü§°',name:'–®–∞–ø–∫–∞ —à—É—Ç–∞',value:200},
        {emoji:'‚≠ê',name:'–ó–≤–µ–∑–¥–∞',value:80},
      ]},
      santa: { price: 49, items: [
        {emoji:'üç™',name:'–ü–µ—á–µ–Ω—å–µ',value:10},
        {emoji:'ü•õ',name:'–ú–æ–ª–æ–∫–æ',value:25},
        {emoji:'üéÖ',name:'–ö–æ–ª–ø–∞–∫',value:50},
        {emoji:'ü¶å',name:'–û–ª–µ–Ω—å',value:120},
        {emoji:'üéÅ',name:'–ë–æ–ª—å—à–æ–π –ø–æ–¥–∞—Ä–æ–∫',value:400},
      ]},
      c2024: {
        price: 599,
        items: [
            {emoji: 'üêâ', name: '–î—Ä–∞–∫–æ–Ω', value: 120},
            {emoji: 'üçæ', name: '–®–∞–º–ø–∞–Ω—Å–∫–æ–µ', value: 250},
            {emoji: 'üéÅ', name: '–ü–æ–¥–∞—Ä–æ–∫ 2024', value: 500},
            {emoji: 'üëë', name: '–ö–æ—Ä–æ–Ω–∞', value: 1000},
            {emoji: 'üíé', name: '–ê–ª–º–∞–∑', value: 2000},
            {emoji: 'üè∞', name: '–ó–∞–º–æ–∫', value: 6000}
        ]
      },
      c2025: {
        price: 399,
        items: [
            {emoji: 'üêç', name: '–ó–º–µ—è', value: 80},
            {emoji: 'üéä', name: '–•–ª–æ–ø—É—à–∫–∞', value: 150},
            {emoji: 'üé´', name: '–ë–∏–ª–µ—Ç 2025', value: 300},
            {emoji: 'ü§ñ', name: '–ö–∏–±–µ—Ä-–ó–º–µ—è', value: 800},
            {emoji: 'üöÄ', name: '–†–∞–∫–µ—Ç–∞', value: 1500}
        ]
      },
      battle: { price: 99, items: [
        {emoji:'üõ°Ô∏è',name:'–©–∏—Ç',value:20},
        {emoji:'‚öîÔ∏è',name:'–ú–µ—á',value:40},
        {emoji:'üíä',name:'–ê–ø—Ç–µ—á–∫–∞',value:80},
        {emoji:'üî´',name:'–ü–∏—Å—Ç–æ–ª–µ—Ç',value:150},
        {emoji:'üí£',name:'–ì—Ä–∞–Ω–∞—Ç–∞',value:300},
        {emoji:'üöÅ',name:'–í–µ—Ä—Ç–æ–ª–µ—Ç',value:800},
      ]},
      dvornik:{ price:9, items:[
        {emoji:'üßπ',name:'–ú–µ—Ç–ª–∞',value:2},
        {emoji:'ü™£',name:'–í–µ–¥—Ä–æ',value:4},
        {emoji:'üßº',name:'–ú—ã–ª–æ',value:6},
        {emoji:'ü™ì',name:'–¢–æ–ø–æ—Ä —Å—Ç–∞—Ä—ã–π',value:12},
        {emoji:'üß§',name:'–ü–µ—Ä—á–∞—Ç–∫–∏ —Ä–∞–±–æ—á–∏–µ',value:20},
        {emoji:'‚õèÔ∏è',name:'–õ–æ–ø–∞—Ç–∞',value:30},
        {emoji:'üõ†Ô∏è',name:'–ù–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤',value:60},
        {emoji:'üö≤',name:'–í–µ–ª–æ—Å–∏–ø–µ–¥ –±/—É',value:150},
      ]},
      schoolboy:{ price:99, items:[
        {emoji:'üìö',name:'–£—á–µ–±–Ω–∏–∫',value:30},
        {emoji:'üéí',name:'–†—é–∫–∑–∞–∫',value:60},
        {emoji:'üì±',name:'–°–º–∞—Ä—Ç—Ñ–æ–Ω',value:300},
        {emoji:'üíª',name:'–ù–æ—É—Ç–±—É–∫',value:500},
        {emoji:'üéÆ',name:'PlayStation',value:800},
        {emoji:'üöó',name:'–ú–∞—à–∏–Ω–∫–∞',value:1000},
        {emoji:'üè†',name:'–ö–≤–∞—Ä—Ç–∏—Ä–∞',value:3000},
      ]},
      event:{ price:199, items:[
        {emoji:'üéâ',name:'–ö–æ–Ω—Ñ–µ—Ç—Ç–∏',value:80},
        {emoji:'üéÅ',name:'–ü–æ–¥–∞—Ä–æ–∫',value:150},
        {emoji:'üéà',name:'–í–æ–∑–¥—É—à–Ω—ã–π —à–∞—Ä',value:250},
        {emoji:'üçæ',name:'–®–∞–º–ø–∞–Ω—Å–∫–æ–µ',value:400},
        {emoji:'üé§',name:'–ú–∏–∫—Ä–æ—Ñ–æ–Ω',value:600},
        {emoji:'üé¨',name:'–ö–∏–Ω–æ',value:1000},
        {emoji:'‚úàÔ∏è',name:'–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ',value:2000},
      ]},
      milioner: { price: 590, items: [
        {emoji: 'üíµ', name: '–î–µ–Ω—å–≥–∏', value: 150},
        {emoji: 'üè¶', name: '–ë–∞–Ω–∫', value: 350},
        {emoji: 'üí∞', name: '–ú–µ—à–æ–∫ –¥–µ–Ω–µ–≥', value: 700},
        {emoji: 'üìà', name: '–ì—Ä–∞—Ñ–∏–∫ —Ä–æ—Å—Ç–∞', value: 1200},
        {emoji: 'ü§ë', name: '–ú–∏–ª–ª–∏–æ–Ω–µ—Ä', value: 2000},
        {emoji: 'üöÄ', name: '–†–∞–∫–µ—Ç–∞', value: 4000},
        {emoji: 'üè∞', name: '–î–≤–æ—Ä–µ—Ü', value: 12000},
      ]},
      neoprime: { price: 990, items: [
        {emoji: 'üí°', name: '–ù–µ–æ–Ω–æ–≤–∞—è –ª–∞–º–ø–∞', value: 300},
        {emoji: 'üíæ', name: '–ö–∏–±–µ—Ä-—á–∏–ø', value: 600},
        {emoji: 'ü•Ω', name: 'VR-–æ—á–∫–∏', value: 1000},
        {emoji: 'üöÅ', name: '–î—Ä–æ–Ω', value: 1500},
        {emoji: 'ü§ñ', name: '–†–æ–±–æ—Ç', value: 2500},
        {emoji: 'üöö', name: '–ö–∏–±–µ—Ä-—Ç—Ä–∞–∫', value: 5000},
        {emoji: 'üåå', name: 'Neo Prime', value: 15000},
      ]},
      grinch: { price: 750, items: [
        {emoji: 'üßÖ', name: '–õ—É–∫', value: 150},
        {emoji: 'üêï', name: '–ú–∞–∫—Å', value: 400},
        {emoji: 'üéÑ', name: '–£–∫—Ä–∞–¥–µ–Ω–Ω–∞—è –µ–ª–∫–∞', value: 750},
        {emoji: 'üéÅ', name: '–ß—É–∂–∏–µ –ø–æ–¥–∞—Ä–∫–∏', value: 1500},
        {emoji: 'üíö', name: '–°–µ—Ä–¥—Ü–µ –ì—Ä–∏–Ω—á–∞', value: 4000},
      ]},
      maldives: { price: 1290, items: [
        {emoji: 'üêö', name: '–†–∞–∫—É—à–∫–∞', value: 350},
        {emoji: 'ü••', name: '–ö–æ–∫–æ—Å', value: 800},
        {emoji: 'üçπ', name: '–ö–æ–∫—Ç–µ–π–ª—å', value: 1200},
        {emoji: 'üå¥', name: '–ü–∞–ª—å–º–∞', value: 2000},
        {emoji: 'üö§', name: '–ì–∏–¥—Ä–æ—Ü–∏–∫–ª', value: 4000},
        {emoji: 'üè†', name: '–ë—É–Ω–≥–∞–ª–æ', value: 8000},
        {emoji: 'üèùÔ∏è', name: '–õ–∏—á–Ω—ã–π –æ—Å—Ç—Ä–æ–≤', value: 25000},
      ]},
      elka: { price: 150, items: [
        {emoji: '‚ùÑÔ∏è', name: '–°–Ω–µ–∂–∏–Ω–∫–∞', value: 20},
        {emoji: 'üç¨', name: '–õ–µ–¥–µ–Ω–µ—Ü', value: 40},
        {emoji: 'üéÑ', name: '–ì–∏—Ä–ª—è–Ω–¥–∞', value: 90},
        {emoji: '‚≠ê', name: '–ó–≤–µ–∑–¥–∞', value: 180},
        {emoji: 'üéÖ', name: '–®–∞–ø–∫–∞ –°–∞–Ω—Ç—ã', value: 350},
        {emoji: 'üçæ', name: '–®–∞–º–ø–∞–Ω—Å–∫–æ–µ', value: 600},
        {emoji: 'üéÜ', name: '–§–µ–π–µ—Ä–≤–µ—Ä–∫', value: 2000},
      ]},
      snowman: { price: 1290, items: [
        {emoji: 'ü•ï', name: '–ú–æ—Ä–∫–æ–≤–∫–∞', value: 180},
        {emoji: 'üß£', name: '–®–∞—Ä—Ñ', value: 350},
        {emoji: 'üõ∑', name: '–°–∞–Ω–∫–∏', value: 600},
        {emoji: '‚õ∏Ô∏è', name: '–ö–æ–Ω—å–∫–∏', value: 1250},
        {emoji: 'üå®Ô∏è', name: '–°–Ω–µ–≥–æ—Ö–æ–¥', value: 3000},
        {emoji: 'üßä', name: '–õ–µ–¥—è–Ω–æ–π —Ç—Ä–æ–Ω', value: 6000},
        {emoji: 'üè∞', name: '–õ–µ–¥—è–Ω–æ–π –¥–≤–æ—Ä–µ—Ü', value: 20000},
      ]},
    };

    function buildBattleCatalog() {
      const res = [];
      Object.keys(cases).forEach(key => {
        cases[key].items.forEach(it => {
          res.push({ emoji: it.emoji, name: it.name, value: it.value, source: '–ë–∞—Ç—Ç–ª:'+key });
        });
      });
      res.sort((a,b) => a.value - b.value);
      battleCatalog = res;
    }

    function renderInventory() {
      const container = document.getElementById('inventoryContainer');
      const allInv = currentUser?.inventory || [];
      const inventory = allInv;
      if (inventory.length === 0) {
        container.innerHTML = `
          <div class="empty-inventory">
            <div class="empty-icon">üì¶</div>
            <h3>–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∏–∑ –±–∞—Ç—Ç–ª–æ–≤</h3>
            <p style="margin-top: 12px;">–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –ø—Ä–µ–¥–º–µ—Ç—ã –∏–∑ –±–∞—Ç—Ç–ª–æ–≤.</p>
          </div>
        `;
        return;
      }
      const wrapper = document.createElement('div');
      const title = document.createElement('div');
      title.className = 'section-title';
      title.textContent = '–ú–æ–∏ –ø—Ä–µ–¥–º–µ—Ç—ã';
      const sortBtn = document.createElement('button');
      sortBtn.className = 'btn';
      sortBtn.id = 'mySortPriceBtn';
      sortBtn.style.marginLeft = '10px';
      sortBtn.textContent = invSortAsc ? '–¶–µ–Ω–∞ ‚Üë' : '–¶–µ–Ω–∞ ‚Üì';
      sortBtn.onclick = () => { invSortAsc = !invSortAsc; renderInventory(); };
      title.appendChild(sortBtn);
      const grid = document.createElement('div');
      grid.className = 'inventory-grid';
      const sorted = inventory.slice().sort((a,b) => invSortAsc ? (a.value||0) - (b.value||0) : (b.value||0) - (a.value||0));
      sorted.forEach((item, idx) => {
        const actualIndex = allInv.indexOf(item);
        const d = document.createElement('div');
        const isActive = selectedLeftIndices.includes(actualIndex);
        d.className = `inventory-item ${isActive ? 'active' : ''}`;
        if (item.source === '–ö–æ–Ω—Ç—Ä–∞–∫—Ç') {
          const imgSrc = resolveItemImage(item);
          d.innerHTML = `
            <div class="item-visual"><img src="${imgSrc}" onerror="this.src='images/games/shoot.png'"></div>
            <div class="inv-name">${item.name || ''}</div>
            <div class="inv-value">${item.value || 0}‚ÇΩ</div>
          `;
        } else {
          d.innerHTML = `
            <div class="inv-emoji">${item.emoji || '‚ùì'}</div>
            <div class="inv-name">${item.name || ''}</div>
            <div class="inv-value">${item.value || 0}‚ÇΩ</div>
          `;
        }
        d.onclick = () => {
          if (selectedLeftIndices.includes(actualIndex)) {
            selectedLeftIndices = selectedLeftIndices.filter(i => i !== actualIndex);
          } else {
            if (selectedLeftIndices.length >= 4) {
              alert('–ú–∞–∫—Å–∏–º—É–º 4 –ø—Ä–µ–¥–º–µ—Ç–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è');
              return;
            }
            selectedLeftIndices = [...selectedLeftIndices, actualIndex];
          }
          applySelection();
        };
        grid.appendChild(d);
      });
      wrapper.appendChild(title);
      wrapper.appendChild(grid);
      container.innerHTML = '';
      container.appendChild(wrapper);
    }

    function applySelection() {
      const inv = currentUser?.inventory || [];
      const selected = selectedLeftIndices.map(i => inv[i]).filter(Boolean);
      const right = rightSelected;
      const total = selected.reduce((sum, it) => sum + (it.value || 0), 0);
      const first = selected[0] || null;
      document.getElementById('leftEmoji').textContent = first ? (first.emoji || '‚ùì') : '‚ùì';
      document.getElementById('leftName').textContent = selected.length > 0 ? `–í—ã–±—Ä–∞–Ω–æ ${selected.length}` : '–ù–µ –≤—ã–±—Ä–∞–Ω';
      document.getElementById('leftValue').textContent = `${total + balanceUse}‚ÇΩ`;

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º breakdown
      const breakdownEl = document.getElementById('leftBreakdown');
      if (balanceUse > 0 && total > 0) {
        breakdownEl.innerHTML = `–ü—Ä–µ–¥–º–µ—Ç—ã: <span>${total}‚ÇΩ</span> + –ë–∞–ª–∞–Ω—Å: <span class="balance-part">${balanceUse}‚ÇΩ</span>`;
      } else if (balanceUse > 0) {
        breakdownEl.innerHTML = `–ë–∞–ª–∞–Ω—Å: <span class="balance-part">${balanceUse}‚ÇΩ</span>`;
      } else if (total > 0) {
        breakdownEl.innerHTML = `–ü—Ä–µ–¥–º–µ—Ç—ã: <span>${total}‚ÇΩ</span>`;
      } else {
        breakdownEl.innerHTML = '';
      }
      const list = document.getElementById('leftSelectedList');
      if (list) {
        list.innerHTML = '';
        selected.forEach(it => {
          const d = document.createElement('div');
          d.className = 'selected-item';
          d.innerHTML = `
            <div class="selected-emoji">${it.emoji || '‚ùì'}</div>
            <div class="selected-value">${it.value || 0}‚ÇΩ</div>
          `;
          list.appendChild(d);
        });
      }
      document.getElementById('rightEmoji').textContent = right ? (right.emoji || '‚ùì') : '‚ùì';
      document.getElementById('rightName').textContent = right ? (right.name || '–ü—Ä–µ–¥–º–µ—Ç') : '–ù–µ –≤—ã–±—Ä–∞–Ω';
      document.getElementById('rightValue').textContent = (right && right.value) ? `${right.value}‚ÇΩ` : '0‚ÇΩ';

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º breakdown –¥–ª—è –ø—Ä–∞–≤–æ–≥–æ —Å–ª–æ—Ç–∞
      const rightBreakdownEl = document.getElementById('rightBreakdown');
      if (right && right.value) {
        const diff = (right.value || 0) - (total + balanceUse);
        if (diff > 0) {
          rightBreakdownEl.innerHTML = `–†–∞–∑–Ω–∏—Ü–∞: <span>+${diff.toLocaleString()}‚ÇΩ</span>`;
        } else {
          rightBreakdownEl.innerHTML = '';
        }
      } else {
        rightBreakdownEl.innerHTML = '';
      }
      const effectiveBase = total + balanceUse;
      const valid = selected.length >= 1 && selected.length <= 4 && right && right.value > effectiveBase;
      const chanceRaw = valid ? (effectiveBase / right.value) * 100 : 0;
      const chance = valid ? Math.min(95, chanceRaw) : 0;

      // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —à–∞–Ω—Å: –µ—Å–ª–∏ –º–µ–Ω—å—à–µ 1% - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–æ–ª—å—à–µ –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
      let chanceText;
      if (chance >= 10) {
        chanceText = `${chance.toFixed(1)}%`;
      } else if (chance >= 1) {
        chanceText = `${chance.toFixed(2)}%`;
      } else if (chance >= 0.1) {
        chanceText = `${chance.toFixed(3)}%`;
      } else if (chance > 0.01) {
        chanceText = `${chance.toFixed(4)}%`;
      } else if (chance > 0.001) {
        chanceText = `${chance.toFixed(5)}%`;
      } else if (chance > 0) {
        chanceText = `${chanceRaw.toExponential(2)}`;
      } else {
        chanceText = '0%';
      }
      document.getElementById('chancePercent').textContent = chanceText;
      const circumference = 2 * Math.PI * 64;
      const offset = circumference * (1 - Math.min(0.95, chance / 100));
      document.getElementById('ringProgress').setAttribute('stroke-dasharray', `${circumference}`);
      document.getElementById('ringProgress').setAttribute('stroke-dashoffset', `${offset}`);
      const ringPtr = document.getElementById('ringPointer');
      if (ringPtr) {
        if (!window.__ringAnimating) {
          ringPtr.style.transition = 'none';
          ringPtr.style.transform = 'rotate(0deg)';
        }
      }
      updateUpgradeButtonState(valid);
      renderInventory();
      updateBalanceUseRange();
    }

    function updateUpgradeButtonState(valid) {
      const btn = document.getElementById('upgradeBtn');
      if (!btn) return;
      btn.disabled = !valid;
      btn.style.opacity = valid ? '1' : '0.6';
      btn.textContent = valid ? '–£–ª—É—á—à–∏—Ç—å' : '–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã';
    }

    function showSelectModal(mode) {
      modalMode = mode;
      const inv = currentUser?.inventory || [];
      const battleInv = inv.filter(isBattleItem);
      let list = mode === 'right' ? battleCatalog.slice() : inv;
      if (mode === 'right' && leftIndex != null) {
        const base = inv[leftIndex];
        const minVal = base.value + balanceUse;
        list = list.filter(it => it.value > minVal);
      }
      modalItems = list.map(it => ({ ...it }));
      renderModalItems();
      document.getElementById('modalTitle').textContent = mode === 'left' ? '–í—ã–±–µ—Ä–∏—Ç–µ –±–∞–∑–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç' : '–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª–µ–≤–æ–π –ø—Ä–µ–¥–º–µ—Ç (–≤—Å–µ —Å–∫–∏–Ω—ã –±–∞—Ç—Ç–ª–æ–≤)';
      document.getElementById('selectModal').style.display = 'flex';
    }

    function renderModalItems() {
      const grid = document.getElementById('modalItemsGrid');
      const search = (document.getElementById('searchInput')?.value || '').trim();
      const indicator = document.getElementById('searchIndicator');

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ–∏—Å–∫–∞
      if (indicator) {
        if (search) {
          indicator.classList.add('active');
        } else {
          indicator.classList.remove('active');
        }
      }

      let items = modalItems.slice();

      if (search) {
          const searchNum = parseFloat(search);
          if (!isNaN(searchNum) && searchNum > 0) {
              // –ò—â–µ–º –ø–æ —Ü–µ–Ω–µ: –æ—Ç -30% –¥–æ +40% –æ—Ç –≤–≤–µ–¥–µ–Ω–Ω–æ–π —Å—É–º–º—ã
              const minP = searchNum * 0.7;
              const maxP = searchNum * 1.4;
              items = items.filter(it => it.value >= minP && it.value <= maxP);
          } else {
              // –ò—â–µ–º –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
              const searchLower = search.toLowerCase();
              items = items.filter(it => (it.name || '').toLowerCase().includes(searchLower));
          }
      }

      items.sort((a,b) => modalSortAsc ? a.value - b.value : b.value - a.value);
      grid.innerHTML = '';
      items.forEach(it => {
        const d = document.createElement('div');
        let active = false;
        if (modalMode === 'left') {
          const idx = (currentUser?.inventory || []).findIndex(x => x.emoji === it.emoji && x.name === it.name && x.value === it.value && isBattleItem(x));
          active = selectedLeftIndices.includes(idx);
        }
        d.className = `inventory-item ${active ? 'active' : ''}`;
        const imgSrc = resolveItemImage(it);
        d.innerHTML = `
          <div class="item-visual"><img src="${imgSrc}" onerror="this.src='images/games/shoot.png'"></div>
          <div class="inv-name">${it.name || ''}</div>
          <div class="inv-value">${it.value || 0}‚ÇΩ</div>
        `;
        d.onclick = () => {
          if (modalMode === 'left') {
            const idx = (currentUser?.inventory || []).findIndex(x => x.emoji === it.emoji && x.name === it.name && x.value === it.value && isBattleItem(x));
            if (idx >= 0) {
              if (selectedLeftIndices.includes(idx)) {
                selectedLeftIndices = selectedLeftIndices.filter(i => i !== idx);
              } else {
                if (selectedLeftIndices.length >= 4) {
                  alert('–ú–∞–∫—Å–∏–º—É–º 4 –ø—Ä–µ–¥–º–µ—Ç–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è');
                  return;
                }
                selectedLeftIndices = [...selectedLeftIndices, idx];
              }
            }
            renderModalItems();
            applySelection();
          } else {
            rightSelected = { emoji: it.emoji, name: it.name, value: it.value };
            applySelection();
            document.getElementById('selectModal').style.display = 'none';
          }
        };
        grid.appendChild(d);
      });
    }

    function updateBalanceUseRange() {
      const range = document.getElementById('balanceUseRange');
      const max = Math.floor(currentUser?.balance || 0);
      range.max = String(max);
      if (balanceUse > max) balanceUse = max;
      range.value = String(balanceUse);
      document.getElementById('balanceUseText').textContent = balanceUse;
    }


    function autoSelectTargetByMult() {
      const inv = currentUser?.inventory || [];
      const selected = selectedLeftIndices.map(i => inv[i]).filter(Boolean);
      if (selected.length === 0 || !currentMult) return;
      const total = selected.reduce((sum, it) => sum + (it.value || 0), 0);
      const targetVal = (total + balanceUse) * currentMult;
      let candidate = null;
      for (let i = 0; i < battleCatalog.length; i++) {
        if (battleCatalog[i].value >= targetVal) { candidate = battleCatalog[i]; break; }
      }
      if (!candidate) candidate = battleCatalog[battleCatalog.length - 1];
      rightSelected = { emoji: candidate.emoji, name: candidate.name, value: candidate.value };
      applySelection();
    }

    async function tryUpgrade() {
      if (isUpgrading) return;
      const inv = currentUser?.inventory || [];
      if (selectedLeftIndices.length === 0 || !rightSelected) {
        document.getElementById('upgradeResult').innerHTML = '<span style="color:#f87171">–í—ã–±–µ—Ä–∏—Ç–µ 1‚Äì4 –ø—Ä–µ–¥–º–µ—Ç–∞ –∏ —Ü–µ–ª—å</span>';
        return;
      }
      isUpgrading = true;
      const btnLock = document.getElementById('upgradeBtn');
      if (btnLock) { btnLock.disabled = true; btnLock.textContent = '–£–ª—É—á—à–µ–Ω–∏–µ‚Ä¶'; }
      try {
        const selected = selectedLeftIndices.map(i => inv[i]).filter(Boolean);
        const target = rightSelected;
        const total = selected.reduce((sum, it) => sum + (it.value || 0), 0);
        const effectiveBase = total + balanceUse;
        if (!(target.value > effectiveBase)) {
          document.getElementById('upgradeResult').innerHTML = '<span style="color:#f87171">–¶–µ–ª–µ–≤–æ–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Ä–æ–∂–µ –±–∞–∑–æ–≤–æ–≥–æ</span>';
          return;
        }
        const chanceRaw = (effectiveBase / target.value) * 100;
        const chance = Math.min(95, chanceRaw);
        let success = false;
        const arc = Math.max(1, Math.min(95, chance)) * 3.6;
        const rollByAngle = (angleIn360) => angleIn360 <= arc;
        const runAnimation = () => new Promise(resolve => {
          const ringPtr = document.getElementById('ringPointer');
          playSpinStart();
          if (fastMode) {
            const angleIn360 = Math.random() * 360;
            if (ringPtr) {
              window.__ringAnimating = true;
              ringPtr.style.transition = 'transform 0.9s cubic-bezier(0.2, 0.8, 0.2, 1)';
              ringPtr.style.transform = `rotate(${angleIn360}deg)`;
            }
            const tickId = startTickLoop(900, spinType);
            setTimeout(() => {
              window.__ringAnimating = false;
              clearInterval(tickId);
              const res = rollByAngle(angleIn360);
              if (res) playWinSound(); else playLoseSound();
              resolve(res);
            }, 900);
            return;
          }
          const baseSpins = 5 * 360;
          const angleIn360 = Math.random() * 360;
          const totalAngle = baseSpins + angleIn360;
          if (spinType === 'normal') {
            if (ringPtr) {
              window.__ringAnimating = true;
              ringPtr.style.transition = 'transform 2.8s cubic-bezier(0.11, 0.89, 0.32, 1.00)';
              ringPtr.style.transform = `rotate(${totalAngle}deg)`;
            }
            const tickId = startTickLoop(2800, 'normal');
            setTimeout(() => {
              window.__ringAnimating = false;
              clearInterval(tickId);
              const res = rollByAngle(angleIn360);
              if (Math.abs(angleIn360 - arc) < 8) playNearHit();
              if (res) playWinSound(); else playLoseSound();
              resolve(res);
            }, 2800);
            return;
          }
          if (spinType === 'bait') {
            const nearAngle = rollByAngle(angleIn360) ? Math.max(0, arc - 6) : Math.min(360, arc + 6);
            const phase1 = baseSpins + nearAngle;
            const phase2 = totalAngle;
            if (ringPtr) {
              window.__ringAnimating = true;
              ringPtr.style.transition = 'transform 1.6s cubic-bezier(0.18, 0.9, 0.2, 1)';
              ringPtr.style.transform = `rotate(${phase1}deg)`;
            }
            const tickId = startTickLoop(2600, 'bait');
            setTimeout(() => {
              playNearHit();
              if (ringPtr) {
                ringPtr.style.transition = 'transform 0.4s cubic-bezier(0.6, 0.0, 0.4, 1)';
                ringPtr.style.transform = `rotate(${phase1 + (rollByAngle(angleIn360) ? -4 : 8)}deg)`;
              }
              setTimeout(() => {
                if (ringPtr) {
                  ringPtr.style.transition = 'transform 0.8s cubic-bezier(0.11, 0.89, 0.32, 1.00)';
                  ringPtr.style.transform = `rotate(${phase2}deg)`;
                }
                setTimeout(() => {
                  window.__ringAnimating = false;
                  clearInterval(tickId);
                  const res = rollByAngle(angleIn360);
                  if (res) playWinSound(); else playLoseSound();
                  resolve(res);
                }, 800);
              }, 420);
            }, 1600);
            return;
          }
          if (spinType === 'degen') {
            const accelSpins = 6 * 360;
            const win = rollByAngle(angleIn360);
            const delta = 6;
            const nearAngle = win ? Math.min(360, arc + delta) : Math.max(0, arc - delta);
            const phase1 = accelSpins + nearAngle;
            if (ringPtr) {
              window.__ringAnimating = true;
              ringPtr.style.transition = 'transform 2.0s cubic-bezier(0.12, 0.85, 0.25, 1)';
              ringPtr.style.transform = `rotate(${phase1}deg)`;
            }
            const tickId = startTickLoop(3200, 'degen');
            setTimeout(() => {
              playNearHit();
              if (ringPtr) {
                ringPtr.style.transition = 'transform 1.2s cubic-bezier(0.11, 0.89, 0.32, 1.00)';
                ringPtr.style.transform = `rotate(${totalAngle}deg)`;
              }
              setTimeout(() => {
                window.__ringAnimating = false;
                clearInterval(tickId);
                const res = rollByAngle(angleIn360);
                if (res) playWinSound(); else playLoseSound();
                resolve(res);
              }, 1200);
            }, 2000);
            return;
          }
          resolve(rollByAngle(angleIn360));
        });
        success = await runAnimation();
        {
          const modal = document.getElementById('upgradeResultModal');
          const card = document.getElementById('upgradeResultCard');
          const title = document.getElementById('upgradeResultTitle');
          const text = document.getElementById('upgradeResultText');
          if (modal && card && title && text) {
            card.className = `result-card ${success ? 'success' : 'fail'}`;
            title.className = `result-title ${success ? 'success' : 'fail'}`;
            title.textContent = success ? '–ü–æ–±–µ–¥–∞!' : '–ü—Ä–æ–∏–≥—Ä—ã—à';
            text.textContent = success ? `–ü–æ–ª—É—á–µ–Ω–æ: ${target.value}‚ÇΩ` : '–ü—Ä–µ–¥–º–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω';
            modal.style.display = 'flex';
          }
        }
        await runTransaction(db, async (tx) => {
          const userRef = doc(db, 'users', userId);
          const snap = await tx.get(userRef);
          if (!snap.exists()) throw new Error('user not found');
          const data = snap.data();
          const curInv = Array.isArray(data.inventory) ? data.inventory.slice() : [];
          const toRemove = selected.map(s => ({ emoji: s.emoji, name: s.name, value: s.value }));
          let removed = 0;
          toRemove.forEach(s => {
            const idx = curInv.findIndex(it => it && it.emoji === s.emoji && it.name === s.name && it.value === s.value);
            if (idx !== -1) { curInv.splice(idx, 1); removed++; }
          });
          if (removed !== toRemove.length) throw new Error('items missing');
          if (success) {
            curInv.push({
              id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString() + Math.random().toString(16).slice(2)),
              emoji: target.emoji,
              name: target.name,
              value: target.value,
              source: '–ê–ø–≥—Ä–µ–π–¥',
              timestamp: Date.now()
            });
          }
          const newBalance = Math.max(0, ((data.balance || 0) - balanceUse));
          tx.update(userRef, { inventory: curInv, balance: newBalance });
          currentUser.inventory = curInv;
          currentUser.balance = newBalance;
        });
        updateBalance();
        selectedLeftIndices = [];
        balanceUse = 0;
        applySelection();
        updateBalance();
        document.getElementById('upgradeResult').innerHTML = success
          ? `<span style="color:#34d399">–£—Å–ø–µ—Ö! –ü–æ–ª—É—á–µ–Ω–æ: ${target.value}‚ÇΩ</span>`
          : `<span style="color:#f87171">–ù–µ—É–¥–∞—á–∞. –ü—Ä–µ–¥–º–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω.</span>`;
      } catch (e) {
        document.getElementById('upgradeResult').innerHTML = '<span style="color:#f87171">–û—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞</span>';
      } finally {
        isUpgrading = false;
        const btnUnlock = document.getElementById('upgradeBtn');
        if (btnUnlock) { btnUnlock.disabled = false; btnUnlock.textContent = '–£–ª—É—á—à–∏—Ç—å'; }
      }
    }

    function bindSelectors() {
      document.getElementById('selectLeft')?.addEventListener('click', () => showSelectModal('left'));
      document.getElementById('selectRight')?.addEventListener('click', () => showSelectModal('right'));
      document.getElementById('upgradeBtn')?.addEventListener('click', tryUpgrade);
      document.getElementById('sortPriceBtn')?.addEventListener('click', () => {
        modalSortAsc = !modalSortAsc;
        document.getElementById('sortPriceBtn').textContent = modalSortAsc ? '–¶–µ–Ω–∞ ‚ÇΩ ‚Üë' : '–¶–µ–Ω–∞ ‚ÇΩ ‚Üì';
        renderModalItems();
      });
      document.getElementById('searchInput')?.addEventListener('input', renderModalItems);
      document.getElementById('closeModalBtn')?.addEventListener('click', () => {
        document.getElementById('selectModal').style.display = 'none';
      });
      document.getElementById('fastMode')?.addEventListener('change', e => {
        fastMode = !!e.target.checked;
      });
      document.querySelectorAll('.spin-type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.spin-type-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          spinType = btn.dataset.type || 'normal';
        });
      });
      document.querySelectorAll('.mult-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.mult-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentMult = parseFloat(btn.dataset.mult);
          autoSelectTargetByMult();
        });
      });
      document.getElementById('balanceUseRange')?.addEventListener('input', e => {
        balanceUse = Math.floor(parseFloat(e.target.value || '0'));
        document.getElementById('balanceUseText').textContent = balanceUse;
        applySelection();
      });
    }
    window.closeUpgradeResult = function() {
      const modal = document.getElementById('upgradeResultModal');
      if (modal) modal.style.display = 'none';
    };

    function loadCurrentUser() {
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          userId = user.uid;
          const snap = await getDoc(doc(db, 'users', user.uid));
          if (snap.exists()) {
            currentUser = snap.data();
            if (!Array.isArray(currentUser.inventory)) currentUser.inventory = [];
            isGuest = false;
            updateBalance();
            buildBattleCatalog();
            renderInventory();
            applySelection();
          }
        } else {
          const username = localStorage.getItem('dropwin_current_username');
          if (username === '–ì–æ—Å—Ç—å') {
            const users = JSON.parse(localStorage.getItem('dropwin_users')) || [];
            currentUser = users.find(u => u.username === '–ì–æ—Å—Ç—å') || { username: '–ì–æ—Å—Ç—å', balance: 0, inventory: [] };
            isGuest = true;
            updateBalance();
            buildBattleCatalog();
            renderInventory();
            applySelection();
          } else {
            location.href = 'register.html';
          }
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      createParticles();
      loadCurrentUser();
      bindSelectors();
    });
  </script>
</body>
</html>
