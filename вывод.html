<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ | DropWin</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Styles adapted from dep.html */
    .method-card {
      background: rgba(30,27,71,0.75);
      border-radius: 16px;
      padding: 18px;
      margin: 16px 0;
      border: 2px solid #6b7280;
      cursor: pointer;
      transition: all 0.25s;
    }
    .method-card.active {
      border-color: #f97316;
      background: rgba(249, 115, 22, 0.15);
      box-shadow: 0 0 20px rgba(249, 115, 22, 0.4);
    }
    .bonus-notice {
      background: linear-gradient(135deg, #1e40af, #1e3a8a);
      padding: 16px;
      border-radius: 16px;
      margin: 20px 0;
      text-align: center;
    }
    .min-info {
      margin-top: 8px;
      font-size: 0.9rem;
      color: #e5e7eb;
      opacity: 0.9;
    }

    /* Modals */
    #confirmModal, #successModal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    #confirmModal.show, #successModal.show {
      display: flex;
    }
    .modal-box {
      background: linear-gradient(145deg, #1e1b4b, #312e81);
      border-radius: 24px;
      padding: 32px;
      max-width: 420px;
      width: 100%;
      text-align: center;
      border: 2px solid #4f46e5;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
    }
    .modal-title {
      font-size: 1.5rem;
      font-weight: bold;
      color: #fff;
      margin-bottom: 20px;
    }
    .modal-amount {
      font-size: 2.5rem;
      font-weight: bold;
      color: #f97316;
      margin: 20px 0;
    }
    .modal-details {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 16px;
      margin: 20px 0;
      text-align: left;
      color: #d1d5db;
      font-size: 0.95rem;
    }
    .modal-details div {
      margin: 8px 0;
      display: flex;
      justify-content: space-between;
    }
    .modal-details span:last-child {
      color: #fff;
      font-weight: 600;
    }
    .modal-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    .modal-btn {
      flex: 1;
      padding: 16px;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
    }
    .modal-btn.cancel {
      background: rgba(239, 68, 68, 0.2);
      color: #f87171;
      border: 2px solid #ef4444;
    }
    .modal-btn.cancel:hover {
      background: rgba(239, 68, 68, 0.4);
    }
    .modal-btn.confirm {
      background: linear-gradient(135deg, #f97316, #ea580c);
      color: #fff;
      box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4);
    }
    .modal-btn.confirm:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(249, 115, 22, 0.5);
    }
    .payment-id {
      background: rgba(0, 0, 0, 0.4);
      padding: 12px;
      border-radius: 10px;
      font-family: monospace;
      font-size: 0.9rem;
      color: #a78bfa;
      margin: 16px 0;
    }
    .payment-link {
      display: block;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: #fff;
      padding: 16px;
      border-radius: 12px;
      text-decoration: none;
      font-weight: bold;
      font-size: 1.1rem;
      margin: 20px 0;
      transition: all 0.3s;
    }
    .payment-link:hover {
      transform: scale(1.02);
      box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
    }
    .payment-status {
      margin-top: 16px;
      padding: 12px;
      border-radius: 10px;
      font-size: 0.95rem;
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
    }
    .payment-close {
      background: transparent;
      border: 2px solid #6b7280;
      color: #9ca3af;
      padding: 12px 24px;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 16px;
      transition: all 0.3s;
    }
    .payment-close:hover {
      border-color: #fff;
      color: #fff;
    }
    
    .support-link {
      margin-top: 18px;
      font-size: 0.9rem;
      color: #9ca3af;
      text-align: center;
    }
    .support-link a {
      color: #60a5fa;
      text-decoration: none;
      font-weight: 600;
    }
    .support-link a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
<div class="particles" id="particles"></div>

<!-- –û–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
<div id="confirmModal">
  <div class="modal-box">
    <div class="modal-title">üìã –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–≤–æ–¥–∞</div>
    <div class="modal-amount" id="confirmAmount">0 ‚ÇΩ</div>
    <div class="modal-details">
      <div><span>–°—É–º–º–∞ —Å–ø–∏—Å–∞–Ω–∏—è:</span><span id="detailAmount">0 ‚ÇΩ</span></div>
      <div><span>–ö–æ–º–∏—Å—Å–∏—è:</span><span>0%</span></div>
      <div><span>–ö –ø–æ–ª—É—á–µ–Ω–∏—é:</span><span id="detailTotal" style="color:#f97316;">0 ‚ÇΩ</span></div>
      <div><span>–ú–µ—Ç–æ–¥:</span><span>Telegram –ë–æ—Ç</span></div>
    </div>
    <div class="modal-buttons">
      <button class="modal-btn cancel" onclick="closeConfirmModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="modal-btn confirm" onclick="submitWithdraw()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å ‚Üí</button>
    </div>
  </div>
</div>

<!-- –û–∫–Ω–æ —É—Å–ø–µ—Ö–∞ (–∫–∞–∫ Payment Modal) -->
<div id="successModal">
  <div class="modal-box">
    <div class="modal-title">‚úÖ –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞</div>
    <div class="modal-amount" id="successAmount">0 ‚ÇΩ</div>
    <div class="payment-id">ID: <span id="successId">---</span></div>
    <div class="payment-status" id="successStatus">
      ‚è≥ –û–∂–∏–¥–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
    </div>
    <a href="#" class="payment-link" id="successLink" target="_blank">
      üì± –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤ –±–æ—Ç–µ
    </a>
    <div style="color: #9ca3af; font-size: 0.9rem; margin-top: 12px;">–°–æ–∑–¥–∞–Ω–æ: <span id="successTime">--:--</span></div>
    <button class="payment-close" onclick="closeSuccessModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<div class="header">
  <div class="logo">üíé DROPWIN</div>
  <div class="balance-container">
    <div class="balance">üí∞ <span id="balance">‚Äî</span>‚ÇΩ</div>
  </div>
</div>

<div class="content">
  <button class="back-btn" onclick="location.href='profile.html'">‚Üê –ü—Ä–æ—Ñ–∏–ª—å</button>

  <div class="game-card">
    <div class="game-title">–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</div>

    <div class="bonus-notice" style="background: linear-gradient(135deg, #1e40af, #1e3a8a);">
      <strong>‚ö†Ô∏è –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ ‚Äî 1000‚ÇΩ</strong><br>
      –ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–≤–æ–¥ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å –≤–∞—à —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å.
      <div class="min-info">
        –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–∫–∏.
      </div>
    </div>

    <!-- Cooldown Warning Block -->
    <div id="cooldownWarning" style="display: none; background: rgba(239, 68, 68, 0.2); color: #fca5a5; padding: 12px; border-radius: 12px; margin: 16px 0; border: 1px solid #ef4444; text-align: center;">
      ‚õî –í—ã–≤–æ–¥ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω.<br>
      –ü–æ–¥–æ–∂–¥–∏—Ç–µ <span id="cooldownTimer" style="font-weight: bold; color: #fff;">--:--</span> –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è.
    </div>
    
    <!-- No Games Warning Block -->
    <div id="noGamesWarning" style="display: none; background: rgba(239, 68, 68, 0.2); color: #fca5a5; padding: 12px; border-radius: 12px; margin: 16px 0; border: 1px solid #ef4444; text-align: center;">
      ‚õî –í—ã–≤–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.<br>
      –í–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å—ã–≥—Ä–∞—Ç—å —Ö–æ—Ç—è –±—ã –≤ –æ–¥–Ω—É –∏–≥—Ä—É –ø–µ—Ä–µ–¥ –≤—ã–≤–æ–¥–æ–º —Å—Ä–µ–¥—Å—Ç–≤.
    </div>

    <div class="method-card active">
      <h3>üì± Telegram –ë–æ—Ç</h3>
      <p>–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ DropWins</p>
    </div>

    <div style="margin: 24px 0; position: relative;">
      <label class="input-label">–°—É–º–º–∞ –≤—ã–≤–æ–¥–∞ (‚ÇΩ)</label>
      <div style="display: flex; align-items: center; gap: 12px;">
        <input type="number" id="withdrawAmount" placeholder="1000" min="1000" step="100"
               style="font-size:1.4rem; padding:16px; flex: 1; width: 100%;">
      </div>
    </div>

    <button class="btn" id="withdrawBtn" onclick="showConfirmModal()"
            style="background: linear-gradient(135deg, #f97316, #ea580c); margin-top: 16px;">
      üí∏ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É
    </button>

    <div id="withdrawStatus" style="margin-top: 16px; min-height: 24px;"></div>

    <div class="support-link">
      –ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º –≤—ã–≤–æ–¥–∞ –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É:
      <a href="https://t.me/DropWinHelp_bot" target="_blank">@DropWinHelp_bot</a>
    </div>
  </div>
</div>

<div class="nav">
  <button class="nav-btn" onclick="location.href='index.html'"><span>üè†</span>–ì–ª–∞–≤–Ω–∞—è</button>
  <button class="nav-btn" onclick="location.href='profile.html'"><span>üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</button>
  <button class="nav-btn active"><span>üí∏</span>–í—ã–≤–æ–¥</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBVra2JN-C7-1b_Qa4cU8--XvJ83lymiM8",
    authDomain: "dropwin-8d94b.firebaseapp.com",
    projectId: "dropwin-8d94b",
    storageBucket: "dropwin-8d94b.firebasestorage.app",
    messagingSenderId: "988974289403",
    appId: "1:988974289403:web:886d34e6f65920a105fb5e",
    measurementId: "G-BK010MHN8N"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let userId = null;

  function createParticles() {
    const container = document.getElementById('particles');
    for (let i = 0; i < 40; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      p.style.width = p.style.height = Math.random() * 3 + 1 + 'px';
      p.style.left = Math.random() * 100 + '%';
      p.style.animationDuration = Math.random() * 15 + 10 + 's';
      p.style.animationDelay = Math.random() * 5 + 's';
      container.appendChild(p);
    }
  }

  async function loadUserAndBalance(user) {
    userId = user.uid;
    try {
      const snap = await getDoc(doc(db, 'users', user.uid));
      if (!snap.exists()) {
        document.getElementById('withdrawStatus').innerHTML =
          '<span style="color:#f87171;">–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç –µ—â—ë —Ä–∞–∑.</span>';
        return;
      }
      currentUser = snap.data();
      const balance = currentUser.balance || 0;
      document.getElementById('balance').textContent = balance;

      const btn = document.getElementById('withdrawBtn');
      const amountInput = document.getElementById('withdrawAmount');

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–≥—Ä –∏ –æ–±–æ—Ä–æ—Ç–∞
      const gamesPlayed = currentUser.gamesPlayed || 0;
      const totalBet = currentUser.totalBet || 0;
      const minGames = 5;
      const minTurnover = balance * 0.30;

      if (gamesPlayed < minGames || totalBet < minTurnover) {
        const noGamesWarn = document.getElementById('noGamesWarning');
        const btn = document.getElementById('withdrawBtn');
        const amountInput = document.getElementById('withdrawAmount');
        
        if (noGamesWarn) {
          noGamesWarn.style.display = 'block';
          noGamesWarn.innerHTML = `
            ‚õî –í—ã–≤–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.<br>
            –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å—ã–≥—Ä–∞—Ç—å –º–∏–Ω–∏–º—É–º ${minGames} –∏–≥—Ä –∏ —Å–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–æ–∫ –Ω–∞ —Å—É–º–º—É –Ω–µ –º–µ–Ω–µ–µ 30% –æ—Ç –±–∞–ª–∞–Ω—Å–∞.<br>
            <div style="margin-top:8px; font-size:0.9em; opacity:0.8;">
               –°—ã–≥—Ä–∞–Ω–æ: ${gamesPlayed}/${minGames}<br>
               –°—Ç–∞–≤–æ–∫: ${Math.floor(totalBet)} / ${Math.floor(minTurnover)} ‚ÇΩ
            </div>
          `;
        }
        if (btn) {
          btn.disabled = true;
          btn.style.opacity = '0.5';
          btn.textContent = '–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ª–æ–≤–∏—è –≤—ã–≤–æ–¥–∞';
        }
        if (amountInput) amountInput.disabled = true;
        return;
      }

      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–ø–æ–∑–∏—Ç: —Ç—Ä–µ–±—É–µ–º 5 –∏–≥—Ä –∏ –æ–±–æ—Ä–æ—Ç 30% –æ—Ç —Å—É–º–º—ã –¥–æ–ø. –¥–µ–ø–æ–∑–∏—Ç–∞
      const lastWithdrawalAt = currentUser.lastWithdrawalAt || 0;
      const lastDepositAt = currentUser.lastDepositAt || 0;
      const lastDepositAmount = currentUser.lastDepositAmount || 0;
      const isAdditionalDeposit = !!(lastDepositAt && lastWithdrawalAt && lastDepositAt > lastWithdrawalAt);
      if (isAdditionalDeposit && lastDepositAmount > 0) {
        const gamesAtDep = currentUser.gamesPlayedAtLastDeposit || 0;
        const betAtDep = currentUser.totalBetAtLastDeposit || 0;
        const gamesSinceDep = Math.max(0, (currentUser.gamesPlayed || 0) - gamesAtDep);
        const betSinceDep = Math.max(0, (currentUser.totalBet || 0) - betAtDep);
        const depMinGames = 5;
        const depMinTurnover = Math.floor(lastDepositAmount * 0.30);
        if (gamesSinceDep < depMinGames || betSinceDep < depMinTurnover) {
          const noGamesWarn = document.getElementById('noGamesWarning');
          if (noGamesWarn) {
            noGamesWarn.style.display = 'block';
            noGamesWarn.innerHTML = `
              ‚õî –í—ã–≤–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.<br>
              –ü–æ—Å–ª–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –¥–µ–ø–æ–∑–∏—Ç–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å—ã–≥—Ä–∞—Ç—å –º–∏–Ω–∏–º—É–º ${depMinGames} –∏–≥—Ä –∏ —Å–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–æ–∫ –Ω–∞ —Å—É–º–º—É –Ω–µ –º–µ–Ω–µ–µ 30% –æ—Ç —Å—É–º–º—ã –¥–µ–ø–æ–∑–∏—Ç–∞.<br>
              <div style="margin-top:8px; font-size:0.9em; opacity:0.8;">
                 –°—ã–≥—Ä–∞–Ω–æ –ø–æ—Å–ª–µ –¥–µ–ø–æ–∑–∏—Ç–∞: ${gamesSinceDep}/${depMinGames}<br>
                 –°—Ç–∞–≤–æ–∫ –ø–æ—Å–ª–µ –¥–µ–ø–æ–∑–∏—Ç–∞: ${Math.floor(betSinceDep)} / ${depMinTurnover} ‚ÇΩ
              </div>
            `;
          }
          if (btn) {
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.textContent = '–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ª–æ–≤–∏—è –≤—ã–≤–æ–¥–∞';
          }
          if (amountInput) amountInput.disabled = true;
          return;
        }
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–µ—Ä–∂–∫–∏ 1 —á–∞—Å
      let lastDepositAtCool = currentUser.lastDepositAt || 0;
      if (!lastDepositAtCool && Array.isArray(currentUser.cryptoTransactions)) {
        lastDepositAtCool = currentUser.cryptoTransactions
          .filter(t => t && t.type === 'deposit')
          .reduce((m, t) => Math.max(m, t.timestamp || 0), 0);
      }
      
      const cooldownMs = 60 * 60 * 1000;
      const timeSinceDep = Date.now() - lastDepositAtCool;
      
      if (lastDepositAtCool && timeSinceDep < cooldownMs) {
        // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤—ã–≤–æ–¥–∞
        const warning = document.getElementById('cooldownWarning');
        const timerSpan = document.getElementById('cooldownTimer');
        warning.style.display = 'block';
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.textContent = '–í—ã–≤–æ–¥ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
        amountInput.disabled = true;
        
        // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞
        const updateTimer = () => {
          const remaining = cooldownMs - (Date.now() - lastDepositAt);
          if (remaining <= 0) {
             warning.style.display = 'none';
             btn.disabled = false;
             btn.style.opacity = '1';
             btn.textContent = 'üí∏ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É';
             amountInput.disabled = false;
             return;
          }
          const minutes = Math.floor(remaining / 60000);
          const seconds = Math.floor((remaining % 60000) / 1000);
          timerSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
          requestAnimationFrame(updateTimer);
        };
        updateTimer();
        return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –¥–∞–ª—å–Ω–µ–π—à—É—é –ª–æ–≥–∏–∫—É UI, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–±–∏—Ç—å disabled
      }

      if (balance < 1000) {
        btn.disabled = true;
        btn.style.opacity = '0.6';
        btn.textContent = '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤';
        amountInput.disabled = true;
        document.getElementById('withdrawStatus').innerHTML =
          '<span style="color:#fbbf24;">–î–ª—è –≤—ã–≤–æ–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –º–∏–Ω–∏–º—É–º 1000‚ÇΩ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ.</span>';
      } else {
        amountInput.max = balance;
      }
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', e);
      document.getElementById('withdrawStatus').innerHTML =
        '<span style="color:#f87171;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</span>';
    }
  }

  // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
  window.showConfirmModal = function() {
    if (!currentUser) return alert('–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç');
    
    const balance = currentUser.balance || 0;
    const amount = Number(document.getElementById('withdrawAmount').value);

    if (!amount || amount < 1000) return alert('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞ ‚Äî 1000‚ÇΩ');
    if (amount > balance) return alert('–ù–µ–ª—å–∑—è –≤—ã–≤–æ–¥–∏—Ç—å –±–æ–ª—å—à–µ, —á–µ–º —É –≤–∞—Å –Ω–∞ –±–∞–ª–∞–Ω—Å–µ.');

    document.getElementById('confirmAmount').textContent = `${amount} ‚ÇΩ`;
    document.getElementById('detailAmount').textContent = `${amount} ‚ÇΩ`;
    document.getElementById('detailTotal').textContent = `${amount} ‚ÇΩ`;

    document.getElementById('confirmModal').classList.add('show');
  };

  window.closeConfirmModal = function() {
    document.getElementById('confirmModal').classList.remove('show');
  };
  
  window.closeSuccessModal = function() {
    document.getElementById('successModal').classList.remove('show');
    location.reload(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è —É—Å–ø–µ—à–Ω–æ–π –∑–∞—è–≤–∫–∏
  };

  window.submitWithdraw = async function() {
    closeConfirmModal();
    const status = document.getElementById('withdrawStatus');
    status.innerHTML = '<div style="color:#fbbf24;">–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏...</div>';

    const amount = Number(document.getElementById('withdrawAmount').value);
    const withdrawId = 'WD' + Date.now().toString(36).toUpperCase() +
      Math.random().toString(36).substring(2, 6).toUpperCase();

    const data = {
      paymentId: withdrawId,
      withdrawId: withdrawId,
      userId: userId,
      username: currentUser.username || currentUser.email || 'Unknown',
      amount: amount,
      status: 'pending',
      method: 'telegram_bot',
      kind: 'withdraw',
      createdAt: Date.now(),
      updatedAt: Date.now()
    };

    try {
      await runTransaction(db, async (transaction) => {
        const userRef = doc(db, 'users', userId);
        const userDoc = await transaction.get(userRef);
        
        if (!userDoc.exists()) {
          throw new Error("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω");
        }
        
        const d = userDoc.data();
        const currentBalance = d.balance || 0;
        const cooldownMs = 60 * 60 * 1000; // 1 —á–∞—Å –∑–∞–¥–µ—Ä–∂–∫–∏ –ø–æ—Å–ª–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
        let lastDepositAt = d.lastDepositAt || 0;
        if (!lastDepositAt && Array.isArray(d.cryptoTransactions)) {
          lastDepositAt = d.cryptoTransactions
            .filter(t => t && t.type === 'deposit')
            .reduce((m, t) => Math.max(m, t.timestamp || 0), 0);
        }
        if (lastDepositAt && (Date.now() - lastDepositAt) < cooldownMs) {
          throw new Error("–í—ã–≤–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: –¥–µ–π—Å—Ç–≤—É–µ—Ç –∑–∞–¥–µ—Ä–∂–∫–∞ 1 —á–∞—Å –ø–æ—Å–ª–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è");
        }
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–ø–æ–∑–∏—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ 5 –∏–≥—Ä –∏ 30% –æ—Ç —Å—É–º–º—ã –¥–µ–ø–æ–∑–∏—Ç–∞
        const lastWithdrawalAt = d.lastWithdrawalAt || 0;
        const lastDepositAmount = d.lastDepositAmount || 0;
        const isAdditionalDeposit = !!(lastDepositAt && lastWithdrawalAt && lastDepositAt > lastWithdrawalAt);
        if (isAdditionalDeposit && lastDepositAmount > 0) {
          const gamesAtDep = d.gamesPlayedAtLastDeposit || 0;
          const betAtDep = d.totalBetAtLastDeposit || 0;
          const gamesSinceDep = Math.max(0, (d.gamesPlayed || 0) - gamesAtDep);
          const betSinceDep = Math.max(0, (d.totalBet || 0) - betAtDep);
          const depMinGames = 5;
          const depMinTurnover = Math.floor(lastDepositAmount * 0.30);
          if (gamesSinceDep < depMinGames || betSinceDep < depMinTurnover) {
            throw new Error("–ü–æ—Å–ª–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –¥–µ–ø–æ–∑–∏—Ç–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è 5 –∏–≥—Ä –∏ –æ–±–æ—Ä–æ—Ç 30% –æ—Ç —Å—É–º–º—ã –¥–µ–ø–æ–∑–∏—Ç–∞");
          }
        }
        if (currentBalance < amount) {
          throw new Error("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤");
        }
        
        transaction.update(userRef, { 
          balance: currentBalance - amount,
          lastWithdrawalAt: Date.now()
        });
        transaction.set(doc(db, 'payments', withdrawId), data);
      });
      
      status.innerHTML = '';
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º Success Modal
      document.getElementById('successAmount').textContent = `${amount} ‚ÇΩ`;
      document.getElementById('successId').textContent = withdrawId;
      document.getElementById('successTime').textContent = new Date().toLocaleTimeString('ru-RU');
      
      // –°—Å—ã–ª–∫–∞ –Ω–∞ –±–æ—Ç–∞
      const tgLink = `https://t.me/DropWins_Bot?start=${withdrawId}`;
      
      // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ Telegram
      window.location.href = tgLink;
      
      // –ù–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–µ—Ä–Ω—É–ª—Å—è
      document.getElementById('successLink').href = tgLink;
      document.getElementById('successAmount').textContent = `${amount} ‚ÇΩ`;
      document.getElementById('successId').textContent = withdrawId;
      document.getElementById('successTime').textContent = new Date().toLocaleTimeString('ru-RU');
      document.getElementById('successModal').classList.add('show');

    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥:', e);
      status.innerHTML =
        '<span style="color:#f87171;">–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</span>';
    }
  };

  onAuthStateChanged(auth, (user) => {
    if (!user) {
      location.href = 'register.html';
      return;
    }
    loadUserAndBalance(user);
  });

  document.addEventListener('DOMContentLoaded', () => {
    createParticles();
  });
</script>
</body>
</html>
